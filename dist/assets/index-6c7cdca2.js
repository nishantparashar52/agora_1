(function(){const Ye=document.createElement("link").relList;if(Ye&&Ye.supports&&Ye.supports("modulepreload"))return;for(const Tt of document.querySelectorAll('link[rel="modulepreload"]'))Oe(Tt);new MutationObserver(Tt=>{for(const De of Tt)if(De.type==="childList")for(const mr of De.addedNodes)mr.tagName==="LINK"&&mr.rel==="modulepreload"&&Oe(mr)}).observe(document,{childList:!0,subtree:!0});function ri(Tt){const De={};return Tt.integrity&&(De.integrity=Tt.integrity),Tt.referrerPolicy&&(De.referrerPolicy=Tt.referrerPolicy),Tt.crossOrigin==="use-credentials"?De.credentials="include":Tt.crossOrigin==="anonymous"?De.credentials="omit":De.credentials="same-origin",De}function Oe(Tt){if(Tt.ep)return;Tt.ep=!0;const De=ri(Tt);fetch(Tt.href,De)}})();var ol=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function RD(pe){return pe&&pe.__esModule&&Object.prototype.hasOwnProperty.call(pe,"default")?pe.default:pe}var BT={exports:{}};(function(pe,Ye){(function(ri,Oe){pe.exports=Oe()})(ol,function(){function ri(t,e){return e.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(n){if(n!=="default"&&!(n in t)){var r=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return i[n]}})}})}),Object.freeze(t)}var Oe=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof ol<"u"?ol:typeof self<"u"?self:{},Tt=function(t){try{return!!t()}catch{return!0}},De=!Tt(function(){var t=function(){}.bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),mr=De,al=Function.prototype,WT=al.bind,Na=al.call,HT=mr&&WT.bind(Na,Na),ue=mr?function(t){return t&&HT(t)}:function(t){return t&&function(){return Na.apply(t,arguments)}},_i=ue({}.isPrototypeOf),Yo=function(t){return t&&t.Math==Math&&t},Et=Yo(typeof globalThis=="object"&&globalThis)||Yo(typeof window=="object"&&window)||Yo(typeof self=="object"&&self)||Yo(typeof Oe=="object"&&Oe)||function(){return this}()||Function("return this")(),KT=De,cl=Function.prototype,dl=cl.apply,ul=cl.call,Da=typeof Reflect=="object"&&Reflect.apply||(KT?ul.bind(dl):function(){return ul.apply(dl,arguments)}),Pe=function(t){return typeof t=="function"},io={},Xi=!Tt(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),YT=De,qo=Function.prototype.call,Bi=YT?qo.bind(qo):function(){return qo.apply(qo,arguments)},Pa={},ll={}.propertyIsEnumerable,hl=Object.getOwnPropertyDescriptor,qT=hl&&!ll.call({1:2},1);Pa.f=qT?function(t){var e=hl(this,t);return!!e&&e.enumerable}:ll;var Rn,Jo,Yn=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},pl=ue,JT=pl({}.toString),XT=pl("".slice),no=function(t){return XT(JT(t),8,-1)},zT=ue,QT=Tt,ZT=no,La=Et.Object,$T=zT("".split),ka=QT(function(){return!La("z").propertyIsEnumerable(0)})?function(t){return ZT(t)=="String"?$T(t,""):La(t)}:La,tR=Et.TypeError,Xo=function(t){if(t==null)throw tR("Can't call method on "+t);return t},eR=ka,iR=Xo,In=function(t){return eR(iR(t))},nR=Pe,Ni=function(t){return typeof t=="object"?t!==null:nR(t)},vn={},Ma=vn,Ua=Et,rR=Pe,El=function(t){return rR(t)?t:void 0},zi=function(t,e){return arguments.length<2?El(Ma[t])||El(Ua[t]):Ma[t]&&Ma[t][e]||Ua[t]&&Ua[t][e]},qn=zi("navigator","userAgent")||"",_l=Et,xa=qn,ml=_l.process,fl=_l.Deno,Sl=ml&&ml.versions||fl&&fl.version,gl=Sl&&Sl.v8;gl&&(Jo=(Rn=gl.split("."))[0]>0&&Rn[0]<4?1:+(Rn[0]+Rn[1])),!Jo&&xa&&(!(Rn=xa.match(/Edge\/(\d+)/))||Rn[1]>=74)&&(Rn=xa.match(/Chrome\/(\d+)/))&&(Jo=+Rn[1]);var fr=Jo,Tl=fr,oR=Tt,Va=!!Object.getOwnPropertySymbols&&!oR(function(){var t=Symbol();return!String(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&Tl&&Tl<41}),Rl=Va&&!Symbol.sham&&typeof Symbol.iterator=="symbol",sR=zi,aR=Pe,cR=_i,dR=Rl,uR=Et.Object,Fa=dR?function(t){return typeof t=="symbol"}:function(t){var e=sR("Symbol");return aR(e)&&cR(e.prototype,uR(t))},lR=Et.String,zo=function(t){try{return lR(t)}catch{return"Object"}},hR=Pe,pR=zo,ER=Et.TypeError,un=function(t){if(hR(t))return t;throw ER(pR(t)+" is not a function")},_R=un,ja=function(t,e){var i=t[e];return i==null?void 0:_R(i)},Ba=Bi,Ga=Pe,Wa=Ni,mR=Et.TypeError,Qo={exports:{}},Il=Et,fR=Object.defineProperty,SR=function(t,e){try{fR(Il,t,{value:e,configurable:!0,writable:!0})}catch{Il[t]=e}return e},vl="__core-js_shared__",Ha=Et[vl]||SR(vl,{}),Cl=Ha;(Qo.exports=function(t,e){return Cl[t]||(Cl[t]=e!==void 0?e:{})})("versions",[]).push({version:"3.20.3",mode:"pure",copyright:"Â© 2014-2022 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.20.3/LICENSE",source:"https://github.com/zloirock/core-js"});var gR=Xo,TR=Et.Object,Cn=function(t){return TR(gR(t))},RR=Cn,IR=ue({}.hasOwnProperty),ei=Object.hasOwn||function(t,e){return IR(RR(t),e)},vR=ue,CR=0,yR=Math.random(),AR=vR(1 .toString),Ka=function(t){return"Symbol("+(t===void 0?"":t)+")_"+AR(++CR+yR,36)},OR=Et,bR=Qo.exports,yl=ei,wR=Ka,Al=Va,Ol=Rl,ro=bR("wks"),Jn=OR.Symbol,bl=Jn&&Jn.for,NR=Ol?Jn:Jn&&Jn.withoutSetter||wR,fe=function(t){if(!yl(ro,t)||!Al&&typeof ro[t]!="string"){var e="Symbol."+t;Al&&yl(Jn,t)?ro[t]=Jn[t]:ro[t]=Ol&&bl?bl(e):NR(e)}return ro[t]},DR=Bi,wl=Ni,Nl=Fa,PR=ja,LR=function(t,e){var i,n;if(e==="string"&&Ga(i=t.toString)&&!Wa(n=Ba(i,t))||Ga(i=t.valueOf)&&!Wa(n=Ba(i,t))||e!=="string"&&Ga(i=t.toString)&&!Wa(n=Ba(i,t)))return n;throw mR("Can't convert object to primitive value")},kR=fe,MR=Et.TypeError,UR=kR("toPrimitive"),xR=function(t,e){if(!wl(t)||Nl(t))return t;var i,n=PR(t,UR);if(n){if(e===void 0&&(e="default"),i=DR(n,t,e),!wl(i)||Nl(i))return i;throw MR("Can't convert object to primitive value")}return e===void 0&&(e="number"),LR(t,e)},VR=Fa,Zo=function(t){var e=xR(t,"string");return VR(e)?e:e+""},Dl=Ni,Ya=Et.document,FR=Dl(Ya)&&Dl(Ya.createElement),qa=function(t){return FR?Ya.createElement(t):{}},jR=qa,Pl=!Xi&&!Tt(function(){return Object.defineProperty(jR("div"),"a",{get:function(){return 7}}).a!=7}),BR=Xi,GR=Bi,WR=Pa,HR=Yn,KR=In,YR=Zo,qR=ei,JR=Pl,Ll=Object.getOwnPropertyDescriptor;io.f=BR?Ll:function(t,e){if(t=KR(t),e=YR(e),JR)try{return Ll(t,e)}catch{}if(qR(t,e))return HR(!GR(WR.f,t,e),t[e])};var XR=Tt,zR=Pe,QR=/#|\.prototype\./,oo=function(t,e){var i=$R[ZR(t)];return i==eI||i!=tI&&(zR(e)?XR(e):!!e)},ZR=oo.normalize=function(t){return String(t).replace(QR,".").toLowerCase()},$R=oo.data={},tI=oo.NATIVE="N",eI=oo.POLYFILL="P",kl=oo,iI=un,nI=De,rI=ue(ue.bind),so=function(t,e){return iI(t),e===void 0?t:nI?rI(t,e):function(){return t.apply(e,arguments)}},Gi={},Ml=Xi&&Tt(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),Ul=Et,oI=Ni,sI=Ul.String,aI=Ul.TypeError,Wi=function(t){if(oI(t))return t;throw aI(sI(t)+" is not an object")},cI=Xi,dI=Pl,uI=Ml,$o=Wi,xl=Zo,lI=Et.TypeError,Ja=Object.defineProperty,hI=Object.getOwnPropertyDescriptor,pI="enumerable",EI="configurable",_I="writable";Gi.f=cI?uI?function(t,e,i){if($o(t),e=xl(e),$o(i),typeof t=="function"&&e==="prototype"&&"value"in i&&_I in i&&!i.writable){var n=hI(t,e);n&&n.writable&&(t[e]=i.value,i={configurable:EI in i?i.configurable:n.configurable,enumerable:pI in i?i.enumerable:n.enumerable,writable:!1})}return Ja(t,e,i)}:Ja:function(t,e,i){if($o(t),e=xl(e),$o(i),dI)try{return Ja(t,e,i)}catch{}if("get"in i||"set"in i)throw lI("Accessors not supported");return"value"in i&&(t[e]=i.value),t};var mI=Gi,fI=Yn,Xn=Xi?function(t,e,i){return mI.f(t,e,fI(1,i))}:function(t,e,i){return t[e]=i,t},ts=Et,SI=Da,gI=ue,TI=Pe,RI=io.f,II=kl,Sr=vn,vI=so,gr=Xn,Vl=ei,CI=function(t){var e=function(i,n,r){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(i);case 2:return new t(i,n)}return new t(i,n,r)}return SI(t,this,arguments)};return e.prototype=t.prototype,e},Fe=function(t,e){var i,n,r,o,s,a,c,d,u=t.target,l=t.global,E=t.stat,m=t.proto,T=l?ts:E?ts[u]:(ts[u]||{}).prototype,g=l?Sr:Sr[u]||gr(Sr,u,{})[u],R=g.prototype;for(r in e)i=!II(l?r:u+(E?".":"#")+r,t.forced)&&T&&Vl(T,r),s=g[r],i&&(a=t.noTargetGet?(d=RI(T,r))&&d.value:T[r]),o=i&&a?a:e[r],i&&typeof s==typeof o||(c=t.bind&&i?vI(o,ts):t.wrap&&i?CI(o):m&&TI(o)?gI(o):o,(t.sham||o&&o.sham||s&&s.sham)&&gr(c,"sham",!0),gr(g,r,c),m&&(Vl(Sr,n=u+"Prototype")||gr(Sr,n,{}),gr(Sr[n],r,o),t.real&&R&&!R[r]&&gr(R,r,o)))},yI=Math.ceil,AI=Math.floor,Xa=function(t){var e=+t;return e!=e||e===0?0:(e>0?AI:yI)(e)},OI=Xa,bI=Math.min,wI=function(t){return t>0?bI(OI(t),9007199254740991):0},yn=function(t){return wI(t.length)},NI=un,DI=Cn,PI=ka,LI=yn,kI=Et.TypeError,Fl=function(t){return function(e,i,n,r){NI(i);var o=DI(e),s=PI(o),a=LI(o),c=t?a-1:0,d=t?-1:1;if(n<2)for(;;){if(c in s){r=s[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw kI("Reduce of empty array with no initial value")}for(;t?c>=0:a>c;c+=d)c in s&&(r=i(r,s[c],c,o));return r}},MI={left:Fl(!1),right:Fl(!0)},UI=Tt,za=function(t,e){var i=[][t];return!!i&&UI(function(){i.call(null,e||function(){throw 1},1)})},es=no(Et.process)=="process",xI=MI.left,jl=fr,VI=es;Fe({target:"Array",proto:!0,forced:!za("reduce")||!VI&&jl>79&&jl<83},{reduce:function(t){var e=arguments.length;return xI(this,t,e,e>1?arguments[1]:void 0)}});var FI=vn,An=function(t){return FI[t+"Prototype"]},jI=An("Array").reduce,BI=_i,GI=jI,Qa=Array.prototype,Bl=function(t){var e=t.reduce;return t===Qa||BI(Qa,t)&&e===Qa.reduce?GI:e},On=Bl;let Gl=!0,Wl=!0;function is(t,e,i){const n=t.match(e);return n&&n.length>=i&&parseInt(n[i],10)}function zn(t,e,i){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(s,a){if(s!==e)return r.apply(this,arguments);const c=d=>{const u=i(d);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[s,c])};const o=n.removeEventListener;n.removeEventListener=function(s,a){if(s!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(a))return o.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[s,c])},Object.defineProperty(n,"on"+e,{get(){return this["_on"+e]},set(s){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),s&&this.addEventListener(e,this["_on"+e]=s)},enumerable:!0,configurable:!0})}function WI(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(Gl=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function HI(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(Wl=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function Hl(){if(typeof window=="object"){if(Gl)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Za(t,e){Wl&&console.warn(t+" is deprecated, please use "+e+" instead.")}function KI(t){const e={browser:null,version:null};if(t===void 0||!t.navigator)return e.browser="Not a browser.",e;const{navigator:i}=t;if(i.mozGetUserMedia)e.browser="firefox",e.version=is(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||t.isSecureContext===!1&&t.webkitRTCPeerConnection)e.browser="chrome",e.version=is(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!t.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return e.browser="Not a supported browser.",e;e.browser="safari",e.version=is(i.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype}return e}function Kl(t){return Object.prototype.toString.call(t)==="[object Object]"}function Yl(t){var e;return Kl(t)?On(e=Object.keys(t)).call(e,function(i,n){const r=Kl(t[n]),o=r?Yl(t[n]):t[n],s=r&&!Object.keys(o).length;return o===void 0||s?i:Object.assign(i,{[n]:o})},{}):t}function ql(t,e,i){const n=i?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const o=[];return t.forEach(s=>{s.type==="track"&&s.trackIdentifier===e.id&&o.push(s)}),o.forEach(s=>{t.forEach(a=>{a.type===n&&a.trackId===s.id&&function c(d,u,l){u&&!l.has(u.id)&&(l.set(u.id,u),Object.keys(u).forEach(E=>{E.endsWith("Id")?c(d,d.get(u[E]),l):E.endsWith("Ids")&&u[E].forEach(m=>{c(d,d.get(m),l)})}))}(t,a,r)})}),r}var YI=Qo.exports,qI=Ka,Jl=YI("keys"),ns=function(t){return Jl[t]||(Jl[t]=qI(t))},JI=!Tt(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),XI=Et,zI=ei,QI=Pe,ZI=Cn,$I=JI,Xl=ns("IE_PROTO"),$a=XI.Object,tv=$a.prototype,tc=$I?$a.getPrototypeOf:function(t){var e=ZI(t);if(zI(e,Xl))return e[Xl];var i=e.constructor;return QI(i)&&e instanceof i?i.prototype:e instanceof $a?tv:null},zl=Et,ev=Pe,iv=zl.String,nv=zl.TypeError,rv=ue,ov=Wi,sv=function(t){if(typeof t=="object"||ev(t))return t;throw nv("Can't set "+iv(t)+" as a prototype")},av=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,i={};try{(t=rv(Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set))(i,[]),e=i instanceof Array}catch{}return function(n,r){return ov(n),sv(r),e?t(n,r):n.__proto__=r,n}}():void 0),rs={},cv=Xa,dv=Math.max,uv=Math.min,ec=function(t,e){var i=cv(t);return i<0?dv(i+e,0):uv(i,e)},lv=In,hv=ec,pv=yn,Ql=function(t){return function(e,i,n){var r,o=lv(e),s=pv(o),a=hv(n,s);if(t&&i!=i){for(;s>a;)if((r=o[a++])!=r)return!0}else for(;s>a;a++)if((t||a in o)&&o[a]===i)return t||a||0;return!t&&-1}},Ev={includes:Ql(!0),indexOf:Ql(!1)},os={},ic=ei,_v=In,mv=Ev.indexOf,fv=os,Zl=ue([].push),$l=function(t,e){var i,n=_v(t),r=0,o=[];for(i in n)!ic(fv,i)&&ic(n,i)&&Zl(o,i);for(;e.length>r;)ic(n,i=e[r++])&&(~mv(o,i)||Zl(o,i));return o},nc=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Sv=$l,gv=nc.concat("length","prototype");rs.f=Object.getOwnPropertyNames||function(t){return Sv(t,gv)};var rc={};rc.f=Object.getOwnPropertySymbols;var Tv=zi,Rv=rs,Iv=rc,vv=Wi,Cv=ue([].concat),yv=Tv("Reflect","ownKeys")||function(t){var e=Rv.f(vv(t)),i=Iv.f;return i?Cv(e,i(t)):e},th=ei,Av=yv,Ov=io,bv=Gi,oc={},wv=$l,Nv=nc,sc=Object.keys||function(t){return wv(t,Nv)},Dv=Xi,Pv=Ml,Lv=Gi,kv=Wi,Mv=In,Uv=sc;oc.f=Dv&&!Pv?Object.defineProperties:function(t,e){kv(t);for(var i,n=Mv(e),r=Uv(e),o=r.length,s=0;o>s;)Lv.f(t,i=r[s++],n[i]);return t};var ss,eh=zi("document","documentElement"),xv=Wi,Vv=oc,ih=nc,Fv=os,jv=eh,Bv=qa,nh=ns("IE_PROTO"),ac=function(){},rh=function(t){return"<script>"+t+"<\/script>"},oh=function(t){t.write(rh("")),t.close();var e=t.parentWindow.Object;return t=null,e},as=function(){try{ss=new ActiveXObject("htmlfile")}catch{}var t,e;as=typeof document<"u"?document.domain&&ss?oh(ss):((e=Bv("iframe")).style.display="none",jv.appendChild(e),e.src="javascript:",(t=e.contentWindow.document).open(),t.write(rh("document.F=Object")),t.close(),t.F):oh(ss);for(var i=ih.length;i--;)delete as.prototype[ih[i]];return as()};Fv[nh]=!0;var cs=Object.create||function(t,e){var i;return t!==null?(ac.prototype=xv(t),i=new ac,ac.prototype=null,i[nh]=t):i=as(),e===void 0?i:Vv.f(i,e)},Gv=ue("".replace),Wv=String(Error("zxcasd").stack),sh=/\n\s*at [^:]*:[^\n]*/,Hv=sh.test(Wv),Kv=Ni,Yv=Xn,Tr={},qv=Tr,Jv=fe("iterator"),Xv=Array.prototype,ah={};ah[fe("toStringTag")]="z";var cc=String(ah)==="[object z]",zv=Et,Qv=cc,Zv=Pe,ds=no,$v=fe("toStringTag"),tC=zv.Object,eC=ds(function(){return arguments}())=="Arguments",bn=Qv?ds:function(t){var e,i,n;return t===void 0?"Undefined":t===null?"Null":typeof(i=function(r,o){try{return r[o]}catch{}}(e=tC(t),$v))=="string"?i:eC?ds(e):(n=ds(e))=="Object"&&Zv(e.callee)?"Arguments":n},iC=bn,ch=ja,nC=Tr,rC=fe("iterator"),dh=function(t){if(t!=null)return ch(t,rC)||ch(t,"@@iterator")||nC[iC(t)]},oC=Bi,sC=un,aC=Wi,cC=zo,dC=dh,uC=Et.TypeError,lC=Bi,uh=Wi,hC=ja,pC=so,EC=Bi,_C=Wi,mC=zo,fC=function(t){return t!==void 0&&(qv.Array===t||Xv[Jv]===t)},SC=yn,lh=_i,gC=function(t,e){var i=arguments.length<2?dC(t):e;if(sC(i))return aC(oC(i,t));throw uC(cC(t)+" is not iterable")},TC=dh,hh=function(t,e,i){var n,r;uh(t);try{if(!(n=hC(t,"return"))){if(e==="throw")throw i;return i}n=lC(n,t)}catch(o){r=!0,n=o}if(e==="throw")throw i;if(r)throw n;return uh(n),i},RC=Et.TypeError,us=function(t,e){this.stopped=t,this.result=e},ph=us.prototype,ls=function(t,e,i){var n,r,o,s,a,c,d,u=i&&i.that,l=!(!i||!i.AS_ENTRIES),E=!(!i||!i.IS_ITERATOR),m=!(!i||!i.INTERRUPTED),T=pC(e,u),g=function(y){return n&&hh(n,"normal",y),new us(!0,y)},R=function(y){return l?(_C(y),m?T(y[0],y[1],g):T(y[0],y[1])):m?T(y,g):T(y)};if(E)n=t;else{if(!(r=TC(t)))throw RC(mC(t)+" is not iterable");if(fC(r)){for(o=0,s=SC(t);s>o;o++)if((a=R(t[o]))&&lh(ph,a))return a;return new us(!1)}n=gC(t,r)}for(c=n.next;!(d=EC(c,n)).done;){try{a=R(d.value)}catch(y){hh(n,"throw",y)}if(typeof a=="object"&&a&&lh(ph,a))return a}return new us(!1)},IC=bn,vC=Et.String,Rr=function(t){if(IC(t)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return vC(t)},CC=Rr,yC=Yn,AC=!Tt(function(){var t=Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",yC(1,7)),t.stack!==7)}),OC=Fe,bC=Et,wC=_i,NC=tc,hs=av,DC=function(t,e,i){for(var n=Av(e),r=bv.f,o=Ov.f,s=0;s<n.length;s++){var a=n[s];th(t,a)||i&&th(i,a)||r(t,a,o(e,a))}},Eh=cs,ps=Xn,dc=Yn,PC=function(t,e){if(Hv&&typeof t=="string")for(;e--;)t=Gv(t,sh,"");return t},LC=function(t,e){Kv(e)&&"cause"in e&&Yv(t,"cause",e.cause)},kC=ls,MC=function(t,e){return t===void 0?arguments.length<2?"":e:CC(t)},UC=AC,xC=fe("toStringTag"),Es=bC.Error,VC=[].push,ao=function(t,e){var i,n=arguments.length>2?arguments[2]:void 0,r=wC(uc,this);hs?i=hs(new Es,r?NC(this):uc):(i=r?this:Eh(uc),ps(i,xC,"Error")),e!==void 0&&ps(i,"message",MC(e)),UC&&ps(i,"stack",PC(i.stack,1)),LC(i,n);var o=[];return kC(t,VC,{that:o}),ps(i,"errors",o),i};hs?hs(ao,Es):DC(ao,Es,{name:!0});var uc=ao.prototype=Eh(Es.prototype,{constructor:dc(1,ao),message:dc(1,""),name:dc(1,"AggregateError")});OC({global:!0},{AggregateError:ao});var FC=Pe,lc=Ha,jC=ue(Function.toString);FC(lc.inspectSource)||(lc.inspectSource=function(t){return jC(t)});var _s,co,ms,hc=lc.inspectSource,BC=Pe,GC=hc,_h=Et.WeakMap,WC=BC(_h)&&/native code/.test(GC(_h)),mh=Et,pc=ue,HC=Ni,KC=Xn,Ec=ei,_c=Ha,YC=ns,qC=os,fh="Object already initialized",mc=mh.TypeError,JC=mh.WeakMap;if(WC||_c.state){var Qn=_c.state||(_c.state=new JC),XC=pc(Qn.get),Sh=pc(Qn.has),zC=pc(Qn.set);_s=function(t,e){if(Sh(Qn,t))throw new mc(fh);return e.facade=t,zC(Qn,t,e),e},co=function(t){return XC(Qn,t)||{}},ms=function(t){return Sh(Qn,t)}}else{var Ir=YC("state");qC[Ir]=!0,_s=function(t,e){if(Ec(t,Ir))throw new mc(fh);return e.facade=t,KC(t,Ir,e),e},co=function(t){return Ec(t,Ir)?t[Ir]:{}},ms=function(t){return Ec(t,Ir)}}var Zn,gh,Th,fs={set:_s,get:co,has:ms,enforce:function(t){return ms(t)?co(t):_s(t,{})},getterFor:function(t){return function(e){var i;if(!HC(e)||(i=co(e)).type!==t)throw mc("Incompatible receiver, "+t+" required");return i}}},fc=Xi,QC=ei,Rh=Function.prototype,ZC=fc&&Object.getOwnPropertyDescriptor,Sc=QC(Rh,"name"),Ih={EXISTS:Sc,PROPER:Sc&&function(){}.name==="something",CONFIGURABLE:Sc&&(!fc||fc&&ZC(Rh,"name").configurable)},$C=Xn,Ss=function(t,e,i,n){n&&n.enumerable?t[e]=i:$C(t,e,i)},ty=Tt,ey=Pe,iy=cs,vh=tc,ny=Ss,gc=fe("iterator"),Ch=!1;[].keys&&("next"in(Th=[].keys())?(gh=vh(vh(Th)))!==Object.prototype&&(Zn=gh):Ch=!0);var ry=Zn==null||ty(function(){var t={};return Zn[gc].call(t)!==t});ey((Zn=ry?{}:iy(Zn))[gc])||ny(Zn,gc,function(){return this});var yh={IteratorPrototype:Zn,BUGGY_SAFARI_ITERATORS:Ch},oy=bn,sy=cc?{}.toString:function(){return"[object "+oy(this)+"]"},ay=cc,cy=Gi.f,dy=Xn,uy=ei,ly=sy,Ah=fe("toStringTag"),uo=function(t,e,i,n){if(t){var r=i?t:t.prototype;uy(r,Ah)||cy(r,Ah,{configurable:!0,value:e}),n&&!ay&&dy(r,"toString",ly)}},hy=yh.IteratorPrototype,py=cs,Ey=Yn,_y=uo,my=Tr,fy=function(){return this},Sy=Fe,gy=Bi,Ty=function(t,e,i,n){var r=e+" Iterator";return t.prototype=py(hy,{next:Ey(+!n,i)}),_y(t,r,!1,!0),my[r]=fy,t},Ry=tc,Iy=uo,Oh=Ss,bh=Tr,vy=Ih.PROPER,gs=yh.BUGGY_SAFARI_ITERATORS,Tc=fe("iterator"),wh="keys",Ts="values",Nh="entries",Cy=function(){return this},Dh=function(t,e,i,n,r,o,s){Ty(i,e,n);var a,c,d,u=function(y){if(y===r&&g)return g;if(!gs&&y in m)return m[y];switch(y){case wh:case Ts:case Nh:return function(){return new i(this,y)}}return function(){return new i(this)}},l=e+" Iterator",E=!1,m=t.prototype,T=m[Tc]||m["@@iterator"]||r&&m[r],g=!gs&&T||u(r),R=e=="Array"&&m.entries||T;if(R&&(a=Ry(R.call(new t)))!==Object.prototype&&a.next&&(Iy(a,l,!0,!0),bh[l]=Cy),vy&&r==Ts&&T&&T.name!==Ts&&(E=!0,g=function(){return gy(T,this)}),r)if(c={values:u(Ts),keys:o?g:u(wh),entries:u(Nh)},s)for(d in c)(gs||E||!(d in m))&&Oh(m,d,c[d]);else Sy({target:e,proto:!0,forced:gs||E},c);return s&&m[Tc]!==g&&Oh(m,Tc,g,{name:r}),bh[e]=g,c},yy=In,Ph=Tr,Lh=fs;Gi.f;var Ay=Dh,kh="Array Iterator",Oy=Lh.set,by=Lh.getterFor(kh);Ay(Array,"Array",function(t,e){Oy(this,{type:kh,target:yy(t),index:0,kind:e})},function(){var t=by(this),e=t.target,i=t.kind,n=t.index++;return!e||n>=e.length?(t.target=void 0,{value:void 0,done:!0}):i=="keys"?{value:n,done:!1}:i=="values"?{value:e[n],done:!1}:{value:[n,e[n]],done:!1}},"values"),Ph.Arguments=Ph.Array;var Mh=Et.Promise,wy=Ss,Ny=zi,Dy=Gi,Py=Xi,Uh=fe("species"),Ly=_i,ky=Et.TypeError,xh=fe("iterator"),Vh=!1;try{var My=0,Fh={next:function(){return{done:!!My++}},return:function(){Vh=!0}};Fh[xh]=function(){return this},Array.from(Fh,function(){throw 2})}catch{}var Uy=ue,xy=Tt,jh=Pe,Vy=bn,Fy=hc,Bh=function(){},jy=[],Gh=zi("Reflect","construct"),Rc=/^\s*(?:class|function)\b/,By=Uy(Rc.exec),Gy=!Rc.exec(Bh),lo=function(t){if(!jh(t))return!1;try{return Gh(Bh,jy,t),!0}catch{return!1}},Wh=function(t){if(!jh(t))return!1;switch(Vy(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Gy||!!By(Rc,Fy(t))}catch{return!0}};Wh.sham=!0;var ho,vr,Hh,Ic,vc=!Gh||xy(function(){var t;return lo(lo.call)||!lo(Object)||!lo(function(){t=!0})||t})?Wh:lo,Wy=vc,Hy=zo,Ky=Et.TypeError,Kh=Wi,Yy=function(t){if(Wy(t))return t;throw Ky(Hy(t)+" is not a constructor")},qy=fe("species"),Yh=function(t,e){var i,n=Kh(t).constructor;return n===void 0||(i=Kh(n)[qy])==null?e:Yy(i)},Cc=ue([].slice),qh=/(?:ipad|iphone|ipod).*applewebkit/i.test(qn),mi=Et,Jy=Da,Xy=so,Jh=Pe,zy=ei,Qy=Tt,Xh=eh,Zy=Cc,zh=qa,$y=qh,tA=es,yc=mi.setImmediate,Ac=mi.clearImmediate,eA=mi.process,Oc=mi.Dispatch,iA=mi.Function,Qh=mi.MessageChannel,nA=mi.String,bc=0,po={},rA="onreadystatechange";try{ho=mi.location}catch{}var wc=function(t){if(zy(po,t)){var e=po[t];delete po[t],e()}},Nc=function(t){return function(){wc(t)}},Zh=function(t){wc(t.data)},$h=function(t){mi.postMessage(nA(t),ho.protocol+"//"+ho.host)};yc&&Ac||(yc=function(t){var e=Zy(arguments,1);return po[++bc]=function(){Jy(Jh(t)?t:iA(t),void 0,e)},vr(bc),bc},Ac=function(t){delete po[t]},tA?vr=function(t){eA.nextTick(Nc(t))}:Oc&&Oc.now?vr=function(t){Oc.now(Nc(t))}:Qh&&!$y?(Ic=(Hh=new Qh).port2,Hh.port1.onmessage=Zh,vr=Xy(Ic.postMessage,Ic)):mi.addEventListener&&Jh(mi.postMessage)&&!mi.importScripts&&ho&&ho.protocol!=="file:"&&!Qy($h)?(vr=$h,mi.addEventListener("message",Zh,!1)):vr=rA in zh("script")?function(t){Xh.appendChild(zh("script")).onreadystatechange=function(){Xh.removeChild(this),wc(t)}}:function(t){setTimeout(Nc(t),0)});var Eo,$n,_o,Cr,Dc,Pc,Lc,tp,ep={set:yc,clear:Ac},oA=Et,sA=/ipad|iphone|ipod/i.test(qn)&&oA.Pebble!==void 0,aA=/web0s(?!.*chrome)/i.test(qn),tr=Et,ip=so,cA=io.f,kc=ep.set,dA=qh,uA=sA,lA=aA,Mc=es,np=tr.MutationObserver||tr.WebKitMutationObserver,rp=tr.document,op=tr.process,Rs=tr.Promise,sp=cA(tr,"queueMicrotask"),ap=sp&&sp.value;ap||(Eo=function(){var t,e;for(Mc&&(t=op.domain)&&t.exit();$n;){e=$n.fn,$n=$n.next;try{e()}catch(i){throw $n?Cr():_o=void 0,i}}_o=void 0,t&&t.enter()},dA||Mc||lA||!np||!rp?!uA&&Rs&&Rs.resolve?((Lc=Rs.resolve(void 0)).constructor=Rs,tp=ip(Lc.then,Lc),Cr=function(){tp(Eo)}):Mc?Cr=function(){op.nextTick(Eo)}:(kc=ip(kc,tr),Cr=function(){kc(Eo)}):(Dc=!0,Pc=rp.createTextNode(""),new np(Eo).observe(Pc,{characterData:!0}),Cr=function(){Pc.data=Dc=!Dc}));var hA=ap||function(t){var e={fn:t,next:void 0};_o&&(_o.next=e),$n||($n=e,Cr()),_o=e},yr={},cp=un,pA=function(t){var e,i;this.promise=new t(function(n,r){if(e!==void 0||i!==void 0)throw TypeError("Bad Promise constructor");e=n,i=r}),this.resolve=cp(e),this.reject=cp(i)};yr.f=function(t){return new pA(t)};var EA=Wi,_A=Ni,mA=yr,dp=function(t,e){if(EA(t),_A(e)&&e.constructor===t)return e;var i=mA.f(t);return(0,i.resolve)(e),i.promise},fA=Et,Is=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},up=function(){this.head=null,this.tail=null};up.prototype={add:function(t){var e={item:t,next:null};this.head?this.tail.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return this.head=t.next,this.tail===t&&(this.tail=null),t.item}};var Uc,lp,xc,SA=typeof window=="object",vs=Fe,ln=Et,gA=zi,wn=Bi,Vc=Mh,TA=function(t,e,i){for(var n in e)i&&i.unsafe&&t[n]?t[n]=e[n]:wy(t,n,e[n],i);return t},RA=uo,IA=function(t){var e=Ny(t),i=Dy.f;Py&&e&&!e[Uh]&&i(e,Uh,{configurable:!0,get:function(){return this}})},Fc=un,Cs=Pe,vA=Ni,CA=function(t,e){if(Ly(e,t))return t;throw ky("Incorrect invocation")},yA=hc,hp=ls,AA=function(t,e){if(!e&&!Vh)return!1;var i=!1;try{var n={};n[xh]=function(){return{next:function(){return{done:i=!0}}}},t(n)}catch{}return i},OA=Yh,pp=ep.set,jc=hA,bA=dp,wA=function(t,e){var i=fA.console;i&&i.error&&(arguments.length==1?i.error(t):i.error(t,e))},Ep=yr,Bc=Is,NA=up,Gc=fs,DA=kl,PA=SA,ys=es,_p=fr,LA=fe("species"),Qi="Promise",mp=Gc.getterFor(Qi),kA=Gc.set,MA=Gc.getterFor(Qi),UA=Vc&&Vc.prototype,Zi=Vc,As=UA,fp=ln.TypeError,Wc=ln.document,Hc=ln.process,Ar=Ep.f,xA=Ar,VA=!!(Wc&&Wc.createEvent&&ln.dispatchEvent),Sp=Cs(ln.PromiseRejectionEvent),gp="unhandledrejection",Os=DA(Qi,function(){var t=yA(Zi),e=t!==String(Zi);if(!e&&_p===66||!As.finally)return!0;if(_p>=51&&/native code/.test(t))return!1;var i=new Zi(function(r){r(1)}),n=function(r){r(function(){},function(){})};return(i.constructor={})[LA]=n,!(i.then(function(){})instanceof n)||!e&&PA&&!Sp}),FA=Os||!AA(function(t){Zi.all(t).catch(function(){})}),Tp=function(t){var e;return!(!vA(t)||!Cs(e=t.then))&&e},Rp=function(t,e){var i,n,r,o=e.value,s=e.state==1,a=s?t.ok:t.fail,c=t.resolve,d=t.reject,u=t.domain;try{a?(s||(e.rejection===2&&BA(e),e.rejection=1),a===!0?i=o:(u&&u.enter(),i=a(o),u&&(u.exit(),r=!0)),i===t.promise?d(fp("Promise-chain cycle")):(n=Tp(i))?wn(n,i,c,d):c(i)):d(o)}catch(l){u&&!r&&u.exit(),d(l)}},Ip=function(t,e){t.notified||(t.notified=!0,jc(function(){for(var i,n=t.reactions;i=n.get();)Rp(i,t);t.notified=!1,e&&!t.rejection&&jA(t)}))},vp=function(t,e,i){var n,r;VA?((n=Wc.createEvent("Event")).promise=e,n.reason=i,n.initEvent(t,!1,!0),ln.dispatchEvent(n)):n={promise:e,reason:i},!Sp&&(r=ln["on"+t])?r(n):t===gp&&wA("Unhandled promise rejection",i)},jA=function(t){wn(pp,ln,function(){var e,i=t.facade,n=t.value;if(Cp(t)&&(e=Bc(function(){ys?Hc.emit("unhandledRejection",n,i):vp(gp,i,n)}),t.rejection=ys||Cp(t)?2:1,e.error))throw e.value})},Cp=function(t){return t.rejection!==1&&!t.parent},BA=function(t){wn(pp,ln,function(){var e=t.facade;ys?Hc.emit("rejectionHandled",e):vp("rejectionhandled",e,t.value)})},Or=function(t,e,i){return function(n){t(e,n,i)}},br=function(t,e,i){t.done||(t.done=!0,i&&(t=i),t.value=e,t.state=2,Ip(t,!0))},Kc=function(t,e,i){if(!t.done){t.done=!0,i&&(t=i);try{if(t.facade===e)throw fp("Promise can't be resolved itself");var n=Tp(e);n?jc(function(){var r={done:!1};try{wn(n,e,Or(Kc,r,t),Or(br,r,t))}catch(o){br(r,o,t)}}):(t.value=e,t.state=1,Ip(t,!1))}catch(r){br({done:!1},r,t)}}};Os&&(As=(Zi=function(t){CA(this,As),Fc(t),wn(Uc,this);var e=mp(this);try{t(Or(Kc,e),Or(br,e))}catch(i){br(e,i)}}).prototype,(Uc=function(t){kA(this,{type:Qi,done:!1,notified:!1,parent:!1,reactions:new NA,rejection:!1,state:0,value:void 0})}).prototype=TA(As,{then:function(t,e){var i=MA(this),n=Ar(OA(this,Zi));return i.parent=!0,n.ok=!Cs(t)||t,n.fail=Cs(e)&&e,n.domain=ys?Hc.domain:void 0,i.state==0?i.reactions.add(n):jc(function(){Rp(n,i)}),n.promise},catch:function(t){return this.then(void 0,t)}}),lp=function(){var t=new Uc,e=mp(t);this.promise=t,this.resolve=Or(Kc,e),this.reject=Or(br,e)},Ep.f=Ar=function(t){return t===Zi||t===xc?new lp(t):xA(t)}),vs({global:!0,wrap:!0,forced:Os},{Promise:Zi}),RA(Zi,Qi,!1,!0),IA(Qi),xc=gA(Qi),vs({target:Qi,stat:!0,forced:Os},{reject:function(t){var e=Ar(this);return wn(e.reject,void 0,t),e.promise}}),vs({target:Qi,stat:!0,forced:!0},{resolve:function(t){return bA(this===xc?Zi:this,t)}}),vs({target:Qi,stat:!0,forced:FA},{all:function(t){var e=this,i=Ar(e),n=i.resolve,r=i.reject,o=Bc(function(){var s=Fc(e.resolve),a=[],c=0,d=1;hp(t,function(u){var l=c++,E=!1;d++,wn(s,e,u).then(function(m){E||(E=!0,a[l]=m,--d||n(a))},r)}),--d||n(a)});return o.error&&r(o.value),i.promise},race:function(t){var e=this,i=Ar(e),n=i.reject,r=Bc(function(){var o=Fc(e.resolve);hp(t,function(s){wn(o,e,s).then(i.resolve,n)})});return r.error&&n(r.value),i.promise}});var GA=Bi,WA=un,HA=yr,KA=Is,YA=ls;Fe({target:"Promise",stat:!0},{allSettled:function(t){var e=this,i=HA.f(e),n=i.resolve,r=i.reject,o=KA(function(){var s=WA(e.resolve),a=[],c=0,d=1;YA(t,function(u){var l=c++,E=!1;d++,GA(s,e,u).then(function(m){E||(E=!0,a[l]={status:"fulfilled",value:m},--d||n(a))},function(m){E||(E=!0,a[l]={status:"rejected",reason:m},--d||n(a))})}),--d||n(a)});return o.error&&r(o.value),i.promise}});var qA=un,JA=zi,XA=Bi,zA=yr,QA=Is,ZA=ls,yp="No one promise resolved";Fe({target:"Promise",stat:!0},{any:function(t){var e=this,i=JA("AggregateError"),n=zA.f(e),r=n.resolve,o=n.reject,s=QA(function(){var a=qA(e.resolve),c=[],d=0,u=1,l=!1;ZA(t,function(E){var m=d++,T=!1;u++,XA(a,e,E).then(function(g){T||l||(l=!0,r(g))},function(g){T||l||(T=!0,c[m]=g,--u||o(new i(c,yp)))})}),--u||o(new i(c,yp))});return s.error&&o(s.value),n.promise}});var Ap=Mh,$A=zi,tO=Pe,eO=Yh,Op=dp;Fe({target:"Promise",proto:!0,real:!0,forced:!!Ap&&Tt(function(){Ap.prototype.finally.call({then:function(){}},function(){})})},{finally:function(t){var e=eO(this,$A("Promise")),i=tO(t);return this.then(i?function(n){return Op(e,t()).then(function(){return n})}:t,i?function(n){return Op(e,t()).then(function(){throw n})}:t)}});var Yc=ue,iO=Xa,nO=Rr,rO=Xo,oO=Yc("".charAt),bp=Yc("".charCodeAt),sO=Yc("".slice),wp=function(t){return function(e,i){var n,r,o=nO(rO(e)),s=iO(i),a=o.length;return s<0||s>=a?t?"":void 0:(n=bp(o,s))<55296||n>56319||s+1===a||(r=bp(o,s+1))<56320||r>57343?t?oO(o,s):n:t?sO(o,s,s+2):r-56320+(n-55296<<10)+65536}},aO={codeAt:wp(!1),charAt:wp(!0)}.charAt,cO=Rr,Np=fs,dO=Dh,Dp="String Iterator",uO=Np.set,lO=Np.getterFor(Dp);dO(String,"String",function(t){uO(this,{type:Dp,string:cO(t),index:0})},function(){var t,e=lO(this),i=e.string,n=e.index;return n>=i.length?{value:void 0,done:!0}:(t=aO(i,n),e.index+=t.length,{value:t,done:!1})});var hO=vn.Promise,pO={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},EO=Et,_O=bn,mO=Xn,Pp=Tr,Lp=fe("toStringTag");for(var qc in pO){var kp=EO[qc],Jc=kp&&kp.prototype;Jc&&_O(Jc)!==Lp&&mO(Jc,Lp,qc),Pp[qc]=Pp.Array}var Mp=hO,V=Mp;const Up=Hl;function xp(t,e){const i=t&&t.navigator;if(!i.mediaDevices)return;const n=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;const a={};return Object.keys(s).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;const d=typeof s[c]=="object"?s[c]:{ideal:s[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const u=function(l,E){return l?l+E.charAt(0).toUpperCase()+E.slice(1):E==="deviceId"?"sourceId":E};if(d.ideal!==void 0){a.optional=a.optional||[];let l={};typeof d.ideal=="number"?(l[u("min",c)]=d.ideal,a.optional.push(l),l={},l[u("max",c)]=d.ideal,a.optional.push(l)):(l[u("",c)]=d.ideal,a.optional.push(l))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[u("",c)]=d.exact):["min","max"].forEach(l=>{d[l]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[u(l,c)]=d[l])})}),s.advanced&&(a.optional=(a.optional||[]).concat(s.advanced)),a},r=function(s,a){if(e.version>=61)return a(s);if((s=JSON.parse(JSON.stringify(s)))&&typeof s.audio=="object"){const c=function(d,u,l){u in d&&!(l in d)&&(d[l]=d[u],delete d[u])};c((s=JSON.parse(JSON.stringify(s))).audio,"autoGainControl","googAutoGainControl"),c(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=n(s.audio)}if(s&&typeof s.video=="object"){let c=s.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});const d=e.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||d)){let u;if(delete s.video.facingMode,c.exact==="environment"||c.ideal==="environment"?u=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(u=["front"]),u)return i.mediaDevices.enumerateDevices().then(l=>{let E=(l=l.filter(m=>m.kind==="videoinput")).find(m=>u.some(T=>m.label.toLowerCase().includes(T)));return!E&&l.length&&u.includes("back")&&(E=l[l.length-1]),E&&(s.video.deviceId=c.exact?{exact:E.deviceId}:{ideal:E.deviceId}),s.video=n(s.video),Up("chrome: "+JSON.stringify(s)),a(s)})}s.video=n(s.video)}return Up("chrome: "+JSON.stringify(s)),a(s)},o=function(s){return e.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(s,a,c){r(s,d=>{i.webkitGetUserMedia(d,a,u=>{c&&c(o(u))})})}.bind(i),i.mediaDevices.getUserMedia){const s=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(a){return r(a,c=>s(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(u=>{u.stop()}),new DOMException("","NotFoundError");return d},d=>V.reject(o(d))))}}}function Vp(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function Fp(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(i){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=i)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",n=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===n.track.id):{track:n.track};const o=new Event("track");o.track=n.track,o.receiver=r,o.transceiver={receiver:r},o.streams=[i.stream],this.dispatchEvent(o)}),i.stream.getTracks().forEach(n=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===n.id):{track:n};const o=new Event("track");o.track=n,o.receiver=r,o.transceiver={receiver:r},o.streams=[i.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else zn(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function jp(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(r,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=r.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:r}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,a){let c=r.apply(this,arguments);return c||(c=e(this,s),this._senders.push(c)),c};const o=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){o.apply(this,arguments);const a=this._senders.indexOf(s);a!==-1&&this._senders.splice(a,1)}}const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach(o=>{const s=this._senders.find(a=>a.track===o);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(n=>n._pc=this),i},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Bp(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[i,n,r]=arguments;if(arguments.length>0&&typeof i=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof i!="function"))return e.apply(this,[]);const o=function(a){const c={};return a.result().forEach(d=>{const u={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(l=>{u[l]=d.stat(l)}),c[u.id]=u}),c},s=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){const a=function(c){n(s(o(c)))};return e.apply(this,[a,i])}return new V((a,c)=>{e.apply(this,[function(d){a(s(o(d)))},c])}).then(n,r)}}function Gp(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const i=t.RTCPeerConnection.prototype.getSenders;i&&(t.RTCPeerConnection.prototype.getSenders=function(){const r=i.apply(this,[]);return r.forEach(o=>o._pc=this),r});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const r=n.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){const r=this;return this._pc.getStats().then(o=>ql(o,r.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const i=t.RTCPeerConnection.prototype.getReceivers;i&&(t.RTCPeerConnection.prototype.getReceivers=function(){const n=i.apply(this,[]);return n.forEach(r=>r._pc=this),n}),zn(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(r=>ql(r,n.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const i=arguments[0];let n,r,o;return this.getSenders().forEach(s=>{s.track===i&&(n?o=!0:n=s)}),this.getReceivers().forEach(s=>(s.track===i&&(r?o=!0:r=s),s.track===i)),o||n&&r?V.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():r?r.getStats():V.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Wp(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,s){if(!s)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=e.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(a)===-1&&this._shimmedLocalStreams[s.id].push(a):this._shimmedLocalStreams[s.id]=[s,a],a};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(c=>{if(this.getSenders().find(d=>d.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});const s=this.getSenders();i.apply(this,arguments);const a=this.getSenders().filter(c=>s.indexOf(c)===-1);this._shimmedLocalStreams[o.id]=[o].concat(a)};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],n.apply(this,arguments)};const r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(s=>{const a=this._shimmedLocalStreams[s].indexOf(o);a!==-1&&this._shimmedLocalStreams[s].splice(a,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s]}),r.apply(this,arguments)}}function Hp(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return Wp(t);const i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const d=i.apply(this);return this._reverseStreams=this._reverseStreams||{},d.map(u=>this._reverseStreams[u.id])};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(d){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},d.getTracks().forEach(u=>{if(this.getSenders().find(l=>l.track===u))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[d.id]){const u=new t.MediaStream(d.getTracks());this._streams[d.id]=u,this._reverseStreams[u.id]=d,d=u}n.apply(this,[d])};const r=t.RTCPeerConnection.prototype.removeStream;function o(d,u){let l=u.sdp;return Object.keys(d._reverseStreams||[]).forEach(E=>{const m=d._reverseStreams[E],T=d._streams[m.id];l=l.replace(new RegExp(T.id,"g"),m.id)}),new RTCSessionDescription({type:u.type,sdp:l})}function s(d,u){let l=u.sdp;return Object.keys(d._reverseStreams||[]).forEach(E=>{const m=d._reverseStreams[E],T=d._streams[m.id];l=l.replace(new RegExp(m.id,"g"),T.id)}),new RTCSessionDescription({type:u.type,sdp:l})}t.RTCPeerConnection.prototype.removeStream=function(d){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[d.id]||d]),delete this._reverseStreams[this._streams[d.id]?this._streams[d.id].id:d.id],delete this._streams[d.id]},t.RTCPeerConnection.prototype.addTrack=function(d,u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find(T=>T===d))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(T=>T.track===d))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const m=this._streams[u.id];if(m)m.addTrack(d),V.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const T=new t.MediaStream([d]);this._streams[u.id]=T,this._reverseStreams[T.id]=u,this.addStream(T)}return this.getSenders().find(T=>T.track===d)},["createOffer","createAnswer"].forEach(function(d){const u=t.RTCPeerConnection.prototype[d],l={[d](){const E=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[m=>{const T=o(this,m);E[0].apply(null,[T])},m=>{E[1]&&E[1].apply(null,m)},arguments[2]]):u.apply(this,arguments).then(m=>o(this,m))}};t.RTCPeerConnection.prototype[d]=l[d]});const a=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=s(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const d=c.get.apply(this);return d.type===""?d:o(this,d)}}),t.RTCPeerConnection.prototype.removeTrack=function(d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!d._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(d._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let u;this._streams=this._streams||{},Object.keys(this._streams).forEach(l=>{this._streams[l].getTracks().find(E=>d.track===E)&&(u=this._streams[l])}),u&&(u.getTracks().length===1?this.removeStream(this._reverseStreams[u.id]):u.removeTrack(d.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Xc(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const n=t.RTCPeerConnection.prototype[i],r={[i](){return arguments[0]=new(i==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};t.RTCPeerConnection.prototype[i]=r[i]})}function Kp(t,e){zn(t,"negotiationneeded",i=>{const n=i.target;if(!(e.version<72||n.getConfiguration&&n.getConfiguration().sdpSemantics==="plan-b")||n.signalingState==="stable")return i})}var Yp=Object.freeze({__proto__:null,shimMediaStream:Vp,shimOnTrack:Fp,shimGetSendersWithDtmf:jp,shimGetStats:Bp,shimSenderReceiverGetStats:Gp,shimAddTrackRemoveTrackWithNative:Wp,shimAddTrackRemoveTrack:Hp,shimPeerConnection:Xc,fixNegotiationNeeded:Kp,shimGetUserMedia:xp,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof e=="function"?t.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then(n=>{const r=i.video&&i.video.width,o=i.video&&i.video.height,s=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:s||3}},r&&(i.video.mandatory.maxWidth=r),o&&(i.video.mandatory.maxHeight=o),t.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});function qp(t,e){const i=t&&t.navigator,n=t&&t.MediaStreamTrack;if(i.getUserMedia=function(r,o,s){Za("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(r).then(o,s)},!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const r=function(s,a,c){a in s&&!(c in s)&&(s[c]=s[a],delete s[a])},o=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s.audio,"autoGainControl","mozAutoGainControl"),r(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},n&&n.prototype.getSettings){const s=n.prototype.getSettings;n.prototype.getSettings=function(){const a=s.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(n&&n.prototype.applyConstraints){const s=n.prototype.applyConstraints;n.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[a])}}}}function Jp(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function zc(t,e){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const o=t.RTCPeerConnection.prototype[r],s={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=s[r]});const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[r,o,s]=arguments;return n.apply(this,[r||null]).then(a=>{if(e.version<53&&!o)try{a.forEach(c=>{c.type=i[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,u)=>{a.set(u,Object.assign({},d,{type:i[d.type]||d.type}))})}return a}).then(o,s)}}function Xp(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const n=i.apply(this,arguments);return n._pc=this,n}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):V.resolve(new Map)}}function zp(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(n=>n._pc=this),i}),zn(t,"track",i=>(i.receiver._pc=i.srcElement,i)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Qp(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){Za("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&e.getTracks().includes(i.track)&&this.removeTrack(i)})})}function Zp(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function $p(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const n=i.length>0;n&&i.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const r=e.apply(this,arguments);if(n){const{sender:o}=r,s=o.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=i,o.sendEncodings=i,this.setParametersPromises.push(o.setParameters(s).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return r})}function tE(t){if(typeof t!="object"||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function eE(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?V.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function iE(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?V.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var nE=Object.freeze({__proto__:null,shimOnTrack:Jp,shimPeerConnection:zc,shimSenderGetStats:Xp,shimReceiverGetStats:zp,shimRemoveStream:Qp,shimRTCDataChannel:Zp,shimAddTransceiver:$p,shimGetParameters:tE,shimCreateOffer:eE,shimCreateAnswer:iE,shimGetUserMedia:qp,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,V.reject(n)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(i)})}});function rE(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(n=>e.call(this,n,i)),i.getVideoTracks().forEach(n=>e.call(this,n,i))},t.RTCPeerConnection.prototype.addTrack=function(i){for(var n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return r&&r.forEach(s=>{this._localStreams?this._localStreams.includes(s)||this._localStreams.push(s):this._localStreams=[s]}),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(e);if(i===-1)return;this._localStreams.splice(i,1);const n=e.getTracks();this.getSenders().forEach(r=>{n.includes(r.track)&&this.removeTrack(r)})})}}function oE(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(i){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=i),this.addEventListener("track",this._onaddstreampoly=n=>{n.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,this.dispatchEvent(o)})})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(r=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(r)>=0)return;i._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,i.dispatchEvent(o)})}),e.apply(i,arguments)}}}function sE(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,i=e.createOffer,n=e.createAnswer,r=e.setLocalDescription,o=e.setRemoteDescription,s=e.addIceCandidate;e.createOffer=function(c,d){const u=arguments.length>=2?arguments[2]:arguments[0],l=i.apply(this,[u]);return d?(l.then(c,d),V.resolve()):l},e.createAnswer=function(c,d){const u=arguments.length>=2?arguments[2]:arguments[0],l=n.apply(this,[u]);return d?(l.then(c,d),V.resolve()):l};let a=function(c,d,u){const l=r.apply(this,[c]);return u?(l.then(d,u),V.resolve()):l};e.setLocalDescription=a,a=function(c,d,u){const l=o.apply(this,[c]);return u?(l.then(d,u),V.resolve()):l},e.setRemoteDescription=a,a=function(c,d,u){const l=s.apply(this,[c]);return u?(l.then(d,u),V.resolve()):l},e.addIceCandidate=a}function aE(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const i=e.mediaDevices,n=i.getUserMedia.bind(i);e.mediaDevices.getUserMedia=r=>n(cE(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(i,n,r){e.mediaDevices.getUserMedia(i).then(n,r)}.bind(e))}function cE(t){return t&&t.video!==void 0?Object.assign({},t,{video:Yl(t.video)}):t}function dE(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(i,n){if(i&&i.iceServers){const r=[];for(let o=0;o<i.iceServers.length;o++){let s=i.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(Za("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,r.push(s)):r.push(i.iceServers[o])}i.iceServers=r}return new e(i,n)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function uE(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function lE(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(i){if(i){i.offerToReceiveAudio!==void 0&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const n=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):i.offerToReceiveAudio!==!0||n||this.addTransceiver("audio",{direction:"recvonly"}),i.offerToReceiveVideo!==void 0&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function hE(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var pE=Object.freeze({__proto__:null,shimLocalStreamsAPI:rE,shimRemoteStreamsAPI:oE,shimCallbacksAPI:sE,shimGetUserMedia:aE,shimConstraints:cE,shimRTCIceServerUrls:dE,shimTrackEventTransceiver:uE,shimCreateOfferLegacy:lE,shimAudioContext:hE}),fO=`	
\v\f\r Â áââââââââââââ¯âã\u2028\u2029\uFEFF`,SO=Xo,gO=Rr,EE=ue("".replace),bs=`[	
\v\f\r Â áââââââââââââ¯âã\u2028\u2029\uFEFF]`,TO=RegExp("^"+bs+bs+"*"),RO=RegExp(bs+bs+"*$"),Qc=function(t){return function(e){var i=gO(SO(e));return 1&t&&(i=EE(i,TO,"")),2&t&&(i=EE(i,RO,"")),i}},IO={start:Qc(1),end:Qc(2),trim:Qc(3)},vO=Ih.PROPER,CO=Tt,_E=fO,yO=IO.trim;Fe({target:"String",proto:!0,forced:function(t){return CO(function(){return!!_E[t]()||"âÂá "[t]()!=="âÂá "||vO&&_E[t].name!==t})}("trim")},{trim:function(){return yO(this)}});var AO=An("String").trim,OO=_i,bO=AO,Zc=String.prototype,hn=function(t){var e=t.trim;return typeof t=="string"||t===Zc||OO(Zc,t)&&e===Zc.trim?bO:e},$c={exports:{}};(function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};e.localCName=e.generateIdentifier(),e.splitLines=function(i){return hn(i).call(i).split(`
`).map(n=>hn(n).call(n))},e.splitSections=function(i){return i.split(`
m=`).map((n,r)=>{var o;return hn(o=r>0?"m="+n:n).call(o)+`\r
`})},e.getDescription=function(i){const n=e.splitSections(i);return n&&n[0]},e.getMediaSections=function(i){const n=e.splitSections(i);return n.shift(),n},e.matchPrefix=function(i,n){return e.splitLines(i).filter(r=>r.indexOf(n)===0)},e.parseCandidate=function(i){let n;n=i.indexOf("a=candidate:")===0?i.substring(12).split(" "):i.substring(10).split(" ");const r={foundation:n[0],component:{1:"rtp",2:"rtcp"}[n[1]]||n[1],protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]};for(let o=8;o<n.length;o+=2)switch(n[o]){case"raddr":r.relatedAddress=n[o+1];break;case"rport":r.relatedPort=parseInt(n[o+1],10);break;case"tcptype":r.tcpType=n[o+1];break;case"ufrag":r.ufrag=n[o+1],r.usernameFragment=n[o+1];break;default:r[n[o]]===void 0&&(r[n[o]]=n[o+1])}return r},e.writeCandidate=function(i){const n=[];n.push(i.foundation);const r=i.component;r==="rtp"?n.push(1):r==="rtcp"?n.push(2):n.push(r),n.push(i.protocol.toUpperCase()),n.push(i.priority),n.push(i.address||i.ip),n.push(i.port);const o=i.type;return n.push("typ"),n.push(o),o!=="host"&&i.relatedAddress&&i.relatedPort&&(n.push("raddr"),n.push(i.relatedAddress),n.push("rport"),n.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(n.push("tcptype"),n.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(n.push("ufrag"),n.push(i.usernameFragment||i.ufrag)),"candidate:"+n.join(" ")},e.parseIceOptions=function(i){return i.substr(14).split(" ")},e.parseRtpMap=function(i){let n=i.substr(9).split(" ");const r={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),r.name=n[0],r.clockRate=parseInt(n[1],10),r.channels=n.length===3?parseInt(n[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(i){let n=i.payloadType;i.preferredPayloadType!==void 0&&(n=i.preferredPayloadType);const r=i.channels||i.numChannels||1;return"a=rtpmap:"+n+" "+i.name+"/"+i.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(i){const n=i.substr(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1]}},e.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+`\r
`},e.parseFmtp=function(i){const n={};let r;const o=i.substr(i.indexOf(" ")+1).split(";");for(let c=0;c<o.length;c++){var s,a;r=hn(s=o[c]).call(s).split("="),n[hn(a=r[0]).call(a)]=r[1]}return n},e.writeFmtp=function(i){let n="",r=i.payloadType;if(i.preferredPayloadType!==void 0&&(r=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){const o=[];Object.keys(i.parameters).forEach(s=>{i.parameters[s]!==void 0?o.push(s+"="+i.parameters[s]):o.push(s)}),n+="a=fmtp:"+r+" "+o.join(";")+`\r
`}return n},e.parseRtcpFb=function(i){const n=i.substr(i.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},e.writeRtcpFb=function(i){let n="",r=i.payloadType;return i.preferredPayloadType!==void 0&&(r=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(o=>{n+="a=rtcp-fb:"+r+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),n},e.parseSsrcMedia=function(i){const n=i.indexOf(" "),r={ssrc:parseInt(i.substr(7,n-7),10)},o=i.indexOf(":",n);return o>-1?(r.attribute=i.substr(n+1,o-n-1),r.value=i.substr(o+1)):r.attribute=i.substr(n+1),r},e.parseSsrcGroup=function(i){const n=i.substr(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(r=>parseInt(r,10))}},e.getMid=function(i){const n=e.matchPrefix(i,"a=mid:")[0];if(n)return n.substr(6)},e.parseFingerprint=function(i){const n=i.substr(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1].toUpperCase()}},e.getDtlsParameters=function(i,n){return{role:"auto",fingerprints:e.matchPrefix(i+n,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(i,n){let r="a=setup:"+n+`\r
`;return i.fingerprints.forEach(o=>{r+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),r},e.parseCryptoLine=function(i){const n=i.substr(9).split(" ");return{tag:parseInt(n[0],10),cryptoSuite:n[1],keyParams:n[2],sessionParams:n.slice(3)}},e.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?e.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;const n=i.substr(7).split("|");return{keyMethod:"inline",keySalt:n[0],lifeTime:n[1],mkiValue:n[2]?n[2].split(":")[0]:void 0,mkiLength:n[2]?n[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")},e.getCryptoParameters=function(i,n){return e.matchPrefix(i+n,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(i,n){const r=e.matchPrefix(i+n,"a=ice-ufrag:")[0],o=e.matchPrefix(i+n,"a=ice-pwd:")[0];return r&&o?{usernameFragment:r.substr(12),password:o.substr(10)}:null},e.writeIceParameters=function(i){let n="a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`;return i.iceLite&&(n+=`a=ice-lite\r
`),n},e.parseRtpParameters=function(i){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=e.splitLines(i)[0].split(" ");for(let o=3;o<r.length;o++){const s=r[o],a=e.matchPrefix(i,"a=rtpmap:"+s+" ")[0];if(a){const c=e.parseRtpMap(a),d=e.matchPrefix(i,"a=fmtp:"+s+" ");switch(c.parameters=d.length?e.parseFmtp(d[0]):{},c.rtcpFeedback=e.matchPrefix(i,"a=rtcp-fb:"+s+" ").map(e.parseRtcpFb),n.codecs.push(c),c.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(c.name.toUpperCase())}}}return e.matchPrefix(i,"a=extmap:").forEach(o=>{n.headerExtensions.push(e.parseExtmap(o))}),n},e.writeRtpDescription=function(i,n){let r="";r+="m="+i+" ",r+=n.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=n.codecs.map(s=>s.preferredPayloadType!==void 0?s.preferredPayloadType:s.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,n.codecs.forEach(s=>{r+=e.writeRtpMap(s),r+=e.writeFmtp(s),r+=e.writeRtcpFb(s)});let o=0;return n.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime)}),o>0&&(r+="a=maxptime:"+o+`\r
`),n.headerExtensions&&n.headerExtensions.forEach(s=>{r+=e.writeExtmap(s)}),r},e.parseRtpEncodingParameters=function(i){const n=[],r=e.parseRtpParameters(i),o=r.fecMechanisms.indexOf("RED")!==-1,s=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(i,"a=ssrc:").map(E=>e.parseSsrcMedia(E)).filter(E=>E.attribute==="cname"),c=a.length>0&&a[0].ssrc;let d;const u=e.matchPrefix(i,"a=ssrc-group:FID").map(E=>E.substr(17).split(" ").map(m=>parseInt(m,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(d=u[0][1]),r.codecs.forEach(E=>{if(E.name.toUpperCase()==="RTX"&&E.parameters.apt){let m={ssrc:c,codecPayloadType:parseInt(E.parameters.apt,10)};c&&d&&(m.rtx={ssrc:d}),n.push(m),o&&(m=JSON.parse(JSON.stringify(m)),m.fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},n.push(m))}}),n.length===0&&c&&n.push({ssrc:c});let l=e.matchPrefix(i,"b=");return l.length&&(l=l[0].indexOf("b=TIAS:")===0?parseInt(l[0].substr(7),10):l[0].indexOf("b=AS:")===0?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,n.forEach(E=>{E.maxBitrate=l})),n},e.parseRtcpParameters=function(i){const n={},r=e.matchPrefix(i,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);const o=e.matchPrefix(i,"a=rtcp-rsize");n.reducedSize=o.length>0,n.compound=o.length===0;const s=e.matchPrefix(i,"a=rtcp-mux");return n.mux=s.length>0,n},e.writeRtcpParameters=function(i){let n="";return i.reducedSize&&(n+=`a=rtcp-rsize\r
`),i.mux&&(n+=`a=rtcp-mux\r
`),i.ssrc!==void 0&&i.cname&&(n+="a=ssrc:"+i.ssrc+" cname:"+i.cname+`\r
`),n},e.parseMsid=function(i){let n;const r=e.matchPrefix(i,"a=msid:");if(r.length===1)return n=r[0].substr(7).split(" "),{stream:n[0],track:n[1]};const o=e.matchPrefix(i,"a=ssrc:").map(s=>e.parseSsrcMedia(s)).filter(s=>s.attribute==="msid");return o.length>0?(n=o[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},e.parseSctpDescription=function(i){const n=e.parseMLine(i),r=e.matchPrefix(i,"a=max-message-size:");let o;r.length>0&&(o=parseInt(r[0].substr(19),10)),isNaN(o)&&(o=65536);const s=e.matchPrefix(i,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substr(12),10),protocol:n.fmt,maxMessageSize:o};const a=e.matchPrefix(i,"a=sctpmap:");if(a.length>0){const c=a[0].substr(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},e.writeSctpDescription=function(i,n){let r=[];return r=i.protocol!=="DTLS/SCTP"?["m="+i.kind+" 9 "+i.protocol+" "+n.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+n.port+`\r
`]:["m="+i.kind+" 9 "+i.protocol+" "+n.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+n.port+" "+n.protocol+` 65535\r
`],n.maxMessageSize!==void 0&&r.push("a=max-message-size:"+n.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,21)},e.writeSessionBoilerplate=function(i,n,r){let o;const s=n!==void 0?n:2;return o=i||e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+o+" "+s+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(i,n){const r=e.splitLines(i);for(let o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substr(2)}return n?e.getDirection(n):"sendrecv"},e.getKind=function(i){return e.splitLines(i)[0].split(" ")[0].substr(2)},e.isRejected=function(i){return i.split(" ",2)[1]==="0"},e.parseMLine=function(i){const n=e.splitLines(i)[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},e.parseOLine=function(i){const n=e.matchPrefix(i,"o=")[0].substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},e.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;const n=e.splitLines(i);for(let r=0;r<n.length;r++)if(n[r].length<2||n[r].charAt(1)!=="=")return!1;return!0},t.exports=e})($c);var wr=$c.exports,wO=Object.freeze(ri({__proto__:null,default:wr},[$c.exports]));function ws(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&((i=JSON.parse(JSON.stringify(i))).candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){const n=new e(i),r=wr.parseCandidate(i.candidate),o=Object.assign(n,r);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(i)},t.RTCIceCandidate.prototype=e.prototype,zn(t,"icecandidate",i=>(i.candidate&&Object.defineProperty(i,"candidate",{value:new t.RTCIceCandidate(i.candidate),writable:"false"}),i))}function td(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||zn(t,"icecandidate",e=>{if(e.candidate){const i=wr.parseCandidate(e.candidate.candidate);i.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[i.priority>>24])}return e})}function Ns(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const i=function(a){if(!a||!a.sdp)return!1;const c=wr.splitSections(a.sdp);return c.shift(),c.some(d=>{const u=wr.parseMLine(d);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},n=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return e.browser==="firefox"&&(c=e.version<57?a===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),c},o=function(a,c){let d=65536;e.browser==="firefox"&&e.version===57&&(d=65535);const u=wr.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?d=parseInt(u[0].substr(19),10):e.browser==="firefox"&&c!==-1&&(d=2147483637),d},s=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const a=n(arguments[0]),c=r(a),d=o(arguments[0],a);let u;u=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);const l={};Object.defineProperty(l,"maxMessageSize",{get:()=>u}),this._sctp=l}return s.apply(this,arguments)}}function Ds(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(n,r){const o=n.send;n.send=function(){const s=arguments[0],a=s.length||s.size||s.byteLength;if(n.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return o.apply(n,arguments)}}const i=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const n=i.apply(this,arguments);return e(n,this),n},zn(t,"datachannel",n=>(e(n.channel,n.target),n))}function ed(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(i){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),i&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=i)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(i=>{const n=e[i];e[i]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const o=r.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const s=new Event("connectionstatechange",r);o.dispatchEvent(s)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function id(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const r=n.sdp.split(`
`).filter(o=>hn(o).call(o)!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&n instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:n.type,sdp:r}):n.sdp=r}return i.apply(this,arguments)}}function Ps(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.addIceCandidate;i&&i.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?V.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),V.resolve())})}function Ls(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.setLocalDescription;i&&i.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let n=arguments[0]||{};if(typeof n!="object"||n.type&&n.sdp)return i.apply(this,arguments);if(n={type:n.type,sdp:n.sdp},!n.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":n.type="offer";break;default:n.type="answer"}return n.sdp||n.type!=="offer"&&n.type!=="answer"?i.apply(this,[n]):(n.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(o=>i.apply(this,[o]))})}var NO=Object.freeze({__proto__:null,shimRTCIceCandidate:ws,shimRTCIceCandidateRelayProtocol:td,shimMaxMessageSize:Ns,shimSendThrowTypeError:Ds,shimConnectionState:ed,removeExtmapAllowMixed:id,shimAddIceCandidateNullOrEmpty:Ps,shimParameterlessSetLocalDescription:Ls});let be,St;(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=Hl,n=KI(t),r={browserDetails:n,commonShim:NO,extractVersion:is,disableLog:WI,disableWarnings:HI,sdp:wO};switch(n.browser){case"chrome":if(!Yp||!Xc||!e.shimChrome)return i("Chrome shim is not included in this adapter release."),r;if(n.version===null)return i("Chrome shim can not determine version, not shimming."),r;i("adapter.js shimming chrome."),r.browserShim=Yp,Ps(t,n),Ls(t),xp(t,n),Vp(t),Xc(t,n),Fp(t),Hp(t,n),jp(t),Bp(t),Gp(t),Kp(t,n),ws(t),td(t),ed(t),Ns(t,n),Ds(t),id(t,n);break;case"firefox":if(!nE||!zc||!e.shimFirefox)return i("Firefox shim is not included in this adapter release."),r;i("adapter.js shimming firefox."),r.browserShim=nE,Ps(t,n),Ls(t),qp(t,n),zc(t,n),Jp(t),Qp(t),Xp(t),zp(t),Zp(t),$p(t),tE(t),eE(t),iE(t),ws(t),ed(t),Ns(t,n),Ds(t);break;case"safari":if(!pE||!e.shimSafari)return i("Safari shim is not included in this adapter release."),r;i("adapter.js shimming safari."),r.browserShim=pE,Ps(t,n),Ls(t),dE(t),lE(t),sE(t),rE(t),oE(t),uE(t),aE(t),hE(t),ws(t),td(t),Ns(t,n),Ds(t),id(t,n);break;default:i("Unsupported browser!")}})({window:typeof window>"u"?void 0:window}),function(t){t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot"}(be||(be={})),function(t){t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger"}(St||(St={}));var nd={exports:{}};(function(t,e){(function(i,n){var r="function",o="undefined",s="object",a="string",c="major",d="model",u="name",l="type",E="vendor",m="version",T="architecture",g="console",R="mobile",y="tablet",A="smarttv",P="wearable",H="embedded",k="Amazon",M="Apple",D="ASUS",j="BlackBerry",yt="Firefox",Q="Google",Dt="Huawei",At="LG",Yt="Microsoft",_e="Motorola",Kt="Opera",$e="Samsung",O="Sharp",N="Sony",x="Xiaomi",X="Zebra",ut="Facebook",L="Chromium OS",p="Mac OS",S=function(Ft){for(var Zt={},Ot=0;Ot<Ft.length;Ot++)Zt[Ft[Ot].toUpperCase()]=Ft[Ot];return Zt},v=function(Ft,Zt){return typeof Ft===a&&b(Zt).indexOf(b(Ft))!==-1},b=function(Ft){return Ft.toLowerCase()},z=function(Ft,Zt){if(typeof Ft===a)return Ft=Ft.replace(/^\s\s*/,""),typeof Zt===o?Ft:Ft.substring(0,350)},wt=function(Ft,Zt){for(var Ot,Ke,dn,jt,dt,ti,Kn=0;Kn<Zt.length&&!dt;){var Ji=Zt[Kn],FT=Zt[Kn+1];for(Ot=Ke=0;Ot<Ji.length&&!dt&&Ji[Ot];)if(dt=Ji[Ot++].exec(Ft))for(dn=0;dn<FT.length;dn++)ti=dt[++Ke],typeof(jt=FT[dn])===s&&jt.length>0?jt.length===2?typeof jt[1]==r?this[jt[0]]=jt[1].call(this,ti):this[jt[0]]=jt[1]:jt.length===3?typeof jt[1]!==r||jt[1].exec&&jt[1].test?this[jt[0]]=ti?ti.replace(jt[1],jt[2]):n:this[jt[0]]=ti?jt[1].call(this,ti,jt[2]):n:jt.length===4&&(this[jt[0]]=ti?jt[3].call(this,ti.replace(jt[1],jt[2])):n):this[jt]=ti||n;Kn+=2}},me=function(Ft,Zt){for(var Ot in Zt)if(typeof Zt[Ot]===s&&Zt[Ot].length>0){for(var Ke=0;Ke<Zt[Ot].length;Ke++)if(v(Zt[Ot][Ke],Ft))return Ot==="?"?n:Ot}else if(v(Zt[Ot],Ft))return Ot==="?"?n:Ot;return Ft},ji={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Wn={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[m,[u,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[m,[u,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[u,m],[/opios[\/ ]+([\w\.]+)/i],[m,[u,"Opera Mini"]],[/\bopr\/([\w\.]+)/i],[m,[u,Kt]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[u,m],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[m,[u,"UCBrowser"]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[m,[u,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[m,[u,"WeChat"]],[/konqueror\/([\w\.]+)/i],[m,[u,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[m,[u,"IE"]],[/yabrowser\/([\w\.]+)/i],[m,[u,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[u,/(.+)/,"$1 Secure Browser"],m],[/\bfocus\/([\w\.]+)/i],[m,[u,"Firefox Focus"]],[/\bopt\/([\w\.]+)/i],[m,[u,"Opera Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[m,[u,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[m,[u,"Dolphin"]],[/coast\/([\w\.]+)/i],[m,[u,"Opera Coast"]],[/miuibrowser\/([\w\.]+)/i],[m,[u,"MIUI Browser"]],[/fxios\/([-\w\.]+)/i],[m,[u,yt]],[/\bqihu|(qi?ho?o?|360)browser/i],[[u,"360 Browser"]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[u,/(.+)/,"$1 Browser"],m],[/(comodo_dragon)\/([\w\.]+)/i],[[u,/_/g," "],m],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[u,m],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[u],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[u,ut],m],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[u,m],[/\bgsa\/([\w\.]+) .*safari\//i],[m,[u,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[m,[u,"Chrome Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[u,"Chrome WebView"],m],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[m,[u,"Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[u,m],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[m,[u,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[m,u],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[u,[m,me,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[u,m],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[u,"Netscape"],m],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[m,[u,"Firefox Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[u,m],[/(cobalt)\/([\w\.]+)/i],[u,[m,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[T,"amd64"]],[/(ia32(?=;))/i],[[T,b]],[/((?:i[346]|x)86)[;\)]/i],[[T,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[T,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[T,"armhf"]],[/windows (ce|mobile); ppc;/i],[[T,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[T,/ower/,"",b]],[/(sun4\w)[;\)]/i],[[T,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[T,b]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[E,$e],[l,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[E,$e],[l,R]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[E,M],[l,R]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[E,M],[l,y]],[/(macintosh);/i],[d,[E,M]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[E,O],[l,R]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[E,Dt],[l,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[E,Dt],[l,R]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[E,x],[l,R]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[E,x],[l,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[E,"OPPO"],[l,R]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[E,"Vivo"],[l,R]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[E,"Realme"],[l,R]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[E,_e],[l,R]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[E,_e],[l,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[E,At],[l,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[E,At],[l,R]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[E,"Lenovo"],[l,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[E,"Nokia"],[l,R]],[/(pixel c)\b/i],[d,[E,Q],[l,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[E,Q],[l,R]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[E,N],[l,R]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[E,N],[l,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[E,"OnePlus"],[l,R]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[E,k],[l,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[E,k],[l,R]],[/(playbook);[-\w\),; ]+(rim)/i],[d,E,[l,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[E,j],[l,R]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[E,D],[l,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[E,D],[l,R]],[/(nexus 9)/i],[d,[E,"HTC"],[l,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[E,[d,/_/g," "],[l,R]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[E,"Acer"],[l,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[E,"Meizu"],[l,R]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[E,d,[l,R]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[E,d,[l,y]],[/(surface duo)/i],[d,[E,Yt],[l,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[E,"Fairphone"],[l,R]],[/(u304aa)/i],[d,[E,"AT&T"],[l,R]],[/\bsie-(\w*)/i],[d,[E,"Siemens"],[l,R]],[/\b(rct\w+) b/i],[d,[E,"RCA"],[l,y]],[/\b(venue[\d ]{2,7}) b/i],[d,[E,"Dell"],[l,y]],[/\b(q(?:mv|ta)\w+) b/i],[d,[E,"Verizon"],[l,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[E,"Barnes & Noble"],[l,y]],[/\b(tm\d{3}\w+) b/i],[d,[E,"NuVision"],[l,y]],[/\b(k88) b/i],[d,[E,"ZTE"],[l,y]],[/\b(nx\d{3}j) b/i],[d,[E,"ZTE"],[l,R]],[/\b(gen\d{3}) b.+49h/i],[d,[E,"Swiss"],[l,R]],[/\b(zur\d{3}) b/i],[d,[E,"Swiss"],[l,y]],[/\b((zeki)?tb.*\b) b/i],[d,[E,"Zeki"],[l,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[E,"Dragon Touch"],d,[l,y]],[/\b(ns-?\w{0,9}) b/i],[d,[E,"Insignia"],[l,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[E,"NextBook"],[l,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[E,"Voice"],d,[l,R]],[/\b(lvtel\-)?(v1[12]) b/i],[[E,"LvTel"],d,[l,R]],[/\b(ph-1) /i],[d,[E,"Essential"],[l,R]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[E,"Envizen"],[l,y]],[/\b(trio[-\w\. ]+) b/i],[d,[E,"MachSpeed"],[l,y]],[/\btu_(1491) b/i],[d,[E,"Rotor"],[l,y]],[/(shield[\w ]+) b/i],[d,[E,"Nvidia"],[l,y]],[/(sprint) (\w+)/i],[E,d,[l,R]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[E,Yt],[l,R]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[E,X],[l,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[E,X],[l,R]],[/smart-tv.+(samsung)/i],[E,[l,A]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[E,$e],[l,A]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[E,At],[l,A]],[/(apple) ?tv/i],[E,[d,"Apple TV"],[l,A]],[/crkey/i],[[d,"Chromecast"],[E,Q],[l,A]],[/droid.+aft(\w)( bui|\))/i],[d,[E,k],[l,A]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[E,O],[l,A]],[/(bravia[\w ]+)( bui|\))/i],[d,[E,N],[l,A]],[/(mitv-\w{5}) bui/i],[d,[E,x],[l,A]],[/Hbbtv.*(technisat) (.*);/i],[E,d,[l,A]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[E,z],[d,z],[l,A]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[l,A]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[E,d,[l,g]],[/droid.+; (shield) bui/i],[d,[E,"Nvidia"],[l,g]],[/(playstation [345portablevi]+)/i],[d,[E,N],[l,g]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[E,Yt],[l,g]],[/((pebble))app/i],[E,d,[l,P]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[E,M],[l,P]],[/droid.+; (glass) \d/i],[d,[E,Q],[l,P]],[/droid.+; (wt63?0{2,3})\)/i],[d,[E,X],[l,P]],[/(quest( 2| pro)?)/i],[d,[E,ut],[l,P]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[E,[l,H]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[l,R]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[l,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[l,y]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[l,R]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[E,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[m,[u,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[m,[u,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[u,m],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[m,u]],os:[[/microsoft (windows) (vista|xp)/i],[u,m],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[u,[m,me,ji]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[u,"Windows"],[m,me,ji]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[m,/_/g,"."],[u,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[u,p],[m,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[m,u],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[u,m],[/\(bb(10);/i],[m,[u,j]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[m,[u,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[m,[u,"Firefox OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[m,[u,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[m,[u,"watchOS"]],[/crkey\/([\d\.]+)/i],[m,[u,"Chromecast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[u,L],m],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[u,m],[/(sunos) ?([\w\.\d]*)/i],[[u,"Solaris"],m],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[u,m]]},bi=function(Ft,Zt){if(typeof Ft===s&&(Zt=Ft,Ft=n),!(this instanceof bi))return new bi(Ft,Zt).getResult();var Ot=typeof i!==o&&i.navigator?i.navigator:n,Ke=Ft||(Ot&&Ot.userAgent?Ot.userAgent:""),dn=Ot&&Ot.userAgentData?Ot.userAgentData:n,jt=Zt?function(dt,ti){var Kn={};for(var Ji in dt)ti[Ji]&&ti[Ji].length%2==0?Kn[Ji]=ti[Ji].concat(dt[Ji]):Kn[Ji]=dt[Ji];return Kn}(Wn,Zt):Wn;return this.getBrowser=function(){var dt={};return dt.name=n,dt.version=n,wt.call(dt,Ke,jt.browser),dt.major=function(ti){return typeof ti===a?ti.replace(/[^\d\.]/g,"").split(".")[0]:n}(dt.version),Ot&&Ot.brave&&typeof Ot.brave.isBrave==r&&(dt.name="Brave"),dt},this.getCPU=function(){var dt={};return dt.architecture=n,wt.call(dt,Ke,jt.cpu),dt},this.getDevice=function(){var dt={};return dt.vendor=n,dt.model=n,dt.type=n,wt.call(dt,Ke,jt.device),!dt.type&&dn&&dn.mobile&&(dt.type=R),dt.model=="Macintosh"&&Ot&&typeof Ot.standalone!==o&&Ot.maxTouchPoints&&Ot.maxTouchPoints>2&&(dt.model="iPad",dt.type=y),dt},this.getEngine=function(){var dt={};return dt.name=n,dt.version=n,wt.call(dt,Ke,jt.engine),dt},this.getOS=function(){var dt={};return dt.name=n,dt.version=n,wt.call(dt,Ke,jt.os),!dt.name&&dn&&dn.platform!="Unknown"&&(dt.name=dn.platform.replace(/chrome os/i,L).replace(/macos/i,p)),dt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Ke},this.setUA=function(dt){return Ke=typeof dt===a&&dt.length>350?z(dt,350):dt,this},this.setUA(Ke),this};bi.VERSION="0.7.34",bi.BROWSER=S([u,m,c]),bi.CPU=S([T]),bi.DEVICE=S([d,E,l,g,R,A,y,P,H]),bi.ENGINE=bi.OS=S([u,m]),t.exports&&(e=t.exports=bi),e.UAParser=bi;var Hn=typeof i!==o&&(i.jQuery||i.Zepto);if(Hn&&!Hn.ua){var eo=new bi;Hn.ua=eo.getResult(),Hn.ua.get=function(){return eo.getUA()},Hn.ua.set=function(Ft){eo.setUA(Ft);var Zt=eo.getResult();for(var Ot in Zt)Hn.ua[Ot]=Zt[Ot]}}})(typeof window=="object"?window:Oe)})(nd,nd.exports);const rd=new nd.exports;let Di,pn=rd.getResult();function Rt(t){return t&&rd.setUA(t),pn=rd.getResult(),{name:DO(pn),version:PO(pn),os:LO(pn),osVersion:pn.os.version}}function DO(t){if(t.engine.name==="Blink"&&t.browser.name!=="WeChat")return St.CHROME;switch(t.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return St.CHROME;case"Safari":case"Mobile Safari":return St.SAFARI;case"Edge":return St.EDGE;case"Firefox":return St.FIREFOX;case"QQBrowser":return St.QQ;case"Opera":return St.OPERA;case"WeChat":return St.WECHAT;default:return t.browser.name||""}}function PO(t){let e;return e=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",e.split(".")[0]}function LO(t){switch(t.os.name){case"Windows":return t.os.version?t.os.name+" "+t.os.version:t.os.name;default:return t.os.name||""}}function ks(){const t=Rt();return!!(pn.engine.name==="WebKit"&&t.os===be.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==St.SAFARI||ke()&&t.name!==St.SAFARI)}function kO(){const t=Rt();if(ks()){if(t.os===be.MAC_OS)return!0;if(t.os===be.IOS){const e=pn.os.version&&pn.os.version.split(".");if(e&&Number(e[0])===14&&e[1]&&Number(e[1])>=3||e&&Number(e[0])>14)return!0}}return!1}function MO(){return pn.engine.name==="WebKit"}function od(){return Rt().name===St.CHROME}function Le(){return Rt().name===St.SAFARI}function Bt(){return Rt().name===St.FIREFOX}function ke(){return Rt().os===be.IOS}function sd(t){const e=Rt();return!(e.name!==St.CHROME||!e.osVersion)&&Number(e.version)>=t}function mE(t){const e=Rt();return!(e.name!==St.EDGE||!e.osVersion)&&Number(e.version)>=t}function fE(t){const e=Rt();return!(e.name!==St.OPERA||!e.osVersion)&&Number(e.version)>=t}function SE(){const t=Rt();return!(t.name!==St.CHROME||!t.osVersion)&&Number(t.version)<=90}function gE(){const t=Rt();if(t.os!==be.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function Nr(){const t=Rt();if(t.os!==be.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15}function TE(){const t=Rt();if(t.os!==be.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])===0}function RE(){const t=Rt();if(t.os!==be.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function ad(){const t=Rt();if(t.os!==be.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=2}function $i(){return Le()&&navigator.maxTouchPoints>0}function IE(){return Rt().name===St.WECHAT}function vE(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function er(){const t=Rt();return t.name===St.EDGE||t.name===St.SAFARI?!1:!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function cd(){return Rt().os===be.ANDROID}function mo(){const t=Rt();return t.os==="Android"&&(t.name==="Chrome"||t.name===St.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}(function(t){t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver"})(Di||(Di={}));var CE={exports:{}},UO=Fe,xO=Xi,yE=Gi.f;UO({target:"Object",stat:!0,forced:Object.defineProperty!==yE,sham:!xO},{defineProperty:yE});var AE=vn.Object,VO=CE.exports=function(t,e,i){return AE.defineProperty(t,e,i)};AE.defineProperty.sham&&(VO.sham=!0);var OE=CE.exports;function h(t,e,i){return e in t?OE(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var dd,ud={exports:{}},bE=function(t,e){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return t.apply(e,i)}},FO=bE,ld=Object.prototype.toString,hd=(dd=Object.create(null),function(t){var e=ld.call(t);return dd[e]||(dd[e]=e.slice(8,-1).toLowerCase())});function ir(t){return t=t.toLowerCase(),function(e){return hd(e)===t}}function pd(t){return Array.isArray(t)}function Ms(t){return t===void 0}var wE=ir("ArrayBuffer");function NE(t){return t!==null&&typeof t=="object"}function Us(t){if(hd(t)!=="object")return!1;var e=Object.getPrototypeOf(t);return e===null||e===Object.prototype}var jO=ir("Date"),BO=ir("File"),GO=ir("Blob"),WO=ir("FileList");function Ed(t){return ld.call(t)==="[object Function]"}var HO=ir("URLSearchParams");function _d(t,e){if(t!=null)if(typeof t!="object"&&(t=[t]),pd(t))for(var i=0,n=t.length;i<n;i++)e.call(null,t[i],i,t);else for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.call(null,t[r],r,t)}var md,KO=(md=typeof Uint8Array<"u"&&Object.getPrototypeOf(Uint8Array),function(t){return md&&t instanceof md}),je={isArray:pd,isArrayBuffer:wE,isBuffer:function(t){return t!==null&&!Ms(t)&&t.constructor!==null&&!Ms(t.constructor)&&typeof t.constructor.isBuffer=="function"&&t.constructor.isBuffer(t)},isFormData:function(t){var e="[object FormData]";return t&&(typeof FormData=="function"&&t instanceof FormData||ld.call(t)===e||Ed(t.toString)&&t.toString()===e)},isArrayBufferView:function(t){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&wE(t.buffer)},isString:function(t){return typeof t=="string"},isNumber:function(t){return typeof t=="number"},isObject:NE,isPlainObject:Us,isUndefined:Ms,isDate:jO,isFile:BO,isBlob:GO,isFunction:Ed,isStream:function(t){return NE(t)&&Ed(t.pipe)},isURLSearchParams:HO,isStandardBrowserEnv:function(){return(typeof navigator>"u"||navigator.product!=="ReactNative"&&navigator.product!=="NativeScript"&&navigator.product!=="NS")&&typeof window<"u"&&typeof document<"u"},forEach:_d,merge:function t(){var e={};function i(o,s){Us(e[s])&&Us(o)?e[s]=t(e[s],o):Us(o)?e[s]=t({},o):pd(o)?e[s]=o.slice():e[s]=o}for(var n=0,r=arguments.length;n<r;n++)_d(arguments[n],i);return e},extend:function(t,e,i){return _d(e,function(n,r){t[r]=i&&typeof n=="function"?FO(n,i):n}),t},trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},stripBOM:function(t){return t.charCodeAt(0)===65279&&(t=t.slice(1)),t},inherits:function(t,e,i,n){t.prototype=Object.create(e.prototype,n),t.prototype.constructor=t,i&&Object.assign(t.prototype,i)},toFlatObject:function(t,e,i){var n,r,o,s={};e=e||{};do{for(r=(n=Object.getOwnPropertyNames(t)).length;r-- >0;)s[o=n[r]]||(e[o]=t[o],s[o]=!0);t=Object.getPrototypeOf(t)}while(t&&(!i||i(t,e))&&t!==Object.prototype);return e},kindOf:hd,kindOfTest:ir,endsWith:function(t,e,i){t=String(t),(i===void 0||i>t.length)&&(i=t.length),i-=e.length;var n=t.indexOf(e,i);return n!==-1&&n===i},toArray:function(t){if(!t)return null;var e=t.length;if(Ms(e))return null;for(var i=new Array(e);e-- >0;)i[e]=t[e];return i},isTypedArray:KO,isFileList:WO},Dr=je;function DE(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var PE=function(t,e,i){if(!e)return t;var n;if(i)n=i(e);else if(Dr.isURLSearchParams(e))n=e.toString();else{var r=[];Dr.forEach(e,function(s,a){s!=null&&(Dr.isArray(s)?a+="[]":s=[s],Dr.forEach(s,function(c){Dr.isDate(c)?c=c.toISOString():Dr.isObject(c)&&(c=JSON.stringify(c)),r.push(DE(a)+"="+DE(c))}))}),n=r.join("&")}if(n){var o=t.indexOf("#");o!==-1&&(t=t.slice(0,o)),t+=(t.indexOf("?")===-1?"?":"&")+n}return t},YO=je;function xs(){this.handlers=[]}xs.prototype.use=function(t,e,i){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1},xs.prototype.eject=function(t){this.handlers[t]&&(this.handlers[t]=null)},xs.prototype.forEach=function(t){YO.forEach(this.handlers,function(e){e!==null&&t(e)})};var qO=xs,JO=je,LE=je;function Pr(t,e,i,n,r){Error.call(this),this.message=t,this.name="AxiosError",e&&(this.code=e),i&&(this.config=i),n&&(this.request=n),r&&(this.response=r)}LE.inherits(Pr,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var kE=Pr.prototype,ME={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach(function(t){ME[t]={value:t}}),Object.defineProperties(Pr,ME),Object.defineProperty(kE,"isAxiosError",{value:!0}),Pr.from=function(t,e,i,n,r,o){var s=Object.create(kE);return LE.toFlatObject(t,s,function(a){return a!==Error.prototype}),Pr.call(s,t.message,e,i,n,r),s.name=t.name,o&&Object.assign(s,o),s};var Lr=Pr,UE={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Hi=je,xE=function(t,e){e=e||new FormData;var i=[];function n(r){return r===null?"":Hi.isDate(r)?r.toISOString():Hi.isArrayBuffer(r)||Hi.isTypedArray(r)?typeof Blob=="function"?new Blob([r]):Buffer.from(r):r}return function r(o,s){if(Hi.isPlainObject(o)||Hi.isArray(o)){if(i.indexOf(o)!==-1)throw Error("Circular reference detected in "+s);i.push(o),Hi.forEach(o,function(a,c){if(!Hi.isUndefined(a)){var d,u=s?s+"."+c:c;if(a&&!s&&typeof a=="object"){if(Hi.endsWith(c,"{}"))a=JSON.stringify(a);else if(Hi.endsWith(c,"[]")&&(d=Hi.toArray(a)))return void d.forEach(function(l){!Hi.isUndefined(l)&&e.append(u,n(l))})}r(a,u)}}),i.pop()}else e.append(s,n(o))}(t),e},fd=Lr,Vs=je,XO=Vs.isStandardBrowserEnv()?{write:function(t,e,i,n,r,o){var s=[];s.push(t+"="+encodeURIComponent(e)),Vs.isNumber(i)&&s.push("expires="+new Date(i).toGMTString()),Vs.isString(n)&&s.push("path="+n),Vs.isString(r)&&s.push("domain="+r),o===!0&&s.push("secure"),document.cookie=s.join("; ")},read:function(t){var e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},zO=function(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)},QO=function(t,e){return e?t.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):t},VE=function(t,e){return t&&!zO(e)?QO(t,e):e},Sd=je,ZO=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],FE=je,$O=FE.isStandardBrowserEnv()?function(){var t,e=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function n(r){var o=r;return e&&(i.setAttribute("href",o),o=i.href),i.setAttribute("href",o),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:i.pathname.charAt(0)==="/"?i.pathname:"/"+i.pathname}}return t=n(window.location.href),function(r){var o=FE.isString(r)?n(r):r;return o.protocol===t.protocol&&o.host===t.host}}():function(){return!0},gd=Lr;function jE(t){gd.call(this,t??"canceled",gd.ERR_CANCELED),this.name="CanceledError"}je.inherits(jE,gd,{__CANCEL__:!0});var Fs=jE,fo=je,tb=function(t,e,i){var n=i.config.validateStatus;i.status&&n&&!n(i.status)?e(new fd("Request failed with status code "+i.status,[fd.ERR_BAD_REQUEST,fd.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):t(i)},eb=XO,ib=PE,nb=VE,rb=function(t){var e,i,n,r={};return t&&Sd.forEach(t.split(`
`),function(o){if(n=o.indexOf(":"),e=Sd.trim(o.substr(0,n)).toLowerCase(),i=Sd.trim(o.substr(n+1)),e){if(r[e]&&ZO.indexOf(e)>=0)return;r[e]=e==="set-cookie"?(r[e]?r[e]:[]).concat([i]):r[e]?r[e]+", "+i:i}}),r},ob=$O,sb=UE,En=Lr,ab=Fs,cb=function(t){var e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""},db=function(t){return new Promise(function(e,i){var n,r=t.data,o=t.headers,s=t.responseType;function a(){t.cancelToken&&t.cancelToken.unsubscribe(n),t.signal&&t.signal.removeEventListener("abort",n)}fo.isFormData(r)&&fo.isStandardBrowserEnv()&&delete o["Content-Type"];var c=new XMLHttpRequest;if(t.auth){var d=t.auth.username||"",u=t.auth.password?unescape(encodeURIComponent(t.auth.password)):"";o.Authorization="Basic "+btoa(d+":"+u)}var l=nb(t.baseURL,t.url);function E(){if(c){var g="getAllResponseHeaders"in c?rb(c.getAllResponseHeaders()):null,R={data:s&&s!=="text"&&s!=="json"?c.response:c.responseText,status:c.status,statusText:c.statusText,headers:g,config:t,request:c};tb(function(y){e(y),a()},function(y){i(y),a()},R),c=null}}if(c.open(t.method.toUpperCase(),ib(l,t.params,t.paramsSerializer),!0),c.timeout=t.timeout,"onloadend"in c?c.onloadend=E:c.onreadystatechange=function(){c&&c.readyState===4&&(c.status!==0||c.responseURL&&c.responseURL.indexOf("file:")===0)&&setTimeout(E)},c.onabort=function(){c&&(i(new En("Request aborted",En.ECONNABORTED,t,c)),c=null)},c.onerror=function(){i(new En("Network Error",En.ERR_NETWORK,t,c,c)),c=null},c.ontimeout=function(){var g=t.timeout?"timeout of "+t.timeout+"ms exceeded":"timeout exceeded",R=t.transitional||sb;t.timeoutErrorMessage&&(g=t.timeoutErrorMessage),i(new En(g,R.clarifyTimeoutError?En.ETIMEDOUT:En.ECONNABORTED,t,c)),c=null},fo.isStandardBrowserEnv()){var m=(t.withCredentials||ob(l))&&t.xsrfCookieName?eb.read(t.xsrfCookieName):void 0;m&&(o[t.xsrfHeaderName]=m)}"setRequestHeader"in c&&fo.forEach(o,function(g,R){r===void 0&&R.toLowerCase()==="content-type"?delete o[R]:c.setRequestHeader(R,g)}),fo.isUndefined(t.withCredentials)||(c.withCredentials=!!t.withCredentials),s&&s!=="json"&&(c.responseType=t.responseType),typeof t.onDownloadProgress=="function"&&c.addEventListener("progress",t.onDownloadProgress),typeof t.onUploadProgress=="function"&&c.upload&&c.upload.addEventListener("progress",t.onUploadProgress),(t.cancelToken||t.signal)&&(n=function(g){c&&(i(!g||g&&g.type?new ab:g),c.abort(),c=null)},t.cancelToken&&t.cancelToken.subscribe(n),t.signal&&(t.signal.aborted?n():t.signal.addEventListener("abort",n))),r||(r=null);var T=cb(l);T&&["http","https","file"].indexOf(T)===-1?i(new En("Unsupported protocol "+T+":",En.ERR_BAD_REQUEST,t)):c.send(r)})},Me=je,BE=function(t,e){JO.forEach(t,function(i,n){n!==e&&n.toUpperCase()===e.toUpperCase()&&(t[e]=i,delete t[n])})},GE=Lr,ub=xE,lb={"Content-Type":"application/x-www-form-urlencoded"};function WE(t,e){!Me.isUndefined(t)&&Me.isUndefined(t["Content-Type"])&&(t["Content-Type"]=e)}var HE,js={transitional:UE,adapter:((typeof XMLHttpRequest<"u"||typeof process<"u"&&Object.prototype.toString.call(process)==="[object process]")&&(HE=db),HE),transformRequest:[function(t,e){if(BE(e,"Accept"),BE(e,"Content-Type"),Me.isFormData(t)||Me.isArrayBuffer(t)||Me.isBuffer(t)||Me.isStream(t)||Me.isFile(t)||Me.isBlob(t))return t;if(Me.isArrayBufferView(t))return t.buffer;if(Me.isURLSearchParams(t))return WE(e,"application/x-www-form-urlencoded;charset=utf-8"),t.toString();var i,n=Me.isObject(t),r=e&&e["Content-Type"];if((i=Me.isFileList(t))||n&&r==="multipart/form-data"){var o=this.env&&this.env.FormData;return ub(i?{"files[]":t}:t,o&&new o)}return n||r==="application/json"?(WE(e,"application/json"),function(s,a,c){if(Me.isString(s))try{return(a||JSON.parse)(s),Me.trim(s)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(s)}(t)):t}],transformResponse:[function(t){var e=this.transitional||js.transitional,i=e&&e.silentJSONParsing,n=e&&e.forcedJSONParsing,r=!i&&this.responseType==="json";if(r||n&&Me.isString(t)&&t.length)try{return JSON.parse(t)}catch(o){if(r)throw o.name==="SyntaxError"?GE.from(o,GE.ERR_BAD_RESPONSE,this,null,this.response):o}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:null},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};Me.forEach(["delete","get","head"],function(t){js.headers[t]={}}),Me.forEach(["post","put","patch"],function(t){js.headers[t]=Me.merge(lb)});var Td=js,hb=je,pb=Td,KE=function(t){return!(!t||!t.__CANCEL__)},YE=je,Rd=function(t,e,i){var n=this||pb;return hb.forEach(i,function(r){t=r.call(n,t,e)}),t},Eb=KE,_b=Td,mb=Fs;function Id(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new mb}var fi=je,qE=function(t,e){e=e||{};var i={};function n(d,u){return fi.isPlainObject(d)&&fi.isPlainObject(u)?fi.merge(d,u):fi.isPlainObject(u)?fi.merge({},u):fi.isArray(u)?u.slice():u}function r(d){return fi.isUndefined(e[d])?fi.isUndefined(t[d])?void 0:n(void 0,t[d]):n(t[d],e[d])}function o(d){if(!fi.isUndefined(e[d]))return n(void 0,e[d])}function s(d){return fi.isUndefined(e[d])?fi.isUndefined(t[d])?void 0:n(void 0,t[d]):n(void 0,e[d])}function a(d){return d in e?n(t[d],e[d]):d in t?n(void 0,t[d]):void 0}var c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a};return fi.forEach(Object.keys(t).concat(Object.keys(e)),function(d){var u=c[d]||r,l=u(d);fi.isUndefined(l)&&u!==a||(i[d]=l)}),i},JE="0.27.2",fb=JE,Nn=Lr,vd={};["object","boolean","number","function","string","symbol"].forEach(function(t,e){vd[t]=function(i){return typeof i===t||"a"+(e<1?"n ":" ")+t}});var XE={};vd.transitional=function(t,e,i){function n(r,o){return"[Axios v"+fb+"] Transitional option '"+r+"'"+o+(i?". "+i:"")}return function(r,o,s){if(t===!1)throw new Nn(n(o," has been removed"+(e?" in "+e:"")),Nn.ERR_DEPRECATED);return e&&!XE[o]&&(XE[o]=!0,console.warn(n(o," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(r,o,s)}};var zE=je,Sb=PE,QE=qO,ZE=function(t){return Id(t),t.headers=t.headers||{},t.data=Rd.call(t,t.data,t.headers,t.transformRequest),t.headers=YE.merge(t.headers.common||{},t.headers[t.method]||{},t.headers),YE.forEach(["delete","get","head","post","put","patch","common"],function(e){delete t.headers[e]}),(t.adapter||_b.adapter)(t).then(function(e){return Id(t),e.data=Rd.call(t,e.data,e.headers,t.transformResponse),e},function(e){return Eb(e)||(Id(t),e&&e.response&&(e.response.data=Rd.call(t,e.response.data,e.response.headers,t.transformResponse))),Promise.reject(e)})},Bs=qE,gb=VE,$E={assertOptions:function(t,e,i){if(typeof t!="object")throw new Nn("options must be an object",Nn.ERR_BAD_OPTION_VALUE);for(var n=Object.keys(t),r=n.length;r-- >0;){var o=n[r],s=e[o];if(s){var a=t[o],c=a===void 0||s(a,o,t);if(c!==!0)throw new Nn("option "+o+" must be "+c,Nn.ERR_BAD_OPTION_VALUE)}else if(i!==!0)throw new Nn("Unknown option "+o,Nn.ERR_BAD_OPTION)}},validators:vd},kr=$E.validators;function Mr(t){this.defaults=t,this.interceptors={request:new QE,response:new QE}}Mr.prototype.request=function(t,e){typeof t=="string"?(e=e||{}).url=t:e=t||{},(e=Bs(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var i=e.transitional;i!==void 0&&$E.assertOptions(i,{silentJSONParsing:kr.transitional(kr.boolean),forcedJSONParsing:kr.transitional(kr.boolean),clarifyTimeoutError:kr.transitional(kr.boolean)},!1);var n=[],r=!0;this.interceptors.request.forEach(function(l){typeof l.runWhen=="function"&&l.runWhen(e)===!1||(r=r&&l.synchronous,n.unshift(l.fulfilled,l.rejected))});var o,s=[];if(this.interceptors.response.forEach(function(l){s.push(l.fulfilled,l.rejected)}),!r){var a=[ZE,void 0];for(Array.prototype.unshift.apply(a,n),a=a.concat(s),o=Promise.resolve(e);a.length;)o=o.then(a.shift(),a.shift());return o}for(var c=e;n.length;){var d=n.shift(),u=n.shift();try{c=d(c)}catch(l){u(l);break}}try{o=ZE(c)}catch(l){return Promise.reject(l)}for(;s.length;)o=o.then(s.shift(),s.shift());return o},Mr.prototype.getUri=function(t){t=Bs(this.defaults,t);var e=gb(t.baseURL,t.url);return Sb(e,t.params,t.paramsSerializer)},zE.forEach(["delete","get","head","options"],function(t){Mr.prototype[t]=function(e,i){return this.request(Bs(i||{},{method:t,url:e,data:(i||{}).data}))}}),zE.forEach(["post","put","patch"],function(t){function e(i){return function(n,r,o){return this.request(Bs(o||{},{method:t,headers:i?{"Content-Type":"multipart/form-data"}:{},url:n,data:r}))}}Mr.prototype[t]=e(),Mr.prototype[t+"Form"]=e(!0)});var Tb=Mr,Rb=Fs;function Ur(t){if(typeof t!="function")throw new TypeError("executor must be a function.");var e;this.promise=new Promise(function(n){e=n});var i=this;this.promise.then(function(n){if(i._listeners){var r,o=i._listeners.length;for(r=0;r<o;r++)i._listeners[r](n);i._listeners=null}}),this.promise.then=function(n){var r,o=new Promise(function(s){i.subscribe(s),r=s}).then(n);return o.cancel=function(){i.unsubscribe(r)},o},t(function(n){i.reason||(i.reason=new Rb(n),e(i.reason))})}Ur.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},Ur.prototype.subscribe=function(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]},Ur.prototype.unsubscribe=function(t){if(this._listeners){var e=this._listeners.indexOf(t);e!==-1&&this._listeners.splice(e,1)}},Ur.source=function(){var t;return{token:new Ur(function(e){t=e}),cancel:t}};var Ib=Ur,vb=je,t_=je,Cb=bE,Gs=Tb,yb=qE,oi=function t(e){var i=new Gs(e),n=Cb(Gs.prototype.request,i);return t_.extend(n,Gs.prototype,i),t_.extend(n,i),n.create=function(r){return t(yb(e,r))},n}(Td);oi.Axios=Gs,oi.CanceledError=Fs,oi.CancelToken=Ib,oi.isCancel=KE,oi.VERSION=JE,oi.toFormData=xE,oi.AxiosError=Lr,oi.Cancel=oi.CanceledError,oi.all=function(t){return Promise.all(t)},oi.spread=function(t){return function(e){return t.apply(null,e)}},oi.isAxiosError=function(t){return vb.isObject(t)&&t.isAxiosError===!0},ud.exports=oi,ud.exports.default=oi;var Pi=ud.exports;class Ab{constructor(e){h(this,"logger",void 0),h(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.debug(...this.prefixLists,...i)}info(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.info(...this.prefixLists,...i)}warning(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.warning(...this.prefixLists,...i)}error(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.error(...this.prefixLists,...i)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}class Gt{constructor(){h(this,"_events",{}),h(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(i=>i.listener):[]}on(e,i){this._events[e]||(this._events[e]=[]);const n=this._events[e];this._indexOfListener(n,i)===-1&&n.push({listener:i,once:!1})}once(e,i){this._events[e]||(this._events[e]=[]);const n=this._events[e];this._indexOfListener(n,i)===-1&&n.push({listener:i,once:!0})}off(e,i){if(!this._events[e])return;const n=this._events[e],r=this._indexOfListener(n,i);r!==-1&&n.splice(r,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const i=this._events[e].map(s=>s);for(var n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];for(let s=0;s<i.length;s+=1){const a=i[s];a.once&&this.off(e,a.listener),a.listener.apply(this,r||[])}}_indexOfListener(e,i){let n=e.length;for(;n--;)if(e[n].listener===i)return n;return-1}}const Ws=new class extends Gt{reportLogUploadError(t){this.emit("REPORT_LOG_UPLOAD",t)}};let f;(function(t){t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION"})(f||(f={}));class I extends Error{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(i),h(this,"code",void 0),h(this,"message",void 0),h(this,"data",void 0),h(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(i),this.data=n}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return e==="error"&&_.error(this.toString()),e==="warning"&&_.warning(this.toString()),this}throw(){throw this.print(),this}}const ne={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function Cd(t,e){const i=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,i)}function tn(t,e,i,n){const r=Object.assign({},ne,n);let o=r.timeout;const s=async()=>{await function(d){return new V(u=>{window.setTimeout(u,d)})}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o)};let a=!1;const c=new V(async(d,u)=>{e=e||(()=>!1),i=i||(()=>!0);for(let l=0;l<r.maxRetryCount;l+=1){if(a)return u(new I(f.OPERATION_ABORTED));try{const E=await t();if(!e(E,l)||l+1===r.maxRetryCount)return d(E);await s()}catch(E){if(!i(E,l)||l+1===r.maxRetryCount)return u(E);await s()}}});return c.cancel=()=>a=!0,c}function yd(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function e_(){const t=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?(e==null?void 0:e[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const Si={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Hs=Date.now(),So=t=>{for(const e in Si)if(Object.prototype.hasOwnProperty.call(Si,e)&&Si[e]===t)return e;return"DEFAULT"},_=new class{constructor(){h(this,"proxyServerURL",void 0),h(this,"logLevel",Si.DEBUG),h(this,"uploadState","collecting"),h(this,"uploadLogWaitingList",[]),h(this,"uploadLogUploadingList",[]),h(this,"uploadErrorCount",0),h(this,"currentLogID",0),h(this,"url",void 0),h(this,"extLog",(t,e)=>{this.appendLogToWaitingList(t,...e)})}debug(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Si.DEBUG].concat(e);this.log.apply(this,n)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Si.INFO].concat(e);this.log.apply(this,n)}warning(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Si.WARNING].concat(e);this.log.apply(this,n)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Si.ERROR].concat(e);this.log.apply(this,n)}upload(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Si.DEBUG].concat(e);this.uploadLog.apply(this,n)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){Ct("UPLOAD_LOG",!0)}disableLogUpload(){Ct("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new Ab(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-Hs<100)return void setTimeout(()=>{this.log(...e)},Date.now()-Hs);const n=Math.max(0,Math.min(4,e[0]));if(e[0]=yd()+" Agora-SDK [".concat(So(n),"]:"),this.appendLogToWaitingList(n,...e),n<this.logLevel)return;const r=yd()+" %cAgora-SDK [".concat(So(n),"]:");let o=[];if(!C("USE_NEW_LOG"))switch(n){case Si.DEBUG:o=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case Si.INFO:o=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case Si.WARNING:o=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case Si.ERROR:o=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-Hs<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-Hs);const n=Math.max(0,Math.min(4,e[0]));e[0]=yd()+" Agora-SDK [".concat(So(n),"]:"),this.appendLogToWaitingList(n,...e)}appendLogToWaitingList(t){if(!C("UPLOAD_LOG"))return;for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];Array.isArray(i[0])?i[0][0]=e_()+" Agora-SDK [".concat(So(t),"]:"):i[0]=e_()+" Agora-SDK [".concat(So(t),"]:");let r="";i.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),r+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:r,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:gi,process_id:C("PROCESS_ID"),payload:JSON.stringify(t)};return tn(async()=>{const i=await Pi.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(C("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(C("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(i.data!=="OK"){const n=new Error("unexpected upload log response");throw n.response=i,n}},()=>(this.uploadLogUploadingList=[],!1),i=>(i.response?Ws.reportLogUploadError({status:i.response.status,data:i.response.data,headers:i.response.headers,message:i.message}):i.request?Ws.reportLogUploadError({status:i.request.status,message:i.message}):Ws.reportLogUploadError({status:-1,message:i.message}),!0),{timeout:C("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:C("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,C("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}},Ad="v4.17.2-0-gb960eec4-dirty(4/20/2023, 10:39:51 AM)",gi=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(e&&e[1]&&e[2]){const n=e[1],r=e[2];return"".concat(n,".").concat(r)}const i=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(i&&i[1]&&i[2]){const n=i[1],r=i[2];return"".concat(n,".").concat(100*(Number(r)+1))}return"4.0.0.999"}("4.17.2"),Od=function(){try{return JSON.parse("true")===!0}catch{return!0}}(),i_=["CHINA","GLOBAL"],si=function(){const t="us".concat("erna","me"),e="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const o=r.join(""),s={};return s[t]=n,s[e]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=si;const Ob={"90p":st(160,90),"90p_1":st(160,90),"120p":st(160,120,15,30,65),"120p_1":st(160,120,15,30,65),"120p_3":st(120,120,15,30,50),"120p_4":st(212,120),"180p":st(320,180,15,30,140),"180p_1":st(320,180,15,30,140),"180p_3":st(180,180,15,30,100),"180p_4":st(240,180,15,30,120),"240p":st(320,240,15,40,200),"240p_1":st(320,240,15,40,200),"240p_3":st(240,240,15,40,140),"240p_4":st(424,240,15,40,220),"360p":st(640,360,15,80,400),"360p_1":st(640,360,15,80,400),"360p_3":st(360,360,15,80,260),"360p_4":st(640,360,30,80,600),"360p_6":st(360,360,30,80,400),"360p_7":st(480,360,15,80,320),"360p_8":st(480,360,30,80,490),"360p_9":st(640,360,15,80,800),"360p_10":st(640,360,24,80,800),"360p_11":st(640,360,24,80,1e3),"480p":st(640,480,15,100,500),"480p_1":st(640,480,15,100,500),"480p_2":st(640,480,30,100,1e3),"480p_3":st(480,480,15,100,400),"480p_4":st(640,480,30,100,750),"480p_6":st(480,480,30,100,600),"480p_8":st(848,480,15,100,610),"480p_9":st(848,480,30,100,930),"480p_10":st(640,480,10,100,400),"720p":st(1280,720,15,120,1130),"720p_1":st(1280,720,15,120,1130),"720p_2":st(1280,720,30,120,2e3),"720p_3":st(1280,720,30,120,1710),"720p_5":st(960,720,15,120,910),"720p_6":st(960,720,30,120,1380),"1080p":st(1920,1080,15,120,2080),"1080p_1":st(1920,1080,15,120,2080),"1080p_2":st(1920,1080,30,120,3e3),"1080p_3":st(1920,1080,30,120,3150),"1080p_5":st(1920,1080,60,120,4780),"1440p":st(2560,1440,30,120,4850),"1440p_1":st(2560,1440,30,120,4850),"1440p_2":st(2560,1440,60,120,7350),"4k":st(3840,2160,30,120,8910),"4k_1":st(3840,2160,30,120,8910),"4k_3":st(3840,2160,60,120,13500)},bb={"480p":Li(640,480,5),"480p_1":Li(640,480,5),"480p_2":Li(640,480,30),"480p_3":Li(640,480,15),"720p":Li(1280,720,5),"720p_1":Li(1280,720,5),"720p_2":Li(1280,720,30),"720p_3":Li(1280,720,15),"1080p":Li(1920,1080,5),"1080p_1":Li(1920,1080,5),"1080p_2":Li(1920,1080,30),"1080p_3":Li(1920,1080,15)},wb={"1SL1TL":wd(1,1),"3SL3TL":wd(3,3),"2SL3TL":wd(2,3)};function nr(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},Ob[t]):t}function bd(t){return typeof t=="string"?Object.assign({},bb[t]):t}function Ks(t){return typeof t=="string"?Object.assign({},wb[t]):t}const Nb={speech_low_quality:xr(16e3,!1),speech_standard:xr(32e3,!1,18),music_standard:xr(48e3,!1),standard_stereo:xr(48e3,!0,56),high_quality:xr(48e3,!1,128),high_quality_stereo:xr(48e3,!0,192)};function Ys(t){return typeof t=="string"?Object.assign({},Nb[t]):t}function Ct(t,e,i){Object.keys(qe).includes(t)&&(!i&&Object.keys(rr).includes(t)||(qe[t]=e))}function C(t){return qe[t]}const qe={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:i_,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_WITH_FALLBACK_PROXY_PENDING_DURATION:2e3,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0}},rr={};function xr(t,e,i){return{sampleRate:t,stereo:e,bitrate:i}}function st(t,e,i,n,r){return{width:t,height:e,frameRate:i,bitrateMin:n,bitrateMax:r}}function Li(t,e,i,n,r){return{width:{max:t},height:{max:e},frameRate:i,bitrateMin:n,bitrateMax:r}}function wd(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}Od||(qe.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],qe.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],qe.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],qe.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],qe.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],qe.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],qe.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",qe.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",qe.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",qe.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",qe.AREAS=["NORTH_AMERICA","OVERSEA"]);const Db=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],or=[],go=[];function sr(t,e){return!!e&&or.some(i=>i.uid===t&&i.channelName===e)}var Pb=Zo,Lb=Gi,kb=Yn,Nd=function(t,e,i){var n=Pb(e);n in t?Lb.f(t,n,kb(0,i)):t[n]=i},n_=ec,Mb=yn,Ub=Nd,xb=Et.Array,Vb=Math.max,r_=function(t,e,i){for(var n=Mb(t),r=n_(e,n),o=n_(i===void 0?n:i,n),s=xb(Vb(o-r,0)),a=0;r<o;r++,a++)Ub(s,a,t[r]);return s.length=a,s},o_=r_,Fb=Math.floor,Dd=function(t,e){var i=t.length,n=Fb(i/2);return i<8?jb(t,e):Bb(t,Dd(o_(t,0,n),e),Dd(o_(t,n),e),e)},jb=function(t,e){for(var i,n,r=t.length,o=1;o<r;){for(n=o,i=t[o];n&&e(t[n-1],i)>0;)t[n]=t[--n];n!==o++&&(t[n]=i)}return t},Bb=function(t,e,i,n){for(var r=e.length,o=i.length,s=0,a=0;s<r||a<o;)t[s+a]=s<r&&a<o?n(e[s],i[a])<=0?e[s++]:i[a++]:s<r?e[s++]:i[a++];return t},Gb=Dd,s_=qn.match(/firefox\/(\d+)/i),Wb=!!s_&&+s_[1],Hb=/MSIE|Trident/.test(qn),a_=qn.match(/AppleWebKit\/(\d+)\./),Kb=!!a_&&+a_[1],Yb=Fe,c_=ue,qb=un,Jb=Cn,Xb=yn,d_=Rr,Pd=Tt,zb=Gb,Qb=za,u_=Wb,Zb=Hb,l_=fr,h_=Kb,Dn=[],p_=c_(Dn.sort),$b=c_(Dn.push),tw=Pd(function(){Dn.sort(void 0)}),ew=Pd(function(){Dn.sort(null)}),iw=Qb("sort"),E_=!Pd(function(){if(l_)return l_<70;if(!(u_&&u_>3)){if(Zb)return!0;if(h_)return h_<603;var t,e,i,n,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)Dn.push({k:e+n,v:i})}for(Dn.sort(function(o,s){return s.v-o.v}),n=0;n<Dn.length;n++)e=Dn[n].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return r!=="DGBEFHACIJK"}});Yb({target:"Array",proto:!0,forced:tw||!ew||!iw||!E_},{sort:function(t){t!==void 0&&qb(t);var e=Jb(this);if(E_)return t===void 0?p_(e):p_(e,t);var i,n,r=[],o=Xb(e);for(n=0;n<o;n++)n in e&&$b(r,e[n]);for(zb(r,function(s){return function(a,c){return c===void 0?-1:a===void 0?1:s!==void 0?+s(a,c)||0:d_(a)>d_(c)?1:-1}}(t)),i=r.length,n=0;n<i;)e[n]=r[n++];for(;n<o;)delete e[n++];return e}});var nw=An("Array").sort,rw=_i,ow=nw,Ld=Array.prototype,kd=function(t){var e=t.sort;return t===Ld||rw(Ld,t)&&e===Ld.sort?ow:e};function To(t,e){if(typeof t!="boolean")throw new I(f.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function ce(t,e,i){if(!i.includes(t))throw new I(f.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(i)))}function Nt(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t<i||t>n||r&&!sw(t))throw new I(f.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(i,", ").concat(n,"]. integer only"))}function Md(t,e){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new I(f.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));t.min!==void 0&&Nt(t.min,"".concat(e,".min"),0,1/0),t.max!==void 0&&Nt(t.max,"".concat(e,".max"),1,1/0),t.exact!==void 0&&Nt(t.exact,"".concat(e,".exact"),1,1/0),t.ideal!==void 0&&Nt(t.ideal,"".concat(e,".ideal"),1,1/0)}else Nt(t,e,1,1/0)}function Se(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new I(f.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!__(t,i,n,r))throw new I(f.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(i,",").concat(n,"].").concat(r?" ASCII characters only.":""))}function _n(t,e){if(!Array.isArray(t))throw new I(f.INVALID_PARAMS,"".concat(e," should be an array"))}function Ud(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw _.error("Invalid Channel Name ".concat(t)),new I(f.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function xd(t){if(e=t,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||__(t,1,255)))throw _.error("Invalid UID ".concat(t," ").concat(typeof t)),new I(f.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof t=="string"&&_.warning("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}function Pt(t){return t==null}function __(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,n=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=i&&t.length>=e&&(!n||aw(t))}function sw(t){return typeof t=="number"&&t%1==0}function aw(t){if(typeof t!="string")return!1;for(let e=0;e<t.length;e+=1){const i=t.charCodeAt(e);if(i<0||i>255)return!1}return!0}let m_,f_,ge;(function(t){t.FREE="free",t.UPLOADING="uploading"})(m_||(m_={})),function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}(f_||(f_={})),function(t){t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata"}(ge||(ge={}));const Vd={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};function cw(t){return Se(t.reportId,"params.reportId",0,100,!1),Se(t.category,"params.category",0,100,!1),Se(t.event,"params.event",0,100,!1),Se(t.label,"params.label",0,100,!1),Nt(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}const dw={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let Te,Ut,S_,Fd,$t,Mt,ar,mn,Vr,Ro,ai,Re,K,jd,_t,nt,Be,gt,B,q,Je,et,g_,Xe;function T_(t){return Nt(t.timeout,"config.timeout",0,1e5),Nt(t.timeoutFactor,"config.timeoutFactor",0,100,!1),Nt(t.maxRetryCount,"config.maxRetryConfig",0,1/0),Nt(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function uw(t){return ce(t.codec,"config.codec",["vp8","vp9","av1","h264"]),ce(t.mode,"config.mode",["rtc","live"]),t.audioCodec!==void 0&&ce(t.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),t.proxyServer!==void 0&&Se(t.proxyServer,"config.proxyServer",1,1e4),t.turnServer!==void 0&&R_(t.turnServer),t.httpRetryConfig!==void 0&&T_(t.httpRetryConfig),t.websocketRetryConfig!==void 0&&T_(t.websocketRetryConfig),!0}function Io(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function R_(t){return Se(t.turnServerURL,"turnServerURL"),Se(t.username,"username"),Se(t.password,"password"),t.udpport&&Nt(t.udpport,"udpport",1,99999,!0),t.forceturn&&To(t.forceturn,"forceturn"),t.security&&To(t.security,"security"),t.tcpport&&Nt(t.tcpport,"tcpport",1,99999,!0),!0}function I_(t){return t.level!==void 0&&ce(t.level,"level",[1,2,3]),!0}(function(t){t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics"})(Te||(Te={})),function(t){t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed"}(Ut||(Ut={})),function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(S_||(S_={})),function(t){t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(Fd||(Fd={})),function(t){t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.DATACHANNEL_FAILBACK="Client._datachannelFailback",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",t.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage"}($t||($t={})),function(t){t.TRACER="tracer"}(Mt||(Mt={})),function(t){t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND"}(ar||(ar={})),function(t){t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(mn||(mn={})),function(t){t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(Vr||(Vr={})),function(t){t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(Ro||(Ro={})),function(t){t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(ai||(ai={})),function(t){t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(Re||(Re={})),function(t){t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(K||(K={})),function(t){t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(jd||(jd={})),function(t){t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.FALLBACK="FALLBACK",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL"}(_t||(_t={})),function(t){t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.INJECT_STREAM_STATUS="stream-inject-status",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result"}(nt||(nt={})),function(t){t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK"}(Be||(Be={})),function(t){t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed"}(gt||(gt={})),function(t){t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_CONNECTING="datachannel_connecting",t.DATACHANNEL_FAILBACK="datachannel_failback"}(B||(B={})),function(t){t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.SUBSCRIBE="subscribe",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter"}(q||(q={})),function(t){t.PUBLISH_STATS="publish_stats",t.PUBLISH_RELATED_STATS="publish_related_stats",t.SUBSCRIBE_STATS="subscribe_stats",t.SUBSCRIBE_RELATED_STATS="subscribe_related_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.TRANSPORT_STATS="transport_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats"}(Je||(Je={})),function(t){t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list"}(et||(et={})),function(t){t.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",t.NEED_ANSWER="NEED_ANSWER",t.NEED_RENEGOTIATE="NEED_RENEGOTIATE",t.P2P_LOST="P2P_LOST",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NEED_UNPUB="NEED_UNPUB",t.NEED_UNSUB="NEED_UNSUB",t.NEED_UPLOAD="NEED_UPLOAD",t.NEED_CONTROL="NEED_CONTROL",t.START_RECONNECT="START_RECONNECT",t.END_RECONNECT="END_RECONNECT",t.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(g_||(g_={})),function(t){t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source"}(Xe||(Xe={}));const Bd={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,currentPacketLossRate:0},Gd={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},v_={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},lw={uplinkNetworkQuality:0,downlinkNetworkQuality:0},C_={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let $,te,Pn;(function(t){t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"})($||($={})),function(t){t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t.INJECT="inject_streaming"}(te||(te={})),function(t){t[t.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",t[t.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",t[t.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",t[t.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",t[t.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",t[t.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",t[t.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",t[t.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",t[t.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(Pn||(Pn={}));const hw={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Wd={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Hd(t,e){Se(t.url,"".concat(e,".url"),1,1e3,!1),Pt(t.x)||Nt(t.x,"".concat(e,".x"),0,1e4),Pt(t.y)||Nt(t.y,"".concat(e,".y"),0,1e4),Pt(t.width)||Nt(t.width,"".concat(e,".width"),0,1e4),Pt(t.height)||Nt(t.height,"".concat(e,".height"),0,1e4),Pt(t.zOrder)||Nt(t.zOrder,"".concat(e,".zOrder"),0,255),Pt(t.alpha)||Nt(t.alpha,"".concat(e,".alpha"),0,1,!1)}const pw={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Ew={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};let ki,Fr,Wt,y_,Ue,Ki,Ge,Ln,ee,kt,qt,qs,J,re,Kd,Yd,kn,jr,at;function A_(t){if(!t.channelName)throw new I(f.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new I(f.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&Se(t.token,"info.token",1,2047),xd(t.uid),Ud(t.channelName),!0}function O_(t){return ce(t,"mediaSource",["screen","window","application"]),!0}(function(t){t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.INJECT_STREAM_STATUS="@live_uap-inject-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address"})(ki||(ki={})),function(t){t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(Fr||(Fr={})),function(t){t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(Wt||(Wt={})),function(t){t.CONNECT_FAILED="connect failed",t.CONNECT_TIMEOUT="connect timeout",t.WS_DISCONNECTED="websocket disconnected",t.REQUEST_TIMEOUT="request timeout",t.REQUEST_FAILED="request failed",t.WAIT_STATUS_TIMEOUT="wait status timeout",t.WAIT_STATUS_ERROR="wait status error",t.BAD_STATE="bad state",t.WS_ABORT="ws abort",t.AP_REQUEST_TIMEOUT="AP request timeout",t.AP_JSON_PARSE_ERROR="AP json parse error",t.AP_REQUEST_ERROR="AP request error",t.AP_REQUEST_ABORT="AP request abort"}(y_||(y_={})),function(t){t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile"}(Ue||(Ue={})),function(t){t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(Ki||(Ki={})),function(t){t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(Ge||(Ge={})),function(t){t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(Ln||(Ln={})),function(t){t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low"}(ee||(ee={})),function(t){t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_FAILBACK="datachannel_failback",t.RESET_SIGNAL="reset-signal"}(kt||(kt={})),function(t){t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data"}(qt||(qt={})),function(t){t[t.websocket=0]="websocket",t[t.datachannel=1]="datachannel"}(qs||(qs={})),function(t){t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track"}(J||(J={})),function(t){t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream"}(re||(re={})),function(t){t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM"}(Kd||(Kd={})),function(t){t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY"}(Yd||(Yd={})),function(t){t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed"}(kn||(kn={})),function(t){t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(jr||(jr={})),function(t){t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS"}(at||(at={}));const _w=[at.AFRICA,at.ASIA,at.CHINA,at.EUROPE,at.GLOBAL,at.INDIA,at.JAPAN,at.NORTH_AMERICA,at.OCEANIA,at.OVERSEA,at.SOUTH_AMERICA];let de;(function(t){t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL"})(de||(de={}));const Js={CHINA:{},ASIA:{CODE:de.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:de.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:de.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:de.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","	uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:de.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:de.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:de.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:de.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:de.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:de.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:de.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:de.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:de.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};let vo,b_,Z,F,oe,lt,we,Mn,Ie,ze,ci,di,ie,en,xt;Od&&(Js.CHINA={CODE:de.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(t){t.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(vo||(vo={}));class Xs extends Gt{constructor(e,i){super(),h(this,"onICEConnectionStateChange",void 0),h(this,"onConnectionStateChange",void 0),h(this,"onDTLSTransportStateChange",void 0),h(this,"onDTLSTransportError",void 0),h(this,"onICETransportStateChange",void 0),h(this,"onFirstAudioReceived",void 0),h(this,"onFirstVideoReceived",void 0),h(this,"onFirstAudioDecoded",void 0),h(this,"onFirstVideoDecoded",void 0),h(this,"onFirstVideoDecodedTimeout",void 0),h(this,"onSelectedLocalCandidateChanged",void 0),h(this,"onSelectedRemoteCandidateChanged",void 0),h(this,"establishPromise",void 0)}}(function(t){t.SEND="sendonly",t.RECV="recvonly",t.SENDRECV="sendrecv",t.INACTIVE="inactive"})(b_||(b_={})),function(t){t.VIDEO="video",t.AUDIO="audio"}(Z||(Z={})),function(t){t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack"}(F||(F={})),function(t){t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected"}(oe||(oe={})),function(t){t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState"}(lt||(lt={})),function(t){t.ONLINE="ONLINE",t.OFFLINE="OFFLINE"}(we||(we={})),function(t){t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE"}(Mn||(Mn={})),function(t){t.ON_TRACK="on_track",t.ON_NODE="on_node"}(Ie||(Ie={})),function(t){t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints"}(ze||(ze={})),function(t){t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED"}(ci||(ci={})),function(t){t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED"}(di||(di={})),function(t){t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(ie||(ie={})),function(t){t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK"}(en||(en={})),function(t){t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback"}(xt||(xt={}));const xe={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1};function le(){return xe}let se;(function(t){t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"})(se||(se={}));var mw=no,Co=Array.isArray||function(t){return mw(t)=="Array"},fw=Et,w_=Co,Sw=vc,gw=Ni,Tw=fe("species"),N_=fw.Array,Rw=function(t){var e;return w_(t)&&(e=t.constructor,(Sw(e)&&(e===N_||w_(e.prototype))||gw(e)&&(e=e[Tw])===null)&&(e=void 0)),e===void 0?N_:e},D_=function(t,e){return new(Rw(t))(e===0?0:e)},Iw=so,vw=ka,Cw=Cn,yw=yn,Aw=D_,P_=ue([].push),Un=function(t){var e=t==1,i=t==2,n=t==3,r=t==4,o=t==6,s=t==7,a=t==5||o;return function(c,d,u,l){for(var E,m,T=Cw(c),g=vw(T),R=Iw(d,u),y=yw(g),A=0,P=l||Aw,H=e?P(c,y):i||s?P(c,0):void 0;y>A;A++)if((a||A in g)&&(m=R(E=g[A],A,T),t))if(e)H[A]=m;else if(m)switch(t){case 3:return!0;case 5:return E;case 6:return A;case 2:P_(H,E)}else switch(t){case 4:return!1;case 7:P_(H,E)}return o?-1:n||r?r:H}},L_={forEach:Un(0),map:Un(1),filter:Un(2),some:Un(3),every:Un(4),find:Un(5),findIndex:Un(6),filterReject:Un(7)},Ow=L_.forEach,k_=za("forEach")?[].forEach:function(t){return Ow(this,t,arguments.length>1?arguments[1]:void 0)};Fe({target:"Array",proto:!0,forced:[].forEach!=k_},{forEach:k_});var bw=An("Array").forEach,ww=bn,Nw=ei,Dw=_i,Pw=bw,qd=Array.prototype,Lw={DOMTokenList:!0,NodeList:!0},kw=function(t){var e=t.forEach;return t===qd||Dw(qd,t)&&e===qd.forEach||Nw(Lw,ww(t))?Pw:e},Mw=Cn,M_=sc;Fe({target:"Object",stat:!0,forced:Tt(function(){M_(1)})},{keys:function(t){return M_(Mw(t))}});var Uw=vn.Object.keys,xw=Bl,Vw=Fe,Fw=Co,jw=ue([].reverse),U_=[1,2];Vw({target:"Array",proto:!0,forced:String(U_)===String(U_.reverse())},{reverse:function(){return Fw(this)&&(this.length=this.length),jw(this)}});var Bw=An("Array").reverse,Gw=_i,Ww=Bw,Jd=Array.prototype,Hw=function(t){var e=t.reverse;return t===Jd||Gw(Jd,t)&&e===Jd.reverse?Ww:e},Kw=Tt,Yw=fr,qw=fe("species"),x_=function(t){return Yw>=51||!Kw(function(){var e=[];return(e.constructor={})[qw]=function(){return{foo:1}},e[t](Boolean).foo!==1})},Jw=Fe,Xw=Et,V_=Co,zw=vc,Qw=Ni,F_=ec,Zw=yn,$w=In,tN=Nd,eN=fe,iN=Cc,nN=x_("slice"),rN=eN("species"),Xd=Xw.Array,oN=Math.max;Jw({target:"Array",proto:!0,forced:!nN},{slice:function(t,e){var i,n,r,o=$w(this),s=Zw(o),a=F_(t,s),c=F_(e===void 0?s:e,s);if(V_(o)&&(i=o.constructor,(zw(i)&&(i===Xd||V_(i.prototype))||Qw(i)&&(i=i[rN])===null)&&(i=void 0),i===Xd||i===void 0))return iN(o,a,c);for(n=new(i===void 0?Xd:i)(oN(c-a,0)),r=0;a<c;a++,r++)a in o&&tN(n,r,o[a]);return n.length=r,n}});var sN=An("Array").slice,aN=_i,cN=sN,zd=Array.prototype,dN=function(t){var e=t.slice;return t===zd||aN(zd,t)&&e===zd.slice?cN:e};function w(t,e,i,n,r){var o,s,a,c={};return kw(o=Uw(n)).call(o,function(d){c[d]=n[d]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=xw(s=Hw(a=dN(i).call(i)).call(a)).call(s,function(d,u){return u(t,e,d)||d},c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0&&(OE(t,e,c),c=null),c}var uN=An("Array").keys,lN=bn,hN=ei,pN=_i,EN=uN,Qd=Array.prototype,_N={DOMTokenList:!0,NodeList:!0},cr=function(t){var e=t.keys;return t===Qd||pN(Qd,t)&&e===Qd.keys||hN(_N,lN(t))?EN:e};function j_(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function B_(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?j_(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):j_(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let zs=0,Zd=0;function Yi(t,e,i,n){return new V((r,o)=>{e.timeout=e.timeout||C("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),zs+=Yr(e.data)):i&&(e.data.size?zs+=e.data.size:e.data instanceof FormData?zs+=function(s){let a=0;return/DingTalk/i.test(navigator.userAgent)&&s.realFormData&&(s=s.realFormData),s.forEach(c=>{a+=typeof c=="string"?Yr(c):c.size}),a+138}(e.data):zs+=Yr(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,Pi.request(e).then(s=>{typeof s.data=="string"?Zd+=Yr(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Zd+=s.data.byteLength:Zd+=Yr(JSON.stringify(s.data)),n&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{Pi.isCancel(s)?o(new I(f.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new I(f.NETWORK_TIMEOUT,s.message)):s.response?o(new I(f.NETWORK_RESPONSE_ERROR,s.response.status)):o(new I(f.NETWORK_ERROR,s.message))})})}async function mN(t,e){const i=new Blob([e.data],{type:"buffer"});return await Yi(t,B_(B_({},e),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}const Jt=new class extends Gt{set networkState(t){_.info("[".concat(this._moduleName,"]")+"network state changed, "+this._networkState+" -> "+t),this.emit(Mn.NETWORK_STATE_CHANGE,t,this._networkState),t===we.ONLINE?this.emit(Mn.ONLINE):t===we.OFFLINE&&(this.onlineWaiter=new V(e=>{this.once(Mn.ONLINE,()=>{this.onlineWaiter=void 0,e(we.ONLINE)})}),this.emit(Mn.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}constructor(){super(),h(this,"_moduleName","network-indicator"),h(this,"_networkState",we.ONLINE),h(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=we.ONLINE}),window.addEventListener("offline",()=>{this.networkState=we.OFFLINE})}};let $d=!1;const ui=new class extends Gt{constructor(){super(...arguments),h(this,"onAutoplayFailed",void 0),h(this,"onAudioAutoplayFailed",void 0)}};function G_(){if(Rt(),!$d){const t=e=>{e.preventDefault(),$d=!1,mo()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};$d=!0,mo()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),_.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),ui.onAutoplayFailed?ui.onAutoplayFailed():ui.onAudioAutoplayFailed?_.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):_.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),ui.emit("autoplay-failed")}}function tu(t){return new TextEncoder().encode(t)}const W_=function(t,e){const i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i},fN=async t=>function(e,i){let n="";return new Uint8Array(e).forEach(r=>{n+=r.toString(i).padStart(2,"0")}),n}(await crypto.subtle.digest("SHA-256",tu(t)),16);function H_(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function tt(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?H_(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):H_(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function Y(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,i,n){const r=n.value;if(typeof r=="function"){const o=t.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);n.value=function(){for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];let d=a;if(t.argsMap)try{d=t.argsMap(this,...a)}catch(l){_.warning(l),d=[]}try{JSON.stringify(d)}catch{_.warning("arguments for method ".concat(o,".").concat(i," not serializable for apiInvoke.")),d=[]}const u=(t.report||G).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(i),options:d,tag:Mt.TRACER,reportResult:t.reportResult},t.throttleTime);try{const l=r.apply(this,a);return l instanceof V?l.then(E=>(u.onSuccess(t.reportResult&&E),E)).catch(E=>{throw u.onError(E),E}):(u.onSuccess(t.reportResult&&l),l)}catch(l){throw u.onError(l),l}}}return n}}const G=new class{constructor(){h(this,"baseInfoMap",new Map),h(this,"proxyServer",void 0),h(this,"clientList",or),h(this,"eventUploadTimer",void 0),h(this,"setSessionIdTimer",void 0),h(this,"url",void 0),h(this,"backupUrl",void 0),h(this,"_appId",void 0),h(this,"keyEventUploadPendingItems",[]),h(this,"normalEventUploadPendingItems",[]),h(this,"apiInvokeUploadPendingItems",[]),h(this,"apiInvokeCount",0),h(this,"ltsList",[]),h(this,"lastSendNormalEventTime",Date.now()),h(this,"customReportCounterTimer",void 0),h(this,"customReportCount",0),h(this,"extApiInvoke",async t=>{for(const e of t){const i=tt(tt({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Mt.TRACER});this.sendApiInvoke(i)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),C("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),C("EVENT_REPORT_SEND_INTERVAL"))}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void _.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));const e=this.baseInfoMap.get(t),i=Date.now(),n=e.startTime;e.startTime=i,_.debug("rewrite session ".concat(t," startTime: ").concat(i," , ").concat(i-n,"ms")),this.baseInfoMap.set(t,e)}setAppId(t){this._appId=t}reportApiInvoke(t,e,i){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;const n=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,o=()=>({tag:e.tag,invokeId:r,sid:t,name:e.name,apiInvokeTime:n,options:e.options,states:e.states||null}),s=!!C("SHOW_REPORT_INVOKER_LOG");s&&_.info("".concat(e.name," start"),e.options);let a=!1;Ce(e.timeout).then(()=>{a||(this.sendApiInvoke(tt(tt({},o()),{},{error:f.API_INVOKE_TIMEOUT,success:!1})),_.debug("".concat(e.name," timeout")))});const c=new I(f.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:d=>{const u=()=>{if(a)throw c;return a=!0,this.sendApiInvoke(tt(tt({},o()),{},{success:!0},e.reportResult&&{result:d})),s&&_.info("".concat(e.name," onSuccess")),d};return i?sf(u,e.name+"Success",i,()=>a=!0):u()},onError:d=>{const u=()=>{if(a)throw d;a=!0,this.sendApiInvoke(tt(tt({},o()),{},{success:!1,error:d})),s&&_.info("".concat(e.name," onFailure"),d.toString())};return i?sf(u,e.name+"Error",i,()=>a=!0):u()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const i=Date.now(),n=this.createBaseInfo(t,i);n.cname=e.cname;const r=Object.assign({},{willUploadConsoleLog:C("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Od?"global":"oversea",areas:C("AREAS")&&C("AREAS").join(",")},e.extend),o=Date.now(),s=tt(tt({},n),{},{eventType:Te.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,build:Ad,lts:o,elapse:o-i,extend:JSON.stringify(r),mode:e.mode,process:C("PROCESS_ID"),appType:C("APP_TYPE"),success:!0,version:gi});this.send({type:Ut.SESSION,data:s},!0)}joinChooseServer(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt({},n),{},{eventType:Te.JOIN_CHOOSE_SERVER,lts:r,eventElapse:r-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:r-i.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3});this.send({type:Ut.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt({},n),{},{eventType:Te.REQ_USER_ACCOUNT,lts:r,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:r-i.startTime,eventElapse:r-e.lts,extend:JSON.stringify(e.extend)});this.send({type:Ut.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info;e.vid&&(n.vid=e.vid),n.uid=e.uid,n.cid=e.cid;const r=Date.now(),{firstSuccess:o,avoidJoinStartTime:s,isProxy:a,addr:c}=e,d=r-(o&&s?s:i.startTime),u=tt(tt({},n),{},{eventType:Te.JOIN_GATEWAY,lts:r,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,elapse:d,eventElapse:r-e.lts,firstSuccess:o,signalChannel:e.signalChannel}),l=u.success?1:0;if(e.succ&&(i.lastJoinSuccessTime=r),o)this.send({type:Ut.JOIN_GATEWAY,data:u},!0);else{let E;if(c)if(a){const T=c.match(/h=(\d{1,3}-){3}\d{1,3}/g),g=c.match(/p=[0-9]{1,6}/g);E={isSuccess:l,gatewayIp:T&&T.length?T[0].split("=")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split("=")[1]:"",isProxy:a?1:0}}else{const T=c.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),g=c.match(/:[0-9]{1,6}/g);E={isSuccess:l,gatewayIp:T&&T.length?T[0].split("//")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split(":")[1]:"",isProxy:a?1:0}}else E={isSuccess:l,gatewayIp:"",port:"",isProxy:a?1:0};delete u.success,delete u.eventType,delete u.firstSuccess,u.vid=Number(u.vid);const m=Object.assign({},u,E,{eventType:Te.REJOIN_GATEWAY});this.send({type:Ut.RE_JOIN_GATEWAY,data:m},!0)}}joinChannelTimeout(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=Date.now(),r=tt(tt({},i.info),{},{lts:n,timeout:e,elapse:n-i.startTime});this.send({type:Ut.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt({},n),{},{eventType:Te.PUBLISH,lts:r,eventElapse:e.eventElapse,elapse:r-i.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:Ut.PUBLISH,data:o},!0)}subscribe(t,e,i){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,o=Date.now(),s=tt(tt({},r),{},{eventType:Te.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-n.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?s.peerSuid=e.peerid:s.peer=e.peerid,this.send({type:Ut.SUBSCRIBE,data:s},!0)}wsCompressorInit(t){var e;const i=[...cr(e=this.baseInfoMap).call(e)],n=i.length?i[0]:"UnableToGetSid",r=this.baseInfoMap.get(n);if(!r)return;const o=r.info,s=Date.now(),a=tt(tt({},o),{},{eventType:Te.WS_COMPRESSOR_INIT,lts:s,eventElapse:t.eventElapse,elapse:s-r.startTime,status:t.status?1:2});this.send({type:Ut.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(t,e,i,n){const r=this.baseInfoMap.get(t);if(!r)return;const o=r.info,s=Date.now(),a=tt(tt(tt({},o),n),{},{elapse:s-r.startTime,eventType:e,lts:s,firstDecodeFrame:Math.max(s-r.startTime,0),apEnd:Math.max(n.apEnd-r.startTime,0),apStart:Math.max(n.apStart-r.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-r.startTime,0),joinGwStart:Math.max(n.joinGwStart-r.startTime,0),pcEnd:Math.max(n.pcEnd-r.startTime,0),pcStart:Math.max(n.pcStart-r.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-r.startTime,0),subscriberStart:Math.max(n.subscriberStart-r.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-r.startTime,0)});this.send({type:i,data:a},!0)}firstRemoteFrame(t,e,i,n){const r=this.baseInfoMap.get(t);if(!r)return;const o=r.info,s=Date.now(),a=tt(tt(tt({},o),n),{},{elapse:s-r.startTime,eventType:e,lts:s});this.send({type:i,data:a},!0)}onGatewayStream(t,e,i,n){const r=this.baseInfoMap.get(t);if(!r)return;const o=r.info,s=Date.now(),a=tt(tt(tt({},o),n),{},{eventType:e,lts:s});this.send({type:i,data:a},!0)}streamSwitch(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt({},n),{},{eventType:Te.STREAM_SWITCH,lts:r,isDual:e.isdual,elapse:r-i.startTime,success:e.succ});this.send({type:Ut.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt({},n),{},{eventType:Te.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-e.lts,elapse:r-i.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Ut.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt({},n),{},{eventType:Te.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-e.lts,elapse:r-i.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Ut.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,t?_.debug("reportProxyServerurl: ".concat(t)):_.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt({},n),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:r,elapse:r-i.startTime,joinChannelSuccessElapse:r-(i.lastJoinSuccessTime||r),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:Ut.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now();(function(o,s,a){const c=o[s];if(!c||typeof c!="string")return[o];o[s]="";const d=Yr(JSON.stringify(o));let u=0;const l=[];let E=0;for(let m=0;m<c.length;m++)E+=c.charCodeAt(m)<=127?1:3,E<=a-d||(l[l.length]=lr(lr({},o),{},{[s]:c.substring(u,m)}),u=m,E=c.charCodeAt(m)<=127?1:3);return u!==c.length-1&&(l[l.length]=lr(lr({},o),{},{[s]:c.substring(u)})),l})(tt(tt(tt({},n),e),{},{elapse:r-i.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach(o=>this.send({type:Ut.WORKER_EVENT,data:o},!0))}apworkerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt(tt({},n),e),{},{elapse:r-i.startTime,lts:r});this.send({type:Ut.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt(tt({},n),e),{},{elapse:r-i.startTime,lts:r,extend:e.extend||void 0});this.send({type:Ut.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),o=tt(tt(tt({},n),e),{},{elapse:r-i.startTime,lts:r});this.send({type:Ut.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>C("CUSTOM_REPORT_LIMIT"))throw new I(f.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const i=Date.now(),n=e.map(r=>({type:Ut.USER_ANALYTICS,data:tt(tt({sid:t},r),{},{lts:i})}));try{C("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(r){throw _.error("send custom report message failed",r.toString()),new I(f.CUSTOM_REPORT_SEND_FAILED,r.message)}}autoplayFailed(t,e,i,n){if(!t)return;const r=this.baseInfoMap.get(t);if(!r)return;const o=r.info,s=Date.now(),a=tt(tt({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:ui.onAutoplayFailed||ui.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:e,trackId:n,extend:void 0});this.send({type:Ut.AUTOPLAY_FAILED,data:a},!0)}sendApiInvoke(t){const e=C("NOT_REPORT_EVENT");if(t.tag&&e.includes&&e.includes(t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;const i=this.baseInfoMap.get(t.sid);if(!i)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:n,uid:r,cid:o}=i.info;t.lts=t.lts||Date.now();let s;if(t.error)if(t.error instanceof I){const{code:c,message:d}=t.error;s=c||d||t.error.toString()}else s=t.error.toString();const a={invokeId:t.invokeId,sid:t.sid,cname:n,cid:o,uid:r,lts:t.lts,success:t.success,elapse:t.lts-i.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?s:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:Ut.API_INVOKE,data:a},!1),!0}appendSessionId(){this.clientList.forEach(t=>{if(t._sessionId){const e=this.apiInvokeUploadPendingItems.length;for(let i=0;i<e;i++){const n=this.apiInvokeUploadPendingItems.shift();n&&(n.sid=t._sessionId,this.sendApiInvoke(Object.assign({},n)))}}})}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>C("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const i=[],n=[];for(;t.length;){const o=t.shift();i.length<20?i.push(o):n.push(o)}t.push(...n);for(const o of[...i]){var r;this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),kd(r=this.ltsList).call(r,(s,a)=>s-a))}return e||(this.lastSendNormalEventTime=Date.now()),C("ENABLE_EVENT_REPORT")&&i.length&&(C("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((o=>s=>{C("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>C("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-C("NORMAL_EVENT_QUEUE_CAPACITY")),_.warning("report: drop normal events"))))})(i)),t}async postDataToStatsCollector2(t){Jt.networkState===we.OFFLINE&&await V.race([Jt.onlineWaiter,Ce(2*ne.maxRetryTimeout)]);const e=r=>{let o=new Uint8Array;return r.forEach(s=>{const a=tu(JSON.stringify(s.data)),c=new ArrayBuffer(5),d=(l=>{let E=0;return Object.entries(Ut).forEach(m=>{let[T,g]=m;g===l.type&&(E=Fd[T])}),E})(s),u=new DataView(c);u.setUint16(0,a.byteLength,!0),u.setUint8(2,255&d),u.setUint8(3,d>>>8&255),u.setUint8(4,d>>>16&255),o=W_(o,new Uint8Array(c)),o=W_(o,a)}),o},i="event";let n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(C("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let r=0;r<2;r+=1){r===1&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(C("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await Yi(n,{timeout:1e4,data:e(t),headers:tt(tt({token:"32f24ab2ddb74f508aa9286c356cec84",biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(o){if(r===1)throw o;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(o=>JSON.stringify(o)),vid:(o=>{const s=o&&o.data.sid&&this.baseInfoMap.get(o.data.sid);return s&&s.info.vid&&+s.info.vid||0})(t[0])};Jt.networkState===we.OFFLINE&&await V.race([Jt.onlineWaiter,Ce(2*ne.maxRetryTimeout)]);const n=e?"/events/proto-raws":"/events/messages";let r=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("EVENT_REPORT_DOMAIN"),"&p=").concat(C("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(C("EVENT_REPORT_DOMAIN"),":").concat(C("STATS_COLLECTOR_PORT")).concat(n));for(let o=0;o<2;o+=1){o===1&&(r=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(C("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(C("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(C("STATS_COLLECTOR_PORT")).concat(n)));try{e?await mN(r,{timeout:1e4,data:i}):await Yi(r,{timeout:1e4,data:i})}catch(s){if(o===1)throw s;continue}return}}createBaseInfo(t,e){const i=Object.assign({},dw);return i.sid=t,this.baseInfoMap.set(t,{info:i,startTime:e}),i}reportResourceTiming(t,e){const i=performance.getEntriesByName(t),n=i[i.length-1];n&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:n,tag:Mt.TRACER}).onSuccess()}};Ws.on("REPORT_LOG_UPLOAD",t=>{t.networkState=Jt.networkState,G.reportApiInvoke(null,{name:"logUploadError",options:t,tag:Mt.TRACER})});class K_ extends Gt{constructor(e,i){super(),h(this,"trackMediaType",void 0),h(this,"_ID",void 0),h(this,"_hints",[]),h(this,"_isClosed",!1),h(this,"_originMediaStreamTrack",void 0),h(this,"_mediaStreamTrack",void 0),h(this,"_external",{}),this._ID=i||Lt(8,"track-"),this._originMediaStreamTrack=e,this._mediaStreamTrack=e,function(n){go.includes(n)||go.push(n)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){if(!e){const i=G.reportApiInvoke(null,{name:$t.GET_MEDIA_STREAM_TRACK,options:[],tag:Mt.TRACER});this._mediaStreamTrack&&typeof this._mediaStreamTrack.label=="string"?i.onSuccess(this._mediaStreamTrack.label):i.onSuccess("")}return this._mediaStreamTrack}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,function(e){const i=go.indexOf(e);i!==-1&&go.splice(i,1)}(this),this.emit(kn.CLOSED)}}let ae,SN=1;class Ve{constructor(e){h(this,"lockingPromise",V.resolve()),h(this,"locks",0),h(this,"name",""),h(this,"lockId",void 0),this.lockId=SN++,e&&(this.name=e),_.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let i;this.locks+=1,_.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:""));const n=new V(o=>{i=()=>{this.locks-=1,_.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:"")),o()}}),r=this.lockingPromise.then(()=>i);return this.lockingPromise=this.lockingPromise.then(()=>n),r}}function Br(t,e){return function(i,n,r){const o=r.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const s=this[e];if(!s)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));const a=await s.lock("From ".concat(t,".").concat(n));try{for(var c=arguments.length,d=new Array(c),u=0;u<c;u++)d[u]=arguments[u];return await o.apply(this,d)}finally{a()}},r}}class eu extends K_{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}constructor(e,i){super(e,i),h(this,"_enabled",!0),h(this,"_muted",!1),h(this,"_isExternalTrack",!1),h(this,"_isClosed",!1),h(this,"_enabledMutex",void 0),h(this,"processor",void 0),h(this,"_processorContext",void 0),h(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Ve("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,i;return(e=(i=this._originMediaStreamTrack)===null||i===void 0?void 0:i.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,_.debug("[".concat(this.getTrackId(),"] close")),this.emit(J.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,i){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=n,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop(),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Vt(this,J.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){_.debug("[".concat(this.getTrackId(),"] track ended")),this.emit(kn.TRACK_ENDED)}stateCheck(e,i){if(_.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(i,"]")),To(i,e),this._enabled&&this._muted&&e==="enabled"&&i===!1)throw new I(f.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print();if(!this._enabled&&!this._muted&&e==="muted"&&i===!0)throw new I(f.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function Y_(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}(function(t){t.IOS_15_INTERRUPTION_START="ios15-interruption-start",t.IOS_15_INTERRUPTION_END="ios15-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change"})(ae||(ae={}));const q_=window.AudioContext||window.webkitAudioContext;let li=null;const ct=new class extends Gt{constructor(){super(...arguments),h(this,"prevState",void 0),h(this,"curState",void 0),h(this,"currentTime",void 0),h(this,"currentTimeStuckAt",void 0),h(this,"interruptDetectorTrack",void 0),h(this,"onLocalAudioTrackMute",()=>{_.info("ios15-interruption-start"),this.emit(ae.IOS_15_INTERRUPTION_START)}),h(this,"onLocalAudioTrackUnmute",async()=>{_.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?_.info("ios15-interruption-end-canceled"):(li&&await li.suspend(),this.emit(ae.IOS_15_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){_.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){_.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function gN(){if(!q_)return void _.error("your browser is not support web audio");_.info("create audio context");const t=function(e){for(var i=1;i<arguments.length;i++){var n=arguments[i]!=null?arguments[i]:{};i%2?Y_(Object(n),!0).forEach(function(r){h(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Y_(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}({},C("WEBAUDIO_INIT_OPTIONS"));_.debug("audio context init option:",JSON.stringify(t)),li=new q_(t),ct.curState=li.state,li.onstatechange=()=>{ct.prevState=ct.curState,ct.curState=li?li.state:void 0,(ke()||$i())&&ct.prevState==="running"&&ct.curState==="interrupted"&&(_.info("ios-interruption-start"),ct.emit(ae.IOS_INTERRUPTION_START)),(ke()||$i())&&ct.prevState==="interrupted"&&ct.curState==="running"&&(_.info("ios-interruption-end"),ct.emit(ae.IOS_INTERRUPTION_END)),ct.prevState!==ct.curState&&(_.debug("AudioContext State Change","".concat(ct.prevState,"=>").concat(ct.curState)),ct.emit(ae.STATE_CHANGE))},setInterval(()=>{var e;const i=(e=li)===null||e===void 0?void 0:e.currentTime;ct.currentTime!==i?(ct.currentTimeStuckAt&&(_.debug("AudioContext current time resume at ".concat(i)),ct.currentTimeStuckAt=void 0),ct.currentTime=i):(i!==ct.currentTimeStuckAt&&(G.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:i},tag:Mt.TRACER}).onSuccess(),_.warning("AudioContext current time stuck at ".concat(i))),ct.currentTimeStuckAt=i)},5e3),async function(e){const i=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let n,r=!1,o=!1,s=!1;function a(R){e.state==="running"?c(!1):ke()||$i()?e.state==="suspended"&&(c(!0),R&&e.resume().then(u,u)):e.state!=="closed"&&(c(!0),R&&e.resume().then(u,u))}function c(R){if(r!==R){r=R;for(let y=0,A=i;y<A.length;y+=1){const P=A[y];R?window.addEventListener(P,l,{capture:!0,passive:!0}):window.removeEventListener(P,l,{capture:!0,passive:!0})}}}function d(){a(!0)}function u(){a(!1)}function l(){a(!0)}function E(R){if(!s)if(n.paused)if(R){m(!1),s=!0;let y;try{y=n.play(),y?y.then(T,T):(n.addEventListener("playing",T),n.addEventListener("abort",T),n.addEventListener("error",T))}catch{T()}}else m(!0);else m(!1)}function m(R){if(o!==R){o=R;for(let y=0,A=i;y<A.length;y++){const P=A[y];R?window.addEventListener(P,g,{capture:!0,passive:!0}):window.removeEventListener(P,g,{capture:!0,passive:!0})}}}function T(){n.removeEventListener("playing",T),n.removeEventListener("abort",T),n.removeEventListener("error",T),s=!1,E(!1)}function g(){E(!0)}if(ke()){const R=e.createMediaStreamDestination(),y=document.createElement("div");y.innerHTML="<audio x-webkit-airplay='deny'></audio>",n=y.children.item(0),n.controls=!1,n.disableRemotePlayback=!0,n.preload="auto",n.srcObject=R.stream,E(!0)}ct.on(ae.STATE_CHANGE,d),a(!1)}(li)}function Gr(){if(!li){if(gN(),!li)throw new I(f.NOT_SUPPORTED,"can not create audio context");return li}return li}function J_(){return!!li}function dr(t){if(function(){if(iu!==null)return iu;const n=Gr(),r=n.createBufferSource(),o=n.createGain(),s=n.createGain();r.connect(o),r.connect(s),r.disconnect(o);let a=!1;try{r.disconnect(o)}catch{a=!0}return r.disconnect(),iu=a,a}())return;const e=t.connect,i=t.disconnect;t.connect=(n,r,o)=>(t._inputNodes||(t._inputNodes=[]),t._inputNodes.includes(n)||(n instanceof AudioNode?(t._inputNodes.push(n),e.call(t,n,r,o)):e.call(t,n,r)),t),t.disconnect=(n,r,o)=>{i.call(t),n?lu(t._inputNodes,n):t._inputNodes=[];for(const s of t._inputNodes)e.call(t,s)}}let iu=null;function X_(t,e){let i=!1;const n=1/e;if(C("DISABLE_WEBAUDIO")){const r=window.setInterval(()=>{i?window.clearInterval(r):t(performance.now()/1e3)},1e3*n)}else{const r=Gr();let o=r.createGain();o.gain.value=0,o.connect(r.destination);const s=()=>{if(i)return void(o=null);const a=r.createOscillator();a.onended=s,a.connect(o),a.start(0),a.stop(r.currentTime+n),t(r.currentTime)};s()}return()=>{i=!0}}class z_{constructor(){h(this,"context",void 0),h(this,"analyserNode",void 0),h(this,"sourceNode",void 0),this.context=Gr(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e==null||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||ke()||$i()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const n=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(n);for(let r=0;r<e.length;++r)e[r]=n[r]/128-1}const i=On(e).call(e,(n,r)=>n+r*r,0)/e.length;return Math.max(10*Math.log10(i)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,i;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(i=this.sourceNode)===null||i===void 0||i.connect(this.analyserNode)}catch{_.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class Q_ extends Gt{get processSourceNode(){return this.sourceNode}set processedNode(e){var i;if(!this.isDestroyed&&this._processedNode!==e){try{var n;(n=this.sourceNode)===null||n===void 0||n.disconnect(this.outputNode)}catch{}(i=this._processedNode)===null||i===void 0||i.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),h(this,"outputNode",void 0),h(this,"outputTrack",void 0),h(this,"isPlayed",!1),h(this,"sourceNode",void 0),h(this,"context",void 0),h(this,"audioBufferNode",void 0),h(this,"destNode",void 0),h(this,"audioOutputLevel",0),h(this,"volumeLevelAnalyser",void 0),h(this,"_processedNode",void 0),h(this,"playNode",void 0),h(this,"isDestroyed",!1),h(this,"onNoAudioInput",void 0),h(this,"isNoAudioInput",!1),h(this,"_noAudioInputCount",0),this.context=Gr(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),dr(this.outputNode),this.volumeLevelAnalyser=new z_}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=i=>{this.emit(Xe.ON_AUDIO_BUFFER,function(n){for(let r=0;r<n.outputBuffer.numberOfChannels;r+=1){const o=n.outputBuffer.getChannelData(r);for(let s=0;s<o.length;s+=1)o[s]=0}return n.inputBuffer}(i))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!le().webAudioMediaStreamDest)throw new I(f.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&Ui(()=>{ct.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;ke()||$i()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const i=this.volumeLevelAnalyser.getAnalyserNode();let n;i.getFloatTimeDomainData?(n=new Float32Array(i.fftSize),i.getFloatTimeDomainData(n)):(n=new Uint8Array(i.fftSize),i.getByteTimeDomainData(n));let r=!1;for(let o=0;o<n.length;o++)n[o]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await Ce(200),await this.checkHasAudioInput(e?e+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,i;(e=this.processedNode)===null||e===void 0||e.disconnect(),(i=this.sourceNode)===null||i===void 0||i.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class nu extends Q_{get isFreeze(){return!1}constructor(e,i,n){var r;if(super(),h(this,"sourceNode",void 0),h(this,"track",void 0),h(this,"clonedTrack",void 0),h(this,"audioElement",void 0),h(this,"isCurrentTrackCloned",!1),h(this,"isRemoteTrack",!1),h(this,"originVolumeLevelAnalyser",void 0),h(this,"rebuildWebAudio",async()=>{if(_.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void _.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>_.info("resume success")),_.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),dr(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),dr(this.outputNode),this.emit(Xe.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new I(f.UNEXPECTED_ERROR);this.track=e;const o=new MediaStream([this.track]);if(this.isRemoteTrack=!!i,this.sourceNode=this.context.createMediaStreamSource(o),dr(this.sourceNode),n){const a=n.clone();a.enabled=!0,this.clonedTrack=a,_.debug("create an unmuted track ".concat(a.id," from the original track ").concat(n.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));dr(c),this.originVolumeLevelAnalyser=new z_,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;const s=Rt();i&&s.os===be.IOS&&Number((r=s.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(ct.on(ae.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const i=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(i),dr(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Xe.UPDATE_SOURCE),this.audioElement.srcObject=i}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),ct.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const i=e.clone();i.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=i),_.debug("create an unmuted track ".concat(i.id," from the original track ").concat(e.id," to get the volume"));const n=this.context.createMediaStreamSource(new MediaStream([i]));dr(n),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(n)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function Z_(t,e){const i=(r,o)=>r?typeof r!="number"?r.max||r.exact||r.ideal||r.min||o:r:o,n={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:i(e.height,1080),maxWidth:i(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(n.video.mandatory.maxFrameRate=e.frameRate.max,n.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(n.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(n)}async function TN(t){const e=await $_(t.mediaSource),i=await function(n){return new V((r,o)=>{const s=document.createElement("div");s.innerText="share screen",s.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const a=document.createElement("div");a.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const c=document.createElement("div");c.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",c.setAttribute("style","height: 12%;");const d=document.createElement("div");d.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const u=document.createElement("div");u.setAttribute("style","text-align: right; padding: 16px 0;");const l=document.createElement("button");l.innerHTML="cancel",l.setAttribute("style","width: 85px;"),l.onclick=()=>{document.body.removeChild(E);const m=new Error("NotAllowedError");m.name="NotAllowedError",o(m)},u.appendChild(l),a.appendChild(c),a.appendChild(d),a.appendChild(u);const E=document.createElement("div");E.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),E.appendChild(s),E.appendChild(a),document.body.appendChild(E),n.map(m=>{if(m.id){const T=document.createElement("div");T.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let g=m.thumbnail;const{width:R}=g.getSize();R>1920&&(g=g.resize({width:1920})),T.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+g.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+(m.name.replace(/[\u00A0-\u9999<>\&]/g,function(y){return"&#"+y.charCodeAt(0)+";"})+"</span>"),T.onclick=()=>{document.body.removeChild(E),r(m.id)},d.appendChild(T)}})})}(e);return await Z_(i,t)}async function $_(t){let e=["window","screen"];t!=="application"&&t!=="window"||(e=["window"]),t==="screen"&&(e=["screen"]);const i=tm();if(!i)throw new I(f.ELECTRON_IS_NULL);let n=null;try{var r;n=((r=i.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:e}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{n=null}n&&n.then||(n=new V((o,s)=>{i.desktopCapturer.getSources({types:e},(a,c)=>{a?s(a):o(c)})}));try{return await n}catch(o){throw new I(f.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}let Qs=null;function tm(){if(Qs)return Qs;try{return Qs=window.require("electron"),Qs}catch{return null}}function em(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}const ru=new Ve("safari");let im=!1,nm=!1;async function Mi(t,e){let i=0,n=null;for(;i<2;)try{n=await RN(t,e,i>0);break}catch(r){if(r instanceof I)throw _.error("[".concat(e,"] ").concat(r.toString())),r;const o=Zs(r.name||r.code||r,r.message);if(o.code===f.MEDIA_OPTION_INVALID){_.debug("[".concat(e,"] detect media option invalid, retry")),i+=1,await Ce(500);continue}throw _.error("[".concat(e,"] ").concat(o.toString())),o}if(!n)throw new I(f.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n}async function RN(t,e,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new I(f.NOT_SUPPORTED,"can not find getUserMedia");i&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const n=le(),r=new MediaStream;if(t.audioSource&&r.addTrack(t.audioSource),t.videoSource&&r.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return _.debug("Using Video Source/ Audio Source"),r;if(t.screen)if(tm())t.screen.sourceId?Wr(r,await Z_(t.screen.sourceId,t.screen)):Wr(r,await TN(t.screen));else if(od()&&t.screen.extensionId&&t.screen.mandatory){if(!n.getStreamFromExtension)throw new I(f.NOT_SUPPORTED,"This browser does not support screen sharing");_.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const E=await(s=t.screen.extensionId,a=e,new V((m,T)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},g=>{if(!g||!g.streamId)return _.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),g),void T(new I(f.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));m(g.streamId)})}catch(g){_.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),g.toString()),T(new I(f.CHROME_PLUGIN_NOT_INSTALL))}}));t.screen.mandatory.chromeMediaSourceId=E,Wr(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(n.getDisplayMedia){var o;t.screen.mediaSource&&O_(t.screen.mediaSource);const E={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(o=t.screen.displaySurface)!==null&&o!==void 0?o:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:m,surfaceSwitching:T,systemAudio:g}=t.screen,R={selfBrowserSurface:m,surfaceSwitching:T,systemAudio:g};!m&&delete R.selfBrowserSurface,!T&&delete R.surfaceSwitching,!g&&delete R.systemAudio,_.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:E,audio:!!t.screenAudio,controls:R})),Wr(r,await navigator.mediaDevices.getDisplayMedia(function(y){for(var A=1;A<arguments.length;A++){var P=arguments[A]!=null?arguments[A]:{};A%2?em(Object(P),!0).forEach(function(H){h(y,H,P[H])}):Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(P)):em(Object(P)).forEach(function(H){Object.defineProperty(y,H,Object.getOwnPropertyDescriptor(P,H))})}return y}({video:E,audio:!!t.screenAudio},R)))}else{if(!Bt())throw _.error("[".concat(e,"] This browser does not support screenSharing")),new I(f.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&O_(t.screen.mediaSource);const E={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};_.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(E))),Wr(r,await navigator.mediaDevices.getUserMedia(E))}}var s,a;if(!t.video&&!t.audio)return r;let c={video:t.video,audio:t.audio},d=C("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=function E(m,T){if(!af(m)||!af(T)||Array.isArray(m)&&!Array.isArray(T)||!Array.isArray(m)&&Array.isArray(T))return T;if(Array.isArray(T)&&Array.isArray(m)){const g=[...m];for(let R=0;R<T.length;R++)g[R]=E(m[R],T[R]);return g}{const g=lr({},m);for(const R in T)Object.prototype.hasOwnProperty.call(T,R)&&(Object.prototype.hasOwnProperty.call(m,R)?g[R]=E(m[R],T[R]):g[R]=T[R]);return g}}(c,d)}catch{}_.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),Rt();let u,l=null;(Le()||ke()||ks())&&(l=await ru.lock());try{u=await navigator.mediaDevices.getUserMedia(c)}catch(E){throw l&&l(),E}return c.audio&&(im=!0),c.video&&(nm=!0),Wr(r,u),l&&l(),r}function Zs(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new I(f.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new I(f.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new I(f.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new I(f.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new I(f.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new I(f.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return _.error("getUserMedia unexpected error",t),new I(f.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function Wr(t,e){const i=t.getVideoTracks()[0],n=t.getAudioTracks()[0],r=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(n&&t.removeTrack(n),t.addTrack(o)),r&&(i&&t.removeTrack(i),t.addTrack(r))}const hi=new class extends Gt{get state(){return this._state}set state(t){t!==this._state&&(this.emit(mn.STATE_CHANGE,t),this._state=t)}constructor(){super(),h(this,"_state",ar.IDLE),h(this,"isAccessMicrophonePermission",!1),h(this,"isAccessCameraPermission",!1),h(this,"lastAccessMicrophonePermission",!1),h(this,"lastAccessCameraPermission",!1),h(this,"checkdeviceMatched",!1),h(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(C("ENUMERATE_DEVICES_INTERVAL")||cd()&&er())&&this.updateDevicesInfo()},C("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>_.error(t.toString()))}async enumerateDevices(t,e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new I(f.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const n=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(n);let o=!this.isAccessMicrophonePermission&&t,s=!this.isAccessCameraPermission&&e;r.audio&&(o=!1),r.video&&(s=!1);let a=null,c=null,d=null;if(!i&&(o||s)){if(ru.isLocked&&(_.debug("[device manager] wait GUM lock"),(await ru.lock())(),_.debug("[device manager] GUM unlock")),im&&(o=!1,this.isAccessMicrophonePermission=!0),nm&&(s=!1,this.isAccessCameraPermission=!0),_.debug("[device manager] check media device permissions",t,e,o,s),o&&s){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(u){const l=Zs(u.name||u.code||u,u.message);if(l.code===f.PERMISSION_DENIED)throw l;_.warning("getUserMedia failed in getDevices",l)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:t})}catch(u){const l=Zs(u.name||u.code||u,u.message);if(l.code===f.PERMISSION_DENIED)throw l;_.warning("getUserMedia failed in getDevices",l)}this.isAccessMicrophonePermission=!0}else if(s){try{c=await navigator.mediaDevices.getUserMedia({video:e})}catch(u){const l=Zs(u.name||u.code||u,u.message);if(l.code===f.PERMISSION_DENIED)throw l;_.warning("getUserMedia failed in getDevices",l)}this.isAccessCameraPermission=!0}_.debug("[device manager] mic permission",t,"cam permission",e)}try{const u=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach(l=>l.stop()),c&&c.getTracks().forEach(l=>l.stop()),d&&d.getTracks().forEach(l=>l.stop()),a=null,c=null,d=null,u}catch(u){return a&&a.getTracks().forEach(l=>l.stop()),c&&c.getTracks().forEach(l=>l.stop()),d&&d.getTracks().forEach(l=>l.stop()),a=null,c=null,d=null,new I(f.ENUMERATE_DEVICES_FAILED,u.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach(i=>{i.device.label===t&&(e=i.device.deviceId)}),e}async getDeviceById(t){const e=(await this.enumerateDevices(!0,!0,!0)).find(i=>i.deviceId===t);if(!e)throw new I(f.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=ar.INITING;try{await this.updateDevicesInfo(),this.state=ar.INITEND}catch(t){throw _.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=ar.IDLE,!function(){return typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1"}()&&new I(f.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),i=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const r=t.find(s=>s.kind==="audioinput"&&s.deviceId==="default"),o=t.find(s=>s.kind==="audiooutput"&&s.deviceId==="default");r&&o?o.groupId===r.groupId?_.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is the same group")):_.warning("[device-check] default input ".concat(r.label," and output ").concat(o.label," is not the same group")):_.debug("[device-check] default input or output not found")}const n=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(r=>{if(!r.deviceId)return;const o=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){const s={initAt:e,updateAt:e,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),s),i.push(s)}o&&(o.updateAt=e)}),this.deviceInfoMap.forEach((r,o)=>{r.state==="ACTIVE"&&r.updateAt!==e&&(r.state="INACTIVE",i.push(r))}),this.state!==ar.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(mn.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(mn.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(mn.PLAYOUT_DEVICE_CHANGED,r)}}),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const e=t.filter(r=>r.kind==="audioinput"),i=t.filter(r=>r.kind==="videoinput"),n={audio:!1,video:!1};for(const r of e)if(r.label&&r.deviceId){n.audio=!0;break}for(const r of i)if(r.label&&r.deviceId){n.video=!0;break}return n}},IN=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],ii=new class{constructor(){h(this,"onAutoplayFailed",void 0),h(this,"elementMap",new Map),h(this,"elementStateMap",new Map),h(this,"elementsNeedToResume",[]),h(this,"sinkIdMap",new Map),h(this,"autoResumeAfterInterruption",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,i]=t;const n=this.elementStateMap.get(e),r=i.srcObject.getAudioTracks()[0];Nr()?r&&r.readyState==="live"&&ct.curState==="running"&&(_.debug("auto resume after interruption for iOS 15"),i.pause(),i.play()):n&&n==="paused"&&r&&r.readyState==="live"&&ct.curState==="running"&&(_.debug("auto resume after interruption for iOS"),i.play())})}),h(this,"autoResumeAfterInterruptionOnIOS15",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,i]=t;const n=i.srcObject.getAudioTracks()[0];n&&n.readyState==="live"&&(_.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())})}),this.autoResumeAudioElement(),ct.on(ae.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ct.on(ae.IOS_15_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15),ct.on(ae.STATE_CHANGE,()=>{ke()&&ct.prevState==="suspended"&&ct.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(t,e){const i=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),i)try{await i.setSinkId(e)}catch(n){throw new I(f.PERMISSION_DENIED,"can not set sink id: "+n.toString())}}play(t,e,i,n){if(this.elementMap.has(e))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,r),this.elementMap.set(e,r),this.elementStateMap.set(e,ge.INIT),this.setVolume(e,i);const o=this.sinkIdMap.get(e);if(o)try{r.setSinkId(o).catch(a=>{_.warning("[".concat(e,"] set sink id failed"),a.toString())})}catch(a){_.warning("[".concat(e,"] set sink id failed"),a.toString())}const s=r.play();s&&s.then&&s.catch(a=>{n&&G.autoplayFailed(n,"audio",a.message,e),_.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&a.name==="NotAllowedError"&&(_.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),Ui(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),G_()}))})}updateTrack(t,e){const i=this.elementMap.get(t);i&&(i.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)}setVolume(t,e){const i=this.elementMap.get(t);i&&(e=Math.max(0,Math.min(100,e)),i.volume=e/100)}stop(t){const e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;const i=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(i,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){IN.forEach(i=>{e.addEventListener(i,n=>{const r=this.elementStateMap.get(t),o=n.type==="pause"?"paused":n.type;if(_.debug("[".concat(t,"] audio-element-status change ").concat(r," => ").concat(o)),n.type==="error"){const s=e==null?void 0:e.error;s&&_.error("[".concat(t,"] media error, code: ").concat(s.code,", message: ").concat(s.message))}this.elementStateMap.set(t,o)})})}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(i=>{_.debug("Auto resume audio element success")}).catch(i=>{_.warning("Auto resume audio element failed!",i)})}),this.elementsNeedToResume=[]};new V(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{mo()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))})}};function Ht(){return function(t,e,i){const n=i.value;return typeof n=="function"&&(i.value=function(){this._isClosed&&new I(f.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning");for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];const a=n.apply(this,o);return a instanceof V?new V((c,d)=>{a.then(c).catch(d)}):a}),i}}var vN=An("Array").values,CN=bn,yN=ei,AN=_i,ON=vN,ou=Array.prototype,bN={DOMTokenList:!0,NodeList:!0},nn=function(t){var e=t.values;return t===ou||AN(ou,t)&&e===ou.values||yN(bN,CN(t))?ON:e};function rm(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function $s(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?rm(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):rm(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class om extends Gt{constructor(e){super(),h(this,"name","VideoProcessorDestination"),h(this,"ID","0"),h(this,"_source",void 0),h(this,"videoContext",void 0),h(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new I(f.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new I(f.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(Ie.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Ie.ON_TRACK,void 0)}}class sm extends Gt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,i){super(),h(this,"constraintsMap",new Map),h(this,"statsRegistry",[]),h(this,"usageRegistry",[]),h(this,"trackId",void 0),h(this,"direction",void 0),h(this,"_chained",!1),this.trackId=e,this.direction=i}async getConstraints(){return await ye(this,ze.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,i){var n;return _.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(i,e),Vt(this,ze.REQUEST_UPDATE_CONSTRAINTS,Array.from(nn(n=this.constraintsMap).call(n)))}async requestRevertConstraints(e){var i;if(this.constraintsMap.has(e))return _.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Vt(this,ze.REQUEST_UPDATE_CONSTRAINTS,Array.from(nn(i=this.constraintsMap).call(i)))}registerStats(e,i,n){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:i,cb:n})}unregisterStats(e,i){const n=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){const e=[];for(const{processorID:i,processorName:n,type:r,cb:o}of this.statsRegistry)try{const s=o();e.push({processorID:i,processorName:n,type:r,stats:s})}catch(s){_.error(new I(f.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,i){this.usageRegistry.find(n=>n.processorID===e.ID&&n.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:i})}unregisterUsage(e){const i=this.usageRegistry.findIndex(n=>n.processorID===e.ID&&n.processorName===e.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:i}of this.usageRegistry)try{let n=i();n instanceof V&&(n=await n),e.push($s($s({},n),{},{direction:this.direction}))}catch(n){_.error("gather extension usage error",n)}return e}getDirection(){return this.direction}}class am extends Gt{constructor(e){super(),h(this,"name","AudioProcessorDestination"),h(this,"ID","0"),h(this,"inputTrack",void 0),h(this,"inputNode",void 0),h(this,"audioProcessorContext",void 0),h(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new I(f.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new I(f.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Ie.ON_TRACK,void 0),this.emit(Ie.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(Ie.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(Ie.ON_NODE,this.inputNode))}}class cm extends Gt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,i,n){super(),h(this,"constraintsMap",new Map),h(this,"statsRegistry",[]),h(this,"audioContext",void 0),h(this,"trackId",void 0),h(this,"direction",void 0),h(this,"usageRegistry",[]),h(this,"_chained",!1),this.audioContext=e,this.trackId=i,this.direction=n}async getConstraints(){return ye(this,ze.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,i){var n;return _.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(i,e),Vt(this,ze.REQUEST_UPDATE_CONSTRAINTS,Array.from(nn(n=this.constraintsMap).call(n)))}async requestRevertConstraints(e){var i;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Vt(this,ze.REQUEST_UPDATE_CONSTRAINTS,Array.from(nn(i=this.constraintsMap).call(i)))}registerStats(e,i,n){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:i,cb:n})}unregisterStats(e,i){const n=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){const e=[];for(const{processorID:i,processorName:n,type:r,cb:o}of this.statsRegistry)try{const s=o();e.push({processorID:i,processorName:n,type:r,stats:s})}catch(s){_.error(new I(f.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,i){this.usageRegistry.find(n=>n.processorID===e.ID&&n.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:i})}unregisterUsage(e){const i=this.usageRegistry.findIndex(n=>n.processorID===e.ID&&n.processorName===e.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:i}of this.usageRegistry)try{let n=i();n instanceof V&&(n=await n),e.push($s($s({},n),{},{direction:this.direction}))}catch(n){_.error("gather extension usage error",n)}return e}getDirection(){return this.direction}}class su extends Gt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),h(this,"context",void 0),h(this,"processSourceNode",void 0),h(this,"outputTrack",void 0),h(this,"processedNode",void 0),h(this,"clonedTrack",void 0),h(this,"outputNode",void 0),this.outputNode=new wN}setVolume(){}createOutputTrack(){throw new I(f.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class wN{disconnect(){}connect(){}}let ta,Hr=null;class NN{constructor(){h(this,"state","open"),h(this,"trigger",void 0),h(this,"tasks",[]),_.debug("[macro-task-queue] is created."),this.trigger=setTimeout(()=>{this.state="closed",_.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map(e=>e.key),"]")),this.trigger=void 0,this.tasks.forEach(e=>{let{func:i}=e;return i()}),this.tasks.length=0,_.debug("[macro-task-queue] is closed.")})}enqueue(e,i){this.state!=="closed"&&(this.tasks.push({key:e,func:i}),_.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat(typeof e=="string"?e:"")))}runTask(e){if(this.state==="closed")return;const i=this.tasks.findIndex(n=>n.key===e);if(i!==-1){const n=this.tasks.splice(i,1);_.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat(typeof e=="string"?e:"")),n[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,_.debug("[macro-task-queue] is closed."))}}function au(t){return function(e,i,n){var r;const o=(r=n.value)!==null&&r!==void 0?r:n.get,s=function(){Hr&&Hr.state==="open"&&Hr.runTask(t);for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return o==null?void 0:o.apply(this,...c)};return n.value?n.value=s:n.get=s,n}}var dm,um,lm,hm,pm,Em,_m,mm,fm,Sm,gm,Tm,Rm,Im,vm,Cm,ym,Am,Om,bm,wm,mt,Nm,Dm,Pm,Lm,km,Mm,rn,Um,xm,Vm,Fm,jm,Bm,Gm,Wm,Hm,Km,Qe;function Ym(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function cu(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Ym(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ym(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}(function(t){t.UPDATE_TRACK_SOURCE="update-track-source"})(ta||(ta={}));let ve=(dm=au("INIT_WEBAUDIO"),um=au("INIT_WEBAUDIO"),lm=au("INIT_WEBAUDIO"),hm=Y({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),pm=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),Em=Ht(),_m=Br("LocalAudioTrack","_enabledMutex"),mm=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),fm=Ht(),Sm=Br("LocalAudioTrack","_enabledMutex"),gm=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),Tm=Ht(),Rm=Ht(),Im=Ht(),vm=Y({argsMap:t=>[t.getTrackId()]}),Cm=Ht(),ym=Y({argsMap:t=>[t.getTrackId()]}),Am=Ht(),Om=Y({argsMap:t=>[t.getTrackId()]}),bm=Y({argsMap:(t,e)=>[t.getTrackId(),e.name]}),wm=Y({argsMap:t=>[t.getTrackId()]}),w((mt=class extends eu{get _source(){return this._trackSource}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get processorDestination(){return this._processorDestination}set processorDestination(t){this._processorDestination=t}get isPlaying(){return this._useAudioElement?ii.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,i,n,r){super(t,i),h(this,"trackMediaType","audio"),h(this,"_encoderConfig",void 0),h(this,"_trackSource",void 0),h(this,"_enabled",!0),h(this,"_volume",100),h(this,"_useAudioElement",!1),h(this,"_bypassWebAudio",!1),h(this,"processor",void 0),h(this,"_processorContext",void 0),h(this,"_processorDestination",void 0),h(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!n;const o=()=>{this.processorContext=new cm(this._source.context,this.getTrackId(),"local"),this.processorDestination=new am(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Xe.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})},s=r&&Le()&&!J_();C("DISABLE_WEBAUDIO")?(this._source=new su,this._useAudioElement=!0,this._bypassWebAudio=!0):s?this._source=new su:(this._source=new nu(t,!1,this._getOriginVolumeLevel?t:void 0),C("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),o(),!C("DISABLE_WEBAUDIO")&&s&&(Hr||(Hr=new NN),Hr).enqueue("INIT_WEBAUDIO",()=>{this._source=new nu(t,!1,this._getOriginVolumeLevel?t:void 0),C("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),o(),this.emit(ta.UPDATE_TRACK_SOURCE)})}setVolume(t){Nt(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&ii.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void _.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Vt(this,J.NEED_REPLACE_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(i=>{_.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),i)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement)throw new I(f.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ii.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,i){return this._setEnabled(t,e,i)}async _setEnabled(t,e,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await Vt(this,J.NEED_ENABLE_TRACK,this),_.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(n){throw i||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await Vt(this,J.NEED_DISABLE_TRACK,this)}catch(n){throw i||(this._enabled=!0),_.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Vt(this,J.NEED_MUTE_TRACK,this):await Vt(this,J.NEED_UNMUTE_TRACK,this))}getStats(){return yo(()=>{_.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),on(this,J.GET_STATS)||cu({},Bd)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Xe.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Xe.ON_AUDIO_BUFFER),this._source.on(Xe.ON_AUDIO_BUFFER,i=>t(i))}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] start audio playback in element")),ii.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?ii.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ii.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t.addEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop(),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:t,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Vt(this,J.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return V.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new I(f.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new I(f.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Ie.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await Vt(this,J.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Vt(this,J.NEED_REPLACE_TRACK,this))}),this.processorDestination.on(Ie.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Ie.ON_TRACK),this.processorDestination.removeAllListeners(Ie.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(ze.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(ze.REQUEST_CONSTRAINTS)}}).prototype,"_source",[dm],Object.getOwnPropertyDescriptor(mt.prototype,"_source"),mt.prototype),w(mt.prototype,"processorContext",[um],Object.getOwnPropertyDescriptor(mt.prototype,"processorContext"),mt.prototype),w(mt.prototype,"processorDestination",[lm],Object.getOwnPropertyDescriptor(mt.prototype,"processorDestination"),mt.prototype),w(mt.prototype,"setVolume",[hm],Object.getOwnPropertyDescriptor(mt.prototype,"setVolume"),mt.prototype),w(mt.prototype,"setPlaybackDevice",[pm,Em],Object.getOwnPropertyDescriptor(mt.prototype,"setPlaybackDevice"),mt.prototype),w(mt.prototype,"setEnabled",[_m,mm,fm],Object.getOwnPropertyDescriptor(mt.prototype,"setEnabled"),mt.prototype),w(mt.prototype,"setMuted",[Sm,gm,Tm],Object.getOwnPropertyDescriptor(mt.prototype,"setMuted"),mt.prototype),w(mt.prototype,"getStats",[Rm],Object.getOwnPropertyDescriptor(mt.prototype,"getStats"),mt.prototype),w(mt.prototype,"setAudioFrameCallback",[Im],Object.getOwnPropertyDescriptor(mt.prototype,"setAudioFrameCallback"),mt.prototype),w(mt.prototype,"play",[vm,Cm],Object.getOwnPropertyDescriptor(mt.prototype,"play"),mt.prototype),w(mt.prototype,"stop",[ym,Am],Object.getOwnPropertyDescriptor(mt.prototype,"stop"),mt.prototype),w(mt.prototype,"close",[Om],Object.getOwnPropertyDescriptor(mt.prototype,"close"),mt.prototype),w(mt.prototype,"pipe",[bm],Object.getOwnPropertyDescriptor(mt.prototype,"pipe"),mt.prototype),w(mt.prototype,"unpipe",[wm],Object.getOwnPropertyDescriptor(mt.prototype,"unpipe"),mt.prototype),mt),ea=(Nm=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),Dm=Ht(),Pm=Br("MicrophoneAudioTrack","_enabledMutex"),Lm=Y({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),km=Ht(),Mm=Y({argsMap:t=>[t.getTrackId()]}),w((rn=class extends ve{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,i,n){super(t,e.encoderConfig?Ys(e.encoderConfig):{},n,C("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),h(this,"_config",void 0),h(this,"_deviceName","default"),h(this,"_constraints",void 0),h(this,"_originalConstraints",void 0),h(this,"_enabled",!0),this._config=e,this._constraints=i,this._originalConstraints=i,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),Nr()&&ct.bindInterruptDetectorTrack(this),this.on(ta.UPDATE_TRACK_SOURCE,()=>{this.bindProcessorContextEvents()}),J_()&&this.bindProcessorContextEvents()}async setDevice(t){if(_.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await hi.getDeviceById(t),i={};i.audio=cu({},this._constraints),i.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let n=null;try{n=await Mi(i,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),n=await Mi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await hi.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}_.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,i){if(e)return _.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){var n;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(n=this._source.clonedTrack)===null||n===void 0||n.stop(),i||(this._enabled=!1);try{await Vt(this,J.NEED_DISABLE_TRACK,this)}catch(s){throw _.error("[".concat(this.getTrackId(),"] setEnabled false failed"),s.toString()),s}return}const r=cu({},this._constraints),o=hi.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{i||(this._enabled=!0);const s=await Mi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),await Vt(this,J.NEED_ENABLE_TRACK,this)}catch(s){throw i||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled true failed"),s.toString()),s}_.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),Nr()&&ct.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((ke()||$i())&&this._enabled&&!this._isClosed&&ct.duringInterruption){const t=async()=>{ct.off(ae.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};ct.on(ae.IOS_INTERRUPTION_END,t)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.emit(kn.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=hi.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId=i),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const n=await Mi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(ze.REQUEST_UPDATE_CONSTRAINTS,async(t,e,i)=>{try{const n=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(n),e()}catch(n){i(n)}}),this.processorContext.on(ze.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}}).prototype,"setDevice",[Nm,Dm],Object.getOwnPropertyDescriptor(rn.prototype,"setDevice"),rn.prototype),w(rn.prototype,"setEnabled",[Pm,Lm,km],Object.getOwnPropertyDescriptor(rn.prototype,"setEnabled"),rn.prototype),w(rn.prototype,"close",[Mm],Object.getOwnPropertyDescriptor(rn.prototype,"close"),rn.prototype),rn),DN=(Um=Y({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),xm=Ht(),Vm=Y({argsMap:t=>[t.getTrackId()]}),Fm=Ht(),jm=Y({argsMap:t=>[t.getTrackId()]}),Bm=Ht(),Gm=Y({argsMap:t=>[t.getTrackId()]}),Wm=Ht(),Hm=Y({argsMap:t=>[t.getTrackId()]}),Km=Ht(),w((Qe=class extends ve{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,i,n){super(e.createOutputTrack(),i,n),h(this,"source",void 0),h(this,"_bufferSource",void 0),this.source=t,this._bufferSource=e,this._bufferSource.on(Xe.AUDIO_SOURCE_STATE_CHANGE,r=>{this.emit(kn.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}}).prototype,"startProcessAudioBuffer",[Um,xm],Object.getOwnPropertyDescriptor(Qe.prototype,"startProcessAudioBuffer"),Qe.prototype),w(Qe.prototype,"pauseProcessAudioBuffer",[Vm,Fm],Object.getOwnPropertyDescriptor(Qe.prototype,"pauseProcessAudioBuffer"),Qe.prototype),w(Qe.prototype,"seekAudioBuffer",[jm,Bm],Object.getOwnPropertyDescriptor(Qe.prototype,"seekAudioBuffer"),Qe.prototype),w(Qe.prototype,"resumeProcessAudioBuffer",[Gm,Wm],Object.getOwnPropertyDescriptor(Qe.prototype,"resumeProcessAudioBuffer"),Qe.prototype),w(Qe.prototype,"stopProcessAudioBuffer",[Hm,Km],Object.getOwnPropertyDescriptor(Qe.prototype,"stopProcessAudioBuffer"),Qe.prototype),Qe);class Ti extends ve{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=Gr().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,Lt(8,"track-mix-")),h(this,"trackList",void 0),h(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(_.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):_.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){_.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}lu(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach(i=>{i._encoderConfig&&((i._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=i._encoderConfig.bitrate),(i._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=i._encoderConfig.sampleRate),(i._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=i._encoderConfig.sampleSize),i._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}}class PN extends Gt{constructor(){super(...arguments),h(this,"resultStorage",new Map)}setLocalAudioStats(e,i,n){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(n,i)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(n,i))}setLocalVideoStats(e,i,n){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(n,i)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(n,i)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(n))}setRemoteAudioStats(e,i){const n=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",n,this.checkAudioOutputLevel(i))}setRemoteVideoStats(e,i){const n=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",n,this.checkVideoDecode(i))}record(e,i,n){this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(e);if(r&&(r.result.push(n),r.result.length>=5)){const o=r.result.includes(!0);r.isPrevNormal&&!o&&this.emit("exception",qm[e],e,i),!r.isPrevNormal&&o&&this.emit("exception",qm[e]+2e3,e+"_RECOVER",i),r.isPrevNormal=o,r.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,i){return i instanceof Ti&&!i.isActive||!!i.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,i){let n=null;i._encoderConfig&&i._encoderConfig.frameRate&&(n=Sn(i._encoderConfig.frameRate));const r=e.captureFrameRate;return!n||!r||!(n>10&&r<5||n<10&&n>=5&&r<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,i){return!!i.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,i){return i instanceof Ti&&!i.isActive||!!i.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}const qm={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Ri=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(i.length>0){const n=i[i.length-1];return Math.round(performance.now()-n.startTime)}return 0}measureFromPublishStart(t,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(i.length>0){const n=i[i.length-1];return Math.round(performance.now()-n.startTime)}return 0}};function Jm(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ur(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Jm(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Jm(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class Kr{constructor(e){h(this,"store",void 0),h(this,"onStatsException",void 0),h(this,"onUploadPublishDuration",void 0),h(this,"localStats",new Map),h(this,"remoteStats",new Map),h(this,"updateStatsInterval",void 0),h(this,"trafficStats",void 0),h(this,"trafficStatsPeerList",[]),h(this,"uplinkStats",void 0),h(this,"exceptionMonitor",void 0),h(this,"p2pChannel",void 0),h(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new PN,this.exceptionMonitor.on("exception",(i,n,r)=>{this.onStatsException&&this.onStatsException(i,n,r)})}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(F.LocalAudioTrack)||ur({},Bd)}getLocalVideoTrackStats(){return this.localStats.get(F.LocalVideoTrack)||ur({},Gd)}getRemoteAudioTrackStats(e){const i=(o,s)=>{if(!this.trafficStats)return s;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},n={};if(e){var r;const o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.audioStats;o&&(n[e]=i(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:a}]=o;a&&(n[s]=i(s,a))});return n}getRemoteNetworkQualityStats(e){const i={};if(e){var n;const r=(n=this.remoteStats.get(e))===null||n===void 0?void 0:n.networkStats;r&&(i[e]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{networkStats:s}]=r;s&&(i[o]=s)});return i}getRemoteVideoTrackStats(e){const i=(o,s)=>{if(!this.trafficStats)return s;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},n={};if(e){var r;const o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.videoStats;o&&(n[e]=i(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:a}]=o;a&&(n[s]=i(s,a))});return n}getRTCStats(){let e=0,i=0,n=0,r=0;const o=this.localStats.get(F.LocalAudioTrack);o&&(e+=o.sendBytes,i+=o.sendBitrate);const s=this.localStats.get(F.LocalVideoTrack);s&&(e+=s.sendBytes,i+=s.sendBitrate);const a=this.localStats.get(F.LocalVideoLowTrack);a&&(e+=a.sendBytes,i+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:u,videoStats:l}=d;u&&(n+=u.receiveBytes,r+=u.receiveBitrate),l&&(n+=l.receiveBytes,r+=l.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:i,SendBytes:e,RecvBytes:n,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(i=>i.B_ppad!==void 0||i.B_ppvd!==void 0),e.peer_delay.filter(i=>this.trafficStatsPeerList.indexOf(i.peer_uid)===-1).forEach(i=>{var n;const r=(n=this.p2pChannel)===null||n===void 0?void 0:n.getRemoteMedia(i.peer_uid),o=r!=null&&r.videoSSRC?Ri.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,s=r!=null&&r.audioSSRC?Ri.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;i.B_ppad!==void 0&&i.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(i.peer_uid,i.B_ppad,i.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(i.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&_.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,i,n){if(!e)return!1;const r=!!n&&i.framesDecodeFreezeTime>n.framesDecodeFreezeTime,o=!n||i.framesDecodeCount>n.framesDecodeCount;return r||!o}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(i=>{let[n,r]=i;switch(n){case F.LocalVideoTrack:case F.LocalVideoLowTrack:{const o=r,s=ur({},Gd),a=e.getStats(),c=e.getLocalMedia(n);if(a){const d=a.videoSend.find(u=>u.ssrc===(c==null?void 0:c.ssrcs[0].ssrcId));if(d){const u=e.getLocalVideoSize(),l=e.getEncoderConfig(F.LocalVideoTrack);d.codec!=="H264"&&d.codec!=="VP8"&&d.codec!=="VP9"&&d.codec!=="AV1X"&&d.codec!=="AV1"||(s.codecType=d.codec),s.sendBytes=d.bytes,s.sendBitrate=o?8*Math.max(0,s.sendBytes-o.sendBytes):0,d.inputFrame?(s.captureFrameRate=d.inputFrame.frameRate,s.captureResolutionHeight=d.inputFrame.height,s.captureResolutionWidth=d.inputFrame.width):u&&(s.captureResolutionWidth=u.width,s.captureResolutionHeight=u.height),d.sentFrame?(s.sendFrameRate=d.sentFrame.frameRate,s.sendResolutionHeight=d.sentFrame.height,s.sendResolutionWidth=d.sentFrame.width):u&&(s.sendResolutionWidth=u.width,s.sendResolutionHeight=u.height),d.avgEncodeMs&&(s.encodeDelay=d.avgEncodeMs),l&&l.bitrateMax&&(s.targetSendBitrate=1e3*l.bitrateMax),s.sendPackets=d.packets,s.sendPacketsLost=d.packetsLost,s.totalDuration=o?o.totalDuration+1:1,s.totalFreezeTime=o?o.totalFreezeTime:0,this.isLocalVideoFreeze(d)&&(s.totalFreezeTime+=1)}this.trafficStats&&(s.sendPacketsLost=this.trafficStats.B_pvlr4/100)}this.localStats.set(n,s),s&&c&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,c.track,s);break}case F.LocalAudioTrack:{const o=r,s=ur({},Bd),a=e.getStats(),c=e.getLocalMedia(n);if(a){const d=a.audioSend.find(u=>u.ssrc===(c==null?void 0:c.ssrcs[0].ssrcId));if(d){if(d.codec!=="opus"&&d.codec!=="aac"&&d.codec!=="PCMU"&&d.codec!=="PCMA"&&d.codec!=="G722"||(s.codecType=d.codec),d.inputLevel)s.sendVolumeLevel=Math.round(32767*d.inputLevel);else{const u=e.getLocalAudioVolume();u&&(s.sendVolumeLevel=Math.round(32767*u))}s.sendBytes=d.bytes,s.sendPackets=d.packets,s.sendPacketsLost=d.packetsLost,s.sendBitrate=o?8*Math.max(0,s.sendBytes-o.sendBytes):0}}this.trafficStats&&(s.sendPacketsLost=this.trafficStats.B_pvlr4/100),this.localStats.set(F.LocalAudioTrack,s),s&&c&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,c.track,s);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(i=>{let[n,{videoStats:r,audioStats:o,videoPcStats:s}]=i;const a=o,c=r,d=s,u=ur({},v_),l=ur({},C_),E=ur({},lw),{audioTrack:m,videoTrack:T,audioSSRC:g,videoSSRC:R}=e.getRemoteMedia(n),y=e.getStats(),A=y==null?void 0:y.audioRecv.find(k=>k.ssrc===g),P=y==null?void 0:y.videoRecv.find(k=>k.ssrc===R),H=this.trafficStats&&this.trafficStats.peer_delay.find(k=>k.peer_uid===n);if(A&&(A.codec!=="opus"&&A.codec!=="aac"&&A.codec!=="PCMU"&&A.codec!=="PCMA"&&A.codec!=="G722"||(u.codecType=A.codec),A.outputLevel?u.receiveLevel=Math.round(32767*A.outputLevel):m&&(u.receiveLevel=Math.round(32767*m.getVolumeLevel())),u.receiveBytes=A.bytes,u.receivePackets=A.packets,u.receivePacketsLost=A.packetsLost,u.packetLossRate=u.receivePacketsLost/(u.receivePackets+u.receivePacketsLost),u.receiveBitrate=a?8*Math.max(0,u.receiveBytes-a.receiveBytes):0,u.totalDuration=a?a.totalDuration+1:1,u.totalFreezeTime=a?a.totalFreezeTime:0,u.freezeRate=u.totalFreezeTime/u.totalDuration,u.receiveDelay=A.jitterBufferMs,u.totalDuration>10&&Kr.isRemoteAudioFreeze(m)&&(u.totalFreezeTime+=1)),P){P.codec!=="H264"&&P.codec!=="VP8"&&P.codec!=="VP9"&&P.codec!=="AV1X"&&P.codec!=="AV1"||(l.codecType=P.codec),l.receiveBytes=P.bytes,l.receiveBitrate=c?8*Math.max(0,l.receiveBytes-c.receiveBytes):0,l.decodeFrameRate=P.decodeFrameRate<0?0:P.decodeFrameRate,l.renderFrameRate=P.decodeFrameRate<0?0:P.decodeFrameRate,P.outputFrame&&(l.renderFrameRate=P.outputFrame.frameRate),P.receivedFrame?(l.receiveFrameRate=P.receivedFrame.frameRate,l.receiveResolutionHeight=P.receivedFrame.height,l.receiveResolutionWidth=P.receivedFrame.width):T&&(l.receiveResolutionHeight=T._videoHeight||0,l.receiveResolutionWidth=T._videoWidth||0),P.framesRateFirefox!==void 0&&(l.receiveFrameRate=Math.round(P.framesRateFirefox)),l.receivePackets=P.packets,l.receivePacketsLost=P.packetsLost,l.packetLossRate=l.receivePacketsLost/(l.receivePackets+l.receivePacketsLost),l.totalDuration=c?c.totalDuration+1:1,l.totalFreezeTime=c?c.totalFreezeTime:0,l.receiveDelay=P.jitterBufferMs||0;const k=!!R&&e.getRemoteVideoIsReady(R);T&&k&&Kr.isRemoteVideoFreeze(T,P,d)&&(l.totalFreezeTime+=1),l.freezeRate=l.totalFreezeTime/l.totalDuration}H&&(u.end2EndDelay=H.B_ad,l.end2EndDelay=H.B_vd,u.transportDelay=H.B_ed,l.transportDelay=H.B_ed,u.currentPacketLossRate=H.B_ealr4/100,l.currentPacketLossRate=H.B_evlr4/100,E.uplinkNetworkQuality=H.B_punq?H.B_punq:0,E.downlinkNetworkQuality=H.B_pdnq?H.B_pdnq:0),this.remoteStats.set(n,{audioStats:u,videoStats:l,videoPcStats:P,networkStats:E}),m&&this.exceptionMonitor.setRemoteAudioStats(m,u),T&&this.exceptionMonitor.setRemoteVideoStats(T,l)})}}const fn=new class extends Gt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),h(this,"_lastHiddenTime",0),h(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),_.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};function Xm(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ia(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Xm(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Xm(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function na(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(C("TURN_DOMAIN")):(_.info("Cannot recognized as IP address ".concat(t,". Used As Host instead")),t)}function zm(t,e){var i,n;const r=C("GATEWAY_DOMAINS");let o=r[1]&&e.indexOf(r[1])!==-1?1:0;t.addresses=t.addresses||[];const s=t.addresses.map(c=>c.domain_prefix?{address:"".concat(c.domain_prefix,".").concat(r[o++%r.length],":").concat(c.port)}:c.ip.match(/^[\.\:\d]+$/)?{ip:c.ip,port:c.port,address:"".concat(c.ip.replace(/[^\d]/g,"-"),".").concat(r[o++%r.length],":").concat(c.port)}:(_.info("Cannot recognized as IP address ".concat(c.ip,". Used As Host instead")),{ip:c.ip,port:c.port,address:"".concat(c.ip,":").concat(c.port)}));if((i=t.detail)!==null&&i!==void 0&&i[18]&&typeof((n=t.detail)===null||n===void 0?void 0:n[18])=="string"){const c=t.detail[18],d=c==null?void 0:c.split(";");for(let u=0;u<d.length;u++){var a;const l=hn(a=d[u]).call(a);s[u]&&l&&(s[u].ip6=l)}}return{gatewayAddrs:s,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function Sn(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function Qm(t){const e=t._encoderConfig;if(!e)return{};const i={resolution:e.width&&e.height?"".concat(Sn(e.width),"x").concat(Sn(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(i.maxFrameRate=e.frameRate,i.minFrameRate=e.frameRate):e.frameRate&&(i.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,i.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),i}function Zm(t,e,i){var n,r,o,s,a,c,d,u;const l=e.videoSend.find(R=>R.ssrc===t);if(!l)return null;const E={id:Lt(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:l.ssrc.toString()},m=(n=(r=(o=l.inputFrame)===null||o===void 0?void 0:o.height)!==null&&r!==void 0?r:i==null?void 0:i._videoHeight)!==null&&n!==void 0?n:0,T=(s=(a=(c=l.inputFrame)===null||c===void 0?void 0:c.width)!==null&&a!==void 0?a:i==null?void 0:i._videoWidth)!==null&&s!==void 0?s:0,g=(d=(u=l.inputFrame)===null||u===void 0?void 0:u.frameRate)!==null&&d!==void 0?d:0;return m&&(E.A_fhi=m+""),T&&(E.A_fwi=T+""),g&&(E.A_fri=g+""),E}function $m(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function du(t,e){let i,n,r;switch(e){case se.CHOOSE_SERVER:i=4096,n="choose server";break;case se.CLOUD_PROXY:i=1048576,n="proxy";break;case se.CLOUD_PROXY_5:i=4194304,n="proxy5";break;case se.CLOUD_PROXY_FALLBACK:i=4194310,n="proxy fallback";break;default:throw new I(f.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(o=>{o.buffer&&o.buffer.flag===i&&(r={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>ia(ia({},s),{},{ticket:o.buffer.cert})),server_ts:t.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:ia(ia({},o.buffer.detail),t.detail),flag:o.buffer.flag,opid:t.opid,cert:o.buffer.cert})}),!r)throw new I(f.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(n," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return r}async function LN(t,e){return await V.all(t.addresses.map(async i=>({address:na(i.ip),tcpport:i.port,udpport:i.port,username:e&&C("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():si.username,password:e&&C("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await fN(e.toString()):si.password})))}function kN(t,e){const i=e._videoWidth||e.getMediaStreamTrack(!0).getSettings().width;return i||_.warning("cannot get original video track's width, default scale down 4 times for low stream"),i?i/Sn(t.width):4}function ra(t){let{candidateType:e,relayProtocol:i,type:n,address:r,port:o,protocol:s}=t;return n==="local-candidate"?{candidateType:e,relayProtocol:i,protocol:s}:{candidateType:e,relayProtocol:i,address:r,port:o,protocol:s}}function tf(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function lr(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?tf(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):tf(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function Yr(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function Ce(t){return new V(e=>{window.setTimeout(e,t)})}function MN(t){const e=new I(f.TIMEOUT,"timeout");return new V((i,n)=>{window.setTimeout(()=>n(e),t)})}function Lt(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const i=Math.random().toString(16).substr(2,t).toLowerCase();return i.length===t?"".concat(e).concat(i):"".concat(e).concat(i)+Lt(t-i.length,"")}function uu(){return Lt(32,"").toUpperCase()}const oa=()=>{};function ef(t){return new V((e,i)=>{let n=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const o=ke()?"canplay":"playing";r.addEventListener(o,()=>{const s=r.videoWidth,a=r.videoHeight;!s&&Bt()||(n=!0,r.srcObject=null,r.remove(),e([s,a]))}),r.srcObject=new MediaStream([t]),r.play().catch(oa),setTimeout(()=>{n||(r.srcObject=null,r.remove(),e([r.videoWidth,r.videoHeight]))},4e3)})}function qr(t){return V.all(t.map(e=>e.then(i=>{throw i},i=>i))).then(e=>{throw e},e=>e)}function ye(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return t.getListeners(e).length===0?V.reject(new I(f.UNEXPECTED_ERROR,"can not emit promise")):new V((o,s)=>{t.emit(e,...n,o,s)})}function Vt(t,e){if(t.getListeners(e).length===0)return V.resolve();for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return ye(t,e,...n)}function on(t,e){if(t.getListeners(e).length===0)return null;for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return hr(t,e,...n)}function hr(t,e){let i=null,n=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(t.emit(e,...o,a=>{i=a},a=>{n=a}),n!==null)throw n;if(i===null)throw new I(f.UNEXPECTED_ERROR,"handler is not sync");return i}function lu(t,e){const i=t.indexOf(e);i!==-1&&t.splice(i,1)}function nf(t){const e=[];return t.forEach(i=>{e.indexOf(i)===-1&&e.push(i)}),e}function Ui(t){V.resolve().then(t)}function Xt(t){return JSON.parse(JSON.stringify(t))}const rf={};function yo(t,e){rf[e]||(rf[e]=!0,t())}function hu(t){const e=window.atob(t),i=new Uint8Array(new ArrayBuffer(e.length));for(let n=0;n<e.length;n+=1)i[n]=e.charCodeAt(n);return i}function sa(t){let e="";for(let i=0;i<t.length;i+=1)e+=String.fromCharCode(t[i]);return window.btoa(e)}const of=new class{constructor(){h(this,"fnMap",new Map)}throttleByKey(t,e,i,n){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(e)){const a=this.fnMap.get(e);if(a.threshold!==i){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout(()=>{const d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e)},i);this.fnMap.set(e,{fn:t,threshold:i,timer:c,args:o,skipFn:n})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,lr(lr({},a),{},{fn:t,args:o,skipFn:n}))}else{const a=window.setTimeout(()=>{const c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e)},i);this.fnMap.set(e,{fn:t,threshold:i,timer:a,args:o,skipFn:n})}}},sf=of.throttleByKey.bind(of),Ao=async t=>{let{fragementLength:e,referenceList:i,asyncMapHandler:n,allFailedhandler:r,promisesCollector:o}=t,s=0;const a=e;let c,d=0;const u=async()=>{const l=(()=>{const E=s*a,m=E+a;return i.slice(E,m).map(n)})();o&&o.push(...l);try{c=await qr(l)}catch(E){if(d+=a,s++,!(d>=i.length))return void await u();r(E)}l.forEach(E=>E.cancel())};return await u(),c};function af(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}const UN={[Vr.ACCESS_POINT]:{[Re.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Re.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Re.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Re.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Re.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Re.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voice service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Re.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Vr.UNILBS]:{[ai.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[ai.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[ai.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[ai.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[ai.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[ai.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[ai.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[ai.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[ai.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[ai.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[ai.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[ai.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Vr.STRING_UID_ALLOCATOR]:{[Ro.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[Ro.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[Ro.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function aa(t){const e=UN[Math.floor(t/1e4)];if(!e)return{desc:"unkonw error",retry:!1};const i=e[t%1e4];if(!i){if(Math.floor(t/1e4)===Vr.ACCESS_POINT){const n=t%1e4;if(n.toString()[0]==="1")return{desc:t.toString(),retry:!1};if(n.toString()[0]==="2")return{desc:t.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const xN={[K.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[K.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[K.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[K.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[K.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[K.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[K.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[K.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[K.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[K.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[K.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[K.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[K.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[K.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[K.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[K.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[K.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[K.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[K.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[K.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[K.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[K.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[K.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[K.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[K.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[K.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[K.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[K.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[K.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[K.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[K.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[K.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[K.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[K.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[K.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[K.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[K.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[K.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[K.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[K.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[K.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[K.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[K.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[K.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[K.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[K.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[K.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[K.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[K.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[K.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[K.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[K.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[K.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[K.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[K.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[K.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[K.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[K.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[K.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[K.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[K.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[K.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[K.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[K.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Oo(t){return xN[t]||{desc:"UNKNOW_ERROR_".concat(t),action:"failed"}}function cf(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}class Jr extends Gt{get url(){return this.websocket?this.websocket.url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit($.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit($.CONNECTED):this._state==="closed"?this.emit($.CLOSED):this._state==="failed"&&this.emit($.FAILED))}resetReconnectCount(e){_.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,i){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4?arguments[4]:void 0;super(),h(this,"connectionID",0),h(this,"currentURLIndex",0),h(this,"urls",void 0),h(this,"_reconnectMode","tryNext"),h(this,"reconnectReason",void 0),h(this,"_initMutex",new Ve("websocket")),h(this,"name",void 0),h(this,"_state","closed"),h(this,"reconnectInterrupter",void 0),h(this,"websocket",void 0),h(this,"retryConfig",void 0),h(this,"reconnectCount",0),h(this,"forceCloseTimeout",5e3),h(this,"onlineReconnectListener",void 0),h(this,"useCompress",void 0),h(this,"tryDoubleDomain",!1),h(this,"wsInflateLength",0),h(this,"wsDeflateLength",0),h(this,"closeEstablishingWs",()=>{}),h(this,"store",void 0),h(this,"joinChannelServiceRecordIndex",void 0),this.store=o,this.name=e,this.retryConfig=function(u){for(var l=1;l<arguments.length;l++){var E=arguments[l]!=null?arguments[l]:{};l%2?cf(Object(E),!0).forEach(function(m){h(u,m,E[m])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(E)):cf(Object(E)).forEach(function(m){Object.defineProperty(u,m,Object.getOwnPropertyDescriptor(E,m))})}return u}({},i),this.useCompress=n,this.tryDoubleDomain=r;const{timeout:s,timeoutFactor:a}=i,c=Math.max(300,Math.floor(3*s/5)),d=Math.max(1.2,Math.floor(8*a)/10);we.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),Jt.on(Mn.NETWORK_STATE_CHANGE,(u,l)=>{u!==l&&(this.resetReconnectCount("network state change: ".concat(l," -> ").concat(u)),u===we.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=s,this.retryConfig.timeoutFactor=a))})}getConnection(){return this.websocket||void 0}init(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this.forceCloseTimeout=i;const n=(r,o)=>{this.urls=e;const s=this.urls[this.currentURLIndex];this.state="connecting",this.createWebSocketConnection(s).then(r).catch(o),this.once($.CLOSED,()=>o(new I(f.WS_DISCONNECT))),this.once($.CONNECTED,()=>r())};return this._initMutex.lock().then(r=>new V((o,s)=>{n(o,s)}).then(()=>{r()}).catch(()=>{r()}))}close(e,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const n=this.websocket;i?setTimeout(()=>n.close(),500):n.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,i){if(!this.websocket)return void _.warning("[".concat(this.name,"] can not reconnect, no websocket"));var n;e!==void 0&&(this.reconnectMode=e),_.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinChannelServiceRecordIndex=="number"&&((n=this.store)===null||n===void 0||n.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinChannelServiceRecordIndex));const r=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),r&&r.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new I(f.WS_ABORT,"websocket is not ready");try{i||(e=JSON.stringify(e)),this.websocket.send(e)}catch(n){throw new I(f.WS_ERR,"send websocket message error"+n.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,i=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:i}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e,i){return this.connectionID+=1,this.connectionID,this.joinChannelServiceRecordIndex=void 0,new V((n,r)=>{var o;const s=u=>{var l;(l=this.store)===null||l===void 0||l.signalChannelOpen(),_.debug("[".concat(this.name,"] websocket opened:"),u),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n()},a=async u=>{if(_.debug("[".concat(this.name,"] websocket close ").concat(this.websocket&&this.websocket.url,", code: ").concat(u.code,", reason: ").concat(u.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount<this.retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=u.reason,this.state="reconnecting");const l=on(this,$.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,E=await this.reconnectWithAction(l);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!E)return r(new I(f.WS_DISCONNECT,"websocket reconnect failed: ".concat(u.code))),void this.close(!0);n()}else r(new I(f.WS_DISCONNECT,"websocket close: ".concat(u.code))),this.close()},c=u=>{this.emit($.ON_MESSAGE,u)};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),C("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=C("GATEWAY_WSS_ADDRESS")),_.debug("[".concat(this.name,"] start connect, url: ").concat(e));const d=(o=this.store)===null||o===void 0?void 0:o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});this.chooseBestWebsocketConnection(e,!!i,d).then(u=>{var l;this.websocket=u,s&&s(u.url),u.onclose=a,u.onmessage=c,(l=this.store)===null||l===void 0||l.recordJoinChannelService({endTs:Date.now(),status:"success"},d),this.joinChannelServiceRecordIndex=d}).catch(u=>{var l;if((l=this.store)===null||l===void 0||l.recordJoinChannelService({endTs:Date.now(),status:u instanceof I&&u.code===f.WS_ABORT?"aborted":"error",errors:[u]},d),this.state!=="closed"){if(u instanceof I&&u.code===f.WS_ERR){const E=new I(f.WS_ERR,"init websocket failed! Error: ".concat(u.toString()));return _.error("[".concat(this.name,"]").concat(E)),void r(E)}a&&a(u)}else r(new I(f.WS_DISCONNECT,"websocket is closed: ".concat(u.toString())))})})}async reconnectWithAction(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||!this.urls||this.state==="closed")return!1;this.onlineReconnectListener||Jt.networkState!==we.OFFLINE||(this.onlineReconnectListener=Jt.onlineWaiter&&Jt.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let n=!0;if(this.reconnectInterrupter=()=>{n=!1},i){const s=Cd(this.reconnectCount,this.retryConfig);_.debug("[".concat(this.name,"] wait ").concat(s,"ms to reconnect websocket, mode: ").concat(e)),await V.race([Ce(s),this.onlineReconnectListener||new V(()=>{})])}if(this.state==="closed"||!n)return!1;this.reconnectCount+=1;const r=async(s,a)=>{this.emit($.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(s)};try{if(e==="retry"){const s=this.urls[this.currentURLIndex];this.emit($.RECONNECT_WAITTING_FINISH,e),await r(s,e)}else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return await this.reconnectWithAction("recover",!1);_.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex));const s=this.urls[this.currentURLIndex];this.emit($.RECONNECT_WAITTING_FINISH,e),await r(s,e)}else if(e==="recover"){_.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit($.RECONNECT_WAITTING_FINISH,e),this.urls=await ye(this,$.REQUEST_NEW_URLS),this.currentURLIndex=0;const s=this.urls[this.currentURLIndex];await r(s,e)}return!0}catch(s){var o;return _.error("[".concat(this.name,"] reconnect failed"),s.toString()),s!=null&&(o=s.data)!==null&&o!==void 0&&o.desc&&Array.isArray(s.data.desc)&&s.data.desc.length&&s.data.desc.includes("dynamic key expired")?(this.emit($.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,i)}}async chooseBestWebsocketConnection(e,i,n){return new V((r,o)=>{let s=!1;const a=[];this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),a.forEach(g=>{g.onclose=null,g.onopen=null,g.onmessage=null,g.close()}),o(new I(f.WS_ABORT,"choose best websocket aborted"))};const c=C("GATEWAY_DOMAINS");let d;const u=e.indexOf("?h="),l=c.find(g=>u!==-1?e.includes(g,u):e.includes(g));_.debug("[choose-best-ws] currentDomain: ",l,", domains: ",c);let E=!this.tryDoubleDomain||i||!l;if(!E&&l){var m;const g=Date.now();try{c.forEach(R=>{const y=u===-1?e.replace(l,R):e.substr(0,u)+e.substr(u).replace(l,R),A=new WebSocket(y);A.binaryType="arraybuffer",a.push(A),_.debug("[choose-best-ws] ws is connecting:",A.url)})}catch{for(_.debug("[choose-best-ws] ws create failed, fallback to single url"),a.forEach(y=>y.close());a.length;)a.pop();E=!0}(m=this.store)===null||m===void 0||m.recordJoinChannelService({urls:a.map(R=>R.url),service:"gateway"},n),a.forEach(R=>{R.onopen=()=>{if(s)return;const y=Date.now()-g;_.debug("[choose-best-ws] ws open cost ".concat(y,"ms")),a.filter(A=>A!==R).forEach(A=>{_.debug("[choose-best-ws]close backup websocket: ".concat(A.url)),A.close()}),s=!0,r(R)},R.onclose=y=>{d=y,!s&&(a.find(A=>!(A.readyState===WebSocket.CLOSED||A.readyState===WebSocket.CLOSING))||(_.debug("[choose-best-ws] all websocket is closed"),s=!0,o(d)))},R.onmessage=y=>{_.debug("[choose-best-ws]".concat(R.url," onmessage: ").concat(y.data))}}),Ce(this.forceCloseTimeout).then(()=>{a.forEach(R=>{R.readyState!==WebSocket.OPEN&&R.close()})})}if(E){var T;let g;_.debug("[choose-best-ws] use single url: ",e),(T=this.store)===null||T===void 0||T.recordJoinChannelService({urls:[e],service:"gateway"},n);try{g=new WebSocket(e),a.push(g),g.binaryType="arraybuffer"}catch(R){const y=new I(f.WS_ERR,"init websocket failed! Error: ".concat(R.toString()));return _.error("[".concat(this.name,"]").concat(y)),void o(y)}g.onopen=()=>{r(g)},g.onclose=R=>{o(R)},g.onmessage=R=>{_.debug("[choose-best-ws]".concat(g.url," onmessage: ").concat(R.data))},Ce(this.forceCloseTimeout).then(()=>{g&&g.readyState!==WebSocket.OPEN&&g.close()})}}).then(r=>(this.closeEstablishingWs=void 0,r)).catch(r=>{throw this.closeEstablishingWs=void 0,r})}}class df{constructor(e){h(this,"input",[]),h(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return this.input.length===0?0:On(e=this.input).call(e,(i,n)=>i+n)/this.input.length}}class uf extends Gt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===gt.CONNECTED?this.emit(B.WS_CONNECTED):e===gt.RECONNECTING?this.emit(B.WS_RECONNECTING,this._websocketReconnectReason):e===gt.CLOSED&&this.emit(B.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),h(this,"_disconnectedReason",void 0),h(this,"_websocketReconnectReason",void 0),h(this,"_connectionState",gt.CLOSED),h(this,"reconnectToken",void 0),h(this,"websocket",void 0),h(this,"openConnectionTime",void 0),h(this,"clientId",void 0),h(this,"lastMsgTime",Date.now()),h(this,"uploadCache",[]),h(this,"uploadCacheInterval",void 0),h(this,"rttRolling",new df(5)),h(this,"pingpongTimer",void 0),h(this,"wsInflateDataTimer",void 0),h(this,"pingpongTimeoutCount",0),h(this,"joinResponse",void 0),h(this,"multiIpOption",void 0),h(this,"initError",void 0),h(this,"spec",void 0),h(this,"store",void 0),h(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(B.ON_BINARY_DATA,n.data);const r=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===et.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===et.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(_t.UID_BANNED);break;case 15:this.close(_t.IP_BANNED);break;case 16:this.close(_t.CHANNEL_BANNED)}if(r._type===et.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case K.ERR_LICENSE_MISSING:this.close(_t.LICENSE_MISSING);break;case K.ERR_LICENSE_EXPIRED:this.close(_t.LICENSE_EXPIRED);break;case K.ERR_LICENSE_MINUTES_EXCEEDED:this.close(_t.LICENSE_MINUTES_EXCEEDED);break;case K.ERR_LICENSE_PERIOD_INVALID:this.close(_t.LICENSE_PERIOD_INVALID);break;case K.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(_t.LICENSE_MULTIPLE_SDK_SERVICE);break;case K.ERR_LICENSE_ILLEGAL:this.close(_t.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new Jr("gateway-".concat(this.clientId),this.spec.retryConfig,!0,!0,i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===gt.CONNECTED&&this.reconnect("retry",Be.OFFLINE)})}async request(e,i,n,r){const o=Lt(6,""),s={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new V((T,g)=>{if(this.connectionState===gt.CONNECTED)return T();const R=()=>{this.off(B.WS_CLOSED,y),T()},y=()=>{this.off(B.WS_CONNECTED,R),g(new I(f.WS_ABORT))};this.once(B.WS_CONNECTED,R),this.once(B.WS_CLOSED,y),e!==q.PUBLISH&&e!==q.SUBSCRIBE&&e!==q.UNSUBSCRIBE&&e!==q.UNPUBLISH&&e!==q.CONTROL&&e!==q.RESTART_ICE||this.once(B.DISCONNECT_P2P,()=>{g(new I(f.DISCONNECT_P2P))}),e!==q.PUBLISH&&e!==q.RESTART_ICE||this.once(B.ABORT_P2P_EXECUTION,()=>{g(new I(f.DISCONNECT_P2P))})});if(this.connectionState!==gt.CONNECTING&&this.connectionState!==gt.RECONNECTING||e===q.JOIN||e===q.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;const d=new V((T,g)=>{let R=!1;const y=(P,H)=>{R=!0,T({isSuccess:P==="success",message:H||{}}),this.off(B.WS_CLOSED,A),this.off(B.WS_RECONNECTING,A),this.emit(B.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),y);const A=()=>{g(new I(f.WS_ABORT,"type: ".concat(e))),this.off(B.WS_CLOSED,A),this.off(B.WS_RECONNECTING,A),this.off("res-@".concat(o),y)};this.once(B.WS_CLOSED,A),this.once(B.WS_RECONNECTING,A),Ce(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||R||(_.warning("ws request timeout, type: ".concat(e)),this.emit(B.REQUEST_TIMEOUT,e,i))})});let u=null;try{u=await d}catch(T){if(this.connectionState===gt.CLOSED||e===q.LEAVE)throw new I(f.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?T.throw():e===q.JOIN||e===q.REJOIN?null:(await c(),await this.request(e,i))}if(u.isSuccess)return u.message;const l=Number(u.message.error_code||u.message.code),E=Oo(l),m=new I(f.UNEXPECTED_RESPONSE,"".concat(E.desc,": ").concat(u.message.error_str),{code:l,data:u.message});return E.action==="success"?u.message:(_.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(E.desc,", action: ").concat(E.action)),l===K.ERR_TOO_MANY_BROADCASTERS?((e===q.JOIN||e===q.REJOIN)&&(this.initError=m,this.close()),m.throw()):E.action==="failed"?m.throw():E.action==="quit"?(this.initError=m,this.close(),m.throw()):(l===K.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Be.MULTI_IP)):this.reconnect(E.action,Be.SERVER_ERROR),e===q.JOIN||e===q.REJOIN?null:await this.request(e,i)))}waitMessage(e,i){return new V(n=>{const r=o=>{(!i||i(o))&&(this.off(e,r),n(o))};this.on(e,r)})}upload(e,i){const n={_type:e,_message:i};try{this.websocket.sendMessage(n)}catch{const o=C("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==gt.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},C("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){const n={_type:e,_message:i};this.websocket.sendMessage(n)}init(e,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new V((n,r)=>{this.once(B.WS_CONNECTED,()=>n(this.joinResponse)),this.once(B.WS_CLOSED,()=>r(this.initError||new I(f.WS_ABORT))),this.connectionState=gt.CONNECTING,this.websocket.init(e).catch(r),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4),setTimeout(()=>{i&&this.openConnectionTime===void 0&&(_.debug("[".concat(this.clientId,"] init websocket timeout while join with fallback to proxy")),r(new I(f.INIT_WEBSOCKET_TIMEOUT)))},C("JOIN_WITH_FALLBACK_PROXY_PENDING_DURATION"))})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||_t.LEAVE,this.connectionState=gt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===_t.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Jr("gateway-".concat(this.clientId),this.spec.retryConfig,!0,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(B.ABORT_P2P_EXECUTION);const e=await ye(this,B.REQUEST_JOIN_INFO),i=await this.request(q.JOIN,e);if(!i)return this.emit(B.REPORT_JOIN_GATEWAY,f.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(B.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new I(f.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=hr(this,B.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const i=await this.request(q.REJOIN,e);return!!i&&(this.connectionState=gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(n=>{this.emit(et.ON_USER_ONLINE,{uid:n.uid}),n.audio&&this.emit(et.ON_ADD_AUDIO_STREAM,{uid:n.uid,uint_id:n.uint_id,audio:!0,ssrcId:n.audio_ssrc}),n.video&&this.emit(et.ON_ADD_VIDEO_STREAM,{uid:n.uid,uint_id:n.uint_id,video:!0,ssrcId:n.video_ssrc}),n.audio_mute?this.emit(et.MUTE_AUDIO,{uid:n.uid}):this.emit(et.UNMUTE_AUDIO,{uid:n.uid}),n.video_mute?this.emit(et.MUTE_VIDEO,{uid:n.uid}):this.emit(et.UNMUTE_VIDEO,{uid:n.uid}),n.audio_enable_local?this.emit(et.ENABLE_LOCAL_AUDIO,{uid:n.uid}):this.emit(et.DISABLE_LOCAL_AUDIO,{uid:n.uid}),n.video_enable_local?this.emit(et.ENABLE_LOCAL_VIDEO,{uid:n.uid}):this.emit(et.DISABLE_LOCAL_VIDEO,{uid:n.uid}),n.audio||n.video||this.emit(et.ON_REMOVE_STREAM,{uid:n.uid,uint_id:n.uint_id})}),!0)}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);const i=Oo(e.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(_t.UID_BANNED),void this.close()):void this.reconnect(i.action,Be.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=C("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>C("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Be.TIMEOUT):this.request(q.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-i;this.rttRolling.add(n),C("REPORT_STATS")&&this.send(q.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:i}=this.websocket.getWsInflateData();e!==0&&i!==0&&this.upload(Je.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on($.RECONNECT_WAITTING_FINISH,e=>{this.emit(B.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on($.RECONNECT_CREATE_CONNECTION,e=>{this.emit(B.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on($.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on($.CLOSED,()=>{this.connectionState=gt.CLOSED}),this.websocket.on($.FAILED,()=>{this._disconnectedReason=_t.NETWORK_ERROR,this.connectionState=gt.CLOSED}),this.websocket.on($.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===gt.CONNECTED?this.connectionState=gt.RECONNECTING:this.connectionState=gt.CONNECTING}),this.websocket.on($.WILL_RECONNECT,(e,i)=>{if(hr(this,B.IS_P2P_DISCONNECTED)&&e==="retry")return _.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(B.NEED_RENEW_SESSION),this.emit(B.DISCONNECT_P2P),i("tryNext");e!=="retry"&&(_.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(B.NEED_RENEW_SESSION),this.emit(B.DISCONNECT_P2P)),i(e)}),this.websocket.on($.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Be.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(B.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof I&&e.code===f.UNEXPECTED_RESPONSE&&e.data.code===K.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Be.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Be.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on($.REQUEST_NEW_URLS,(e,i)=>{ye(this,B.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on($.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(et.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}function lf(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}class VN extends Gt{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(xt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(xt.CONNECTED):this._state==="closed"?this.emit(xt.CLOSED):this._state==="failed"&&this.emit(xt.FAILED))}constructor(e,i,n,r){super(),h(this,"connectionID",0),h(this,"currentURLIndex",0),h(this,"reconnectReason",void 0),h(this,"_reconnectMode","tryNext"),h(this,"_initMutex",void 0),h(this,"_name",void 0),h(this,"_state","closed"),h(this,"_reconnectInterrupter",void 0),h(this,"_url",void 0),h(this,"_retryConfig",void 0),h(this,"_reconnectCount",0),h(this,"_forceCloseTimeout",5e3),h(this,"_onlineReconnectListener",void 0),h(this,"_closeEstablishingTransmitter",()=>{}),h(this,"_store",void 0),h(this,"_joinChannelServiceRecordIndex",void 0),h(this,"_transmitter",void 0),h(this,"_useCompress",void 0),h(this,"_inflateLength",0),h(this,"_deflateLength",0),this._store=r,this._name=e,this._retryConfig=function(o){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?lf(Object(a),!0).forEach(function(c){h(o,c,a[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(a)):lf(Object(a)).forEach(function(c){Object.defineProperty(o,c,Object.getOwnPropertyDescriptor(a,c))})}return o}({},i),this._useCompress=n}resetReconnectCount(e){_.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const n=this._transmitter;i?setTimeout(()=>n.close(),500):n.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,i){if(!this._transmitter)return void _.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;e!==void 0&&(this.reconnectMode=e),_.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((n=this._store)===null||n===void 0||n.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));const r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){const e=this._inflateLength,i=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:i}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}function hf(t,e,i){if("getBigUint64"in DataView.prototype)return t.getBigUint64(e,i);const n=t.getUint32(e,i),r=t.getUint32(e+4,i),o=+!!i,s=+!i;return BigInt(n*s+r*o)<<BigInt(32)|BigInt(n*o+r*s)}function pf(t,e,i,n){if("setBigUint64"in DataView.prototype)return t.setBigUint64(e,i,n);const r=Number(i>>BigInt(32)),o=Number(i&BigInt(4294967295));n?(t.setUint32(e+4,r,n),t.setUint32(e,o,n)):(t.setUint32(e,r,n),t.setUint32(e+4,o,n))}let Ii;(function(t){t[t.Default=0]="Default",t[t.Ack=1]="Ack"})(Ii||(Ii={}));class FN{constructor(e,i,n){h(this,"version",1),h(this,"initialRTO",void 0),h(this,"maxBatchAckCount",void 0),h(this,"maxRTO",void 0),h(this,"initialRTT",void 0),h(this,"ID",void 0),h(this,"rtt",void 0),h(this,"packetNumber",1),h(this,"rtoRatioMap",new Map),h(this,"timeoutMap",new Map),h(this,"unorderedPacketQueue",[]),h(this,"batchAckPacketQueue",[]),h(this,"lastOrderedPacketNumber",0),h(this,"batchAckTimer",void 0),h(this,"sendImpl",void 0),h(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=i,this.ID=Lt(7,"transmitter-"),this.initialRTO=(n==null?void 0:n.initialRTO)!==void 0?n.initialRTO:C("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(n==null?void 0:n.initialRTT)!==void 0?n.initialRTT:C("TRANSMITTER_INITIAL_RTT"),this.rtt=(n==null?void 0:n.initialRTT)!==void 0?n.initialRTT:C("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(n==null?void 0:n.maxBatchAckCount)!==void 0?n.maxBatchAckCount:C("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(n==null?void 0:n.maxRTO)!==void 0?n.maxRTO:C("TRANSMITTER_MAX_RTO")}packetize(e,i){return{type:Ii.Default,version:this.version,packetNumber:i,payload:e}}serialize(e){switch(e.type){case Ii.Default:{let i;typeof e.payload=="string"?i=new TextEncoder().encode(e.payload):i=e.payload;const n=new ArrayBuffer(i.length+15),r=new DataView(n);return r.setUint16(0,e.version),r.setUint8(2,e.type),r.setUint32(3,e.packetNumber),pf(r,7,BigInt(e.sendTs)),new Uint8Array(r.buffer).set(i,15),n}case Ii.Ack:{const i=new ArrayBuffer(16),n=new DataView(i);return n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.maxAckPacketNumber),n.setUint8(7,e.shift),pf(n,8,BigInt(e.ackSendTs)),i}}}deserialize(e){const i=new DataView(e),n=i.getUint16(0),r=i.getUint8(2);switch(r){case Ii.Default:{const o=i.getUint32(3),s=hf(i,7),a=e.slice(15),c=new TextDecoder().decode(a);return{version:n,type:r,packetNumber:o,sendTs:Number(s),payload:c}}case Ii.Ack:{const o=i.getUint32(3),s=i.getUint8(7),a=hf(i,8);return{version:n,type:r,maxAckPacketNumber:o,shift:s,ackSendTs:Number(a)}}default:throw _.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(e){const i=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const n=this.calculateRTO(i),r=window.setTimeout(()=>{this.resendMessage(i)},n);this.timeoutMap.set(i.packetNumber,r),this.sendPacket(i)}onData(e){const i=this.deserialize(e);i.type===Ii.Default?this.ack(i):i.type===Ii.Ack&&(this.updateRTT(i,Math.round(performance.now())),this.clearRTO(i))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(e=>{let[i,n]=e;window.clearTimeout(n)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const i=this.calculateRTO(e),n=window.setTimeout(()=>{this.resendMessage(e)},i);this.timeoutMap.set(e.packetNumber,n),this.sendPacket(e)}calculateRTO(e){const i=this.rtoRatioMap.get(e.packetNumber);if(i===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const n=9*this.rtt/8*i;return this.rtoRatioMap.set(e.packetNumber,i+1),n>this.maxRTO?this.maxRTO:n}}updateRTT(e,i){const n=e.ackSendTs;this.rtt=this.rtt*(7/8)+(i-n-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const i=this.unorderedPacketQueue[0];if(!i){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(i.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const i={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:Ii.Ack,version:this.version};this.sendPacket(i)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const i={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:Ii.Ack,version:this.version};this.sendPacket(i)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Ii.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===Ii.Default&&(e.sendTs=Math.round(performance.now()));const i=this.serialize(e);this.sendImpl(i)}clearRTO(e){for(let i=e.maxAckPacketNumber-e.shift;i<=e.maxAckPacketNumber;i++){const n=this.timeoutMap.get(i);n!==void 0&&window.clearTimeout(n),this.timeoutMap.delete(i),this.rtoRatioMap.delete(i)}}}class Ef extends VN{constructor(e,i){super(e,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),h(this,"_initMutex",void 0),h(this,"_reconnectInterrupter",void 0),h(this,"_url",void 0),h(this,"_transmitter",void 0),h(this,"_addresses",void 0),h(this,"_reliableTransmission",void 0),this._initMutex=new Ve("datachannel");const{timeout:n,timeoutFactor:r}=i,o=Math.max(300,Math.floor(3*n/5)),s=Math.max(1.2,Math.floor(8*r)/10);we.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s),Jt.on(Mn.NETWORK_STATE_CHANGE,(a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===we.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s):(this._retryConfig.timeout=n,this._retryConfig.timeoutFactor=r))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=i;const n=(r,o)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex(a=>a.fingerprint||C("FINGERPRINT"));const s=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(s).then(r).catch(o),this.once(xt.CLOSED,()=>o(new I(f.WS_DISCONNECT))),this.once(xt.CONNECTED,()=>r())};return this._initMutex.lock().then(r=>new V((o,s)=>{n(o,s)}).then(()=>{r()}).catch(()=>{r()}))}sendMessage(e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new I(f.WS_ABORT,"datachannel is not ready");try{i||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(n){throw new I(f.WS_ERR,"send datachannel signal message error"+n.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const i=JSON.stringify(e);return{compressed:i,compressedLength:i.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new V((i,n)=>{var r;const o=()=>{_.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},s=async u=>{var l;if((l=this._closeEstablishingTransmitter)===null||l===void 0||l.call(this),_.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(u.code,", reason: ").concat(u.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=u.reason,this.state="reconnecting");const E=on(this,xt.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,m=await this.reconnectWithAction(E);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!m)return n(new I(f.WS_DISCONNECT,"datachannel reconnect failed: ".concat(u.code))),void this.close(!0);i()}else n(new I(f.WS_DISCONNECT,"datachannel close: ".concat(u.code))),this.close()},a=u=>{var l;(l=this._reliableTransmission)===null||l===void 0||l.onData(u.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),_.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();ye(this,xt.TO_CONNECT_DATACHANNEL,e).then(u=>{var l,E;if(!u)throw new Error("transmissonInfo not exist yet");const{transmitter:m,close:T}=u;this._transmitter=m,(l=this._store)===null||l===void 0||l.signalChannelOpen();const g=Date.now()-d;_.debug("[choose dc] dc open cost ".concat(g,"ms")),this._reliableTransmission=new FN(R=>{var y;this._transmitter&&this._transmitter.readyState==="open"&&((y=this._transmitter)===null||y===void 0||y.send(R))},R=>{typeof R=="string"&&this.emit(xt.ON_MESSAGE,R)}),this._closeEstablishingTransmitter=()=>{var R;(R=this._reliableTransmission)===null||R===void 0||R.close(),this._reliableTransmission=void 0,T()},o&&o(),m.onclose=s,m.onmessage=a,(E=this._store)===null||E===void 0||E.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c}).catch(u=>{var l;if((l=this._store)===null||l===void 0||l.recordJoinChannelService({endTs:Date.now(),status:u instanceof I&&u.code===f.WS_ABORT?"aborted":"error",errors:[u]},c),this.state!=="closed"){if(u instanceof I&&u.code===f.WS_ERR){const E=new I(f.WS_ERR,"init datachannel failed! Error: ".concat(u.toString()));return _.error("[".concat(this._name,"]").concat(E)),void n(E)}s&&s(u)}else n(new I(f.WS_DISCONNECT,"datachannel is closed: ".concat(u.toString())))})})}async reconnectWithAction(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Jt.networkState!==we.OFFLINE||(this._onlineReconnectListener=Jt.onlineWaiter&&Jt.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},i){const s=Cd(this._reconnectCount,this._retryConfig);_.debug("[".concat(this._name,"] wait ").concat(s,"ms to reconnect datachannel, mode: ").concat(e)),await V.race([Ce(s),this._onlineReconnectListener||new V(()=>{})])}if(this.state==="closed"||!n)return!1;this._reconnectCount+=1;const r=async(s,a)=>{this.emit(xt.RECONNECT_CREATE_CONNECTION,a),await this.createTransmitterConnection(s)};try{if(e==="retry"){const s=this._addresses[this.currentURLIndex];this.emit(xt.RECONNECT_WAITTING_FINISH,e),await r(s,e)}else if(e==="tryNext"){this.currentURLIndex+=1;for(let a=this.currentURLIndex;a<this._addresses.length;a++){if(this._addresses[a].fingerprint||C("FINGERPRINT")){this.currentURLIndex=a;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return _.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);_.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const s=this._addresses[this.currentURLIndex];this.emit(xt.RECONNECT_WAITTING_FINISH,e),await r(s,e)}else e==="recover"&&(_.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(xt.RECONNECT_WAITTING_FINISH,e),this.emit(xt.FAILBACK));return!0}catch(s){var o;return _.error("[".concat(this._name,"] reconnect failed"),s.toString()),s!=null&&(o=s.data)!==null&&o!==void 0&&o.desc&&Array.isArray(s.data.desc)&&s.data.desc.length&&s.data.desc.includes("dynamic key expired")?(this.emit(xt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,i)}}}class gn extends Gt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===gt.CONNECTED?this.emit(B.WS_CONNECTED):e===gt.RECONNECTING?this.emit(B.WS_RECONNECTING,this._websocketReconnectReason):e===gt.CLOSED&&this.emit(B.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),h(this,"_disconnectedReason",void 0),h(this,"_websocketReconnectReason",void 0),h(this,"_connectionState",gt.CLOSED),h(this,"reconnectToken",void 0),h(this,"websocket",void 0),h(this,"openConnectionTime",void 0),h(this,"clientId",void 0),h(this,"lastMsgTime",Date.now()),h(this,"uploadCache",[]),h(this,"uploadCacheInterval",void 0),h(this,"rttRolling",new df(5)),h(this,"pingpongTimer",void 0),h(this,"inflateDataTimer",void 0),h(this,"pingpongTimeoutCount",0),h(this,"joinResponse",void 0),h(this,"multiIpOption",void 0),h(this,"initError",void 0),h(this,"spec",void 0),h(this,"store",void 0),h(this,"onWebsocketMessage",n=>{if(n instanceof ArrayBuffer)return void this.emit(B.ON_BINARY_DATA,n);const r=JSON.parse(n);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")&&(this.emit(r._type,r._message),r._type===et.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===et.ON_USER_BANNED))switch(r._message.error_code){case 14:this.close(_t.UID_BANNED);break;case 15:this.close(_t.IP_BANNED);break;case 16:this.close(_t.CHANNEL_BANNED)}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new Ef("gateway-".concat(this.clientId),this.spec.retryConfig,!0,i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===gt.CONNECTED&&this.reconnect("retry",en.OFFLINE)})}async request(e,i,n,r){const o=Lt(6,""),s={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new V((T,g)=>{if(this.connectionState===gt.CONNECTED)return T();const R=()=>{this.off(B.WS_CLOSED,y),T()},y=()=>{this.off(B.WS_CONNECTED,R),g(new I(f.WS_ABORT))};this.once(B.WS_CONNECTED,R),this.once(B.WS_CLOSED,y),e!==q.PUBLISH&&e!==q.SUBSCRIBE&&e!==q.UNSUBSCRIBE&&e!==q.UNPUBLISH&&e!==q.CONTROL&&e!==q.RESTART_ICE||this.once(B.DISCONNECT_P2P,()=>{g(new I(f.DISCONNECT_P2P))}),e!==q.PUBLISH&&e!==q.RESTART_ICE||this.once(B.ABORT_P2P_EXECUTION,()=>{g(new I(f.DISCONNECT_P2P))})});if(this.connectionState!==gt.CONNECTING&&this.connectionState!==gt.RECONNECTING||e===q.JOIN||e===q.REJOIN||await c(),e===q.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),this.websocket.sendMessage(s,!0,!1),r)return;const d=new V((T,g)=>{let R=!1;const y=(P,H)=>{R=!0,T({isSuccess:P==="success",message:H||{}}),this.off(B.WS_CLOSED,A),this.off(B.WS_RECONNECTING,A),this.emit(B.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),y);const A=()=>{g(new I(f.WS_ABORT,"type: ".concat(e))),this.off(B.WS_CLOSED,A),this.off(B.WS_RECONNECTING,A),this.off("res-@".concat(o),y)};this.once(B.WS_CLOSED,A),this.once(B.WS_RECONNECTING,A),Ce(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||R||(_.warning("dc request timeout, type: ".concat(e)),this.emit(B.REQUEST_TIMEOUT,e,i))})});let u=null;try{u=await d}catch(T){if(this.connectionState===gt.CLOSED||e===q.LEAVE)throw new I(f.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?T.throw():e===q.JOIN||e===q.REJOIN?null:(await c(),await this.request(e,i))}if(u.isSuccess)return u.message;const l=Number(u.message.error_code||u.message.code),E=Oo(l),m=new I(f.UNEXPECTED_RESPONSE,"".concat(E.desc,": ").concat(u.message.error_str),{code:l,data:u.message});return E.action==="success"?u.message:(_.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(E.desc,", action: ").concat(E.action)),l===K.ERR_TOO_MANY_BROADCASTERS?((e===q.JOIN||e===q.REJOIN)&&(this.initError=m,this.close()),m.throw()):E.action==="failed"?m.throw():E.action==="quit"?(this.initError=m,this.close(),m.throw()):(l===K.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",en.MULTI_IP)):this.reconnect(E.action,en.SERVER_ERROR),e===q.JOIN||e===q.REJOIN?null:await this.request(e,i)))}waitMessage(e,i){return new V(n=>{const r=o=>{(!i||i(o))&&(this.off(e,r),n(o))};this.on(e,r)})}upload(e,i){const n={_type:e,_message:i};try{this.websocket.sendMessage(n)}catch{const o=C("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==gt.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},C("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){const n={_type:e,_message:i};this.websocket.sendMessage(n)}init(e,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new V((n,r)=>{this.once(B.WS_CONNECTED,()=>n(this.joinResponse)),this.once(B.WS_CLOSED,()=>r(this.initError||new I(f.WS_ABORT))),this.connectionState=gt.CONNECTING,this.websocket.init(e).catch(r),this.websocket.once(xt.FAILBACK,()=>{this.openConnectionTime===void 0&&r(new I(f.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{i&&this.openConnectionTime===void 0&&(_.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),r(new I(f.INIT_DATACHANNEL_TIMEOUT)))},C("DC_JOIN_WITH_FAILBACK"))})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||_t.LEAVE,this.connectionState=gt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===_t.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Ef("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(B.ABORT_P2P_EXECUTION);const e=await ye(this,B.DATACHANNEL_CONNECTING),i=await this.request(q.JOIN,e);if(!i)return this.emit(B.REPORT_JOIN_GATEWAY,f.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(B.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new I(f.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=hr(this,B.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const i=await this.request(q.REJOIN,e);return!!i&&(this.connectionState=gt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(n=>{this.emit(et.ON_USER_ONLINE,{uid:n.uid}),n.audio&&this.emit(et.ON_ADD_AUDIO_STREAM,{uid:n.uid,uint_id:n.uint_id,audio:!0,ssrcId:n.audio_ssrc}),n.video&&this.emit(et.ON_ADD_VIDEO_STREAM,{uid:n.uid,uint_id:n.uint_id,video:!0,ssrcId:n.video_ssrc}),n.audio_mute?this.emit(et.MUTE_AUDIO,{uid:n.uid}):this.emit(et.UNMUTE_AUDIO,{uid:n.uid}),n.video_mute?this.emit(et.MUTE_VIDEO,{uid:n.uid}):this.emit(et.UNMUTE_VIDEO,{uid:n.uid}),n.audio_enable_local?this.emit(et.ENABLE_LOCAL_AUDIO,{uid:n.uid}):this.emit(et.DISABLE_LOCAL_AUDIO,{uid:n.uid}),n.video_enable_local?this.emit(et.ENABLE_LOCAL_VIDEO,{uid:n.uid}):this.emit(et.DISABLE_LOCAL_VIDEO,{uid:n.uid}),n.audio||n.video||this.emit(et.ON_REMOVE_STREAM,{uid:n.uid,uint_id:n.uint_id})}),!0)}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);const i=Oo(e.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(_t.UID_BANNED),void this.close()):void this.reconnect(i.action,en.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=C("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>C("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",en.TIMEOUT):this.request(q.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-i;this.rttRolling.add(n),C("REPORT_STATS")&&this.send(q.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleInflateData(){const{inflateLength:e,deflateLength:i}=this.websocket.getInflateData();e!==0&&i!==0&&this.upload(Je.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(xt.RECONNECT_WAITTING_FINISH,e=>{this.emit(B.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(xt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(B.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(xt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(xt.CLOSED,()=>{this.connectionState=gt.CLOSED}),this.websocket.on(xt.FAILED,()=>{this._disconnectedReason=_t.NETWORK_ERROR,this.connectionState=gt.CLOSED}),this.websocket.on(xt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===gt.CONNECTED?this.connectionState=gt.RECONNECTING:this.connectionState=gt.CONNECTING}),this.websocket.on(xt.WILL_RECONNECT,(e,i)=>{if(hr(this,B.IS_P2P_DISCONNECTED)&&e==="retry")return _.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(B.NEED_RENEW_SESSION),this.emit(B.DISCONNECT_P2P),i("tryNext");e!=="retry"&&(_.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(B.NEED_RENEW_SESSION),this.emit(B.DISCONNECT_P2P)),i(e)}),this.websocket.on(xt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",en.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(B.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof I&&e.code===f.UNEXPECTED_RESPONSE&&e.data.code===K.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",en.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",en.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(xt.REQUEST_NEW_URLS,(e,i)=>{ye(this,B.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on(xt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(et.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(xt.TO_CONNECT_DATACHANNEL,async(e,i,n)=>ye(this,B.DATACHANNEL_PRECONNECT,e).then(i).catch(n)),this.websocket.on(xt.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(B.DATACHANNEL_FAILBACK)})}}function _f(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function sn(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?_f(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):_f(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}const pu=new Map;class jN extends Gt{get state(){return this._state}set state(e){if(e===this._state)return;const i=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(kt.CONNECTION_STATE_CHANGE,e,i,this._disconnectedReason):this.emit(kt.CONNECTION_STATE_CHANGE,e,i)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){_.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,i){super(),h(this,"store",void 0),h(this,"joinInfo",void 0),h(this,"key",void 0),h(this,"signal",void 0),h(this,"role",void 0),h(this,"inChannelInfo",{joinAt:null,duration:0}),h(this,"spec",void 0),h(this,"_state","DISCONNECTED"),h(this,"_statsCollector",void 0),h(this,"_disconnectedReason",void 0),h(this,"isSignalRecover",!1),h(this,"hasChangeBGPAddress",!1),h(this,"trafficStatsInterval",void 0),h(this,"networkQualityInterval",void 0),h(this,"_joinGatewayStartTime",0),h(this,"_signalTimeout",!1),h(this,"_clientRoleOptions",void 0),h(this,"_isProactiveJoin",!1),this.store=e,this.spec=i,this.signal=this.store.useDataChannel?new gn(sn(sn({},i),{},{retryConfig:i.websocketRetryConfig}),e):new uf(sn(sn({},i),{},{retryConfig:i.websocketRetryConfig}),e),this._statsCollector=i.statsCollector,this.role=i.role||"audience",this._clientRoleOptions=i.clientRoleOptions,this.handleSignalEvents()}async join(e,i,n){if(this.signal instanceof gn){let c=!1;e.cloudProxyServer!=="disabled"?(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),c=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),c=!0):e.apResponse.addresses.some(d=>d.fingerprint)||C("FINGERPRINT")||(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),c=!0),c&&this.resetSignal()}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let o=pu.get(e.cname);if(o||(o=new Map,pu.set(e.cname,o)),this._isProactiveJoin=!0,o.has(e.uid)){const c=new I(f.UID_CONFLICT);throw G.joinGateway(e.sid,{lts:r,succ:!1,ec:c.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof gn?"1":"0"}),this._isProactiveJoin=!1,c}o.set(e.uid,!0),this.joinInfo=e,this.key=i;let s=0;this.joinGatewayStartTime=r;const a=e.proxyServer;try{let c;if(_.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof gn?"datachannel":"websocket"," join uid ").concat(s)),this.signal instanceof gn)c=await this.signal.init(e.apResponse.addresses,n);else{const d=e.proxyServer,u=d?e.gatewayAddrs.map(l=>{const E=l.address.split(":");return"wss://".concat(d,"/ws/?h=").concat(E[0],"&p=").concat(E[1])}):e.gatewayAddrs.map(l=>"wss://".concat(l.address));c=await this.signal.init(u,n)}s=c.uid,_.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof gn?"datachannel":"websocket"," join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(c){throw c&&c.code===f.INIT_WEBSOCKET_TIMEOUT?(_.warning("[".concat(this.store.clientId,"] User join failed"),c.toString()),c):c&&c.code===f.INIT_DATACHANNEL_TIMEOUT?(_.warning("[".concat(this.store.clientId,"] User join datachannel failed"),c.toString()),this.resetSignal(),c):(_.error("[".concat(this.store.clientId,"] User join failed"),c.toString()),G.joinGateway(e.sid,{lts:r,succ:!1,ec:c.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!a,signalChannel:this.signal instanceof gn?"1":"0"}),this._isProactiveJoin=!1,o.delete(e.uid),this.signal.close(),c)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),_.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(c=>{_.warning("[".concat(this.store.clientId,"] get traffic stats error"),c.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(kt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(kt.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(kt.NETWORK_QUALITY,{uplinkNetworkQuality:$m(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:$m(this._statsCollector.trafficStats.B_dnq)}):this.emit(kt.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),s}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){i!==_t.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==gt.CONNECTED||await function(n,r){return r===1/0?n:V.race([n,MN(r)])}(this.signal.request(q.LEAVE,void 0,!0),3e3)}catch(n){_.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),n)}this.signal.close(i),i!==_t.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,i,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new I(f.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:C("PUB_EXTEND"),twcc:!!C("PUBLISH_TWCC")};try{return(await this.signal.request(q.PUBLISH,r,!0))._message}catch(o){if(n&&o.data&&o.data.code===K.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(e,i),this.publish(e,i,!1);throw o}}async unpublish(e,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new I(f.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(q.UNPUBLISH,{stream_id:i,ortc:e},!0)}catch(n){_.warning("unpublish warning: ",n)}}async subscribe(e,i,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new I(f.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:e,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!C("SUBSCRIBE_TWCC"),extend:C("SUB_EXTEND"),ssrcId:i.ssrcId};try{return(await this.signal.request(q.SUBSCRIBE,r,!0))._message}catch(o){if(n&&o.data&&o.data.code===K.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(e,i),await this.subscribe(e,i,!1);throw o}}async subscribeAll(e,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new I(f.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:e,dtx:!1};try{return await this.signal.request(q.SUBSCRIBE_STREAMS,n,!0)}catch(r){if(i&&r.data&&r.data.code===K.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw r}}async setVideoProfile(e){const i=function(n){if(!(n.bitrateMax&&n.bitrateMin&&n.frameRate&&n.height&&n.width))return;let r=n.frameRate,o=n.width,s=n.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,r||(a=!1)),a?{stream_type:0,width:o,height:s,fps:r,start_bps:1e3*n.bitrateMax,min_bps:1e3*n.bitrateMin,target_bps:1e3*n.bitrateMax}:void 0}(e);if(i)return this.signal.request(q.SET_VIDEO_PROFILE,i);_.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,i){try{await this.signal.request(q.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:i},!0)}catch(n){_.warning("unsubscribe warning: ",n)}}async massUnsubscribe(e){try{await this.signal.request(q.UNSUBSCRIBE_STREAMS,e,!0)}catch(i){_.warning("unsubscribeAll warning: ",i)}}async reconnectPC(e){const{iceParameters:i,dtlsParameters:n,rtpCapabilities:r}=e;return{gatewayEstablishParams:await this.signal.request(q.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(q.GATEWAY_INFO)}renewToken(e){return this.signal.request(q.RENEW_TOKEN,e)}async setClientRole(e,i){if(i&&(this._clientRoleOptions=Object.assign({},i)),this.state!=="CONNECTED")return void(this.role=e);let n;n=e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:0,await this.signal.request(q.SET_CLIENT_ROLE,{role:e,level:n,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,i){await this.signal.request(q.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:i})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(q.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,i){await this.signal.request(q.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:i})}async pickSVCLayer(e,i){await this.signal.request(q.PICK_SVC_LAYER,{stream_id:e,spatial_layer:i.spatialLayer,temporal_layer:i.temporalLayer})}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),sn({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(q.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=pu.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(i){let n;return n=i.startsWith("dc")?i.match(/(dc\:\/\/)?([^:]+):(\d+)/):i.match(/(wss\:\/\/)?([^:]+):(\d+)/),n?{username:si.username,password:si.password,turnServerURL:n[2],tcpport:parseInt(n[3])+30,udpport:parseInt(n[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(sn(sn({},si),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const e=await this.signal.request(q.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.peer_delay.forEach(i=>{const n=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===i.peer_uid);n&&n.B_st!==i.B_st&&Ui(()=>{this.emit(kt.STREAM_TYPE_CHANGE,i.peer_uid,i.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new I(f.UNEXPECTED_ERROR,"can not generate join message, no join info");const i=Object.assign({},this.joinInfo.apResponse);let n=C("REPORT_APP_SCENARIO");if(typeof n!="string")try{n=JSON.stringify(n)}catch{n=void 0}n&&n.length>128&&(n=void 0);const r=sn({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:gi,browser:navigator.userAgent,process_id:C("PROCESS_ID"),mode:this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:i,extend:C("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:n,attributes:{userAttributes:{enablePublishedUserList:C("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:C("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof C("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?C("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof C("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?C("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof C("ENABLE_USER_LICENSE_CHECK")=="boolean"?C("ENABLE_USER_LICENSE_CHECK"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(r.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(r.aes_mode=this.joinInfo.aesmode,C("ENCRYPT_AES")?(r.aes_secret=this.joinInfo.aespassword,r.aes_encrypt=!0):r.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(r.aes_salt=this.joinInfo.aessalt)),i.addresses[this.signal.websocket.currentURLIndex]&&(r.ap_response.ticket=i.addresses[this.signal.websocket.currentURLIndex].ticket,delete i.addresses),this.joinInfo.defaultVideoStream!==void 0&&(r.default_video_stream=this.joinInfo.defaultVideoStream),r}getRejoinMessage(){if(!this.joinInfo)throw new I(f.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(B.WS_RECONNECT_WAITTING_FINISH,e=>{["tryNext","recover"].includes(e)&&this.joinInfo&&G.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(B.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(B.WS_RECONNECTING,e=>{this.joinInfo&&G.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||Be.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",G.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(B.WS_CLOSED,e=>{let i;switch(e){case _t.LEAVE:i=Be.LEAVE;break;case _t.UID_BANNED:case _t.IP_BANNED:case _t.CHANNEL_BANNED:case _t.SERVER_ERROR:i=Be.SERVER_ERROR;break;case _t.FALLBACK:i=Be.FALLBACK;break;case _t.LICENSE_MISSING:case _t.LICENSE_EXPIRED:case _t.LICENSE_MINUTES_EXCEEDED:case _t.LICENSE_PERIOD_INVALID:case _t.LICENSE_MULTIPLE_SDK_SERVICE:case _t.LICENSE_ILLEGAL:i=e;break;default:i=Be.NETWORK_ERROR}_.debug("[signal] websocket closed, reason: ".concat(i||"undefined -> "+Be.NETWORK_ERROR)),this.joinInfo&&G.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===_t.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:i}),this._disconnectedReason=e,e!==_t.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(B.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&this._clientRoleOptions.level&&(_.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions&&this._clientRoleOptions.level)),this.setClientRole(this.role,this._clientRoleOptions)),G.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof gn?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void _.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Ct("EVENT_REPORT_DOMAIN",e[1]),Ct("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Ct("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}),this.signal.on(et.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(B.REQUEST_RECOVER,(e,i,n)=>{if(!this.joinInfo)return n(new I(f.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,ye(this,kt.REQUEST_NEW_GATEWAY_LIST).then(i).catch(n)}),this.signal.on(B.REQUEST_JOIN_INFO,async e=>{var i;this.updateTurnConfigFromSignal();const{iceParameters:n,dtlsParameters:r,rtpCapabilities:o}=await ye(this,kt.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(i=this.joinInfo)===null||i===void 0?void 0:i.turnServer});e(this.getJoinMessage({ortc:{iceParameters:n,dtlsParameters:r,rtpCapabilities:o,version:"2"}}))}),this.signal.on(B.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(B.REPORT_JOIN_GATEWAY,(e,i)=>{this.joinInfo&&(G.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:i,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof gn?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(B.IS_P2P_DISCONNECTED,e=>{e(hr(this,kt.IS_P2P_DISCONNECTED))}),this.signal.on(B.DISCONNECT_P2P,()=>{this.emit(kt.DISCONNECT_P2P)}),this.signal.on(B.NEED_RENEW_SESSION,()=>{this.emit(kt.NEED_RENEW_SESSION)}),this.signal.on(B.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(B.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(B.JOIN_RESPONSE,e=>{const i=this.getCurrentGatewayAddress();this.emit(kt.JOIN_RESPONSE,e,i)}),this.signal.on(B.DATACHANNEL_PRECONNECT,async(e,i,n)=>{this.updateTurnConfigFromSignal();const r=this.getCurrentGatewayAddress();return ye(this,kt.DATACHANNEL_PRECONNECT,e,r).then(i).catch(n)}),this.signal.on(B.DATACHANNEL_CONNECTING,async e=>{const{iceParameters:i,dtlsParameters:n,rtpCapabilities:r}=await ye(this,kt.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:r,version:"2"}}))}),this.signal.on(B.DATACHANNEL_FAILBACK,()=>{_.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(kt.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(e,i){try{await this.signal.request(q.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[i]},!0)}catch(n){throw _.warning("unsubscribe warning",n),n}}async tryUnpubBeforeRepub(e,i){try{await this.signal.request(q.UNPUBLISH,{stream_id:e,ortc:i},!0)}catch(n){throw _.warning("unpublish warning: ",n),n}}async tryMassUnsubBeforeResub(e){const i={users:e.map(n=>({stream_id:n.stream_id,stream_type:n.stream_type}))};try{await this.signal.request(q.UNSUBSCRIBE_STREAMS,i,!0)}catch(n){throw _.warning("massUnsubscribe warning",n),n}}async muteLocal(e,i){const n={action:e.find(r=>r.stream_type===ee.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(q.CONTROL,n,!0,!0)}catch(r){throw _.warning("gateway unmuteLocal warning: ",r),r}}async unmuteLocal(e,i){const n={action:e.find(r=>r.stream_type===ee.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(q.CONTROL,n,!0,!0)}catch(r){throw _.warning("gateway muteLocal warning: ",r),r}}uploadStats(e,i){this.signal.upload(e,i)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(q.RESTART_ICE,i,!0)}catch(n){throw _.warning("P2PChannel.restartICE warning: ",n),n}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,Be.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!C("GATEWAY_WSS_ADDRESS"))return(e=this.joinInfo)!==null&&e!==void 0&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(q.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(_t.FALLBACK)),this.store.useDataChannel=!1,this.signal=new uf(sn(sn({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(kt.RESET_SIGNAL,qs.websocket)}}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var t;function e(O){var N=0;return function(){return N<O.length?{done:!1,value:O[N++]}:{done:!0}}}var i=typeof Object.defineProperties=="function"?Object.defineProperty:function(O,N,x){return O==Array.prototype||O==Object.prototype||(O[N]=x.value),O},n,r=function(O){O=[typeof globalThis=="object"&&globalThis,O,typeof window=="object"&&window,typeof self=="object"&&self,typeof Oe=="object"&&Oe];for(var N=0;N<O.length;++N){var x=O[N];if(x&&x.Math==Math)return x}throw Error("Cannot find global object")}(this);function o(O,N){if(N)t:{var x=r;O=O.split(".");for(var X=0;X<O.length-1;X++){var ut=O[X];if(!(ut in x))break t;x=x[ut]}(N=N(X=x[O=O[O.length-1]]))!=X&&N!=null&&i(x,O,{configurable:!0,writable:!0,value:N})}}function s(O){return(O={next:O})[Symbol.iterator]=function(){return this},O}function a(O){var N=typeof Symbol<"u"&&Symbol.iterator&&O[Symbol.iterator];return N?N.call(O):{next:e(O)}}if(o("Symbol",function(O){function N(ut,L){this.A=ut,i(this,"description",{configurable:!0,writable:!0,value:L})}if(O)return O;N.prototype.toString=function(){return this.A};var x="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",X=0;return function ut(L){if(this instanceof ut)throw new TypeError("Symbol is not a constructor");return new N(x+(L||"")+"_"+X++,L)}}),o("Symbol.iterator",function(O){if(O)return O;O=Symbol("Symbol.iterator");for(var N="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),x=0;x<N.length;x++){var X=r[N[x]];typeof X=="function"&&typeof X.prototype[O]!="function"&&i(X.prototype,O,{configurable:!0,writable:!0,value:function(){return s(e(this))}})}return O}),typeof Object.setPrototypeOf=="function")n=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}n=c?function(O,N){if(O.__proto__=N,O.__proto__!==N)throw new TypeError(O+" is not extensible");return O}:null}var u=n;function l(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function E(O){if(O.m)throw new TypeError("Generator is already running");O.m=!0}function m(O,N){return O.h=3,{value:N}}function T(O){this.g=new l,this.G=O}function g(O,N,x,X){try{var ut=N.call(O.g.j,x);if(!(ut instanceof Object))throw new TypeError("Iterator result "+ut+" is not an object");if(!ut.done)return O.g.m=!1,ut;var L=ut.value}catch(p){return O.g.j=null,O.g.s(p),R(O)}return O.g.j=null,X.call(O.g,L),R(O)}function R(O){for(;O.g.h;)try{var N=O.G(O.g);if(N)return O.g.m=!1,{value:N.value,done:!1}}catch(x){O.g.v=void 0,O.g.s(x)}if(O.g.m=!1,O.g.l){if(N=O.g.l,O.g.l=null,N.F)throw N.D;return{value:N.return,done:!0}}return{value:void 0,done:!0}}function y(O){this.next=function(N){return O.o(N)},this.throw=function(N){return O.s(N)},this.return=function(N){return function(x,X){E(x.g);var ut=x.g.j;return ut?g(x,"return"in ut?ut.return:function(L){return{value:L,done:!0}},X,x.g.return):(x.g.return(X),R(x))}(O,N)},this[Symbol.iterator]=function(){return this}}function A(O,N){return N=new y(new T(N)),u&&O.prototype&&u(N,O.prototype),N}if(l.prototype.o=function(O){this.v=O},l.prototype.s=function(O){this.l={D:O,F:!0},this.h=this.C||this.u},l.prototype.return=function(O){this.l={return:O},this.h=this.u},T.prototype.o=function(O){return E(this.g),this.g.j?g(this,this.g.j.next,O,this.g.o):(this.g.o(O),R(this))},T.prototype.s=function(O){return E(this.g),this.g.j?g(this,this.g.j.throw,O,this.g.o):(this.g.s(O),R(this))},o("Array.prototype.entries",function(O){return O||function(){return function(N,x){N instanceof String&&(N+="");var X=0,ut=!1,L={next:function(){if(!ut&&X<N.length){var p=X++;return{value:x(p,N[p]),done:!1}}return ut=!0,{done:!0,value:void 0}}};return L[Symbol.iterator]=function(){return L},L}(this,function(N,x){return[N,x]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var P=function(O,N){for(var x=0;x<O.length;x++)N(O[x])},H=function(O){return O.replace(/\r?\n|\r/g,`\r
`)},k=function(O,N,x){return N instanceof Blob?(x=x!==void 0?x+"":typeof N.name=="string"?N.name:"blob",N.name===x&&Object.prototype.toString.call(N)!=="[object Blob]"||(N=new File([N],x)),[String(O),N]):[String(O),String(N)]},M=function(O,N){if(O.length<N)throw new TypeError(N+" argument required, but only "+O.length+" present.")},D=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,j=D.FormData,yt=D.XMLHttpRequest&&D.XMLHttpRequest.prototype.send,Q=D.Request&&D.fetch,Dt=D.navigator&&D.navigator.sendBeacon,At=D.Element&&D.Element.prototype,Yt=D.Symbol&&Symbol.toStringTag;Yt&&(Blob.prototype[Yt]||(Blob.prototype[Yt]="Blob"),"File"in D&&!File.prototype[Yt]&&(File.prototype[Yt]="File"));try{new File([],"")}catch{D.File=function(N,x,X){return N=new Blob(N,X||{}),Object.defineProperties(N,{name:{value:x},lastModified:{value:+(X&&X.lastModified!==void 0?new Date(X.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Yt&&Object.defineProperty(N,Yt,{value:"File"}),N}}var _e=function(O){return O.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Kt=function(O){this.i=[];var N=this;O&&P(O.elements,function(x){if(x.name&&!x.disabled&&x.type!=="submit"&&x.type!=="button"&&!x.matches("form fieldset[disabled] *"))if(x.type==="file"){var X=x.files&&x.files.length?x.files:[new File([],"",{type:"application/octet-stream"})];P(X,function(ut){N.append(x.name,ut)})}else x.type==="select-multiple"||x.type==="select-one"?P(x.options,function(ut){!ut.disabled&&ut.selected&&N.append(x.name,ut.value)}):x.type==="checkbox"||x.type==="radio"?x.checked&&N.append(x.name,x.value):(X=x.type==="textarea"?H(x.value):x.value,N.append(x.name,X))})};if((t=Kt.prototype).append=function(O,N,x){M(arguments,2),this.i.push(k(O,N,x))},t.delete=function(O){M(arguments,1);var N=[];O=String(O),P(this.i,function(x){x[0]!==O&&N.push(x)}),this.i=N},t.entries=function O(){var N,x=this;return A(O,function(X){if(X.h==1&&(N=0),X.h!=3)return N<x.i.length?X=m(X,x.i[N]):(X.h=0,X=void 0),X;N++,X.h=2})},t.forEach=function(O,N){M(arguments,1);for(var x=a(this),X=x.next();!X.done;X=x.next()){var ut=a(X.value);X=ut.next().value,ut=ut.next().value,O.call(N,ut,X,this)}},t.get=function(O){M(arguments,1);var N=this.i;O=String(O);for(var x=0;x<N.length;x++)if(N[x][0]===O)return N[x][1];return null},t.getAll=function(O){M(arguments,1);var N=[];return O=String(O),P(this.i,function(x){x[0]===O&&N.push(x[1])}),N},t.has=function(O){M(arguments,1),O=String(O);for(var N=0;N<this.i.length;N++)if(this.i[N][0]===O)return!0;return!1},t.keys=function O(){var N,x,X,ut,L=this;return A(O,function(p){if(p.h==1&&(N=a(L),x=N.next()),p.h!=3)return x.done?void(p.h=0):(X=x.value,ut=a(X),m(p,ut.next().value));x=N.next(),p.h=2})},t.set=function(O,N,x){M(arguments,2),O=String(O);var X=[],ut=k(O,N,x),L=!0;P(this.i,function(p){p[0]===O?L&&(L=!X.push(ut)):X.push(p)}),L&&X.push(ut),this.i=X},t.values=function O(){var N,x,X,ut,L=this;return A(O,function(p){if(p.h==1&&(N=a(L),x=N.next()),p.h!=3)return x.done?void(p.h=0):(X=x.value,(ut=a(X)).next(),m(p,ut.next().value));x=N.next(),p.h=2})},Kt.prototype._asNative=function(){for(var O=new j,N=a(this),x=N.next();!x.done;x=N.next()){var X=a(x.value);x=X.next().value,X=X.next().value,O.append(x,X)}return O},Kt.prototype._blob=function(){var O="----formdata-polyfill-"+Math.random(),N=[],x="--"+O+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(X,ut){return typeof X=="string"?N.push(x+_e(H(ut))+`"\r
\r
`+H(X)+`\r
`):N.push(x+_e(H(ut))+'"; filename="'+_e(X.name)+`"\r
Content-Type: `+(X.type||"application/octet-stream")+`\r
\r
`,X,`\r
`)}),N.push("--"+O+"--"),new Blob(N,{type:"multipart/form-data; boundary="+O})},Kt.prototype[Symbol.iterator]=function(){return this.entries()},Kt.prototype.toString=function(){return"[object FormData]"},At&&!At.matches&&(At.matches=At.matchesSelector||At.mozMatchesSelector||At.msMatchesSelector||At.oMatchesSelector||At.webkitMatchesSelector||function(O){for(var N=(O=(this.document||this.ownerDocument).querySelectorAll(O)).length;0<=--N&&O.item(N)!==this;);return-1<N}),Yt&&(Kt.prototype[Yt]="FormData"),yt){var $e=D.XMLHttpRequest.prototype.setRequestHeader;D.XMLHttpRequest.prototype.setRequestHeader=function(O,N){$e.call(this,O,N),O.toLowerCase()==="content-type"&&(this.B=!0)},D.XMLHttpRequest.prototype.send=function(O){O instanceof Kt?(O=O._blob(),this.B||this.setRequestHeader("Content-Type",O.type),yt.call(this,O)):yt.call(this,O)}}Q&&(D.fetch=function(O,N){return N&&N.body&&N.body instanceof Kt&&(N.body=N.body._blob()),Q.call(this,O,N)}),Dt&&(D.navigator.sendBeacon=function(O,N){return N instanceof Kt&&(N=N._asNative()),Dt.call(this,O,N)}),D.FormData=Kt}})();const ca=()=>{const t=C("AREAS");return t.length===0&&t.push(at.GLOBAL),On(t).call(t,(e,i,n)=>{const r=mf(i);return r?n===0?r:"".concat(e,",").concat(r):e},"")},mf=t=>t===at.OVERSEA?"".concat(de.ASIA,",").concat(de.EUROPE,",").concat(de.AFRICA,",").concat(de.NORTH_AMERICA,",").concat(de.SOUTH_AMERICA,",").concat(de.OCEANIA):de[t],BN=t=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map(i=>{const n=Js[i],r=Object.keys(n);r&&r.map(o=>{o!=="CODE"&&(e[o]=e[o].concat(n[o]))})}),e},da={GLOBAL:{ASIA:[at.CHINA,at.JAPAN,at.INDIA,at.KOREA,at.HKMC],EUROPE:[],NORTH_AMERICA:[at.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Eu=Object.keys(da[at.GLOBAL]),ff=[at.CHINA,at.NORTH_AMERICA,at.EUROPE,at.ASIA,at.JAPAN,at.INDIA,at.OCEANIA,at.SOUTH_AMERICA,at.AFRICA,at.KOREA,at.HKMC,at.US],GN=function(t,e){let i=[];if(t.includes(at.GLOBAL)){const o=[at.GLOBAL,at.OVERSEA],s=Object.keys(Js);if(e===at.GLOBAL)throw new I(f.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===at.CHINA)i=[at.OVERSEA];else if(r=e,Eu.includes(r)){const a=(n=e,da[at.GLOBAL][n]||[]),c=[...o,e,...a];i=s.filter(d=>!c.includes(d))}else if(function(a){let c=!1;return Eu.forEach(d=>{da[at.GLOBAL][d].includes(a)&&(c=!0)}),c}(e)){const a=function(d){let u;return Eu.forEach(l=>{da[at.GLOBAL][l].includes(d)&&(u=l)}),u}(e),c=[...o,a,e];i=s.filter(d=>!c.includes(d))}else i=t;i=function(a){const c=[];return ff.forEach(d=>{a.includes(d)&&c.push(d)}),c.concat(a.filter(d=>!ff.includes(d)))}(i)}else i=t;var n,r;return i};function Sf(t){if(!t&&C("AREAS").includes(at.EXTENSIONS))return _.debug("update area from ap : reset"),void _u(i_,!0);if(!C("AREAS").includes(at.GLOBAL)||!t)return;let e=Js.EXTENSIONS;e&&(e={CODE:mf(at.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},_.debug("update area from ap success: ".concat(t,",config is "),e),Ct("AREAS",[at.EXTENSIONS],!0),Object.keys(e).map(i=>{i==="LOG_UPLOAD_SERVER"||i==="EVENT_REPORT_DOMAIN"||i==="EVENT_REPORT_BACKUP_DOMAIN"||i==="PROXY_SERVER_TYPE3"?Ct(i,e[i][0]):Ct(i,e[i])}))}function _u(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=G.reportApiInvoke(null,{name:$t.SET_AREA,options:t,tag:Mt.TRACER});try{let n=[];if(typeof t=="string"&&(n=[t]),Array.isArray(t)&&(t.forEach(o=>{if(!_w.includes(o))throw new I(f.INVALID_PARAMS,"invalid area code")}),n=t),Object.prototype.toString.call(t)==="[object Object]"){const{areaCode:o,excludedArea:s}=t;if(!o)throw new I(f.INVALID_PARAMS,"area code is needed");let a=o;typeof o=="string"&&(a=[o]),n=s?GN(a,s):a}if(!e){if(rr.AREAS){const o=new I(f.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(o),void _.warning("setArea is prohibited because of config-distribute")}if(n.includes(at.GLOBAL)&&C("AREAS")===at.EXTENSIONS){const o=new I(f.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(o),void _.warning("setArea is prohibited because of ap extensions")}}Ct("AREAS",n,e);const r=BN(n);Object.keys(r).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?Ct(o,r[o][0]):Ct(o,r[o])}),_.debug("set area success:",n.join(","))}catch(n){throw i.onError(n),n}i.onSuccess()}function gf(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Tf(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?gf(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):gf(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let mu=1;function WN(t,e,i,n,r){mu+=1;const o={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:mu,requestId:mu,version:gi,cname:i.cname},s={service_name:e,json_body:JSON.stringify(o)};let a,c,d=t[0];return tn(async()=>{a=Date.now();const u=await Yi(d,{data:s,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,u.code!==0){const m=new I(f.UNEXPECTED_RESPONSE,"live streaming ap error, code"+u.code,{retry:!0,responseTime:c});throw _.error(m.toString()),m}const l=JSON.parse(u.json_body);if(l.code!==200){const m=new I(f.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(l.code,", reason: ").concat(l.reason),{code:l.code,responseTime:c});throw _.error(m.toString()),m}if(!l.servers||l.servers.length===0){const m=new I(f.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:l.code,responseTime:c});throw _.error(m.toString()),m}const E=function(m,T){return{addressList:m.servers.map(g=>"wss://".concat(g.address.replace(/\./g,"-"),".").concat(C("WORKER_DOMAIN"),":").concat(g.wss,"?serviceName=").concat(encodeURIComponent(T))),workerToken:m.workerToken,vid:m.vid}}(l,e);return C("LIVE_STREAMING_ADDRESS")&&(E.addressList=C("LIVE_STREAMING_ADDRESS")instanceof Array?C("LIVE_STREAMING_ADDRESS"):[C("LIVE_STREAMING_ADDRESS")]),Tf(Tf({},E),{},{responseTime:c})},(u,l)=>(G.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(u.addressList),firstSuccess:l===0,responseTime:c,serverIp:t[l%t.length]}),!1),(u,l)=>(G.apworkerEvent(i.sid,{success:!1,sc:u.data&&u.data.code||200,serviceName:e,responseTime:c,serverIp:t[l%t.length]}),!!(u.code!==f.OPERATION_ABORTED&&u.code!==f.UNEXPECTED_RESPONSE||u.data&&u.data.retry)&&(d=t[(l+1)%t.length],!0)),r)}let fu=1;function Rf(t,e,i,n){let{url:r,areaCode:o}=t;const s=Date.now();let a;const[c,d]=yf(e,o,[se.CHOOSE_SERVER]);let u=Jt.networkState;return tn(async()=>{u&&Jt.networkState===we.OFFLINE&&Jt.onlineWaiter&&await V.race([Jt.onlineWaiter,Ce(n&&n.maxRetryTimeout||ne.maxRetryTimeout)]),u=Jt.networkState;const{data:l,headers:E}=await Yi(r,{data:c,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a=E.http3==="1"?1:-1,G.reportResourceTiming(r,e.sid),vf(l,r,e,s,[se.CHOOSE_SERVER],a);const m=du(l,se.CHOOSE_SERVER);return Cf(m),zm(m,r)},l=>(l&&G.joinChooseServer(e.sid,{lts:s,succ:!0,csAddr:r,opid:d,serverList:l.gatewayAddrs.map(E=>E.address),ec:null,cid:l.cid.toString(),uid:l.uid.toString(),csIp:l.csIp,unilbsServerIds:[se.CHOOSE_SERVER].toString(),isHttp3:a}),!1),l=>l.code!==f.OPERATION_ABORTED&&(l.code===f.CAN_NOT_GET_GATEWAY_SERVER?l.data.retry:(G.joinChooseServer(e.sid,{lts:s,succ:!1,csAddr:r,serverList:null,opid:d,ec:l.code,csIp:l.data&&l.data.csIp,unilbsServerIds:[se.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:u}),isHttp3:a}),_.warning("[".concat(e.clientId,"] Choose server network error, retry"),l),!0)),n)}function If(t,e,i,n){let r,{url:o,areaCode:s,serviceIds:a}=t;const c=Date.now(),[d,u]=yf(e,s,a);let l;return tn(async()=>{l&&Jt.networkState===we.OFFLINE&&Jt.onlineWaiter&&await V.race([Jt.onlineWaiter,Ce(n&&n.maxRetryTimeout||ne.maxRetryTimeout)]),l=Jt.networkState;const{data:E,headers:m}=await Yi(o,{data:d,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=m.http3==="1"?1:-1,G.reportResourceTiming(o,e.sid),vf(E,o,e,c,a,r);const T=du(E,se.CHOOSE_SERVER),g=du(E,e.cloudProxyServer==="proxy5"?se.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?se.CLOUD_PROXY:se.CLOUD_PROXY_FALLBACK);return Cf(T),{gatewayInfo:zm(T,o),proxyInfo:g,url:o}},E=>(E.gatewayInfo&&G.joinChooseServer(e.sid,{lts:c,succ:!0,csAddr:o,serverList:E.gatewayInfo.gatewayAddrs.map(m=>m.address),ec:null,opid:u,cid:E.gatewayInfo.cid.toString(),uid:E.gatewayInfo.uid.toString(),csIp:E.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r}),E.proxyInfo&&G.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:E.proxyInfo.addresses.map(m=>m.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1),E=>E.code!==f.OPERATION_ABORTED&&(E.code===f.CAN_NOT_GET_GATEWAY_SERVER?E.data.retry:(G.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:E.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:l})}),_.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),E),!0)),n)}const vf=(t,e,i,n,r,o)=>{const s=[],a=c=>{c.flag===4096?G.joinChooseServer(i.sid,{lts:n,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:c.error.message,csIp:c.error.data&&c.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o}):c.flag!==1048576&&c.flag!==4194304&&c.flag!==4194310||G.joinWebProxyAP(i.sid,{lts:n,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:c.error.code,eventType:i.cloudProxyServer,unilbsServerIds:r.toString()})};if(t.response_body.forEach(c=>{const d=c.buffer.code;if(c.uri===23&&d===0&&!c.buffer.edges_services)if(c.buffer.flag===4194310)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),c.buffer.edges_services=[];else{const u={error:new I(f.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:c.buffer.flag};s.push(u),a(u)}if(d!==0){const u=aa(d),l={error:new I(f.CAN_NOT_GET_GATEWAY_SERVER,u.desc,{desc:u.desc,retry:u.retry,csIp:t.detail[502]}),flag:c.buffer.flag};c.buffer.flag===4194310?_.warning(l.error.toString()):s.push(l),a(l)}}),s.length)throw _.warning("[".concat(i.clientId,"] multi unilbs ").concat(e," failed, ").concat(s.map(c=>"flag: ".concat(c.flag,", message: ").concat(c.error.message,", retry: ").concat(c.error.data.retry)).join(" | "))),new I(f.CAN_NOT_GET_GATEWAY_SERVER,s.map(c=>"flag: ".concat(c.flag,", message: ").concat(c.error.message)).join(" | "),{retry:!!s.find(c=>c.error.data.retry),csIp:t.detail[502],desc:[...new Set(s.map(c=>{var d,u;return c==null||(d=c.error)===null||d===void 0||(u=d.data)===null||u===void 0?void 0:u.desc}).filter(c=>!!c))]})},Cf=t=>{var e,i,n,r;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new I(f.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if((e=t.detail)!==null&&e!==void 0&&e[23]&&typeof((i=t.detail)===null||i===void 0?void 0:i[23])=="string"?Sf(t.detail[23].toLowerCase()):Sf(),(n=t.detail)!==null&&n!==void 0&&n[19]&&typeof((r=t.detail)===null||r===void 0?void 0:r[19])=="string"){const s=t.detail[19],a=s==null?void 0:s.split(";");for(let c=0;c<a.length;c++){var o;const d=hn(o=a[c]).call(o);t.addresses[c]&&a&&(t.addresses[c].fingerprint=d)}}if(C("GATEWAY_ADDRESS")&&C("GATEWAY_ADDRESS").length>0){_.debug("assign gateway address to",C("GATEWAY_ADDRESS"));const s=C("GATEWAY_ADDRESS").map(a=>{var c,d;const u=(c=(d=t.addresses.find(l=>l.ip===a.ip&&l.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:u}});t.addresses=s}},HN=(t,e)=>{if(t.response_body&&t.response_body.length){const i=t.response_body[0];if(i.buffer.code!==0){const n=aa(i.buffer.code);throw new I(f.UPDATE_TICKET_FAILED,"[".concat(i.buffer.code,"]: ").concat(n.desc),{retry:n.retry})}return i.buffer.ticket}throw _.debug("update ticket request received ap response without response body:",e),new I(f.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},yf=(t,e,i)=>{const n=Math.floor(Math.random()*1e12),r={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:{6:t.stringUid,11:e,12:C("USE_NEW_TOKEN")?"1":void 0,22:e},key:t.token,service_ids:i,uid:t.uid||0}}]};r.request_bodies.forEach(s=>{t.multiIP&&t.multiIP.gateway_ip&&(s.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))});const o=new FormData;return o.append("request",JSON.stringify(r)),[o,n]},KN=(t,e)=>{const i=Math.floor(Math.random()*1e12),n={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(n)),[r,i]};let Su=0;async function gu(t,e,i,n){return{gatewayInfo:await async function(o,s,a,c){let d=null;const u=[],l=async()=>{const m=C("WEBCS_DOMAIN").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(R=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(R+"/api/v2/transpond/webrtc?v=2"):"https://".concat(R,"/api/v2/transpond/webrtc?v=2"),areaCode:ca()})),T=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(R=>R.url)}),g=await Ao({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:R=>(_.debug("[".concat(o.clientId,"] Connect to choose_server:"),R.url),Rf(R,o,s,a)),allFailedhandler:R=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},T),R[0]},promisesCollector:u});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},T),g},E=async()=>{if(await Ce(1e3),d!==null)return d;const m=C("WEBCS_DOMAIN_BACKUP_LIST").map(R=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(R+"/api/v2/transpond/webrtc?v=2"):"https://".concat(R,"/api/v2/transpond/webrtc?v=2"),areaCode:ca()})),T=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(R=>R.url)}),g=await Ao({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:R=>(_.debug("[".concat(o.clientId,"] Connect to backup choose_server:"),R.url),Rf(R,o,s,a)),allFailedhandler:R=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},T),R[0]},promisesCollector:u});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},T),g};try{return d=await qr([l(),E()]),u.length&&u.forEach(m=>m.cancel&&typeof m.cancel=="function"&&m.cancel()),d}catch(m){throw m[0]}}(t,e,i,n)}}async function Af(t,e,i,n,r){const o=t.cloudProxyServer;if(o==="disabled"){if(!n)return;if(t.useLocalAccessPoint)return await gu(t,e,i,r);if(C("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:d,proxyInfo:u}=await bf(t,e,i,r);return t.turnServer&&t.turnServer.mode!=="auto"||(t.turnServer={mode:"manual",servers:u.map(l=>({turnServerURL:l.address,tcpport:l.tcpport||si.tcpport,udpport:l.udpport||si.udpport,username:l.username||si.username,password:l.password||si.password,forceturn:!1,security:!0}))}),{gatewayInfo:d}}return await gu(t,e,i,r)}const{proxyInfo:s,gatewayInfo:a}=await bf(t,e,i,r),c={gatewayInfo:a};return t.turnServer={mode:"manual",servers:s.map(d=>({turnServerURL:d.address,tcpport:o==="proxy3"?void 0:d.tcpport?d.tcpport:si.tcpport,udpport:o==="proxy4"?void 0:d.udpport?d.udpport:si.udpport,username:d.username||si.username,password:d.password||si.password,forceturn:o!=="proxy4",security:o==="proxy5"}))},_.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),c}async function Of(t,e,i,n,r){const o=C("ACCOUNT_REGISTER").slice(0,C("AJAX_REQUEST_CONCURRENT"));let s=[];s=e.proxyServer?o.map(c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1")):o.map(c=>"https://".concat(c,"/api/v1"));const a=r==null?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{const c=await async function(d,u,l,E,m){const T=Date.now(),g={sid:l.sid,opid:10,appid:l.appId,string_uid:u};let R=d[0];const y=await tn(()=>Yi(R+"".concat(R.indexOf("?")===-1?"?":"&","action=stringuid"),{data:g,cancelToken:E,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(A,P)=>{if(A.code===0){if(A.uid<=0||A.uid>=Math.pow(2,32))throw _.error("Invalid Uint Uid ".concat(u," => ").concat(A.uid),A),G.reqUserAccount(g.sid,{lts:T,success:!1,serverAddr:R,stringUid:g.string_uid,uid:A.uid,errorCode:f.INVALID_UINT_UID_FROM_STRING_UID,extend:g}),new I(f.INVALID_UINT_UID_FROM_STRING_UID);return G.reqUserAccount(g.sid,{lts:T,success:!0,serverAddr:R,stringUid:g.string_uid,uid:A.uid,errorCode:null,extend:g}),!1}const H=aa(A.code);return H.retry&&(R=d[(P+1)%d.length]),G.reqUserAccount(g.sid,{lts:T,success:!1,serverAddr:R,stringUid:g.string_uid,uid:A.uid,errorCode:H.desc,extend:g}),H.retry},(A,P)=>A.code!==f.OPERATION_ABORTED&&(G.reqUserAccount(g.sid,{lts:T,success:!1,serverAddr:R,stringUid:g.string_uid,uid:null,errorCode:A.code,extend:g}),R=d[(P+1)%d.length],!0),m);if(y.code!==0){const A=aa(y.code);throw new I(f.UNEXPECTED_RESPONSE,A.desc)}return y}(s,t,e,i,n);return r==null||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r==null||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function YN(t,e,i){const n=C("CDS_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(a=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(a+"/api/v1"):"https://".concat(a,"/api/v1?action=config")).map(a=>function(c,d,u,l){const E=Rt(),m={flag:64,cipher_method:0,features:{device:E.name,system:E.os,system_general:navigator.userAgent,vendor:d.appId,version:gi,cname:d.cname,sid:d.sid,session_id:d.sid,detail:"",proxyServer:d.proxyServer}};return tn(()=>Yi(c,{data:m,timeout:1e3,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,T=>T.code!==f.OPERATION_ABORTED,l)}(a,t,e,i));let r=null,o=null,s={};try{r=await qr(n)}catch(a){if(a.code===f.OPERATION_ABORTED)throw a;o=a}if(n.forEach(a=>a.cancel()),G.reportApiInvoke(t.sid,{name:$t.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:r}}).onSuccess(),r&&r.test_tags)try{s=function(a){if(!a.test_tags)return{};const c=a.test_tags,d=Object.keys(c),u={};return d.forEach(l=>{var E;const m=hn(E=l.slice(4)).call(E),T=JSON.parse(c[l])[1];u[m]=T}),u}(r)}catch{}return s}async function bf(t,e,i,n){const r=C("PROXY_SERVER_TYPE3"),o=(m,T,g)=>{let R=g||r;return Array.isArray(R)&&(R=T%2==0?r[1]:r[0]),"https://".concat(R,"/ap/?url=").concat(m)};let s=null;const a=[],c=async()=>{const m=C("WEBCS_DOMAIN").slice(0,C("AJAX_REQUEST_CONCURRENT")).map((R,y)=>{let A;return A=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(R,"/api/v2/transpond/webrtc?v=2"),y,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(R,"/api/v2/transpond/webrtc?v=2"):o("".concat(R,"/api/v2/transpond/webrtc?v=2"),y),{url:A,areaCode:ca(),serviceIds:[se.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?se.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?se.CLOUD_PROXY:se.CLOUD_PROXY_FALLBACK]}}),T=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(R=>R.url)}),g=await Ao({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:R=>(_.debug("[".concat(t.clientId,"] Connect to choose_server:"),R.url),If(R,t,e,i)),allFailedhandler:R=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},T),R[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},T),g},d=async()=>{if(await Ce(1e3),s!==null)return s;const m=C("WEBCS_DOMAIN_BACKUP_LIST").map((R,y)=>{let A;return A=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(R,"/api/v2/transpond/webrtc?v=2"),y,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(R,"/api/v2/transpond/webrtc?v=2"):o("".concat(R,"/api/v2/transpond/webrtc?v=2"),y),{url:A,areaCode:ca(),serviceIds:[se.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?se.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?se.CLOUD_PROXY:se.CLOUD_PROXY_FALLBACK]}}),T=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(R=>R.url)}),g=await Ao({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:R=>(_.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),R.url),If(R,t,e,i)),allFailedhandler:R=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},T),R[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},T),g};let u,l,E;try{({gatewayInfo:u,proxyInfo:l,url:E}=await qr([c(),d()]))}catch(m){throw m[0]}if(a.length&&a.forEach(m=>m.cancel&&typeof m.cancel=="function"&&m.cancel()),!u||!l)throw new I(f.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=E,t.cloudProxyServer!=="disabled"&&Array.isArray(r)&&E){const m=/^https?:\/\/(.+?)(\/.*)?$/.exec(E)[1];r.includes(m)&&(t.proxyServer=m,_.setProxyServer(m),G.setProxyServer(m))}return s={gatewayInfo:u,proxyInfo:await LN(l,u.uid)},s}async function wf(t,e,i,n){const r=C("UAP_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(o=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap"));return await WN(r,t,e,i,n)}async function qN(t,e,i){const n=C("UAP_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(r=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(r+"/api/v1?action=uap"):"https://".concat(r,"/api/v1?action=uap")).map(r=>function(o,s,a,c){const d={command:"convergeAllocateEdge",sid:s.sid,appId:s.appId,token:s.token,ts:Date.now(),version:gi,cname:s.cname,uid:s.uid.toString(),requestId:fu,seq:fu};fu+=1;const u={service_name:"tele_channel",json_body:JSON.stringify(d)};return tn(async()=>{const l=await Yi(o,{data:u,cancelToken:a,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(l.code!==0){const m=new I(f.UNEXPECTED_RESPONSE,"cross channel ap error, code"+l.code,{retry:!0});throw _.error(m.toString()),m}const E=JSON.parse(l.json_body);if(E.code!==200){const m=new I(f.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(E.code,", reason: ").concat(E.reason));throw _.error(m.toString()),m}if(!E.servers||E.servers.length===0){const m=new I(f.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw _.error(m.toString()),m}return{vid:E.vid,workerToken:E.workerToken,addressList:(C("CHANNEL_MEDIA_RELAY_SERVERS")||E.servers).map(m=>"wss://".concat(m.address.replace(/\./g,"-"),".").concat(C("WORKER_DOMAIN"),":").concat(m.wss))}},void 0,l=>!!(l.code!==f.OPERATION_ABORTED&&l.code!==f.UNEXPECTED_RESPONSE||l.data&&l.data.retry),c)}(r,t,e,i));try{const r=await qr(n);return n.forEach(o=>o.cancel()),r}catch(r){throw r[0]}}async function JN(t,e,i){let n=null;const r=[],o=async s=>{const a=C(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return s&&(await Ce(1e3),n!==null)?n:await Ao({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(_.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),c),function(d,u,l,E){const[m]=KN(u,[se.CHOOSE_SERVER]);let T=Jt.networkState;return tn(async()=>{T&&Jt.networkState===we.OFFLINE&&Jt.onlineWaiter&&await V.race([Jt.onlineWaiter,Ce(E&&E.maxRetryTimeout||ne.maxRetryTimeout)]),T=Jt.networkState;const g=await Yi(d,{data:m,cancelToken:l,headers:{"Content-Type":"multipart/form-data;"}},!0);return HN(g,d)},()=>!1,g=>g.code!==f.OPERATION_ABORTED&&(g.code===f.UPDATE_TICKET_FAILED?g.data.retry:(_.warning("[".concat(u.clientId,"] update ticket network error, retry"),g),!0)),E)}(c,t,e,i)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return n=await qr([o(!1),o(!0)]),r.length&&r.forEach(s=>s.cancel&&typeof s.cancel=="function"&&s.cancel()),n}catch(s){throw s[0]}}function Nf(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Df(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Nf(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Nf(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class XN extends Gt{constructor(){super(),h(this,"configs",void 0),h(this,"joinInfo",void 0),h(this,"cancelToken",void 0),h(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),h(this,"interval",void 0),h(this,"mutex",new Ve("config-distribute")),h(this,"mutableParamsRead",!1)}startGetConfigDistribute(e,i){this.joinInfo=e,this.cancelToken=i,this.interval&&this.stopGetConfigDistribute(),C("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},C("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,G.reportApiInvoke(null,{options:void 0,name:$t.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Mt.TRACER}).onSuccess(JSON.stringify(rr))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void _.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const i=await this.mutex.lock();try{e=await YN(this.joinInfo,this.cancelToken,this.retryConfig),_.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(n){const r=new I(f.NETWORK_RESPONSE_ERROR,n);_.warning("[config-distribute] ".concat(r.toString()))}finally{i()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var i;(i=e)&&i.uplink&&i.id&&i.uplink.max_bitrate!==void 0&&i.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(vo.UPDATE_BITRATE_LIMIT,e):this.emit(vo.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&Df({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var i;const n=kd(i=Object.keys(e).filter(o=>/^webrtc_ng_global_parameter/.test(o))).call(i);for(let o=0;o<n.length;o++)for(let s=n.length-1;s>o;s--){const a=n[s];if(typeof e[a].__priority=="number"){const c=e[a].__priority,d=n[s-1];if(typeof e[d].__priority=="number"){if(!(c>e[d].__priority))continue;{const u=a;n[s]=n[s-1],n[s-1]=u}}else{const u=a;n[s]=n[s-1],n[s-1]=u}}}const r={};n.forEach(o=>{const s=e[o],a=s.__expires;Object.keys(s).forEach(c=>{c==="__priority"||c==="__expires"||Object.prototype.hasOwnProperty.call(r,c)||(r[c]=Df({value:s[c]},a&&{expires:a}))})});try{const o=JSON.stringify(r),s=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",s),_.debug("Caching global parameters ".concat(o))}catch(o){_.error("Error caching global parameters:",o.message)}}}function Pf(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function bo(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Pf(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Pf(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class zN extends Gt{constructor(e,i,n,r){super(),h(this,"spec",void 0),h(this,"token",void 0),h(this,"websocket",void 0),h(this,"pingpongTimer",void 0),h(this,"reconnectMode","retry"),h(this,"serviceMode",void 0),h(this,"reqId",0),h(this,"commandReqId",0),h(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),h(this,"handleWebSocketMessage",o=>{if(!o.data)return;const s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):this.serviceMode===te.INJECT?this.emit(ki.INJECT_STREAM_STATUS,s):(G.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===te.TRANSCODE?1:2}),this.emit(ki.PUBLISH_STREAM_STATUS,s))}),this.spec=i,this.token=e,this.serviceMode=r,this.websocket=new Jr("live-streaming",n),this.websocket.on($.CONNECTED,this.handleWebSocketOpen),this.websocket.on($.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on($.REQUEST_NEW_URLS,(o,s)=>{ye(this,ki.REQUEST_NEW_ADDRESS).then(o).catch(s)}),this.websocket.on($.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,i,n,r){this.reqId+=1,e==="request"&&(this.commandReqId+=1);const o=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new I(f.UNEXPECTED_ERROR);const a=bo({command:e,sdkVersion:gi==="4.17.2"?"0.0.1":gi,seq:s,requestId:s,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},i);if(this.websocket.state==="closed")throw new I(f.WS_DISCONNECT);const c=()=>new V((E,m)=>{this.websocket.once($.CLOSED,()=>m(new I(f.WS_ABORT))),this.websocket.once($.CONNECTED,E)});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new V((E,m)=>{const T=()=>{m(new I(f.WS_ABORT))};this.websocket.once($.RECONNECTING,T),this.websocket.once($.CLOSED,T),this.once("@".concat(s,"-").concat(this.spec.sid),g=>{E(g)})});r&&G.workerEvent(this.spec.sid,bo(bo({},r),{},{requestId:o,actionType:"request",payload:JSON.stringify(i.clientRequest),serverCode:0,code:0}));const u=Date.now();this.websocket.sendMessage(a);let l=null;try{l=await d}catch(E){if(this.websocket.state==="closed")throw E;return await c(),await this.request(e,i,n)}return r&&G.workerEvent(this.spec.sid,bo(bo({},r),{},{requestId:o,actionType:"response",payload:JSON.stringify(l.serverResponse),serverCode:l.code,success:l.code===200,responseTime:Date.now()-u})),l.code!==200&&this.handleResponseError(l),l}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e=gi==="4.17.2"?"0.0.1":gi;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case Wt.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void _.warning("live stream response already exists stream");case Wt.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Wt.LIVE_STREAM_RESPONSE_BAD_STREAM:case Wt.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new I(f.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Wt.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new I(f.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Wt.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new I(f.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Wt.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const i=new I(f.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(ki.WARNING,i,e.serverResponse.url)}case Wt.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const i=new I(f.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(ki.WARNING,i,e.serverResponse.url)}case Wt.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new I(f.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Wt.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new I(f.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Wt.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const i=new I(f.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(ki.WARNING,i,e.serverResponse.url)}case Wt.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new I(f.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Wt.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new I(f.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Wt.LIVE_STREAM_RESPONSE_WORKER_LOST:case Wt.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new I(f.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Wt.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new I(f.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new I(f.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Wt.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Wt.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Wt.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Wt.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new I(f.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(oa)},6e3)}}function Lf(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function We(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Lf(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Lf(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class QN extends Gt{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ne,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ne;super(),h(this,"onLiveStreamWarning",void 0),h(this,"onLiveStreamError",void 0),h(this,"onInjectStatusChange",void 0),h(this,"spec",void 0),h(this,"retryTimeout",1e4),h(this,"connection",void 0),h(this,"httpRetryConfig",void 0),h(this,"wsRetryConfig",void 0),h(this,"streamingTasks",new Map),h(this,"isStartingStreamingTask",!1),h(this,"taskMutex",new Ve("live-streaming")),h(this,"cancelToken",Pi.CancelToken.source()),h(this,"transcodingConfig",void 0),h(this,"injectConfig",We({},Ew)),h(this,"injectLoopTimes",0),h(this,"uapResponse",void 0),h(this,"lastTaskId",1),h(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=n,this.wsRetryConfig=i}async setTranscodingConfig(e){const i=We(We({},pw),e);i.videoCodecProfile!==66&&i.videoCodecProfile!==77&&i.videoCodecProfile!==100&&(_.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map(s=>We(We(We({},hw),s),{},{zOrder:s.zOrder?s.zOrder+1:1}))),function(s){Pt(s.width)||Nt(s.width,"config.width",0,1e4),Pt(s.height)||Nt(s.height,"config.height",0,1e4),Pt(s.videoBitrate)||Nt(s.videoBitrate,"config.videoBitrate",1,1e6),Pt(s.videoFrameRate)||Nt(s.videoFrameRate,"config.videoFrameRate"),Pt(s.lowLatency)||To(s.lowLatency,"config.lowLatency"),Pt(s.audioSampleRate)||ce(s.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Pt(s.audioBitrate)||Nt(s.audioBitrate,"config.audioBitrate",1,128),Pt(s.audioChannels)||ce(s.audioChannels,"config.audioChannels",[1,2,3,4,5]),Pt(s.videoGop)||Nt(s.videoGop,"config.videoGop"),Pt(s.videoCodecProfile)||ce(s.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Pt(s.userCount)||Nt(s.userCount,"config.userCount",0,17),Pt(s.backgroundColor)||Nt(s.backgroundColor,"config.backgroundColor",0,16777215),Pt(s.userConfigExtraInfo)||Se(s.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),s.transcodingUsers&&!Pt(s.transcodingUsers)&&(_n(s.transcodingUsers,"config.transcodingUsers"),s.transcodingUsers.forEach((a,c)=>{xd(a.uid),Pt(a.x)||Nt(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),Pt(a.y)||Nt(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),Pt(a.width)||Nt(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),Pt(a.height)||Nt(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),Pt(a.zOrder)||Nt(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),Pt(a.alpha)||Nt(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)})),Pt(s.watermark)||Hd(s.watermark,"watermark"),Pt(s.backgroundImage)||Hd(s.backgroundImage,"backgroundImage"),s.images&&!Pt(s.images)&&(_n(s.images,"config.images"),s.images.forEach((a,c)=>{Hd(a,"images[".concat(c,"]"))}))}(i);const n=[];i.images&&n.push(...i.images.map(s=>We(We(We({},Wd),s),{},{zOrder:255}))),i.backgroundImage&&(n.push(We(We(We({},Wd),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(n.push(We(We(We({},Wd),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=n,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map(s=>We({},s)),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);const r=(i.userConfigs||[]).map(s=>typeof s.uid=="number"?V.resolve(s.uid):Of(s.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await V.all(r)).forEach((s,a)=>{i.userConfigs&&i.userConfigs[a]&&(i.userConfigs[a].uid=s)}),this.transcodingConfig=i,this.connection)try{var o;const s=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(nn(o=this.streamingTasks).call(o)).map(a=>a.taskId).join("#")});_.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(s.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(s){if(!s.data||!s.data.retry)throw s;s.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{_.warning("[".concat(this.spec.clientId,"] live streaming receive error"),s.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,s).then(()=>{_.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))}).catch(c=>{_.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})})}}setInjectStreamConfig(e,i){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=i}async startLiveStreamingTask(e,i,n){var r;if(Array.from(nn(r=this.streamingTasks).call(r)).find(c=>c.mode===te.INJECT)&&i===te.INJECT)return new I(f.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&i===te.TRANSCODE)throw new I(f.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let o={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};_.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(i));const s=await this.taskMutex.lock();if(!this.connection&&n)return void s();if(this.streamingTasks.get(e)&&!n)return s(),new I(f.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(c){throw s(),c}switch(i){case te.TRANSCODE:o.transcodingConfig=We({},this.transcodingConfig);break;case te.RAW:break;case te.INJECT:o={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(o.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const c=new V((u,l)=>{Ce(this.retryTimeout).then(()=>{if(n)return l(n);const E=this.statusError.get(e);return E?(this.statusError.delete(e),l(E)):void 0})}),d=await V.race([this.connection.request("request",{clientRequest:o},!0,{url:e,command:"PublishStream",workerType:i===te.TRANSCODE?1:2,requestByUser:!n,tid:a.toString()}),c]);this.isStartingStreamingTask=!1,_.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(d.code)),this.streamingTasks.set(e,{clientRequest:o,mode:i,url:e,taskId:a}),s()}catch(c){if(s(),this.isStartingStreamingTask=!1,!c.data||!c.data.retry||n)throw c;return c.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,i,c)):await this.startLiveStreamingTask(e,i,c)}}stopLiveStreamingTask(e){return new V((i,n)=>{const r=this.streamingTasks.get(e);if(!r||!this.connection)return new I(f.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=r.mode;r.abortTask=()=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),i()},this.connection.request("request",{clientRequest:{command:o===te.INJECT?"UninjectStream":"UnpublishStream",url:r.url}},!1,{url:e,command:"UnPublishStream",workerType:o===te.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&o!==te.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),i(),o===te.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Pn.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)}).catch(n)})}async controlInjectStream(e,i,n,r){const o=this.streamingTasks.get(e);if(!o||!this.connection||o.mode!==te.INJECT)throw new I(f.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:i,audioVolume:n,position:r}})).serverResponse}resetAllTask(){var e;const i=Array.from(nn(e=this.streamingTasks).call(e));this.terminate();for(const n of i)this.startLiveStreamingTask(n.url,n.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(n.url,r)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Pi.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new I(f.UNEXPECTED_ERROR,"live streaming connection has already connected");const i=await ye(this,Fr.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=i,this.connection=new zN(i.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(ki.WARNING,(n,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,n)),this.connection.on(ki.PUBLISH_STREAM_STATUS,n=>this.handlePublishStreamServer(n)),this.connection.on(ki.INJECT_STREAM_STATUS,n=>this.handleInjectStreamServerStatus(n)),this.connection.on(ki.REQUEST_NEW_ADDRESS,(n,r)=>{if(!this.connection)return r(new I(f.UNEXPECTED_ERROR,"can not get new live streaming address list"));ye(this,Fr.REQUEST_WORKER_MANAGER_LIST,e).then(o=>{this.uapResponse=o,n(o.addressList)}).catch(r)}),await this.connection.init(i.addressList),this.connection}handlePublishStreamServer(e){const i=e.serverStatus&&e.serverStatus.url||"empty_url",n=this.streamingTasks.get(i),r=e.reason;switch(e.code){case Wt.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Wt.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Wt.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Wt.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const s=new I(f.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(n)return _.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,s);if(!this.isStartingStreamingTask)return;this.statusError.set(i,s)}case Wt.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const s=new I(f.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,s)}case Wt.LIVE_STREAM_RESPONSE_WORKER_LOST:case Wt.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();const s=Array.from(nn(o=this.streamingTasks).call(o));for(const a of s)a.abortTask?a.abortTask():(_.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new I(f.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{_.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{_.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}handleInjectStreamServerStatus(e){const i=Number(e.uid),n=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Pn.INJECT_STREAM_STATUS_START_SUCCESS,i,n));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Pn.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,i,n),void this.streamingTasks.delete(n);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Pn.INJECT_STREAM_STATUS_START_UNAUTHORIZED,i,n),void this.streamingTasks.delete(n);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Pn.INJECT_STREAM_STATUS_BROKEN,i,n),void this.streamingTasks.delete(n);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Pn.INJECT_STREAM_STATUS_START_TIMEOUT,i,n),void this.streamingTasks.delete(n);default:return void _.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class kf{constructor(){h(this,"destChannelMediaInfos",new Map),h(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){A_(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){A_(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Ud(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function Mf(t){if(!(t instanceof kf))return new I(f.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=t.getSrcChannelMediaInfo(),i=t.getDestChannelMediaInfo();if(!e)return new I(f.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(i.size===0)return new I(f.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class ZN extends Gt{constructor(e,i,n){super(),h(this,"ws",void 0),h(this,"requestId",1),h(this,"heartBeatTimer",void 0),h(this,"joinInfo",void 0),h(this,"clientId",void 0),h(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),h(this,"onClose",r=>{this.emit("close"),this.dispose()}),h(this,"onMessage",r=>{const o=JSON.parse(r.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=e,this.clientId=i,this.ws=new Jr("cross-channel-".concat(this.clientId),n),this.ws.on($.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on($.CONNECTED,this.onOpen),this.ws.on($.ON_MESSAGE,this.onMessage),this.ws.on($.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){const i=this.requestId++;return e.requestId=i,e.seq=i,this.ws.sendMessage(e),i}waitStatus(e){return new V((i,n)=>{const r=window.setTimeout(()=>{n(new I(f.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,o=>{window.clearTimeout(r),o.state&&o.state!==0?n(new I(f.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):i(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),n(new I(f.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new I(f.WS_DISCONNECT);const i=()=>new V((s,a)=>{this.ws.once($.CLOSED,()=>a(new I(f.WS_ABORT))),this.ws.once($.CONNECTED,s)});this.ws.state!=="connected"&&await i();const n=this.sendMessage(e),r=new V((s,a)=>{const c=()=>{a(new I(f.WS_ABORT))};this.ws.once($.RECONNECTING,c),this.ws.once($.CLOSED,c),this.once("req_".concat(n),s),Ce(3e3).then(()=>{this.removeAllListeners("req_".concat(n)),this.ws.off($.RECONNECTING,c),this.ws.off($.CLOSED,c),a(new I(f.TIMEOUT,"cross channel ws request timeout"))})}),o=await r;if(!o||o.code!==200)throw new I(f.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(e){this.ws.removeAllListeners($.REQUEST_NEW_URLS),this.ws.on($.REQUEST_NEW_URLS,i=>{i(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const i=this.requestId++;return e.requestId=i,this.ws.sendMessage(e),i}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class $N extends Gt{set state(e){e!==this._state&&(e!==Ge.RELAY_STATE_FAILURE&&(this.errorCode=Ln.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,i,n,r){super(),h(this,"joinInfo",void 0),h(this,"sid",void 0),h(this,"clientId",void 0),h(this,"cancelToken",Pi.CancelToken.source()),h(this,"workerToken",void 0),h(this,"requestId",0),h(this,"signal",void 0),h(this,"prevChannelMediaConfig",void 0),h(this,"httpRetryConfig",void 0),h(this,"_state",Ge.RELAY_STATE_IDLE),h(this,"errorCode",Ln.RELAY_OK),h(this,"onStatus",o=>{_.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(o))),o&&o.command&&(o.command==="onAudioPacketReceived"&&this.emit("event",Ki.PACKET_RECEIVED_AUDIO_FROM_SRC),o.command==="onVideoPacketReceived"&&this.emit("event",Ki.PACKET_RECEIVED_VIDEO_FROM_SRC),o.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=Ln.SRC_TOKEN_EXPIRED,this.state=Ge.RELAY_STATE_FAILURE),o.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=Ln.DEST_TOKEN_EXPIRED,this.state=Ge.RELAY_STATE_FAILURE))}),h(this,"onReconnect",async()=>{_.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Ki.NETWORK_DISCONNECTED),this.state=Ge.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(o=>{this.state!==Ge.RELAY_STATE_IDLE&&(_.error("auto restart channel media relay failed",o.toString()),this.errorCode=Ln.SERVER_CONNECTION_LOST,this.state=Ge.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=i,this.sid=uu(),this.signal=new ZN(this.joinInfo,this.clientId,n),this.httpRetryConfig=r}async startChannelMediaRelay(e){if(this.state!==Ge.RELAY_STATE_IDLE)throw new I(f.INVALID_OPERATION);this.state=Ge.RELAY_STATE_CONNECTING,await this.connect(),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(i){throw i.data&&i.data.serverResponse&&i.data.serverResponse.command==="SetSourceChannel"?new I(f.CROSS_CHANNEL_FAILED_JOIN_SRC):i.data&&i.data.serverResponse&&i.serverResponse.command==="SetDestChannelStatus"?new I(f.CROSS_CHANNEL_FAILED_JOIN_DEST):i.data&&i.data.serverResponse&&i.serverResponse.command==="StartPacketTransfer"?new I(f.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):i}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==Ge.RELAY_STATE_RUNNING)throw new I(f.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),_.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Ge.RELAY_STATE_IDLE,this.dispose()}dispose(){_.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Pi.CancelToken.source(),this.state=Ge.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await qN(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Ki.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const i=this.genMessage(Ue.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(Ue.SetSdkProfile,e);await this.signal.request(n),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const r=this.genMessage(Ue.SetSourceChannel,e);await this.signal.request(r),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Ki.PACKET_JOINED_SRC_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(Ue.SetSourceUserId,e);await this.signal.request(o),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const s=this.genMessage(Ue.SetDestChannel,e);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Ki.PACKET_JOINED_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(Ue.StartPacketTransfer,e);await this.signal.request(a),this.emit("event",Ki.PACKET_SENT_TO_DEST_CHANNEL),this.state=Ge.RELAY_STATE_RUNNING,_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success"))}async sendUpdateMessage(e){const i=this.genMessage(Ue.UpdateDestChannel,e);await this.signal.request(i),this.emit("event",Ki.PACKET_UPDATE_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(Ue.StopPacketTransfer);await this.signal.request(e),_.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,i){const n=[],r=[],o=[];this.requestId+=1;const s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:gi,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};s.sdkVersion==="4.17.2"&&(s.sdkVersion="0.0.1");let a=null,c=null;switch(e){case Ue.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case Ue.SetSourceChannel:if(c=i&&i.getSrcChannelMediaInfo(),!c)throw new I(f.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},s;case Ue.SetSourceUserId:if(c=i&&i.getSrcChannelMediaInfo(),!c)throw new I(f.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:c.uid+""},s;case Ue.SetDestChannel:if(a=i&&i.getDestChannelMediaInfo(),!a)throw new I(f.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{n.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"SetDestChannel",channelName:n,uid:r,token:o},s;case Ue.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case Ue.Reconnect:return s.clientRequest={command:"Reconnect"},s;case Ue.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case Ue.UpdateDestChannel:if(a=i&&i.getDestChannelMediaInfo(),!a)throw new I(f.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{n.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"UpdateDestChannel",channelName:n,uid:r,token:o},s}return s}}const Tu=t=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new V((i,n)=>{e.toBlob(async r=>{if(e.remove(),r){const o=await Uf(r);i({buffer:o,width:e.width,height:e.height})}else n(new I(f.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,1)})},Uf=async t=>{const e=await t.arrayBuffer();return new Uint8Array(e)};function xf(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Vf(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?xf(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):xf(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class Ru{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(_.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}constructor(e){h(this,"trackId",void 0),h(this,"config",void 0),h(this,"onFirstVideoFrameDecoded",void 0),h(this,"freezeTimeCounterList",[]),h(this,"renderFreezeAccTime",0),h(this,"timeUpdatedCount",0),h(this,"freezeTime",0),h(this,"playbackTime",0),h(this,"lastTimeUpdatedTime",0),h(this,"autoplayFailed",!1),h(this,"videoTrack",void 0),h(this,"videoElement",void 0),h(this,"cacheVideoElement",void 0),h(this,"videoElementCheckInterval",void 0),h(this,"_videoElementStatus",ge.NONE),h(this,"isGettingVideoDimensions",!1),h(this,"startGetVideoDimensions",()=>{const i=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return _.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(i,500)};!this.isGettingVideoDimensions&&i()}),h(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&ct.curState==="running"&&(ad()?(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.2")),this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):RE()?(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.1")),this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):TE()&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.0")),this.videoElement.pause(),this.videoElement.play()))}),h(this,"handleVideoEvents",i=>{switch(i.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=ge.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=ge.CANPLAY;break;case"stalled":this.videoElementStatus=ge.STALLED;break;case"suspend":this.videoElementStatus=ge.SUSPEND;break;case"pause":this.videoElementStatus=ge.PAUSED,ke()||$i()||Le()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=ge.WAITING;break;case"abort":this.videoElementStatus=ge.ABORT;break;case"ended":this.videoElementStatus=ge.ENDED;break;case"emptied":this.videoElementStatus=ge.EMPTIED;break;case"error":{this.videoElementStatus=ge.ERROR;const n=this.videoElement.error;n&&_.error("[".concat(this.trackId,"] media error, code: ").concat(n.code,", message: ").concat(n.message));break}case"timeupdate":{const n=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=n);const r=n-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=n,fn.lastVisibleTime<fn.lastHiddenTime||o<fn.lastHiddenTime||o<fn.lastVisibleTime)return;for(r>C("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),h(this,"autoResumeAfterInterruptionOnIOS15",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(ad()?(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.2")),this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):RE()?(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.1")),this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):TE()&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for iOS 15.0")),this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),ct.on(ae.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ct.on(ae.IOS_15_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const i=this.videoElement.play();i&&i.catch&&i.catch(r=>{e&&G.autoplayFailed(e,"video",r.message,this.trackId),r.name==="NotAllowedError"?(_.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):_.warning("[".concat(this.trackId,"] play warning: "),r)});const n=Rt();if((n.name==="Safari"&&Number(n.version)===15||Nr())&&i&&i.then&&i.catch){const r=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};i.then(r).catch(r)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const i=e.getContext("2d");if(!i)return _.error("create canvas context failed!"),new ImageData(2,2);i.drawImage(this.videoElement,0,0,e.width,e.height);const n=i.getImageData(0,0,e.width,e.height);return e.remove(),n}async getCurrentFrameToUint8Array(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const n=document.createElement("canvas");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight;const r=n.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,n.width,n.height),new V((o,s)=>{n.toBlob(async a=>{if(n.remove(),a){const c=await Uf(a);o({buffer:c,width:n.width,height:n.height})}else s(new I(f.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,i<0?.1:i>1?1:i)})):await Tu(e)}destroy(){ct.off(ae.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ct.off(ae.IOS_15_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=ge.INIT,!this.videoElementCheckInterval&&(Ff.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(o){return o!==document.body&&document.body.contains(o)})(this.videoElement)||(this.videoElementStatus=ge.DESTROYED)},1e3),C("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,i;let o;const s=(a,c)=>{if(this.videoElementStatus===ge.PLAYING){if(o){const l=c.presentationTime-o.presentationTime;l>C("VIDEO_FREEZE_DURATION")&&fn.lastVisibleTime>=fn.lastHiddenTime&&o.timestamp>fn.lastVisibleTime&&o.timestamp>fn.lastHiddenTime&&(this.renderFreezeAccTime+=l)}o=Vf(Vf({},c),{},{timestamp:a})}var d,u;C("ENABLE_VIDEO_FRAME_CALLBACK")&&((d=(u=this.videoElement).requestVideoFrameCallback)===null||d===void 0||d.call(u,s))};(e=(i=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(i,s)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),cd()&&(this.videoElement.poster="noposter");const n=Rt();n.name==="Safari"&&Number(n.version)===15||Nr()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Bt()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Bt()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch(o=>{_.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){Ff.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=ge.NONE}handleAutoPlayFailed(){const e=i=>{i.preventDefault(),this.videoElement.play().then(()=>{_.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(n=>{_.error(n)}),this.autoplayFailed=!1,mo()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};mo()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),G_()}}const Ff=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class jf extends Ru{constructor(e){super(e),h(this,"container",void 0),h(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const i=e.element;i!==this.slot&&(this.destroy(),this.slot=i),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var i;(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var i;let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,n):await Tu(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",C("KEEP_LAST_FRAME")&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function ua(t){const e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});const i=nr(t.encoderConfig);return e.width=i.width,e.height=i.height,!vE()&&i.frameRate&&(e.frameRate=i.frameRate),Rt().name===St.EDGE&&typeof e.frameRate=="object"&&(e.frameRate.max=60),Bt()&&(e.frameRate={ideal:30,max:30}),e}function t0(t){const e={};t.screenSourceType&&(e.mediaSource=t.screenSourceType),t.extensionId&&od()&&(e.extensionId=t.extensionId);const{displaySurface:i,selfBrowserSurface:n,surfaceSwitching:r,systemAudio:o}=t;(sd(107)||mE(107)||fE(93))&&(i&&(ce(i,"displaySurface",["browser","window","monitor"]),e.displaySurface=i),n?(ce(n,"selfBrowserSurface",["exclude","include"]),e.selfBrowserSurface=n):e.selfBrowserSurface="include",r&&(ce(r,"surfaceSwitching",["exclude","include"]),e.surfaceSwitching=r)),(sd(105)||mE(105)||fE(91))&&o&&(ce(o,"systemAudio",["exclude","include"]),e.systemAudio=o),t.electronScreenSourceId&&(e.sourceId=t.electronScreenSourceId);const s=t.encoderConfig?bd(t.encoderConfig):null;return e.mandatory={chromeMediaSource:"desktop",maxWidth:s?s.width:void 0,maxHeight:s?s.height:void 0},s&&(s.frameRate&&(typeof s.frameRate=="number"?(e.mandatory.maxFrameRate=s.frameRate,e.mandatory.minFrameRate=s.frameRate):(e.mandatory.maxFrameRate=s.frameRate.max||s.frameRate.ideal||s.frameRate.exact||void 0,e.mandatory.minFrameRate=s.frameRate.min||s.frameRate.ideal||s.frameRate.exact||void 0),e.frameRate=s.frameRate),s.width&&(e.width=s.width),s.height&&(e.height=s.height)),e}function Bf(t){const e={};if(vE()||(t.AGC!==void 0&&(e.autoGainControl=t.AGC),t.AEC!==void 0&&(e.echoCancellation=t.AEC),t.ANS!==void 0&&(e.noiseSuppression=t.ANS,od()&&t.ANS&&(e.googHighpassFilter=t.ANS))),t.encoderConfig){const i=Ys(t.encoderConfig);e.channelCount=i.stereo?2:1,e.sampleRate=i.sampleRate,e.sampleSize=i.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),cd()&&(e.sampleRate=void 0),e}var Xr,la;(function(t){t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE"})(Xr||(Xr={})),function(t){t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(la||(la={}));var Gf,Wf,Hf,Kf,Yf,qf,Jf,Xf,zf,Qf,Zf,$f,tS,eS,iS,nS,rS,oS,sS,aS,cS,dS,uS,lS,it,hS,pS,ES,_S,mS,fS,SS,gS,vi,TS=new class{constructor(){h(this,"_clientSize",null),h(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),h(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),h(this,"getStyle",t=>window.getComputedStyle(t,null)),h(this,"checkCssVisibleProperty",t=>{let e=!0;const i=this.getStyle(t),{display:n,visibility:r,opacity:o,filter:s}=i;return(n==="none"||["hidden","collapse"].includes(r)||Number(o)<.1)&&(e=!1),e?(s&&s.split(" ").filter(a=>{const c=a.split("(")[0];return["brightness","blur","opacity"].includes(c)}).map(a=>{const[c,d]=a.split(/\(|\)/);return[c,Number(d.match(/^[0-9\.]+/))]}).forEach(a=>{const[c,d]=a;switch(c){case"brightness":(d<.1||d>3)&&(e=!1);break;case"blur":d>3&&(e=!1);break;case"opacity":d<.1&&(e=!1)}}),e):!1}),h(this,"checkPropertyUpToAllParentNodes",(t,e)=>{let i=!0,n=!0;const r=s=>e(s);let o=t;for(;o&&n;)r(o)||(i=!1,n=!1),o=o.parentElement,o||(n=!1);return i}),h(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),h(this,"getSizeAboutClient",t=>{const{width:e,height:i,left:n,right:r,top:o,bottom:s}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:i,left:n,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),h(this,"checkActualSize",()=>{const{width:t,height:e,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(t,e,i)}),h(this,"elementFromPoint",(t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null),h(this,"checkCoverForAPoint",(t,e,i)=>{const n=this.elementFromPoint(t,e);return n!==null&&n!==i}),h(this,"getPointPositionList",()=>{const{width:t,height:e,left:i,top:n}=this._clientSize,r=t/6,o=e/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){const u=(i*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,l=(n*a+(d===0?.1:d===4?(o*d*a-1e5)/a:o*d)*a)/a;s.push({x:u,y:l})}return[...s]}),h(this,"checkElementCover",t=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,t)).filter(e=>!!e).length>6),h(this,"checkSizeIsVisible",(t,e,i)=>(t>50||i/t<=10)&&(e>50||i/e<=10)),h(this,"checkSizeOfPartInClient",()=>{const{left:t,right:e,top:i,bottom:n,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize;let a,c,d,u;if(t<0)a=0;else{if(!(t<o))return!1;a=t}if(e<0)return!1;if(c=e<o?e:o,i<0)d=0;else{if(!(i<r))return!1;d=i}if(n<0)return!1;u=n<r?n:r;const l=c-a,E=u-d;return this.checkSizeIsVisible(l,E,s)}),h(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),h(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(Xr.COVERED);{const e=this.checkActualSize(),i=this.checkSizeOfPartInClient();return e&&!i?this.returnHiddenResult(Xr.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Xr.SIZE)}}return this.returnHiddenResult(Xr.STYLE)}return this.returnHiddenResult(la.UNMOUNTED)}return this.returnHiddenResult(la.INVALID_HTML_ELEMENT)}),h(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function RS(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function wo(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?RS(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):RS(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let zt=(Gf=Y({argsMap:(t,e,i)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),Wf=Ht(),Hf=Y({argsMap:t=>[t.getTrackId()]}),Kf=Br("LocalVideoTrack","_enabledMutex"),Yf=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),qf=Ht(),Jf=Br("LocalVideoTrack","_enabledMutex"),Xf=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),zf=Ht(),Qf=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),Zf=Ht(),$f=Ht(),tS=Y({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),eS=Ht(),iS=Ht(),nS=Ht(),rS=Ht(),oS=Ht(),sS=Ht(),aS=Ht(),cS=Y({argsMap:(t,e)=>[t.getTrackId(),e.name]}),dS=Y({argsMap:t=>[t.getTrackId()]}),uS=Y({argsMap:t=>[t.getTrackId()]}),lS=Y({argsMap:(t,e,i)=>[t.getTrackId(),e.label,i]}),w((it=class GT extends eu{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==ge.PLAYING)}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,i,n,r,o,s){if(super(e,o),h(this,"trackMediaType","video"),h(this,"_player",void 0),h(this,"_videoVisibleTimer",null),h(this,"_previousVideoVisibleStatus",void 0),h(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),h(this,"_encoderConfig",void 0),h(this,"_scalabiltyMode",{numSpatialLayers:1,numTemporalLayers:1}),h(this,"_optimizationMode",void 0),h(this,"_videoHeight",void 0),h(this,"_videoWidth",void 0),h(this,"_forceBitrateLimit",void 0),h(this,"_enabled",!0),h(this,"processorDestination",void 0),h(this,"_processorContext",void 0),Le()){const{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();this._encoderConfig=i,this._scalabiltyMode=n,this._optimizationMode=r,this._hints=s||[],this._hints.indexOf(re.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile(),i&&this._hints.indexOf(re.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(i),this.processorContext=new sm(this.getTrackId(),"local"),this.processorDestination=new om(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const r=document.getElementById(e);r?e=r:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));const n=wo(wo(wo({},this._getDefaultPlayerConfig()),i),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(n):(e instanceof HTMLVideoElement?this._player=new Ru(n):this._player=new jf(n),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.emit(kn.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},C("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await Vt(this,J.NEED_DISABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}return i||(this._enabled=!1),void _.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Vt(this,J.NEED_ENABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Vt(this,J.NEED_MUTE_TRACK,this):await Vt(this,J.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,i){if(!this._enabled)throw new I(f.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=nr(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const n=ua({encoderConfig:e});(Le()||ke()||$i())&&(n.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(r){const o=new I(f.UNEXPECTED_ERROR,r.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=e,this._hints.indexOf(re.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Vt(this,J.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw()}}getStats(){return yo(()=>{_.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),on(this,J.GET_STATS)||wo({},Gd)}async setBeautyEffect(e){_.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,i):await Tu(e)}clone(e,i,n,r){const o=this._mediaStreamTrack.clone();return new GT(o,e,i,n,r)}async setBitrateLimit(e){if(_.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await Vt(this,J.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw()}}}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void _.error(f.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const i=this._optimizationMode;try{this._optimizationMode=e,await Vt(this,J.SET_OPTIMIZATION_MODE,this)}catch(n){throw this._optimizationMode=i,_.error("[".concat(this.getTrackId(),"] set optimization mode failed"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return _.error(f.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabiltyMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabiltyMode=e,_.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){ef(this._originMediaStreamTrack).then(e=>{let[i,n]=e;this._videoHeight=n,this._videoWidth=i}).catch(oa)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:i,frameRate:n}=this.getMediaStreamTrackSettings();if(!e||!i||!n)return;const[r,o]=function(s,a,c){const d=C("BITRATE_ADAPTER_TYPE");let u;const l=200*Math.pow(c/15,.6)*Math.pow(s*a/640/360,.75),E=l;if(d==="STANDARD_BITRATE")u=4*l;else{if(d!=="COMPATIABLE_BITRATE")return;u=2*l}return[Math.floor(u),Math.floor(E)]}(e,i,n)||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=o,this._encoderConfig.bitrateMax=r,_.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(i,", fps: ").concat(n,"] => [brMax: ").concat(r,", brMin: ").concat(o,"]")))}getVideoElementVisibleStatus(){try{var e,i;const n=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:o,slot:s}=r;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){const a=TS.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(n){throw new I(f.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new I(f.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}async replaceTrack(e,i){if(!(e instanceof MediaStreamTrack))throw new I(f.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new I(f.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,i,!0),this.updateMediaStreamTrackResolution()}bindProcessorDestinationEvents(){this.processorDestination.on(Ie.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await Vt(this,J.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Vt(this,J.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Ie.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(ze.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(ze.REQUEST_CONSTRAINTS)}}).prototype,"play",[Gf,Wf],Object.getOwnPropertyDescriptor(it.prototype,"play"),it.prototype),w(it.prototype,"stop",[Hf],Object.getOwnPropertyDescriptor(it.prototype,"stop"),it.prototype),w(it.prototype,"setEnabled",[Kf,Yf,qf],Object.getOwnPropertyDescriptor(it.prototype,"setEnabled"),it.prototype),w(it.prototype,"setMuted",[Jf,Xf,zf],Object.getOwnPropertyDescriptor(it.prototype,"setMuted"),it.prototype),w(it.prototype,"setEncoderConfiguration",[Qf,Zf],Object.getOwnPropertyDescriptor(it.prototype,"setEncoderConfiguration"),it.prototype),w(it.prototype,"getStats",[$f],Object.getOwnPropertyDescriptor(it.prototype,"getStats"),it.prototype),w(it.prototype,"setBeautyEffect",[tS,eS],Object.getOwnPropertyDescriptor(it.prototype,"setBeautyEffect"),it.prototype),w(it.prototype,"getCurrentFrameData",[iS],Object.getOwnPropertyDescriptor(it.prototype,"getCurrentFrameData"),it.prototype),w(it.prototype,"getCurrentFrameImage",[nS],Object.getOwnPropertyDescriptor(it.prototype,"getCurrentFrameImage"),it.prototype),w(it.prototype,"setBitrateLimit",[rS],Object.getOwnPropertyDescriptor(it.prototype,"setBitrateLimit"),it.prototype),w(it.prototype,"setOptimizationMode",[oS],Object.getOwnPropertyDescriptor(it.prototype,"setOptimizationMode"),it.prototype),w(it.prototype,"setScalabiltyMode",[sS],Object.getOwnPropertyDescriptor(it.prototype,"setScalabiltyMode"),it.prototype),w(it.prototype,"updateMediaStreamTrackResolution",[aS],Object.getOwnPropertyDescriptor(it.prototype,"updateMediaStreamTrackResolution"),it.prototype),w(it.prototype,"pipe",[cS],Object.getOwnPropertyDescriptor(it.prototype,"pipe"),it.prototype),w(it.prototype,"unpipe",[dS],Object.getOwnPropertyDescriptor(it.prototype,"unpipe"),it.prototype),w(it.prototype,"close",[uS],Object.getOwnPropertyDescriptor(it.prototype,"close"),it.prototype),w(it.prototype,"replaceTrack",[lS],Object.getOwnPropertyDescriptor(it.prototype,"replaceTrack"),it.prototype),it),IS=(hS=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),pS=Ht(),ES=Br("CameraVideoTrack","_enabledMutex"),_S=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),mS=Ht(),fS=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),SS=Ht(),gS=Y({argsMap:t=>[t.getTrackId()]}),w((vi=class extends zt{get __className__(){return"CameraVideoTrack"}constructor(t,e,i,n,r,o){super(t,nr(e.encoderConfig),n,r,o),h(this,"_config",void 0),h(this,"_originalConstraints",void 0),h(this,"_constraints",void 0),h(this,"_enabled",!0),h(this,"_deviceName","default"),h(this,"tryResumeVideoForIOS15WeChat",async()=>{Nr()&&!ad()&&IE()&&this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=e,this._originalConstraints=i,this._constraints=i,this._deviceName=t.label,this._encoderConfig=nr(this._config.encoderConfig),ct.on(ae.IOS_15_INTERRUPTION_END,this.tryResumeVideoForIOS15WeChat),ct.on(ae.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15WeChat),this.bindProcessorContextEvents()}async setDevice(t){if(_.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const e=await hi.getDeviceById(t),i={};i.video=wo({},this._constraints),i.video.deviceId={exact:t},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let n=null;try{n=await Mi(i,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),n=await Mi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await hi.getDeviceById(t);this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}_.info("[".concat(this.getTrackId(),"] setDevice success"))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const i=await Mi({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await Vt(this,J.NEED_ENABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),e||(this._enabled=!1);try{await Vt(this,J.NEED_DISABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,e){if(!this._enabled)throw new I(f.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t=nr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin);const i=Xt(this._config);i.encoderConfig=t;const n=ua(i);(Le()||ke()||$i())&&(n.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(r){const o=new I(f.UNEXPECTED_ERROR,r.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}this._config=i,this._constraints=n,this._originalConstraints=n,this._encoderConfig=t,this._hints.indexOf(re.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Vt(this,J.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw()}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((ke()||$i())&&this._enabled&&!this._isClosed&&ct.duringInterruption){const t=async()=>{ct.off(ae.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};ct.on(ae.IOS_INTERRUPTION_END,t)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.emit(kn.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=hi.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId={exact:i}),this._enabled){const n=await Mi({video:e},this.getTrackId());this._constraints=e,await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),ct.off(ae.IOS_15_INTERRUPTION_END,this.tryResumeVideoForIOS15WeChat),ct.off(ae.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15WeChat)}bindProcessorContextEvents(){this.processorContext.on(ze.REQUEST_UPDATE_CONSTRAINTS,async(t,e,i)=>{try{const n=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(n),e()}catch(n){i(n)}}),this.processorContext.on(ze.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}}).prototype,"setDevice",[hS,pS],Object.getOwnPropertyDescriptor(vi.prototype,"setDevice"),vi.prototype),w(vi.prototype,"setEnabled",[ES,_S,mS],Object.getOwnPropertyDescriptor(vi.prototype,"setEnabled"),vi.prototype),w(vi.prototype,"setEncoderConfiguration",[fS,SS],Object.getOwnPropertyDescriptor(vi.prototype,"setEncoderConfiguration"),vi.prototype),w(vi.prototype,"close",[gS],Object.getOwnPropertyDescriptor(vi.prototype,"close"),vi.prototype),vi);class Iu{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio)return this._audioTrack}get videoTrack(){if(this.hasVideo)return this._videoTrack}constructor(e,i){h(this,"uid",void 0),h(this,"_uintid",void 0),h(this,"_trust_in_room_",!0),h(this,"_trust_audio_enabled_state_",!0),h(this,"_trust_video_enabled_state_",!0),h(this,"_trust_audio_mute_state_",!0),h(this,"_trust_video_mute_state_",!0),h(this,"_audio_muted_",!1),h(this,"_video_muted_",!1),h(this,"_audio_enabled_",!0),h(this,"_video_enabled_",!0),h(this,"_audio_added_",!1),h(this,"_video_added_",!1),h(this,"_trust_video_stream_added_state_",!0),h(this,"_trust_audio_stream_added_state_",!0),h(this,"_audioTrack",void 0),h(this,"_videoTrack",void 0),h(this,"_audioSSRC",void 0),h(this,"_videoSSRC",void 0),h(this,"_audioOrtc",void 0),h(this,"_videoOrtc",void 0),h(this,"_cname",void 0),h(this,"_rtxSsrcId",void 0),this.uid=e,this._uintid=i}}var e0=Mp,i0=yr,n0=Is;Fe({target:"Promise",stat:!0},{try:function(t){var e=i0.f(this),i=n0(t);return(i.error?e.reject:e.resolve)(i.value),e.promise}});var vu=e0,r0=Fe,o0=Et,s0=Tt,a0=Co,c0=Ni,d0=Cn,u0=yn,vS=Nd,l0=D_,h0=x_,p0=fr,CS=fe("isConcatSpreadable"),yS=9007199254740991,AS="Maximum allowed index exceeded",OS=o0.TypeError,E0=p0>=51||!s0(function(){var t=[];return t[CS]=!1,t.concat()[0]!==t}),_0=h0("concat"),m0=function(t){if(!c0(t))return!1;var e=t[CS];return e!==void 0?!!e:a0(t)};r0({target:"Array",proto:!0,forced:!E0||!_0},{concat:function(t){var e,i,n,r,o,s=d0(this),a=l0(s,0),c=0;for(e=-1,n=arguments.length;e<n;e++)if(m0(o=e===-1?s:arguments[e])){if(c+(r=u0(o))>yS)throw OS(AS);for(i=0;i<r;i++,c++)i in o&&vS(a,c,o[i])}else{if(c>=yS)throw OS(AS);vS(a,c++,o)}return a.length=c,a}});var bS={},f0=no,S0=In,wS=rs.f,g0=r_,NS=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];bS.f=function(t){return NS&&f0(t)=="Window"?function(e){try{return wS(e)}catch{return g0(NS)}}(t):wS(S0(t))};var No={},T0=fe;No.f=T0;var DS=vn,R0=ei,I0=No,v0=Gi.f,Ee=function(t){var e=DS.Symbol||(DS.Symbol={});R0(e,t)||v0(e,t,{value:I0.f(t)})},zr=Fe,Cu=Et,C0=zi,y0=Da,Do=Bi,A0=ue,Qr=Xi,pr=Va,yu=Tt,Ae=ei,O0=Co,b0=Pe,w0=Ni,N0=_i,Au=Fa,Ou=Wi,D0=Cn,ha=In,bu=Zo,PS=Rr,wu=Yn,Po=cs,LS=sc,P0=rs,kS=bS,Nu=rc,MS=io,US=Gi,L0=oc,xS=Pa,k0=Cc,Du=Ss,Lo=Qo.exports,VS=os,FS=Ka,jS=fe,M0=No,U0=Ee,x0=uo,BS=fs,pa=L_.forEach,pi=ns("hidden"),Ea="Symbol",GS=jS("toPrimitive"),V0=BS.set,WS=BS.getterFor(Ea),qi=Object.prototype,xn=Cu.Symbol,Er=xn&&xn.prototype,HS=Cu.TypeError,Pu=Cu.QObject,ko=C0("JSON","stringify"),KS=MS.f,Vn=US.f,YS=kS.f,F0=xS.f,qS=A0([].push),Tn=Lo("symbols"),Mo=Lo("op-symbols"),Lu=Lo("string-to-symbol-registry"),ku=Lo("symbol-to-string-registry"),j0=Lo("wks"),Mu=!Pu||!Pu.prototype||!Pu.prototype.findChild,Uu=Qr&&yu(function(){return Po(Vn({},"a",{get:function(){return Vn(this,"a",{value:7}).a}})).a!=7})?function(t,e,i){var n=KS(qi,e);n&&delete qi[e],Vn(t,e,i),n&&t!==qi&&Vn(qi,e,n)}:Vn,xu=function(t,e){var i=Tn[t]=Po(Er);return V0(i,{type:Ea,tag:t,description:e}),Qr||(i.description=e),i},_a=function(t,e,i){t===qi&&_a(Mo,e,i),Ou(t);var n=bu(e);return Ou(i),Ae(Tn,n)?(i.enumerable?(Ae(t,pi)&&t[pi][n]&&(t[pi][n]=!1),i=Po(i,{enumerable:wu(0,!1)})):(Ae(t,pi)||Vn(t,pi,wu(1,{})),t[pi][n]=!0),Uu(t,n,i)):Vn(t,n,i)},Vu=function(t,e){Ou(t);var i=ha(e),n=LS(i).concat(Fu(i));return pa(n,function(r){Qr&&!Do(JS,i,r)||_a(t,r,i[r])}),t},JS=function(t){var e=bu(t),i=Do(F0,this,e);return!(this===qi&&Ae(Tn,e)&&!Ae(Mo,e))&&(!(i||!Ae(this,e)||!Ae(Tn,e)||Ae(this,pi)&&this[pi][e])||i)},XS=function(t,e){var i=ha(t),n=bu(e);if(i!==qi||!Ae(Tn,n)||Ae(Mo,n)){var r=KS(i,n);return!r||!Ae(Tn,n)||Ae(i,pi)&&i[pi][n]||(r.enumerable=!0),r}},zS=function(t){var e=YS(ha(t)),i=[];return pa(e,function(n){Ae(Tn,n)||Ae(VS,n)||qS(i,n)}),i},Fu=function(t){var e=t===qi,i=YS(e?Mo:ha(t)),n=[];return pa(i,function(r){!Ae(Tn,r)||e&&!Ae(qi,r)||qS(n,Tn[r])}),n};if(pr||(Du(Er=(xn=function(){if(N0(Er,this))throw HS("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?PS(arguments[0]):void 0,e=FS(t),i=function(n){this===qi&&Do(i,Mo,n),Ae(this,pi)&&Ae(this[pi],e)&&(this[pi][e]=!1),Uu(this,e,wu(1,n))};return Qr&&Mu&&Uu(qi,e,{configurable:!0,set:i}),xu(e,t)}).prototype,"toString",function(){return WS(this).tag}),Du(xn,"withoutSetter",function(t){return xu(FS(t),t)}),xS.f=JS,US.f=_a,L0.f=Vu,MS.f=XS,P0.f=kS.f=zS,Nu.f=Fu,M0.f=function(t){return xu(jS(t),t)},Qr&&Vn(Er,"description",{configurable:!0,get:function(){return WS(this).description}})),zr({global:!0,wrap:!0,forced:!pr,sham:!pr},{Symbol:xn}),pa(LS(j0),function(t){U0(t)}),zr({target:Ea,stat:!0,forced:!pr},{for:function(t){var e=PS(t);if(Ae(Lu,e))return Lu[e];var i=xn(e);return Lu[e]=i,ku[i]=e,i},keyFor:function(t){if(!Au(t))throw HS(t+" is not a symbol");if(Ae(ku,t))return ku[t]},useSetter:function(){Mu=!0},useSimple:function(){Mu=!1}}),zr({target:"Object",stat:!0,forced:!pr,sham:!Qr},{create:function(t,e){return e===void 0?Po(t):Vu(Po(t),e)},defineProperty:_a,defineProperties:Vu,getOwnPropertyDescriptor:XS}),zr({target:"Object",stat:!0,forced:!pr},{getOwnPropertyNames:zS,getOwnPropertySymbols:Fu}),zr({target:"Object",stat:!0,forced:yu(function(){Nu.f(1)})},{getOwnPropertySymbols:function(t){return Nu.f(D0(t))}}),ko&&zr({target:"JSON",stat:!0,forced:!pr||yu(function(){var t=xn();return ko([t])!="[null]"||ko({a:t})!="{}"||ko(Object(t))!="{}"})},{stringify:function(t,e,i){var n=k0(arguments),r=e;if((w0(e)||t!==void 0)&&!Au(t))return O0(e)||(e=function(o,s){if(b0(r)&&(s=Do(r,this,o,s)),!Au(s))return s}),n[1]=e,y0(ko,null,n)}}),!Er[GS]){var B0=Er.valueOf;Du(Er,GS,function(t){return Do(B0,this)})}x0(xn,Ea),VS[pi]=!0,Ee("asyncIterator"),Ee("hasInstance"),Ee("isConcatSpreadable"),Ee("iterator"),Ee("match"),Ee("matchAll"),Ee("replace"),Ee("search"),Ee("species"),Ee("split"),Ee("toPrimitive"),Ee("toStringTag"),Ee("unscopables"),uo(Et.JSON,"JSON",!0);var G0=vn.Symbol;Ee("asyncDispose"),Ee("dispose"),Ee("matcher"),Ee("metadata"),Ee("observable"),Ee("patternMatch"),Ee("replaceAll");var QS=G0,ZS=No.f("asyncIterator"),W0=ZS;function $S(t){this.wrapped=t}function Uo(t){var e,i;function n(o,s){try{var a=t[o](s),c=a.value,d=c instanceof $S;vu.resolve(d?c.wrapped:c).then(function(u){d?n(o==="return"?"return":"next",u):r(a.done?"return":"normal",u)},function(u){n("throw",u)})}catch(u){r("throw",u)}}function r(o,s){switch(o){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1})}(e=e.next)?n(e.key,e.arg):i=null}this._invoke=function(o,s){return new vu(function(a,c){var d={key:o,arg:s,resolve:a,reject:c,next:null};i?i=i.next=d:(e=i=d,n(o,s))})},typeof t.return!="function"&&(this.return=void 0)}function xi(t){return function(){return new Uo(t.apply(this,arguments))}}function rt(t){return new $S(t)}Uo.prototype[typeof QS=="function"&&W0||"@@asyncIterator"]=function(){return this},Uo.prototype.next=function(t){return this._invoke("next",t)},Uo.prototype.throw=function(t){return this._invoke("throw",t)},Uo.prototype.return=function(t){return this._invoke("return",t)};var H0=No.f("iterator");function xo(t,e){var i={},n=!1;function r(o,s){return n=!0,s=new vu(function(a){a(t[o](s))}),{done:!1,value:e(s)}}return i[QS!==void 0&&H0||"@@iterator"]=function(){return this},i.next=function(o){return n?(n=!1,o):r("next",o)},typeof t.throw=="function"&&(i.throw=function(o){if(n)throw n=!1,o;return r("throw",o)}),typeof t.return=="function"&&(i.return=function(o){return n?(n=!1,o):r("return",o)}),i}var tg=ZS,Qt={exports:{}};function eg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ig(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?eg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):eg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function ju(t,e,i,n,r,o,s){let a=[],c=[],d=[],u=[],l=!1,E=!1;if(Qt.exports.parse(t).mediaDescriptions.forEach(m=>{s&&s!==m.attributes.direction||(m.media.mediaType!=="video"||l||(c=m.attributes.payloads,u=m.attributes.extmaps,l=!0),m.media.mediaType!=="audio"||E||(a=m.attributes.payloads,d=m.attributes.extmaps,E=!0))}),!u||c.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!d||a.length===0)throw new Error("Cannot get audio capabilities from SDP.");return c.forEach(m=>{var T;(T=m.rtpMap)!==null&&T!==void 0&&T.clockRate&&(m.rtpMap.clockRate=parseInt(m.rtpMap.clockRate))}),a.forEach(m=>{var T;(T=m.rtpMap)!==null&&T!==void 0&&T.clockRate&&(m.rtpMap.clockRate=parseInt(m.rtpMap.clockRate))}),e&&(a=a.filter(m=>{var T;return((T=m.rtpMap)===null||T===void 0?void 0:T.encodingName.toLowerCase())!=="rtx"}),c=c.filter(m=>{var T;return((T=m.rtpMap)===null||T===void 0?void 0:T.encodingName.toLowerCase())!=="rtx"})),i&&(c=c.filter(m=>{var T;return!/(red)|(ulpfec)|(flexfec)/i.test(((T=m.rtpMap)===null||T===void 0?void 0:T.encodingName)||"")})),n&&(a=a.filter(m=>{var T;return!/(red)|(ulpfec)|(flexfec)/i.test(((T=m.rtpMap)===null||T===void 0?void 0:T.encodingName)||"")})),r&&(r==null?void 0:r.length)>0&&(a=a.filter(m=>{var T;return r.includes(((T=m.rtpMap)===null||T===void 0?void 0:T.encodingName.toLowerCase())||"")})),o&&(o==null?void 0:o.length)>0&&(c=c.filter(m=>{var T;return o.includes(((T=m.rtpMap)===null||T===void 0?void 0:T.encodingName.toLowerCase())||"")})),{audioCodecs:a,videoCodecs:c,audioExtensions:d,videoExtensions:u}}function _r(t){const e=Qt.exports.parse(t);let i,n;for(const r of e.mediaDescriptions){if(!i){const o=r.attributes.iceUfrag,s=r.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:o,icePwd:s}}if(!n){const o=r.attributes.fingerprints;o.length>0&&(n={fingerprints:o})}}if(!n&&e.attributes.fingerprints.length>0&&(n={fingerprints:e.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function ng(t,e){const i=[],n=t.attributes.ssrcGroups.filter(s=>s.semantic==="FID"),r=t.attributes.ssrcGroups.find(s=>s.semantic==="SIM"),o=t.attributes.ssrcs;if(r)r.ssrcIds.forEach(s=>{var a;const c=(a=n.find(d=>d.ssrcIds[0]===s))===null||a===void 0?void 0:a.ssrcIds[1];i.push({ssrcId:s,rtx:e?c:void 0})});else if(n.length>0){const s=n[0].ssrcIds[0],a=n[0].ssrcIds[1];i.push({ssrcId:s,rtx:e?a:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function rg(t,e){const{cname:i}=t;let n;e&&e.ip&&typeof e.port=="number"?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):n=t.iceParameters.candidates.map(a=>({foundation:a.foundation,componentId:"1",transport:a.protocol,priority:a.priority.toString(),connectionAddress:a.ip,port:a.port.toString(),type:a.type,extension:{}}));const r={fingerprints:t.dtlsParameters.fingerprints.map(a=>({hashFunction:a.algorithm,fingerprint:a.fingerprint}))},o={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let s;switch(t.dtlsParameters.role){case"server":s="passive";break;case"client":s="active";break;case"auto":s="actpass"}return{dtlsParameters:r,iceParameters:o,candidates:n,rtpCapabilities:Wu(t.rtpCapabilities),setup:s,cname:i}}function Ci(t,e,i){const n=[],r=[];return t.forEach(o=>{let{ssrcId:s,rtx:a}=o;const c=Lt(8,"track-"),d={ssrcId:s,attributes:ig({label:c,mslabel:i=i||Lt(10,""),msid:"".concat(i," ").concat(c)},e&&{cname:e})};if(n.push(d),a!==void 0){const u={ssrcId:a,attributes:ig({label:c,mslabel:i,msid:"".concat(i," ").concat(c)},e&&{cname:e})};n.push(u),r.push({semantic:"FID",ssrcIds:[s,a]})}}),t.length>1&&r.push({semantic:"SIM",ssrcIds:t.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:n,ssrcGroups:r}}function Zr(t,e){e instanceof ve&&t.attributes.payloads.forEach(i=>{var n;const r=(n=i.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters.minptime="10",i.fmtp.parameters.useinbandfec="1";const o=e._encoderConfig;o&&r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(o.bitrate&&!Bt()&&(i.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(i.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),i.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(i.fmtp.parameters.stereo="1",i.fmtp.parameters["sprop-stereo"]="1"))})}function Bu(t){const e=t.attributes.unrecognized.findIndex(i=>i.attField==="x-google-flag"&&i.attValue==="conference");e!==-1&&t.attributes.unrecognized.splice(e,1)}function Gu(t,e){if(!(e instanceof zt&&e._encoderConfig&&e._hints.indexOf(re.SCREEN_TRACK)===-1))return;const i=e._encoderConfig;le().supportMinBitrate&&i.bitrateMin&&t.attributes.payloads.forEach(n=>{var r;["h264","vp8","vp9","av1"].includes(((r=n.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase())||"")&&(n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))}),le().supportMinBitrate&&!e._hints.includes(re.LOW_STREAM)&&i.bitrateMax&&t.attributes.payloads.forEach(n=>{var r;["h264","vp8","vp9","av1"].includes(((r=n.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase())||"")&&(n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters["x-google-start-bitrate"]="".concat(C("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))})}function og(t){if(t.media.mediaType!=="video")return;const e=Rt();if(e.name!==St.SAFARI&&e.os!==be.IOS)return;const i=t.attributes.extmaps.findIndex(n=>/video-orientation/g.test(n.extensionName));i!==-1&&t.attributes.extmaps.splice(i,1)}function ma(t,e,i){if(!e)return;let n,r;if(t.media.mediaType==="video"?(n=i.videoExtensions,r=i.videoCodecs):(n=i.audioExtensions,r=i.audioCodecs),e.twcc===!0){const o=n.find(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o&&(t.attributes.extmaps.find(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||t.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(s,a){return a.filter(c=>!!s.find(d=>d.payloadType===c.payloadType&&!!d.rtcpFeedbacks.find(u=>u.type==="transport-cc")))}(r,t.attributes.payloads).forEach(s=>{s.rtcpFeedbacks.find(a=>a.type==="transport-cc")||s.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(e.twcc===!1){const o=t.attributes.extmaps.findIndex(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}if(e.remb===!0){const o=n.find(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o&&(t.attributes.extmaps.find(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||t.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(s,a){return a.filter(c=>!!s.find(d=>d.payloadType===c.payloadType&&!!d.rtcpFeedbacks.find(u=>u.type==="goog-remb")))}(r,t.attributes.payloads).forEach(s=>{s.rtcpFeedbacks.find(a=>a.type==="goog-remb")||s.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(e.remb===!1){const o=t.attributes.extmaps.findIndex(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}}function sg(t,e,i){if(Bt()||t.media.mediaType!=="video"||!(e instanceof zt)||i!=="vp9"&&i!=="vp8"||i==="vp8"&&!C("SIMULCAST")||e._scalabiltyMode===void 0||e._scalabiltyMode.numSpatialLayers<=1)return;const n=i==="vp8"?2:e._scalabiltyMode.numSpatialLayers,r=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<n;a++)t.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:Xt(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:Xt(r.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));t.attributes.ssrcGroups.unshift(s)}async function ag(t,e,i,n,r){const o=new RTCPeerConnection;o.addTransceiver("video",{direction:"sendonly"}),o.addTransceiver("audio",{direction:"sendonly"}),o.addTransceiver("video",{direction:"recvonly"}),o.addTransceiver("audio",{direction:"recvonly"});const s=(await o.createOffer()).sdp,a=ju(s,t,e,i,n,r,"sendonly"),c=ju(s,t,e,i,n,r,"recvonly"),d={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},u={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},l={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(fa(a,c,"videoExtensions",d,u,l),fa(a,c,"videoCodecs",d,u,l),fa(a,c,"audioExtensions",d,u,l),fa(a,c,"audioCodecs",d,u,l),C("RAISE_H264_BASELINE_PRIORITY")){const E=l.videoCodecs.findIndex(m=>{var T,g;return((T=m.rtpMap)===null||T===void 0?void 0:T.encodingName.toLocaleLowerCase())==="h264"&&((g=m.fmtp)===null||g===void 0?void 0:g.parameters["profile-level-id"])==="42001f"});if(E!==-1){const m=l.videoCodecs.findIndex(T=>{var g;return((g=T.rtpMap)===null||g===void 0?void 0:g.encodingName.toLocaleLowerCase())==="h264"});if(m<E){_.debug("raising H264 baseline profile priority");const T=l.videoCodecs[E];l.videoCodecs.splice(E,1),l.videoCodecs.splice(m,0,T)}m!==-1&&(u.videoCodecs=u.videoCodecs.filter(T=>{var g,R;return!(((g=T.rtpMap)===null||g===void 0?void 0:g.encodingName.toLocaleLowerCase())==="h264"&&((R=T.fmtp)===null||R===void 0?void 0:R.parameters["profile-level-id"])!=="42001f")})),m!==-1&&C("FILTER_SEND_H264_BASELINE")&&(d.videoCodecs=d.videoCodecs.filter(T=>{var g,R;return!(((g=T.rtpMap)===null||g===void 0?void 0:g.encodingName.toLocaleLowerCase())==="h264"&&((R=T.fmtp)===null||R===void 0?void 0:R.parameters["profile-level-id"])!=="42001f")}))}}try{o.close()}catch{}return{send:d,recv:u,sendrecv:l}}function fa(t,e,i,n,r,o){if(i==="videoExtensions"||i==="audioExtensions"){const s=[];return t[i].forEach(a=>{e[i].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return s.push(d),!0})?o[i].push(a):n[i].push(a)}),void e[i].forEach((a,c)=>{s.indexOf(c)===-1&&r[i].push(a)})}if(i==="videoCodecs"||i==="audioCodecs"){const s=[];return t[i].forEach(a=>{e[i].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return s.push(d),!0})?o[i].push(a):n[i].push(a)}),void e[i].forEach((a,c)=>{s.indexOf(c)===-1&&r[i].push(a)})}}function Wu(t){const{send:e,recv:i,sendrecv:n}=t;if(!n){if(!e||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:i}}let r,o;return e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...n.audioCodecs],r.videoCodecs=[...e.videoCodecs,...n.videoCodecs],r.audioExtensions=[...e.audioExtensions,...n.audioExtensions],r.videoExtensions=[...e.videoExtensions,...n.videoExtensions]):r=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:r,recv:o}}function Fn(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter(e=>{var i;return((i=e.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}(function(t,e){t.exports=(()=>{var i={8:(o,s,a)=>{a.r(s),a.d(s,{Parser:()=>Dt,Printer:()=>$e,parse:()=>X,print:()=>ut});const c=`
`,d="".concat("\r").concat(c),u=" ";let l;function E(L){return L>="0"&&L<="9"}function m(L){return L>="!"&&L<="~"}function T(L){return m(L)||L>="Â"&&L<="Ã¿"}function g(L){return L==="!"||L>="#"&&L<="'"||L>="*"&&L<="+"||L>="-"&&L<="."||L>="0"&&L<="9"||L>="A"&&L<="Z"||L>="^"&&L<="~"}function R(L){return L>="1"&&L<="9"}function y(L){return L>="A"&&L<="Z"||L>="a"&&L<="z"}function A(L){return L==="d"||L==="h"||L==="m"||L==="s"}function P(L){return L>""&&L<"	"||L>"\v"&&L<"\f"||L>""&&L<"Ã¿"}function H(L){return y(L)||E(L)||L==="+"||L==="/"}function k(L){return E(L)||y(L)||L==="+"||L==="/"||L==="-"||L==="_"}function M(L){return y(L)||E(L)||L==="+"||L==="/"}function D(L,p){var S=Object.keys(L);if(Object.getOwnPropertySymbols){var v=Object.getOwnPropertySymbols(L);p&&(v=v.filter(function(b){return Object.getOwnPropertyDescriptor(L,b).enumerable})),S.push.apply(S,v)}return S}function j(L){for(var p=1;p<arguments.length;p++){var S=arguments[p]!=null?arguments[p]:{};p%2?D(Object(S),!0).forEach(function(v){yt(L,v,S[v])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(S)):D(Object(S)).forEach(function(v){Object.defineProperty(L,v,Object.getOwnPropertyDescriptor(S,v))})}return L}function yt(L,p,S){return p in L?Object.defineProperty(L,p,{value:S,enumerable:!0,configurable:!0,writable:!0}):L[p]=S,L}(function(L){L.VERSION="v",L.ORIGIN="o",L.SESSION_NAME="s",L.INFORMATION="i",L.URI="u",L.EMAIL="e",L.PHONE="p",L.CONNECTION="c",L.BANDWIDTH="b",L.TIME="t",L.REPEAT="r",L.ZONE_ADJUSTMENTS="z",L.KEY="k",L.ATTRIBUTE="a",L.MEDIA="m"})(l||(l={}));class Q{consumeText(p,S){let v=S;for(;v<p.length;){const b=p[v];if(b==="\0"||b==="\r"||b===c)break;v+=1}if(v-S==0)throw new Error("Invalid text, at ".concat(p));return v}consumeUnicastAddress(p,S,v){return this.consumeTill(p,S,u)}consumeOneOrMore(p,S,v){let b=S;for(;v(p[b]);)b++;if(b-S==0)throw new Error("Invalid rule at ".concat(S,"."));return b}consumeSpace(p,S){if(p[S]===u)return S+1;throw new Error("Invalid space at ".concat(S,"."))}consumeIP4Address(p,S){let v=S;for(let b=0;b<4;b++)if(v=this.consumeDecimalUChar(p,v),b!==3){if(p[v]!==".")throw new Error("Invalid IP4 address.");v++}return v}consumeDecimalUChar(p,S){let v=S;for(let z=0;z<3&&E(p[v]);z++,v++);if(v-S==0)throw new Error("Invalid decimal uchar.");const b=parseInt(p.slice(S,v));if(b>=0&&b<=255)return v;throw new Error("Invalid decimal uchar")}consumeIP6Address(p,S){let v=this.consumeHexpart(p,S);return p[v]===":"&&(v+=1,v=this.consumeIP4Address(p,v)),v}consumeHexpart(p,S){let v=S;if(p[v]===":"&&p[v+1]===":"){v+=2;try{v=this.consumeHexseq(p,v)}catch{}return v}if(v=this.consumeHexseq(p,v),p[v]===":"&&p[v+1]===":"){v+=2;try{v=this.consumeHexseq(p,v)}catch{}return v}return v}consumeHexseq(p,S){let v=S;for(;v=this.consumeHex4(p,v),p[v]===":"&&p[v+1]!==":";)v+=1;return v}consumeHex4(p,S){let v=0;for(;v<4;v++)if(!((b=p[S+v])>="0"&&b<="9"||b>="a"&&b<="f"||b>="A"&&b<="F")){if(v===0)throw new Error("Invalid hex 4");break}var b;return S+v}consumeFQDN(p,S){let v=S;for(;E(p[v])||y(p[v])||p[v]==="-"||p[v]===".";)v+=1;if(v-S<4)throw new Error("Invalid FQDN");return v}consumeExtnAddr(p,S){return this.consumeOneOrMore(p,S,T)}consumeMulticastAddress(p,S,v){switch(v){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(p,S);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(p,S);default:try{return this.consumeFQDN(p,S)}catch{return this.consumeExtnAddr(p,S)}}}consumeIP6MulticastAddress(p,S){const v=this.consumeHexpart(p,S);return p[v]==="/"?this.consumeInteger(p,v+1):v}consumeIP4MulticastAddress(p,S){let v=S+3;const b=p.slice(S,v),z=parseInt(b);if(z<224||z>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let wt=0;wt<3;wt++){if(p[v]!==".")throw new Error("Invalid IP4 multicast address.");v+=1,v=this.consumeDecimalUChar(p,v)}return p[v]==="/"&&(v+=1),v=this.consumeTTL(p,v),p[v]==="/"&&(v=this.consumeInteger(p,v)),v}consumeInteger(p,S){if(!R(p[S]))throw new Error("Invalid integer.");for(S+=1;E(p[S]);)S+=1;return S}consumeTTL(p,S){if(p[S]==="0")return S+1;if(!R(p[S]))throw new Error("Invalid TTL.");S+=1;for(let v=0;v<2&&E(p[S]);v++)S+=1;return S}consumeToken(p,S){return this.consumeOneOrMore(p,S,g)}consumeTime(p,S){let v=S;if(p[v]==="0")return v+1;for(R(p[v])&&(v+=1);E(p[v]);)v++;if(v-S<10)throw new Error("Invalid time");return v}consumeAddress(p,S){return this.consumeTill(p,S,u)}consumeTypedTime(p,S){let v=S;return v=this.consumeOneOrMore(p,v,E),A(p[v])?v+1:v}consumeRepeatInterval(p,S){if(!R(p[S]))throw new Error("Invalid repeat interval");for(S+=1;E(p[S]);)S+=1;return A(p[S])&&(S+=1),S}consumePort(p,S){return this.consumeOneOrMore(p,S,E)}consume(p,S,v){for(let b=0;b<v.length;b++){if(S+b>=p.length)throw new Error("consume exceeding value length");if(p[S+b]!==v[b])throw new Error("consume ".concat(v," failed at ").concat(b))}return S+v.length}consumeTill(p,S,v){let b=S;for(;b<p.length&&(typeof v!="string"||p[b]!==v)&&(typeof v!="function"||!v(p[b]));)b++;return b}}class Dt extends Q{constructor(){super(),yt(this,"records",[]),yt(this,"currentLine",0)}parse(p){const S=this.probeEOL(p);this.records=p.split(S).filter(Ke=>!!Ke.trim()).map(this.parseLine),this.currentLine=0;const v=this.parseVersion(),b=this.parseOrigin(),z=this.parseSessionName(),wt=this.parseInformation(),me=this.parseUri(),ji=this.parseEmail(),Wn=this.parsePhone(),bi=this.parseConnection(),Hn=this.parseBandWidth(),eo=this.parseTimeFields(),Ft=this.parseKey(),Zt=this.parseSessionAttribute(),Ot=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:v,origin:b,sessionName:z,information:wt,uri:me,emails:ji,phones:Wn,connection:bi,bandwidths:Hn,timeFields:eo,key:Ft,attributes:Zt,mediaDescriptions:Ot}}getCurrentRecord(){const p=this.records[this.currentLine];if(!p)throw new Error("Record doesn't exit.");return p}probeEOL(p){for(let S=0;S<p.length;S++)if(p[S]===c)return p[S-1]==="\r"?d:c;throw new Error("Invalid newline character.")}parseLine(p,S){if(p.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const v=p[0];if(p[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:v,value:p.slice(2),line:S,cur:0}}parseSessionAttribute(){const p=new Yt;for(;this.currentLine<this.records.length;){const S=this.getCurrentRecord();if(S.type!==l.ATTRIBUTE)break;const v={attField:this.extractOneOrMore(S,b=>g(b)&&b!==":"),_cur:0};S.value[S.cur]===":"&&(S.cur+=1,v.attValue=this.extractOneOrMore(S,P)),p.parse(v),this.currentLine++}return p.digest()}parseMediaAttributes(p){const S=new _e(p);for(;this.currentLine<this.records.length;){const v=this.getCurrentRecord();if(v.type!==l.ATTRIBUTE)break;const b={attField:this.extractOneOrMore(v,z=>g(z)&&z!==":"),_cur:0};v.value[v.cur]===":"&&(v.cur+=1,b.attValue=this.extractOneOrMore(v,P)),S.parse(b),this.currentLine++}return S.digest()}parseKey(){const p=this.getCurrentRecord();if(p.type===l.KEY){if(p.value==="prompt"||p.value==="clear:"||p.value==="base64:"||p.value==="uri:")return p.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const p=this.getCurrentRecord();if(p.type===l.ZONE_ADJUSTMENTS){const S=[];for(;;)try{const v=this.extract(p,this.consumeTime);this.consumeSpaceForRecord(p);let b=!1;p.value[p.cur]==="-"&&(b=!0,p.cur+=1);const z=this.extract(p,this.consumeTypedTime);S.push({time:v,typedTime:z,back:b})}catch{break}if(S.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,S}return[]}parseRepeat(){const p=[];for(;;){const S=this.getCurrentRecord();if(S.type!==l.REPEAT)break;{const v=this.extract(S,this.consumeRepeatInterval),b=this.parseTypedTime(S);p.push({repeatInterval:v,typedTimes:b}),this.currentLine++}}return p}parseTypedTime(p){const S=[];for(;;)try{this.consumeSpaceForRecord(p),S.push(this.extract(p,this.consumeTypedTime))}catch{break}if(S.length===0)throw new Error("Invalid typed time.");return S}parseTime(){const p=this.getCurrentRecord(),S=this.extract(p,this.consumeTime);this.consumeSpaceForRecord(p);const v=this.extract(p,this.consumeTime);return this.currentLine++,{startTime:S,stopTime:v}}parseBandWidth(){const p=[];for(;this.currentLine<this.records.length;){const S=this.getCurrentRecord();if(S.type!==l.BANDWIDTH)break;{const v=this.extractOneOrMore(S,g);if(S.value[S.cur]!==":")throw new Error("Invalid bandwidth field.");S.cur++;const b=this.extractOneOrMore(S,E);p.push({bwtype:v,bandwidth:b}),this.currentLine++}}return p}parseVersion(){const p=this.getCurrentRecord();if(p.type!==l.VERSION)throw new Error("first sdp record must be version");const S=p.value.slice(0,this.consumeOneOrMore(p.value,0,E));if(S.length!==p.value.length)throw new Error('invalid proto version, "v='.concat(p.value,'"'));return this.currentLine++,S}parseOrigin(){const p=this.getCurrentRecord();if(p.type!==l.ORIGIN)throw new Error("second line of sdp must be origin");const S=this.extractOneOrMore(p,T);this.consumeSpaceForRecord(p);const v=this.extractOneOrMore(p,E);this.consumeSpaceForRecord(p);const b=this.extractOneOrMore(p,E);this.consumeSpaceForRecord(p);const z=this.extractOneOrMore(p,g);this.consumeSpaceForRecord(p);const wt=this.extractOneOrMore(p,g);this.consumeSpaceForRecord(p);const me=this.extract(p,this.consumeUnicastAddress);return this.currentLine++,{username:S,sessId:v,sessVersion:b,nettype:z,addrtype:wt,unicastAddress:me}}parseSessionName(){const p=this.getCurrentRecord();if(p.type===l.SESSION_NAME){const S=this.extract(p,this.consumeText);return this.currentLine++,S}}parseInformation(){const p=this.getCurrentRecord();if(p.type!==l.INFORMATION)return;const S=this.extract(p,this.consumeText);return this.currentLine++,S}parseUri(){const p=this.getCurrentRecord();if(p.type===l.URI)return this.currentLine++,p.value}parseEmail(){const p=[];for(;;){const S=this.getCurrentRecord();if(S.type!==l.EMAIL)break;p.push(S.value),this.currentLine++}return p}parsePhone(){const p=[];for(;;){const S=this.getCurrentRecord();if(S.type!==l.PHONE)break;p.push(S.value),this.currentLine++}return p}parseConnection(){const p=this.getCurrentRecord();if(p.type===l.CONNECTION){const S=this.extractOneOrMore(p,g);this.consumeSpaceForRecord(p);const v=this.extractOneOrMore(p,g);this.consumeSpaceForRecord(p);const b=this.extract(p,this.consumeAddress);return this.currentLine++,{nettype:S,addrtype:v,address:b}}}parseMedia(){const p=this.getCurrentRecord(),S=this.extract(p,this.consumeToken);this.consumeSpaceForRecord(p);let v=this.extract(p,this.consumePort);p.value[p.cur]==="/"&&(p.cur+=1,v+=this.extract(p,this.consumeInteger)),this.consumeSpaceForRecord(p);const b=[];for(b.push(this.extract(p,this.consumeToken));p.value[p.cur]==="/";)p.cur+=1,b.push(this.extract(p,this.consumeToken));if(b.length===0)throw new Error("Invalid proto");const z=this.parseFmt(p);return this.currentLine++,{mediaType:S,port:v,protos:b,fmts:z}}parseTimeFields(){const p=[];for(;this.getCurrentRecord().type===l.TIME;){const S=this.parseTime(),v=this.parseRepeat(),b=this.parseZone();p.push({time:S,repeats:v,zones:b})}return p}parseMediaDescription(){const p=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.MEDIA;){const S=this.parseMedia(),v=this.parseInformation(),b=this.parseConnections(),z=this.parseBandWidth(),wt=this.parseKey(),me=this.parseMediaAttributes(S);p.push({media:S,information:v,connections:b,bandwidths:z,key:wt,attributes:me})}return p}parseConnections(){const p=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.CONNECTION;)p.push(this.parseConnection());return p}parseFmt(p){const S=[];for(;;)try{this.consumeSpaceForRecord(p),S.push(this.extract(p,this.consumeToken))}catch{break}if(S.length===0)throw new Error("Invalid fmts");return S}extract(p,S,...v){const b=S.call(this,p.value,p.cur,...v),z=p.value.slice(p.cur,b);return p.cur=b,z}extractOneOrMore(p,S){const v=this.consumeOneOrMore(p.value,p.cur,S),b=p.value.slice(p.cur,v);return p.cur=v,b}consumeSpaceForRecord(p){if(p.value[p.cur]!==u)throw new Error("Invalid space at ".concat(p.cur,"."));p.cur+=1}}class At extends Q{constructor(...p){super(...p),yt(this,"attributes",void 0),yt(this,"digested",!1)}extractOneOrMore(p,S,v){const b=this.consumeOneOrMore(p.attValue,p._cur,S),z=p.attValue.slice(p._cur,b),[wt,me]=v||[];if(typeof wt=="number"&&z.length<wt)throw new Error("error in length, should be more or equal than ".concat(wt," characters."));if(typeof me=="number"&&z.length>me)throw new Error("error in length, should be less or equal than ".concat(me," characters."));return p._cur=b,z}consumeAttributeSpace(p){if(p.attValue[p._cur]!==u)throw new Error("Invalid space at ".concat(p._cur,"."));p._cur+=1}extract(p,S,...v){if(!p.attValue)throw new Error("Nothing to extract from attValue.");const b=S.call(this,p.attValue,p._cur,...v),z=p.attValue.slice(p._cur,b);return p._cur=b,z}atEnd(p){if(!p.attValue)throw new Error;return p._cur>=p.attValue.length}peekChar(p){if(!p.attValue)throw new Error;return p.attValue[p._cur]}peek(p,S){if(!p.attValue)throw new Error;for(let v=0;v<S.length;v++)if(S[v]!==p.attValue[p._cur+v])return!1;return!0}parseIceUfrag(p){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(p,H,[4,256])}parseIcePwd(p){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(p,H,[22,256])}parseIceOptions(p){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const S=[];for(;!this.atEnd(p);){S.push(this.extractOneOrMore(p,H));try{this.consumeAttributeSpace(p)}catch(v){if(this.atEnd(p))break;throw v}}this.attributes.iceOptions=S}parseFingerprint(p){const S=this.extract(p,this.consumeToken);this.consumeAttributeSpace(p);const v=this.extract(p,this.consumeTill);this.attributes.fingerprints.push({hashFunction:S,fingerprint:v})}parseExtmap(p){const S=this.extractOneOrMore(p,E);let v;this.peekChar(p)==="/"&&(this.extract(p,this.consume,"/"),v=this.extract(p,this.consumeToken)),this.consumeAttributeSpace(p);const b=this.extract(p,this.consumeTill,u),z=j(j({entry:parseInt(S,10)},v&&{direction:v}),{},{extensionName:b});this.peekChar(p)===u&&(this.consumeAttributeSpace(p),z.extensionAttributes=this.extract(p,this.consumeTill)),this.attributes.extmaps.push(z)}parseSetup(p){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const S=this.extract(p,this.consumeTill);if(S!=="active"&&S!=="passive"&&S!=="actpass"&&S!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=S}}class Yt extends At{constructor(...p){super(...p),yt(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(p){if(this.digested)throw new Error("already digested");try{switch(p.attField){case"group":this.parseGroup(p);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(p);break;case"ice-pwd":this.parseIcePwd(p);break;case"ice-options":this.parseIceOptions(p);break;case"fingerprint":this.parseFingerprint(p);break;case"setup":this.parseSetup(p);break;case"tls-id":this.parseTlsId(p);break;case"identity":this.parseIdentity(p);break;case"extmap":this.parseExtmap(p);break;case"msid-semantic":this.parseMsidSemantic(p);break;default:p.ignored=!0,this.attributes.unrecognized.push(p)}}catch(S){throw console.error("parsing session attribute ".concat(p.attField,' error, "a=').concat(p.attField,":").concat(p.attValue,'"')),S}if(!p.ignored&&p.attValue&&!this.atEnd(p))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(p){const S=this.extract(p,this.consumeToken),v=[];for(;!this.atEnd(p)&&this.peekChar(p)===u;)this.consumeAttributeSpace(p),v.push(this.extract(p,this.consumeToken));this.attributes.groups.push({semantic:S,identificationTag:v})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(p){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(p,k)}parseIdentity(p){const S=this.extractOneOrMore(p,M),v=[];for(;!this.atEnd(p)&&this.peekChar(p)===u;){this.consumeAttributeSpace(p);const b=this.extract(p,this.consumeToken);this.extract(p,this.consume,"=");const z=this.extractOneOrMore(p,wt=>wt!==u&&P(wt));v.push({name:b,value:z})}this.attributes.identities.push({assertionValue:S,extensions:v})}parseMsidSemantic(p){this.peekChar(p)===u&&this.consumeAttributeSpace(p);const S={semantic:this.extract(p,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(p)}catch{break}if(this.peekChar(p)==="*"){this.extract(p,this.consume,"*"),S.applyForAll=!0;break}{const v=this.extract(p,this.consumeTill,u);S.identifierList.push(v)}}this.attributes.msidSemantic=S}}class _e extends At{constructor(p){super(),yt(this,"attributes",void 0),p.protos.indexOf("RTP")!==-1||p.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(p){if(this.digested)throw new Error("already digested");try{switch(p.attField){case"extmap":this.parseExtmap(p);break;case"setup":this.parseSetup(p);break;case"ice-ufrag":this.parseIceUfrag(p);break;case"ice-pwd":this.parseIcePwd(p);break;case"ice-options":this.parseIceOptions(p);break;case"candidate":this.parseCandidate(p);break;case"remote-candidate":this.parseRemoteCandidate(p);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(p);break;case"rtpmap":this.parseRtpmap(p);break;case"ptime":this.parsePtime(p);break;case"maxptime":this.parseMaxPtime(p);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(p);break;case"ssrc":this.parseSSRC(p);break;case"fmtp":this.parseFmtp(p);break;case"rtcp-fb":this.parseRtcpFb(p);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(p);break;case"mid":this.parseMid(p);break;case"msid":this.parseMsid(p);break;case"imageattr":this.parseImageAttr(p);break;case"rid":this.parseRid(p);break;case"simulcast":this.parseSimulcast(p);break;case"sctp-port":this.parseSctpPort(p);break;case"max-message-size":this.parseMaxMessageSize(p);break;case"ssrc-group":this.parseSSRCGroup(p);break;default:p.ignored=!0,this.attributes.unrecognized.push(p)}}catch(S){throw console.error("parsing media attribute ".concat(p.attField,' error, "a=').concat(p.attField,":").concat(p.attValue,'"')),S}if(!p.ignored&&p.attValue&&!this.atEnd(p))throw new Error("attribute parsing error")}parseCandidate(p){const S=this.extractOneOrMore(p,H,[1,32]);this.consumeAttributeSpace(p);const v=this.extractOneOrMore(p,E,[1,5]);this.consumeAttributeSpace(p);const b=this.extract(p,this.consumeToken);this.consumeAttributeSpace(p);const z=this.extractOneOrMore(p,E,[1,10]);this.consumeAttributeSpace(p);const wt=this.extract(p,this.consumeAddress);this.consumeAttributeSpace(p);const me=this.extract(p,this.consumePort);this.consumeAttributeSpace(p),this.extract(p,this.consume,"typ"),this.consumeAttributeSpace(p);const ji={foundation:S,componentId:v,transport:b,priority:z,connectionAddress:wt,port:me,type:this.extract(p,this.consumeToken),extension:{}};for(this.peek(p," raddr")&&(this.extract(p,this.consume," raddr"),this.consumeAttributeSpace(p),ji.relAddr=this.extract(p,this.consumeAddress)),this.peek(p," rport")&&(this.extract(p,this.consume," rport"),this.consumeAttributeSpace(p),ji.relPort=this.extract(p,this.consumePort));this.peekChar(p)===u;){this.consumeAttributeSpace(p);const Wn=this.extract(p,this.consumeToken);this.consumeAttributeSpace(p),ji.extension[Wn]=this.extractOneOrMore(p,m)}this.attributes.candidates.push(ji)}parseRemoteCandidate(p){const S=[];for(;;){const v=this.extractOneOrMore(p,E,[1,5]);this.consumeAttributeSpace(p);const b=this.extract(p,this.consumeAddress);this.consumeAttributeSpace(p);const z=this.extract(p,this.consumePort);S.push({componentId:v,connectionAddress:b,port:z});try{this.consumeAttributeSpace(p)}catch{break}}this.attributes.remoteCandidatesList.push(S)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(p){const S=this.extract(p,this.consumeToken);this.consumeAttributeSpace(p);const v=this.extract(p,this.consumeTill,"/");this.extract(p,this.consume,"/");const b={encodingName:v,clockRate:this.extractOneOrMore(p,E)};this.atEnd(p)||this.peekChar(p)!=="/"||(this.extract(p,this.consume,"/"),b.encodingParameters=parseInt(this.extract(p,this.consumeTill),10));const z=this.attributes.payloads.find(wt=>wt.payloadType===parseInt(S,10));z?z.rtpMap=b:this.attributes.payloads.push({payloadType:parseInt(S,10),rtpMap:b,rtcpFeedbacks:[]})}parsePtime(p){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(p,this.consumeTill)}parseMaxPtime(p){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(p,this.consumeTill)}parseDirection(p){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=p.attField}parseSSRC(p){const S=this.extractOneOrMore(p,E);this.consumeAttributeSpace(p);const v=this.extract(p,this.consumeTill,":");let b;this.peekChar(p)===":"&&(this.extract(p,this.consume,":"),b=this.extract(p,this.consumeTill));const z=this.attributes.ssrcs.find(wt=>wt.ssrcId===parseInt(S,10));z?z.attributes[v]=b:this.attributes.ssrcs.push({ssrcId:parseInt(S,10),attributes:{[v]:b}})}parseFmtp(p){const S=this.extract(p,this.consumeTill,u);this.consumeAttributeSpace(p);const v=this.extract(p,this.consumeTill),b={};v.split(";").forEach(wt=>{let[me,ji]=wt.split("=");me=me.trim();const Wn=typeof ji=="string"?ji.trim():null;typeof me=="string"&&me.length>0&&(b[me]=Wn)});const z=this.attributes.payloads.find(wt=>wt.payloadType===parseInt(S,10));z?z.fmtp={parameters:b}:this.attributes.payloads.push({payloadType:parseInt(S,10),rtcpFeedbacks:[],fmtp:{parameters:b}})}parseFmtParameters(p){const S={},v=this.extract(p,this.consumeTill,"=");p._cur++;const b=this.extract(p,this.consumeTill,";");for(S[v]=b;p.attValue[p._cur]===";";){const z=this.extract(p,this.consumeTill,"=");p._cur++;const wt=this.extract(p,this.consumeTill,";");S[z]=wt}return S}parseRtcpFb(p){let S="";S=this.peekChar(p)==="*"?this.extract(p,this.consume,"*"):this.extract(p,this.consumeTill,u),this.consumeAttributeSpace(p);const v=this.extract(p,this.consumeTill,u);let b;switch(v){case"trr-int":b={type:v,interval:this.extract(p,this.consumeTill)};break;case"ack":case"nack":default:{const z={type:v};this.peekChar(p)===u&&(this.consumeAttributeSpace(p),z.parameter=this.extract(p,this.consumeToken),this.peekChar(p)===u&&(z.additional=this.extract(p,this.consumeTill))),b=z}}if(S==="*")this.attributes.rtcpFeedbackWildcards.push(b);else{const z=this.attributes.payloads.find(wt=>wt.payloadType===parseInt(S,10));z?z.rtcpFeedbacks.push(b):this.attributes.payloads.push({payloadType:parseInt(S,10),rtcpFeedbacks:[b]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(p){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const S={port:this.extract(p,this.consumePort)};this.peekChar(p)===u&&(this.consumeAttributeSpace(p),S.netType=this.extractOneOrMore(p,g),this.consumeAttributeSpace(p),S.addressType=this.extractOneOrMore(p,g),this.consumeAttributeSpace(p),S.address=this.extract(p,this.consumeAddress)),this.attributes.rtcp=S}parseMsid(p){const S={id:this.extractOneOrMore(p,g,[1,64])};this.peekChar(p)===u&&(this.consumeAttributeSpace(p),S.appdata=this.extractOneOrMore(p,g,[1,64])),this.attributes.msids.push(S)}parseImageAttr(p){this.attributes.imageattr.push(p.attValue)}parseRid(p){const S=this.extractOneOrMore(p,b=>y(b)||E(b)||b==="_"||b==="-");this.consumeAttributeSpace(p);const v={id:S,direction:this.extract(p,this.consumeToken),params:[]};if(this.peekChar(p)===u){if(this.consumeAttributeSpace(p),this.peek(p,"pt=")){this.extract(p,this.consume,"pt=");const b=[];for(;;){const z=this.extract(p,this.consumeToken);b.push(z);try{this.extract(p,this.consume,",")}catch{break}}v.payloads=b,this.peekChar(p)===u&&this.extract(p,this.consume,u)}for(;;){const b=this.extract(p,this.consumeToken);switch(b){case"depend":{const z={type:b,rids:this.extract(p,this.consume,"=").split(",")};v.params.push(z);break}case"max-width":case"height-width":case"max-fps":case"max-fs":case"max-br":case"max-pps":case"max-bpp":default:{const z={type:b};this.peekChar(p)==="="&&(this.extract(p,this.consume,"="),z.val=this.extract(p,this.consumeTill,";")),v.params.push(z)}}try{this.extract(p,this.consume,";")}catch{break}}}this.attributes.rids.push(v)}parseSimulcast(p){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=p.attValue,this.extract(p,this.consumeTill)}parseSctpPort(p){this.attributes.sctpPort=this.extractOneOrMore(p,E,[1,5])}parseMaxMessageSize(p){this.attributes.maxMessageSize=this.extractOneOrMore(p,E,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(p){this.attributes.mid=this.extract(p,this.consumeToken)}parseSSRCGroup(p){const S=this.extract(p,this.consumeToken),v=[];for(;;)try{this.consumeAttributeSpace(p);const b=this.extract(p,this.consumeInteger);v.push(parseInt(b,10))}catch{break}this.attributes.ssrcGroups.push({semantic:S,ssrcIds:v})}}function Kt(L,p,S){return p in L?Object.defineProperty(L,p,{value:S,enumerable:!0,configurable:!0,writable:!0}):L[p]=S,L}class $e{constructor(){Kt(this,"eol",d)}print(p,S){let v="";return S&&(this.eol=S),v+=this.printVersion(p.version),v+=this.printOrigin(p.origin),v+=this.printSessionName(p.sessionName),v+=this.printInformation(p.information),v+=this.printUri(p.uri),v+=this.printEmail(p.emails),v+=this.printPhone(p.phones),v+=this.printConnection(p.connection),v+=this.printBandwidth(p.bandwidths),v+=this.printTimeFields(p.timeFields),v+=this.printKey(p.key),v+=this.printSessionAttributes(p.attributes),v+=this.printMediaDescription(p.mediaDescriptions),v}printVersion(p){return"v=".concat(p).concat(this.eol)}printOrigin(p){return"o=".concat(p.username," ").concat(p.sessId," ").concat(p.sessVersion," ").concat(p.nettype," ").concat(p.addrtype," ").concat(p.unicastAddress).concat(this.eol)}printSessionName(p){return p?"s=".concat(p).concat(this.eol):""}printInformation(p){return p?"i=".concat(p).concat(this.eol):""}printUri(p){return p?"u=".concat(p).concat(this.eol):""}printEmail(p){let S="";for(const v of p)S+="e=".concat(v).concat(this.eol);return S}printPhone(p){let S="";for(const v of p)S+="e=".concat(v).concat(this.eol);return S}printConnection(p){return p?"c=".concat(p.nettype," ").concat(p.addrtype," ").concat(p.address).concat(this.eol):""}printBandwidth(p){let S="";for(const v of p)S+="b=".concat(v.bwtype,":").concat(v.bandwidth).concat(this.eol);return S}printTimeFields(p){let S="";for(const v of p){S+="t=".concat(v.time.startTime," ").concat(v.time.startTime).concat(this.eol);for(const b of v.repeats)S+="r=".concat(b.repeatInterval," ").concat(b.typedTimes.join(" ")).concat(this.eol);v.zoneAdjustments&&(S+="z=",S+="z=".concat(v.zoneAdjustments.map(b=>"".concat(b.time," ").concat(b.back?"-":""," ").concat(b.typedTime)).join(" ")).concat(this.eol),S+=this.eol)}return S}printKey(p){return p?"k=".concat(p).concat(this.eol):""}printAttributes(p){let S="";for(const v of p)S+="a=".concat(v.attField).concat(v.attValue?":".concat(v.attValue):"").concat(this.eol);return S}printMediaDescription(p){let S="";for(const v of p)S+=this.printMedia(v.media),S+=this.printInformation(v.information),S+=this.printConnections(v.connections),S+=this.printBandwidth(v.bandwidths),S+=this.printKey(v.key),S+=this.printMediaAttributes(v);return S}printConnections(p){let S="";for(const v of p)S+=this.printConnection(v);return S}printMedia(p){return"m=".concat(p.mediaType," ").concat(p.port," ").concat(p.protos.join("/")," ").concat(p.fmts.join(" ")).concat(this.eol)}printSessionAttributes(p){return new N(this.eol).print(p)}printMediaAttributes(p){return new x(this.eol).print(p)}}class O{constructor(p){Kt(this,"eol",void 0),this.eol=p}printIceUfrag(p){return p===void 0?"":"a=ice-ufrag:".concat(p).concat(this.eol)}printIcePwd(p){return p===void 0?"":"a=ice-pwd:".concat(p).concat(this.eol)}printIceOptions(p){return p===void 0?"":"a=ice-options:".concat(p.join(u)).concat(this.eol)}printFingerprints(p){return p.length>0?p.map(S=>"a=fingerprint:".concat(S.hashFunction).concat(u).concat(S.fingerprint)).join(this.eol)+this.eol:""}printExtmap(p){return p.map(S=>"a=extmap:".concat(S.entry).concat(S.direction?"/".concat(S.direction):"").concat(u).concat(S.extensionName).concat(S.extensionAttributes?"".concat(u).concat(S.extensionAttributes):"").concat(this.eol)).join("")}printSetup(p){return p===void 0?"":"a=setup:".concat(p).concat(this.eol)}printUnrecognized(p){return p.map(S=>"a=".concat(S.attField).concat(S.attValue?":".concat(S.attValue):"").concat(this.eol)).join("")}}class N extends O{print(p){let S="";return S+=this.printGroups(p.groups),S+=this.printMsidSemantic(p.msidSemantic),S+=this.printIceLite(p.iceLite),S+=this.printIceUfrag(p.iceUfrag),S+=this.printIcePwd(p.icePwd),S+=this.printIceOptions(p.iceOptions),S+=this.printFingerprints(p.fingerprints),S+=this.printSetup(p.setup),S+=this.printTlsId(p.tlsId),S+=this.printIdentity(p.identities),S+=this.printExtmap(p.extmaps),S+=this.printUnrecognized(p.unrecognized),S}printGroups(p){let S="";return p.length>0&&(S+=p.map(v=>"a=group:".concat(v.semantic).concat(v.identificationTag.map(b=>"".concat(u).concat(b)).join("")).concat(this.eol)).join("")),S}printIceLite(p){return p===void 0?"":"a=ice-lite"+this.eol}printTlsId(p){return p?"a=tls-id:".concat(p).concat(this.eol):""}printIdentity(p){return p.length===0?"":p.map(S=>"a=identity:".concat(S.assertionValue).concat(S.extensions.map(v=>"".concat(u).concat(v.name).concat(v.value?"=".concat(v.value):"")))).join(this.eol)+this.eol}printMsidSemantic(p){if(!p)return"";let S="a=msid-semantic:".concat(p.semantic);return p.applyForAll?S+="".concat(u,"*"):p.identifierList.length>0&&(S+=p.identifierList.map(v=>"".concat(u).concat(v))),S+this.eol}}class x extends O{print(p){const S=p.attributes;let v="";return v+=this.printRTCP(S.rtcp),v+=this.printIceUfrag(S.iceUfrag),v+=this.printIcePwd(S.icePwd),v+=this.printIceOptions(S.iceOptions),v+=this.printCandidates(S.candidates),v+=this.printRemoteCandidatesList(S.remoteCandidatesList),v+=this.printEndOfCandidates(S.endOfCandidates),v+=this.printFingerprints(S.fingerprints),v+=this.printSetup(S.setup),v+=this.printMid(S.mid),v+=this.printExtmap(S.extmaps),v+=this.printRTPRelated(S),v+=this.printPtime(S.ptime),v+=this.printMaxPtime(S.maxPtime),v+=this.printDirection(S.direction),v+=this.printSSRCGroups(S.ssrcGroups),v+=this.printSSRC(S.ssrcs),v+=this.printRTCPMux(S.rtcpMux),v+=this.printRTCPMuxOnly(S.rtcpMuxOnly),v+=this.printRTCPRsize(S.rtcpRsize),v+=this.printMSId(S.msids),v+=this.printImageattr(S.imageattr),v+=this.printRid(S.rids),v+=this.printSimulcast(S.simulcast),v+=this.printSCTPPort(S.sctpPort),v+=this.printMaxMessageSize(S.maxMessageSize),v+=this.printUnrecognized(S.unrecognized),v}printCandidates(p){return p.map(S=>"a=candidate:".concat(S.foundation).concat(u).concat(S.componentId).concat(u).concat(S.transport).concat(u).concat(S.priority).concat(u).concat(S.connectionAddress).concat(u).concat(S.port).concat(u,"typ").concat(u).concat(S.type).concat(S.relAddr?"".concat(u,"raddr").concat(u).concat(S.relAddr):"").concat(S.relPort?"".concat(u,"rport").concat(u).concat(S.relPort):"").concat(Object.keys(S.extension).map(v=>"".concat(u).concat(v).concat(u).concat(S.extension[v])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(p){return p.map(S=>"a=remote-candidates:".concat(S.join(u)).concat(this.eol)).join("")}printEndOfCandidates(p){return p===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(p){if(!p.payloads)return"";const S=p.payloads;let v="";v+=p.rtcpFeedbackWildcards.map(b=>this.printRTCPFeedback("*",b)).join("");for(const b of S)v+=this.printRtpMap(b.payloadType,b.rtpMap),v+=this.printFmtp(b.payloadType,b.fmtp),v+=b.rtcpFeedbacks.map(z=>this.printRTCPFeedback(b.payloadType,z)).join("");return v}printFmtp(p,S){if(!S)return"";const v=Object.keys(S.parameters);return v.length===1&&S.parameters[v[0]]===null?"a=fmtp:".concat(p).concat(u).concat(v[0]).concat(this.eol):"a=fmtp:".concat(p).concat(u).concat(Object.keys(S.parameters).map(b=>"".concat(b,"=").concat(S.parameters[b])).join(";")).concat(this.eol)}printRtpMap(p,S){return S?"a=rtpmap:".concat(p).concat(u).concat(S.encodingName,"/").concat(S.clockRate).concat(S.encodingParameters?"/".concat(S.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(p,S){let v="a=rtcp-fb:".concat(p).concat(u),b=S;switch(b.type){case"trr-int":v+="ttr-int".concat(u).concat(b.interval);break;case"ack":case"nack":default:b=b,v+="".concat(b.type),b.parameter&&(v+="".concat(u).concat(b.parameter),b.additional&&(v+="".concat(u).concat(b.additional)))}return v+this.eol}printPtime(p){return p===void 0?"":"a=ptime:".concat(p).concat(this.eol)}printMaxPtime(p){return p===void 0?"":"a=maxptime:".concat(p).concat(this.eol)}printDirection(p){return p===void 0?"":"a=".concat(p).concat(this.eol)}printSSRC(p){return p.map(S=>Object.keys(S.attributes).map(v=>"a=ssrc:".concat(S.ssrcId.toString(10)).concat(u).concat(v).concat(S.attributes[v]?":".concat(S.attributes[v]):"").concat(this.eol)).join("")).join("")}printRTCPMux(p){return p===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(p){return p===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(p){return p===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(p){if(p===void 0)return"";let S="a=rtcp:".concat(p.port);return p.netType&&(S+="".concat(u).concat(p.netType)),p.addressType&&(S+="".concat(u).concat(p.addressType)),p.address&&(S+="".concat(u).concat(p.address)),S+this.eol}printMSId(p){return p.map(S=>"a=msid:".concat(S.id).concat(S.appdata?"".concat(u).concat(S.appdata):"").concat(this.eol)).join("")}printImageattr(p){return p.map(S=>"a=imageattr:".concat(S).concat(this.eol)).join("")}printRid(p){return p.map(S=>{let v="a=rid:".concat(S.id).concat(u).concat(S.direction);return S.payloads&&(v+="".concat(u,"pt=").concat(S.payloads.join(","))),S.params.length>0&&(v+="".concat(u).concat(S.params.map(b=>b.type==="depend"?"depend=".concat(b.rids.join(",")):"".concat(b.type,"=").concat(b.val)).join(";"))),v+this.eol}).join("")}printSimulcast(p){return p===void 0?"":"a=simulcast:".concat(p).concat(this.eol)}printSCTPPort(p){return p===void 0?"":"a=sctp-port:".concat(p).concat(this.eol)}printMaxMessageSize(p){return p===void 0?"":"a=max-message-size:".concat(p).concat(this.eol)}printMid(p){return p===void 0?"":"a=mid:".concat(p).concat(this.eol)}printSSRCGroups(p){return p.map(S=>"a=ssrc-group:".concat(S.semantic).concat(S.ssrcIds.map(v=>"".concat(u).concat(v.toString(10))).join("")).concat(this.eol)).join("")}}function X(L){return new Dt().parse(L)}function ut(L,p){return new $e().print(L,p)}}},n={};function r(o){if(n[o])return n[o].exports;var s=n[o]={exports:{}};return i[o](s,s.exports,r),s.exports}return r.d=(o,s)=>{for(var a in s)r.o(s,a)&&!r.o(o,a)&&Object.defineProperty(o,a,{enumerable:!0,get:s[a]})},r.o=(o,s)=>Object.prototype.hasOwnProperty.call(o,s),r.r=o=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},r(8)})()})(Qt);class K0{constructor(e){h(this,"sessionDesc",void 0),h(this,"localCapabilities",void 0),h(this,"rtpCapabilities",void 0),h(this,"candidates",void 0),h(this,"iceParameters",void 0),h(this,"dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),e=Xt(e);const{remoteIceParameters:i,remoteDtlsParameters:n,candidates:r,remoteRTPCapabilities:o,remoteSetup:s,localCapabilities:a,sdkCodec:c,cname:d}=e,u=Qt.exports.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=o,this.candidates=r,this.iceParameters=i,this.dtlsParameters=n,this.setup=s,this.localCapabilities=a,this.cname=d;for(let l=0;l<u.mediaDescriptions.length;l++){const E=u.mediaDescriptions[l];if(E.attributes.iceUfrag=i.iceUfrag,E.attributes.icePwd=i.icePwd,E.attributes.fingerprints=n.fingerprints,E.attributes.candidates=r,E.attributes.setup=s,E.media.mediaType==="video"){E.media.fmts=o.videoCodecs.map(T=>T.payloadType.toString(10));const m=o.videoCodecs.filter(T=>{var g;return(g=T.rtpMap)===null||g===void 0?void 0:g.encodingName.toLowerCase().includes(c)});if(m.length===0)throw new Error("Codec ".concat(c," not supported by remote SDP."));E.attributes.payloads=m,E.attributes.extmaps=o.videoExtensions}E.media.mediaType==="audio"&&(E.media.fmts=o.audioCodecs.map(m=>m.payloadType.toString(10)),E.attributes.payloads=o.audioCodecs,E.attributes.extmaps=o.audioExtensions),u.mediaDescriptions[l]=this.mungMediaDesc(E)}this.sessionDesc=u,this.currentMidIndex=u.mediaDescriptions.length-1}toString(){return Qt.exports.print(this.sessionDesc)}send(e,i,n){const{ssrcs:r,ssrcGroups:o}=Ci(i,this.cname),s=this.sessionDesc.mediaDescriptions.find(d=>e===Z.VIDEO?d.media.mediaType==="video":d.media.mediaType==="audio"),a=r[0].attributes.label,c=r[0].attributes.mslabel;return s.attributes.ssrcs=s.attributes.ssrcs.concat(r),s.attributes.ssrcGroups=s.attributes.ssrcGroups.concat(o),{id:a,mslabel:c}}batchSend(e){return e.map(i=>{let{kind:n,ssrcMsg:r}=i;return this.send(n,r,void 0)})}stopSending(e){this.sessionDesc.mediaDescriptions.forEach(i=>{const n=[],r=[],o=[];i.attributes.ssrcs.forEach(s=>{e.includes(s.attributes.label||"")?o.push(s):n.push(s)}),i.attributes.ssrcGroups.forEach(s=>{o.map(a=>a.ssrcId).includes(s.ssrcIds[0])||r.push(s)}),i.attributes.ssrcs=n,i.attributes.ssrcGroups=r})}mute(e){const i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(e){const i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}receive(e,i,n){e.forEach((r,o)=>{const s=r._mediaStreamTrack,a=this.sessionDesc.mediaDescriptions.findIndex(d=>d.attributes.mid===s.kind),c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=c})}stopReceiving(e){}restartICE(e){e=Xt(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=e.iceUfrag,i.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const i=[];for(let n=0;n<e;n++)i.push((this.currentMidIndex+n+1).toString(10));return i}mungRecvMediaDsec(e,i){const n=Xt(e);return Zr(n,i),Gu(n,i),n}updateRecvMedia(e,i){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(n!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],i);this.sessionDesc.mediaDescriptions[n]=r}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,i,n){const r=this.sessionDesc.mediaDescriptions.find(s=>e===Z.VIDEO?s.attributes.mid==="video":s.attributes.mid==="audio");if(r){const s=r.attributes.ssrcs.find(a=>a.attributes.label===i);var o;s&&(s.attributes.label=n,(o=s.attributes.msid)===null||o===void 0||o.replace(i,n))}}mungMediaDesc(e){const i=Xt(e);return Bu(i),function(n){const r=n.attributes.extmaps.find(o=>o.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");r&&n.attributes.extmaps.splice(n.attributes.extmaps.indexOf(r),1),n.attributes.payloads.forEach(o=>{const s=o.rtcpFeedbacks.findIndex(a=>a.type==="transport-cc");s!==-1&&o.rtcpFeedbacks.splice(s,1)})}(i),i}getSSRC(e){for(const i of this.sessionDesc.mediaDescriptions)for(const n of i.attributes.ssrcs)if(n.attributes.label===e)return[n]}}function Vi(t){if(Array.isArray(t))return t.map(i=>i);if(!cg(t))return t;const e={};for(const i in t)cg(t[i])||Array.isArray(t[i])?e[i]=Vi(t[i]):e[i]=t[i];return e}function cg(t){return!(typeof t!="object"||Array.isArray(t)||!t)}function Y0(){const t=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return t&&t[0]?Number(t[0].split("/")[1]):null}function q0(t){return window.RTCStatsReport?t.getStats()instanceof V:!1}class Hu{constructor(e){h(this,"input",[]),h(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const dg={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Vo={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:dg,remoteCandidate:dg}},ug={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},lg={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,qpSumPerFrame:0},hg={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0},pg={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};class Ku{constructor(e,i){h(this,"onFirstVideoReceived",void 0),h(this,"onFirstVideoDecoded",void 0),h(this,"onFirstAudioReceived",void 0),h(this,"onFirstVideoDecodedTimeout",void 0),h(this,"onFirstAudioDecoded",void 0),h(this,"onSelectedLocalCandidateChanged",void 0),h(this,"onSelectedRemoteCandidateChanged",void 0),h(this,"videoIsReady",!1),h(this,"videoIsReady2",{}),h(this,"pc",void 0),h(this,"options",void 0),h(this,"intervalTimer",void 0),h(this,"stats",Vi(Vo)),h(this,"isFirstVideoReceived",{}),h(this,"isFirstVideoDecoded",{}),h(this,"isFirstAudioReceived",{}),h(this,"isFirstAudioDecoded",{}),h(this,"isFirstVideoDecodedTimeout",{}),h(this,"lossRateWindowStats",[]),this.pc=e,this.options=i,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,i){this.videoIsReady2[e]=i}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const i=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let r=0,o=0,s=0,a=0;for(const c of n)e[c].forEach((d,u)=>{if(!this.lossRateWindowStats[i-1][c][u]||!this.lossRateWindowStats[0][c][u])return;const l=this.lossRateWindowStats[i-1][c][u].packets-this.lossRateWindowStats[0][c][u].packets,E=this.lossRateWindowStats[i-1][c][u].packetsLost-this.lossRateWindowStats[0][c][u].packetsLost;c==="videoSend"||c==="audioSend"?(r+=l,s+=E):(o+=l,a+=E),Number.isNaN(l)||Number.isNaN(l)?d.packetLostRate=0:d.packetLostRate=l<=0||E<=0?0:E/(l+E)});e.sendPacketLossRate=r<=0||s<=0?0:s/(r+s),e.recvPacketLossRate=o<=0||a<=0?0:a/(o+a)}}function Eg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function J0(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Eg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Eg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class X0 extends Ku{constructor(){super(...arguments),h(this,"_stats",Vo),h(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),i=this.statsResponsesToObjects(e);this._stats=Vi(Vo);const n=i.filter(o=>o.type==="ssrc");this.processSSRCStats(n);const r=i.find(o=>o.type==="VideoBwe");r&&this.processBandwidthStats(r),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(i=>{const n=i.id.includes("send");switch("".concat(i.mediaType,"_").concat(n?"send":"recv")){case"video_send":{const r=Vi(lg);r.codec=i.googCodecName,r.adaptionChangeReason="none",i.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),i.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(i.googAvgEncodeMs),r.inputFrame={width:Number(i.googFrameWidthInput)||Number(i.googFrameWidthSent),height:Number(i.googFrameHeightInput)||Number(i.googFrameHeightSent),frameRate:Number(i.googFrameRateInput)},r.sentFrame={width:Number(i.googFrameWidthSent),height:Number(i.googFrameHeightSent),frameRate:Number(i.googFrameRateInput)},r.firsCount=Number(i.googFirReceived),r.nacksCount=Number(i.googNacksReceived),r.plisCount=Number(i.googPlisReceived),r.frameCount=Number(i.framesEncoded),r.bytes=Number(i.bytesSent),r.packets=Number(i.packetsSent),r.packetsLost=Number(i.packetsLost),r.ssrc=Number(i.ssrc),r.rttMs=Number(i.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{const r=Vi(ug),o=this.lastDecodeVideoReceiverStats.get(Number(i.ssrc));if(r.codec=i.googCodecName,r.targetDelayMs=Number(i.googTargetDelayMs),r.renderDelayMs=Number(i.googRenderDelayMs),r.currentDelayMs=Number(i.googCurrentDelayMs),r.minPlayoutDelayMs=Number(i.googMinPlayoutDelayMs),r.decodeMs=Number(i.googDecodeMs),r.maxDecodeMs=Number(i.googMaxDecodeMs),r.receivedFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateReceived)},r.decodedFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateDecoded)},r.decodeFrameRate=Number(i.googFrameRateDecoded),r.outputFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateOutput)},r.jitterBufferMs=Number(i.googJitterBufferMs),r.firsCount=Number(i.googFirsSent),r.nacksCount=Number(i.googNacksSent),r.plisCount=Number(i.googPlisSent),r.framesDecodeCount=Number(i.framesDecoded),r.bytes=Number(i.bytesReceived),r.packets=Number(i.packetsReceived),r.packetsLost=Number(i.packetsLost),r.ssrc=Number(i.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),o){const s=o.stats,a=Date.now()-o.lts;r.framesDecodeFreezeTime=s.framesDecodeFreezeTime,r.framesDecodeInterval=s.framesDecodeInterval,r.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(o.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(i.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(i.ssrc,10),!0))):r.framesDecodeCount<o.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:J0({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{const r=Vi(pg);r.codec=i.googCodecName,r.outputLevel=Math.abs(Number(i.audioOutputLevel))/32767,r.decodingCNG=Number(i.googDecodingCNG),r.decodingCTN=Number(i.googDecodingCTN),r.decodingCTSG=Number(i.googDecodingCTSG),r.decodingNormal=Number(i.googDecodingNormal),r.decodingPLC=Number(i.googDecodingPLC),r.decodingPLCCNG=Number(i.googDecodingPLCCNG),r.expandRate=Number(i.googExpandRate),r.accelerateRate=Number(i.googAccelerateRate),r.preemptiveExpandRate=Number(i.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(i.googSecondaryDecodedRate),r.speechExpandRate=Number(i.googSpeechExpandRate),r.preferredJitterBufferMs=Number(i.googPreferredJitterBufferMs),r.jitterBufferMs=Number(i.googJitterBufferMs),r.jitterMs=Number(i.googJitterReceived),r.bytes=Number(i.bytesReceived),r.packets=Number(i.packetsReceived),r.packetsLost=Number(i.packetsLost),r.ssrc=Number(i.ssrc),r.receivedFrames=Number(i.googDecodingCTN)||Number(i.packetsReceived),r.droppedFrames=Number(i.googDecodingPLC)+Number(i.googDecodingPLCCNG)||Number(i.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{const r=Vi(hg);r.codec=i.googCodecName,r.inputLevel=Math.abs(Number(i.audioInputLevel))/32767,r.aecReturnLoss=Number(i.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(i.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(i.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(i.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(i.bytesSent),r.packets=Number(i.packetsSent),r.packetsLost=Number(i.packetsLost),r.ssrc=Number(i.ssrc),r.rttMs=Number(i.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}})}_getStats(){return new V((e,i)=>{this.pc.getStats(e,i)})}statsResponsesToObjects(e){const i=[];return e.result().forEach(n=>{const r={id:n.id,timestamp:n.timestamp.valueOf().toString(),type:n.type};n.names().forEach(o=>{r[o]=n.stat(o)}),i.push(r)}),i}}function _g(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Fo(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?_g(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):_g(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class mg extends Ku{constructor(){super(...arguments),h(this,"_stats",Vo),h(this,"report",void 0),h(this,"lastDecodeVideoReceiverStats",new Map),h(this,"lastVideoFramesRecv",new Map),h(this,"lastVideoFramesSent",new Map),h(this,"lastVideoFramesDecode",new Map),h(this,"lastVideoJBDelay",new Map),h(this,"lastAudioJBDelay",new Map),h(this,"mediaBytesSent",new Map),h(this,"mediaBytesRetransmit",new Map),h(this,"mediaBytesTargetEncode",new Map),h(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=Vi(Vo),this.report.forEach(e=>{switch(e.type){case Di.OUTBOUND:e.mediaType==="audio"?this.processAudioOutboundStats(e):e.mediaType==="video"&&this.processVideoOutboundStats(e);break;case Di.INBOUND:e.mediaType==="audio"?this.processAudioInboundStats(e):e.mediaType==="video"&&this.processVideoInboundStats(e);break;case Di.TRANSPORT:{const i=this.report.get(e.selectedCandidatePairId);i&&this.processCandidatePairStats(i);break}case Di.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(i=>{e.currentRoundTripTime&&(i.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(i=>{e.currentRoundTripTime&&(i.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const i=this.report.get(e.localCandidateId);i&&this.processCandidateStats(i)}if(e.remoteCandidateId){const i=this.report.get(e.remoteCandidateId);i&&this.processCandidateStats(i)}}processCandidateStats(e){let i;e.type===Di.LOCAL_CANDIDATE&&(i=this._stats.selectedCandidatePair.localCandidate),e.type===Di.REMOTE_CANDIDATE&&(i=this._stats.selectedCandidatePair.remoteCandidate),i&&(i.type=e.type,i.id=e.id,e.address&&(i.address=e.address),e.candidateType&&(i.candidateType=e.candidateType),e.port&&(i.port=e.port),e.priority&&(i.priority=e.priority),e.protocol&&(i.protocol=e.protocol),e.relayProtocol&&(i.relayProtocol=e.relayProtocol),e.type===Di.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==i.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Fo({},i),Fo({},this.stats.selectedCandidatePair.localCandidate)),e.type===Di.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==i.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Fo({},i),Fo({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let i=this._stats.audioRecv.find(n=>n.ssrc===e.ssrc);i||(i=Vi(pg),this._stats.audioRecv.push(i)),i.ssrc=e.ssrc,i.packets=e.packetsReceived,i.packetsLost=e.packetsLost,i.bytes=e.bytesReceived,i.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,i),e.codecId&&(i.codec=this.getCodecFromCodecStats(e.codecId)),i.receivedFrames||(i.receivedFrames=e.packetsReceived),i.droppedFrames||(i.droppedFrames=e.packetsLost),i.receivedFrames>0&&!this.isFirstAudioReceived[i.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(i.ssrc),this.isFirstAudioReceived[i.ssrc]=!0),i.outputLevel&&i.outputLevel>0&&!this.isFirstAudioDecoded[i.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(i.ssrc),this.isFirstAudioDecoded[i.ssrc]=!0),typeof e.concealedSamples=="number"&&(i.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let i=this._stats.videoRecv.find(s=>s.ssrc===e.ssrc);i||(i=Vi(ug),this._stats.videoRecv.push(i)),i.ssrc=e.ssrc,i.packets=e.packetsReceived,i.packetsLost=e.packetsLost,i.bytes=e.bytesReceived,i.firsCount=e.firCount,i.nacksCount=e.nackCount,i.plisCount=e.pliCount,i.framesDecodeCount=e.framesDecoded,i.totalInterFrameDelay=e.totalInterFrameDelay,i.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const n=this.lastDecodeVideoReceiverStats.get(i.ssrc),r=this.lastVideoFramesDecode.get(i.ssrc),o=Date.now();if(i.framesDecodeCount>0&&!this.isFirstVideoDecoded[i.ssrc]){const s=i.decodedFrame?i.decodedFrame.width:0,a=i.decodedFrame?i.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(i.ssrc,s,a),this.isFirstVideoDecoded[i.ssrc]=!0}if(n){const s=n.stats,a=o-n.lts;i.framesDecodeFreezeTime=s.framesDecodeFreezeTime,i.framesDecodeInterval=s.framesDecodeInterval,!this.isFirstVideoDecoded[i.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[i.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(i.ssrc),this.isFirstVideoDecodedTimeout[i.ssrc]=!0),i.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[i.ssrc]?(n.lts=Date.now(),i.framesDecodeInterval=a,i.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?i.framesDecodeFreezeTime+=i.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):i.framesDecodeCount<s.framesDecodeCount&&(i.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(n.stats.framesDecodeCount>e.framesDecoded?i.qpSumPerFrame=e.qpSum/e.framesDecoded:i.qpSumPerFrame=(e.qpSum-n.qpSum)/(e.framesDecoded-n.stats.framesDecodeCount))}r&&o-r.lts>=800?(i.decodeFrameRate=Math.round((i.framesDecodeCount-r.count)/((o-r.lts)/1e3)),this.lastVideoFramesDecode.set(i.ssrc,{count:i.framesDecodeCount,lts:o,rate:i.decodeFrameRate})):r?i.decodeFrameRate=r.rate:this.lastVideoFramesDecode.set(i.ssrc,{count:i.framesDecodeCount,lts:o,rate:0}),e.totalDecodeTime&&(i.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,i),e.codecId&&(i.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(i.framesRateFirefox=e.framerateMean),i.packets>0&&!this.isFirstVideoReceived[i.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(i.ssrc),this.isFirstVideoReceived[i.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(i.ssrc,{stats:Fo({},i),lts:n?n.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let i=this._stats.videoSend.find(r=>r.ssrc===e.ssrc);i||(i=Vi(lg),this._stats.videoSend.push(i));const n=this.mediaBytesSent.get(e.ssrc);if(n)n.add(e.bytesSent);else{const r=new Hu(10);r.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,r)}if(e.retransmittedBytesSent!==void 0){const r=this.mediaBytesRetransmit.get(e.ssrc);if(r)r.add(e.retransmittedBytesSent);else{const o=new Hu(10);o.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,o)}}if(e.totalEncodedBytesTarget){const r=this.mediaBytesTargetEncode.get(e.ssrc);if(r)r.add(e.totalEncodedBytesTarget);else{const o=new Hu(10);o.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,o)}}if(i.ssrc=e.ssrc,i.bytes=e.bytesSent,i.packets=e.packetsSent,i.firsCount=e.firCount,i.nacksCount=e.nackCount,i.plisCount=e.pliCount,i.frameCount=e.framesEncoded,i.adaptionChangeReason=e.qualityLimitationReason,e.totalEncodeTime&&e.framesEncoded){const r=this.lastEncoderMs.get(e.ssrc);if(!r||r.lastFrameCount>e.framesEncoded)i.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const o=e.framesEncoded-r.lastFrameCount,s=e.totalEncodeTime-r.lastEncoderTime;i.avgEncodeMs=1e3*s/o}}if(e.framesEncoded&&e.qpSum){const r=this.lastEncoderMs.get(e.ssrc);!r||r.lastFrameCount>e.framesEncoded?i.qpSumPerFrame=e.qpSum/e.framesEncoded:i.qpSumPerFrame=(e.qpSum-r.lastQpSum)/(e.framesEncoded-r.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(i.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,i),this.processVideoTrackSenderStats(e,e.trackId,i),e.remoteId)this.processRemoteInboundStats(e.remoteId,i);else{const r=this.findRemoteStatsId(e.ssrc,Di.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,i)}}processAudioOutboundStats(e){let i=this._stats.audioSend.find(n=>n.ssrc===e.ssrc);if(i||(i=Vi(hg),this._stats.audioSend.push(i)),i.ssrc=e.ssrc,i.packets=e.packetsSent,i.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,i),e.codecId&&(i.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,i),e.remoteId)this.processRemoteInboundStats(e.remoteId,i);else{const n=this.findRemoteStatsId(e.ssrc,Di.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,i)}}findRemoteStatsId(e,i){var n;const r=Array.from(nn(n=this.report).call(n)).find(o=>o.type===i&&o.ssrc===e);return r?r.id:null}processVideoMediaSource(e,i){const n=this.report.get(e);n&&n.width&&n.height&&n.framesPerSecond&&(i.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(e,i){const n=this.report.get(e);n&&(i.inputLevel=n.audioLevel)}processVideoTrackSenderStats(e,i,n){var r,o,s;const a=i?this.report.get(i):void 0,c=(r=a==null?void 0:a.framesSent)!==null&&r!==void 0?r:e.framesSent;let d=(o=a==null?void 0:a.frameWidth)!==null&&o!==void 0?o:e.frameWidth,u=(s=a==null?void 0:a.frameHeight)!==null&&s!==void 0?s:e.frameHeight;if(typeof c!="number")return;c!==0||typeof d=="number"&&typeof u=="number"||(d=0,u=0);let l=0;const E=Date.now(),m=this.lastVideoFramesSent.get(n.ssrc);m&&E-m.lts>=800?(l=Math.round((c-m.count)/((E-m.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:E,rate:l})):m?l=m.rate:this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:E,rate:0}),n.sentFrame={width:d,height:u,frameRate:Math.max(0,l)}}processVideoTrackReceiverStats(e,i,n){var r,o,s,a,c;const d=i?this.report.get(i):void 0,u=(r=d==null?void 0:d.framesReceived)!==null&&r!==void 0?r:e.framesReceived,l=(o=d==null?void 0:d.frameWidth)!==null&&o!==void 0?o:e.frameWidth,E=(s=d==null?void 0:d.frameHeight)!==null&&s!==void 0?s:e.frameHeight,m=(a=d==null?void 0:d.jitterBufferDelay)!==null&&a!==void 0?a:e.jitterBufferDelay,T=(c=d==null?void 0:d.jitterBufferEmittedCount)!==null&&c!==void 0?c:e.jitterBufferEmittedCount;if(typeof u=="number"){const g=this.lastVideoFramesRecv.get(n.ssrc),R=Date.now();n.framesReceivedCount=u;let y=0;g&&R-g.lts>=800?(y=Math.round((u-g.count)/((R-g.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:u,lts:R,rate:y})):g?y=g.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:u,lts:R,rate:0}),n.receivedFrame={width:l||0,height:E||0,frameRate:y||0},n.decodedFrame={width:l||0,height:E||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:l||0,height:E||0,frameRate:n.decodeFrameRate||0}}if(m&&T){let g=this.lastVideoJBDelay.get(n.ssrc);this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:m,jitterBufferEmittedCount:T}),g||(g={jitterBufferDelay:0,jitterBufferEmittedCount:0});const R=1e3*(m-g.jitterBufferDelay)/(T-g.jitterBufferEmittedCount);n.jitterBufferMs=R,n.currentDelayMs=Math.round(R)}}processAudioTrackSenderStats(e,i,n){var r,o,s,a;const c=i?this.report.get(i):void 0,d=(r=(o=c==null?void 0:c.echoReturnLoss)!==null&&o!==void 0?o:e.echoReturnLoss)!==null&&r!==void 0?r:0,u=(s=(a=c==null?void 0:c.echoReturnLossEnhancement)!==null&&a!==void 0?a:e.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;n.aecReturnLoss=d,n.aecReturnLossEnhancement=u}processAudioTrackReceiverStats(e,i,n){var r,o,s,a,c,d,u;const l=i?this.report.get(i):void 0,E=(r=l==null?void 0:l.removedSamplesForAcceleration)!==null&&r!==void 0?r:e.removedSamplesForAcceleration,m=(o=l==null?void 0:l.totalSamplesReceived)!==null&&o!==void 0?o:e.totalSamplesReceived,T=(s=l==null?void 0:l.jitterBufferDelay)!==null&&s!==void 0?s:e.jitterBufferDelay,g=(a=l==null?void 0:l.jitterBufferEmittedCount)!==null&&a!==void 0?a:e.jitterBufferEmittedCount,R=(c=l==null?void 0:l.audioLevel)!==null&&c!==void 0?c:e==null?void 0:e.audioLevel,y=(d=l==null?void 0:l.totalSamplesDuration)!==null&&d!==void 0?d:e==null?void 0:e.totalSamplesDuration,A=(u=l==null?void 0:l.concealedSamples)!==null&&u!==void 0?u:e.concealedSamples;if(E&&m&&(n.accelerateRate=E/m),T&&g){let H=this.lastAudioJBDelay.get(n.ssrc);this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:T,jitterBufferEmittedCount:g}),H||(H={jitterBufferDelay:0,jitterBufferEmittedCount:0});const k=1e3*(T-H.jitterBufferDelay)/(g-H.jitterBufferEmittedCount);n.jitterBufferMs=Math.round(k)}n.outputLevel=R;let P=1920;y&&m&&(P=m/y/50,n.receivedFrames=Math.round(m/P)),A&&(n.droppedFrames=Math.round(A/P))}processRemoteInboundStats(e,i){const n=this.report.get(e);n&&(i.packetsLost=n.packetsLost,n.roundTripTime&&(i.rttMs=1e3*n.roundTripTime))}getCodecFromCodecStats(e){const i=this.report.get(e);if(!i)return"";const n=i.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let e=0,i=null,n=null;this.mediaBytesSent.forEach(o=>{e+=o.diffMean()}),this.mediaBytesRetransmit.forEach(o=>{i=i===null?o.diffMean():i+o.diffMean()}),this.mediaBytesTargetEncode.forEach(o=>{n=n===null?o.diffMean():n+o.diffMean()});const r=i!==null?e-i:e;this._stats.bitrate={actualEncoded:8*r/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},i!==null&&(this._stats.bitrate.retransmit=8*i/(this.options.updateInterval/1e3)),n!==null&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}}class z0 extends Ku{updateStats(){return V.resolve()}}function Yu(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const o=Y0();return o?o<76?new X0(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new mg(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):q0(t)?new mg(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new z0(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r})}var It;function fg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Sg(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?fg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):fg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let jo=(w((It=class Ho extends Xs{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}constructor(e,i){super(e,i),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"statsFilter",void 0),h(this,"useRTX",!1),h(this,"localCapabilities",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"establishPromise",void 0),h(this,"mutex",new Ve("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(Ho.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Yu(this.peerConnection,void 0,void 0,Bt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=_r(e.sdp),n=ju(e.sdp,!this.useRTX,C("FILTER_VIDEO_FEC"),C("FILTER_AUDIO_FEC"),["opus"]);return this.localCapabilities=n,this.initialOffer=e,Sg(Sg({},i),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:n},offerSDP:e.sdp})}catch(e){throw new I(f.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,i,n,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new K0({remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:r.send,remoteSetup:o,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:s});const a=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}send(e,i){var n=this;return xi(function*(){const r=yield rt(n.mutex.lock());try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=e.map(E=>n.peerConnection.addTrack(E._mediaStreamTrack)),s=yield rt(n.peerConnection.createOffer()),a=Qt.exports.parse(s.sdp),c=e.map(E=>{const m=E._mediaStreamTrack,T=a.mediaDescriptions.find(g=>g.attributes.mid===m.kind);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return function(g,R,y){const A=g.attributes.ssrcs.filter(H=>H.attributes.label===R),P=g.attributes.ssrcGroups;if(A.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(P&&A.length>1){const H=P.find(k=>k.ssrcIds.indexOf(A[0].ssrcId)!==-1);return H?[{ssrcId:H.ssrcIds[0],rtx:y?H.ssrcIds[1]:void 0}]:[{ssrcId:A[0].ssrcId}]}return[{ssrcId:A[0].ssrcId}]}(T,m.id,n.useRTX)});let d;try{d=yield c}catch(E){throw o.forEach(m=>{Le()&&m.replaceTrack(null),n.peerConnection.removeTrack(m)}),E}const u=n.mungSendOfferSDP(s.sdp,e);n.remoteSDP.receive(e,i,d);const l=n.remoteSDP.toString();return yield rt(n.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield rt(n.applySendEncodings(o,e)),yield rt(n.peerConnection.setRemoteDescription({type:"answer",sdp:l})),e.map((E,m)=>{const T=E._mediaStreamTrack.id;return{localSSRC:c[m],id:T}})}catch(o){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const i=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(o=>{Le()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}}async receive(e,i,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:o,mslabel:s}=this.remoteSDP.send(e,i,r),a=new V((u,l)=>{const E=setTimeout(()=>{l(new Error("Cannot receive track, id: ".concat(o)))},1e4),m=T=>{const g=Rt();if((g.name==="Safari"&&Number(g.version)===11||ke())&&T.track.id!==o&&T.streams[0].id===s){var R;const y=T.streams[0].getTracks()[0];return(R=this.remoteSDP)===null||R===void 0||R.updateTrackLabel(e,o,T.track.id),this.peerConnection.removeEventListener("track",m),clearTimeout(E),void u(y)}if(T.track.id===o)return this.peerConnection.removeEventListener("track",m),clearTimeout(E),void u(T.track)};this.peerConnection.addEventListener("track",m)}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:o}}catch(o){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n)}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getSenders().filter(n=>{var r;return e.indexOf(((r=n.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(i.length!==e.length)throw new Error("sender' length doesn't match mids' length.");i.map(n=>{if(Le()&&n.track)n.track.enabled=!1;else{const r=n.getParameters();r.encodings.forEach(o=>o.active=!1),n.setParameters(r)}})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(i.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");i.map(async o=>{if(Le()&&o.track)o.track.enabled=!0;else{const s=o.getParameters();s.encodings.forEach(a=>a.active=!0),await o.setParameters(s)}});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(){var e=this;return xi(function*(){const i=yield rt(e.mutex.lock("From P2PConnection.restartICE"));try{const n=yield rt(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const r=_r(n.sdp),{remoteIceParameters:o}=yield r.iceParameters;if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");e.remoteSDP.restartICE(o);const s=e.remoteSDP.toString();yield rt(e.peerConnection.setLocalDescription(n)),yield rt(e.peerConnection.setRemoteDescription({type:"answer",sdp:s}))}catch(n){_.warning("restart ICE failed, abort operation",n)}finally{i()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i]);this.remoteSDP.updateRecvMedia(i._mediaStreamTrack.kind,i);const o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new I(f.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(e,i){const n=this.peerConnection.getSenders().filter(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===e});n.length===1&&await this.applySendEncodings(n,[i])}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const n=this.peerConnection.getSenders().find(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===i});n&&await n.replaceTrack(e._mediaStreamTrack)}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},C("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Io(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...Ho.turnServerConfigToIceServers(e.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...Ho.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(n=>{n.security?n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),i}async applySendEncodings(e,i){try{if(!le().supportSetRtpSenderParameters||e.length!==i.length)return;for(let r=0;r<e.length;r++){var n;const o=e[r],s=i[r];if(!s)continue;const a={},c={};if(s instanceof zt)switch(s._optimizationMode){case"motion":a.degradationPreference="maintain-framerate";break;case"detail":a.degradationPreference="maintain-resolution";break;default:a.degradationPreference="balanced"}if(C("DSCP_TYPE")&&er()){const l=C("DSCP_TYPE");["very-low","low","medium","high"].includes(l)&&(c.networkPriority=l)}const d=o.getParameters(),u=(n=d.encodings)===null||n===void 0?void 0:n[0];u&&Object.assign(u,c),Object.assign(d,a),await o.setParameters(d)}}catch{_.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,i){const n=Qt.exports.parse(e);return i.forEach((r,o)=>{const s=r._mediaStreamTrack,a=n.mediaDescriptions.find(c=>c.attributes.mid===s.kind);a&&Zr(a,r)}),Qt.exports.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const i=this.remoteSDP.batchSend(e).map((o,s)=>{let{id:a,mslabel:c}=o;const{kind:d}=e[s];return new V((u,l)=>{const E=setTimeout(()=>{l(new Error("Cannot receive track, id: ".concat(a)))},1e4),m=T=>{const g=Rt();if(g.name==="Safari"&&Number(g.version)===11&&T.track.id!==a&&T.streams[0].id===c){var R;const y=T.streams[0].getTracks()[0];return(R=this.remoteSDP)===null||R===void 0||R.updateTrackLabel(d,a,T.track.id),this.peerConnection.removeEventListener("track",m),clearTimeout(E),void u({track:y,id:a})}if(T.track.id===a)return this.peerConnection.removeEventListener("track",m),clearTimeout(E),void u({track:T.track,id:a})};this.peerConnection.addEventListener("track",m)})}),n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await V.all(i)}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(e);return i==null?void 0:i[0].ssrcId}setConfiguration(e){if(le().supportPCSetConfiguration){const i=Ho.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[yi],Object.getOwnPropertyDescriptor(It.prototype,"connect"),It.prototype),w(It.prototype,"stopSending",[yi],Object.getOwnPropertyDescriptor(It.prototype,"stopSending"),It.prototype),w(It.prototype,"receive",[yi],Object.getOwnPropertyDescriptor(It.prototype,"receive"),It.prototype),w(It.prototype,"stopReceiving",[yi],Object.getOwnPropertyDescriptor(It.prototype,"stopReceiving"),It.prototype),w(It.prototype,"muteRemote",[yi],Object.getOwnPropertyDescriptor(It.prototype,"muteRemote"),It.prototype),w(It.prototype,"unmuteRemote",[yi],Object.getOwnPropertyDescriptor(It.prototype,"unmuteRemote"),It.prototype),w(It.prototype,"muteLocal",[yi],Object.getOwnPropertyDescriptor(It.prototype,"muteLocal"),It.prototype),w(It.prototype,"unmuteLocal",[yi],Object.getOwnPropertyDescriptor(It.prototype,"unmuteLocal"),It.prototype),w(It.prototype,"close",[yi],Object.getOwnPropertyDescriptor(It.prototype,"close"),It.prototype),w(It.prototype,"updateEncoderConfig",[yi],Object.getOwnPropertyDescriptor(It.prototype,"updateEncoderConfig"),It.prototype),w(It.prototype,"updateSendParameters",[yi],Object.getOwnPropertyDescriptor(It.prototype,"updateSendParameters"),It.prototype),w(It.prototype,"replaceTrack",[yi],Object.getOwnPropertyDescriptor(It.prototype,"replaceTrack"),It.prototype),w(It.prototype,"getRemoteSSRC",[yi],Object.getOwnPropertyDescriptor(It.prototype,"getRemoteSSRC"),It.prototype),It);function yi(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,o=await r.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{o()}},i}const Sa="9",gg=4e4;class Q0{get localCapabilities(){return Xt(this._localCapabilities)}get rtpCapabilities(){return Xt(this._rtpCapabilities)}get candidates(){return Xt(this._candidates)}get iceParameters(){return Xt(this._iceParameters)}get dtlsParameters(){return Xt(this._dtlsParameters)}constructor(e){h(this,"sessionDesc",void 0),h(this,"_localCapabilities",void 0),h(this,"_rtpCapabilities",void 0),h(this,"_candidates",void 0),h(this,"_iceParameters",void 0),h(this,"_dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),h(this,"firefoxSsrcMidMap",new Map),e=Xt(e);const{remoteIceParameters:i,remoteDtlsParameters:n,candidates:r,remoteRTPCapabilities:o,remoteSetup:s,localCapabilities:a,cname:c}=e,d=Qt.exports.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=o,this._candidates=r,this._iceParameters=i,this._dtlsParameters=n,this._localCapabilities=a,this.setup=s,this.cname=c;const u=this.rtpCapabilities.send;for(const l of d.mediaDescriptions){if(l.attributes.iceUfrag=i.iceUfrag,l.attributes.icePwd=i.icePwd,l.attributes.fingerprints=n.fingerprints,l.attributes.candidates=r,l.attributes.setup=s,l.media.mediaType==="video"&&(l.media.fmts=u.videoCodecs.map(E=>E.payloadType.toString(10)),l.attributes.payloads=u.videoCodecs,l.attributes.extmaps=u.videoExtensions,C("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:E,ssrcGroups:m}=Ci([{ssrcId:gg,rtx:C("USE_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=E,l.attributes.ssrcGroups=m}if(l.media.mediaType==="audio"&&(l.media.fmts=u.audioCodecs.map(E=>E.payloadType.toString(10)),l.attributes.payloads=u.audioCodecs,l.attributes.extmaps=u.audioExtensions,Fn(l),C("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:E,ssrcGroups:m}=Ci([{ssrcId:2e4}],this.cname);l.attributes.ssrcs=E,l.attributes.ssrcGroups=m}}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}preloadRemoteMedia(){const e=C("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const i=this.candidates,n=this.dtlsParameters,r=this.iceParameters,o=this.rtpCapabilities.send;for(let s=1;s<e;s++){const a=2*s+2e4,c=2*s+gg,{ssrcs:d,ssrcGroups:u}=Ci([{ssrcId:a}],this.cname),{ssrcs:l,ssrcGroups:E}=Ci([{ssrcId:c,rtx:C("USE_RTX")?c+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Sa,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.videoCodecs.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:i,extmaps:o.videoExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:E,rtcpFeedbackWildcards:[],payloads:o.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Sa,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.audioCodecs.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:i,extmaps:o.audioExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:u,rtcpFeedbackWildcards:[],payloads:o.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Qt.exports.print(this.sessionDesc)}send(e,i,n,r){const{ssrcs:o,ssrcGroups:s}=Ci(i,this.cname,C("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(Bt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,o);let d;return c===-1||c===1&&(Le()||SE())||gE()?(d=this.createOrRecycleSendMedia(e,o,s,"sendonly",r),this.updateBundleMids()):(d=Xt(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Bt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const i=e.map(o=>{let{kind:s,ssrcMsg:a,mslabel:c}=o;return this.send(s,a,c)}),n=[];let r=!1;return i.forEach(o=>{let{mid:s,needExchangeSDP:a}=o;a&&(r=!0),n.push(s)}),{mids:n,needExchangeSDP:r}}stopSending(e){const i=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1);if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");i.forEach(n=>{n.attributes.mid==="0"||Bt()||gE()?n.attributes.ssrcs=[]:(n.attributes.ssrcs=[],n.attributes.direction="inactive",n.media.port="0")}),this.updateBundleMids()}mute(e){const i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(e){const i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}muteRemote(e){const i=this.sessionDesc.mediaDescriptions.filter(n=>e.includes(n.attributes.mid||""));if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(e){const i=this.sessionDesc.mediaDescriptions.filter(n=>e.includes(n.attributes.mid||""));if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(n=>{n.attributes.direction="recvonly"})}receive(e,i,n,r){e.forEach((o,s)=>{this.createOrRecycleRecvMedia(o,[],"recvonly",i,n,r[s])}),this.updateBundleMids()}stopReceiving(e){const i=this.sessionDesc.mediaDescriptions.filter(n=>e.indexOf(n.attributes.mid)!==-1);if(i.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");i.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}restartICE(e){e=Xt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=e.iceUfrag,i.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const i=[];for(let n=0;n<e;n++)i.push((this.currentMidIndex+n+1).toString(10));return i}findAvailableMediaIndex(e,i){return this.sessionDesc.mediaDescriptions.findIndex(n=>{const r=n.media.mediaType===e&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(Bt()){if(r){const o=this.firefoxSsrcMidMap.get(i[0].ssrcId);return!(o||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!o||o!==n.attributes.mid)}return!1}return r})}createOrRecycleRecvMedia(e,i,n,r,o,s){const a=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=this.localCapabilities.send;let u=[];if(a===Z.VIDEO){var l,E;if(C("H264_PROFILE_LEVEL_ID")&&r==="h264"&&(u=c.videoCodecs.filter(y=>{var A,P;return(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"").includes(r)&&(y==null||(P=y.fmtp)===null||P===void 0?void 0:P.parameters["profile-level-id"])===C("H264_PROFILE_LEVEL_ID")})),!u||((l=u)===null||l===void 0?void 0:l.length)===0){const y=d.videoCodecs.filter(A=>{var P;return(((P=A.rtpMap)===null||P===void 0?void 0:P.encodingName.toLowerCase())||"").includes(r)});y.length!==0&&(u=c.videoCodecs.filter(A=>y.some(P=>P.payloadType===A.payloadType)))}if(C("USE_RTX")){const y=u.map(P=>P.payloadType.toString()),A=c.videoCodecs.filter(P=>{var H,k;return((H=P.rtpMap)===null||H===void 0?void 0:H.encodingName)==="rtx"&&y.includes(((k=P.fmtp)===null||k===void 0?void 0:k.parameters.apt)||"")});u=[...u,...A]}u.length===0&&(_.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat((E=c.videoCodecs[0].rtpMap)===null||E===void 0?void 0:E.encodingName)),u=c.videoCodecs)}else u=c.audioCodecs.filter(y=>{var A;return(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"").includes(o)}),u.length===0&&(_.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),u=c.audioCodecs.filter(y=>{var A;return(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"").includes("opus")}));const m=a===Z.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const T="".concat(this.currentMidIndex);let g={media:{mediaType:a,port:Sa,protos:["UDP","TLS","RTP","SAVPF"],fmts:u.map(y=>y.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:m,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:u,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(T)}};g=this.mungRecvMediaDsec(g,e,s);const R=this.findFirstClosedMedia(a);if(R){const y=this.sessionDesc.mediaDescriptions.indexOf(R);this.sessionDesc.mediaDescriptions[y]=g}else this.sessionDesc.mediaDescriptions.push(g);return g}createOrRecycleSendMedia(e,i,n,r,o){const s=this.rtpCapabilities.send,a=e===Z.VIDEO?s.videoCodecs:s.audioCodecs,c=e===Z.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let u={media:{mediaType:e,port:Sa,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(E=>E.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungSendMediaDesc(u,o);const l=this.findFirstClosedMedia(e);if(l){const E=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[E]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,i,n){const r=Xt(e);return Bu(r),Zr(r,i),Gu(r,i),og(r),ma(r,n,this.localCapabilities.send),r}mungSendMediaDesc(e,i){const n=Xt(e);return ma(n,i,this.localCapabilities.recv),Fn(n),n}updateRecvMedia(e,i){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(n!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],i);this.sessionDesc.mediaDescriptions[n]=r}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(i=>Bt()?i.media.port==="0"&&i.media.mediaType===e:i.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(i=>{var n,r;return((n=i.attributes)===null||n===void 0||(r=n.ssrcs[0])===null||r===void 0?void 0:r.ssrcId)===e[0].ssrcId})}getSSRC(e){var i;return(i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e))===null||i===void 0?void 0:i.attributes.ssrcs}}var vt;function Tg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Rg(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Tg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Tg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let Bo=(w((vt=class Ko extends Xs{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,i){super(e,i),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"transportEventReceiver",void 0),h(this,"statsFilter",void 0),h(this,"useRTX",C("USE_RTX")),h(this,"localCapabilities",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"establishPromise",void 0),h(this,"mutex",new Ve("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(Ko.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Yu(this.peerConnection,void 0,void 0,Bt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=_r(e.sdp),n=await ag(!this.useRTX,C("FILTER_VIDEO_FEC"),C("FILTER_AUDIO_FEC"));return this.localCapabilities=Wu(n),this.initialOffer=e,Rg(Rg({},i),{},{rtpCapabilities:n,offerSDP:e.sdp})}catch(e){throw new I(f.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,i,n,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new Q0({remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:this.localCapabilities,cname:s});const a=this.remoteSDP.toString(),c=Qt.exports.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(m=>m.media.mediaType==="audio");d&&Fn(d);const u=Qt.exports.print(c),l=this.logSDPExchange(u||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:u}),l==null||l(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});const E=this.peerConnection.getTransceivers()[0];if(E!=null&&E.receiver&&this.tryBindTransportEvents(E.receiver),C("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const m=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:m});const T=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(T)}}catch(a){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}send(e,i,n){var r=this;return xi(function*(){const o=yield rt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[];e.forEach(g=>{const R=r.peerConnection.addTransceiver(g._mediaStreamTrack,{direction:"sendonly"});s.push(R)}),Bt()&&C("SIMULCAST")===!0&&(yield rt(r.applySimulcastForFirefox(s,e)));const a=yield rt(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(e.length),d=r.mungSendOfferSDP(a.sdp,e,c),u=Qt.exports.parse(d),l=c.map(g=>{const R=u.mediaDescriptions.find(y=>y.attributes.mid===g);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return ng(R,r.useRTX)});let E;try{E=yield l}catch(g){E=[],r.remoteSDP.receive(e,i,n,E);const R=r.remoteSDP.toString();throw yield rt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield rt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield rt(r.stopSending(c,!0)),g}r.remoteSDP.receive(e,i,n,E);const m=r.remoteSDP.toString(),T=r.logSDPExchange(d,"offer","local","send");return yield rt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield rt(r.applySimulcastEncodings(s,e)),yield rt(r.applySendEncodings(s,e)),T==null||T(m),yield rt(r.peerConnection.setRemoteDescription({type:"answer",sdp:m})),s.map((g,R)=>{const y=c[R];return{localSSRC:l[R],id:y,transceiver:g}})}catch(s){throw s instanceof I?s:new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(e,i){const n=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();s==null||s(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{n&&n()}}async receive(e,i,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,i,n,r);if(s){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(u.sdp,o,e);d==null||d(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),_.debug("[P2PConnection] receive ".concat(e," by exchanging SDP."))}else _.debug("[P2PConnection] receive ".concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o}}catch(o){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const r=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const s=await this.peerConnection.createAnswer();o==null||o(s.sdp||""),await this.peerConnection.setLocalDescription(s),_.debug("[P2PConnection] batchReceive by exchanging SDP.")}else _.debug("[P2PConnection] batchReceive no need to exchange SDP.");return i.map(r=>{const o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r}})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(s=>{s.direction="inactive"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(s,a)=>{s.direction="sendonly"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(){var e=this;return xi(function*(){const i=yield rt(e.mutex.lock("From P2PConnection.restartICE"));try{const n=yield rt(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const r=_r(n.sdp),{remoteIceParameters:o}=yield r.iceParameters;if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");e.remoteSDP.restartICE(o);const s=e.remoteSDP.toString(),a=e.logSDPExchange(n.sdp||"","offer","local","restartICE");yield rt(e.peerConnection.setLocalDescription(n)),a==null||a(s),yield rt(e.peerConnection.setRemoteDescription({type:"answer",sdp:s}))}catch(n){_.warning("restart ICE failed, abort operation",n)}finally{i()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);const o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new I(f.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(e,i){const n=this.peerConnection.getTransceivers().filter(r=>r.mid===e);n.length===1&&(this.isVP8Simulcast(i)?Bt()||await this.applySimulcastEncodings(n,[i]):await this.applySendEncodings(n,[i]))}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const n=this.peerConnection.getTransceivers().find(r=>r.mid===i);n&&await n.sender.replaceTrack(e._mediaStreamTrack)}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},C("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Io(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...Ko.turnServerConfigToIceServers(e.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...Ko.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),C("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(n=>{n.security?n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(na(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!C("FORCE_TURN_TCP")&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),i}tryBindTransportEvents(e){e.transport&&(this.transportEventReceiver=e,e.transport.onstatechange=()=>{var i,n;(i=e.transport)!==null&&i!==void 0&&i.state&&((n=this.onDTLSTransportStateChange)===null||n===void 0||n.call(this,e.transport.state))},e.transport.onerror=i=>{var n;(n=this.onDTLSTransportError)===null||n===void 0||n.call(this,i.error)},e.transport.iceTransport&&(e.transport.iceTransport.onstatechange=()=>{var i;const n=(i=e.transport)===null||i===void 0?void 0:i.iceTransport.state;var r;n&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,n))}))}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async applySendEncodings(e,i){try{if(!le().supportSetRtpSenderParameters||e.length!==i.length)return;for(let d=0;d<e.length;d++){const u=e[d],l=i[d];if(l&&l instanceof zt){var n,r;if(this.isVP8Simulcast(l))continue;const E={},m={};switch(l._optimizationMode){case"motion":E.degradationPreference="maintain-framerate";break;case"detail":E.degradationPreference="maintain-resolution";break;default:E.degradationPreference="balanced"}var o,s,a,c;if((n=l._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&(m.maxBitrate=1e3*((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)),l._hints.includes(re.LOW_STREAM)&&((s=l._encoderConfig)!==null&&s!==void 0&&s.frameRate&&(m.maxFramerate=Sn(l._encoderConfig.frameRate)),(a=l._encoderConfig)!==null&&a!==void 0&&a.scaleResolutionDownBy&&((c=l._encoderConfig)===null||c===void 0?void 0:c.scaleResolutionDownBy)>1&&(m.scaleResolutionDownBy=l._encoderConfig.scaleResolutionDownBy)),C("DSCP_TYPE")&&er()){const R=C("DSCP_TYPE");["very-low","low","medium","high"].includes(R)&&(m.networkPriority=R)}const T=u.sender.getParameters(),g=(r=T.encodings)===null||r===void 0?void 0:r[0];Bt()&&!g&&(E.encodings=[m]),g&&Object.assign(g,m),Object.assign(T,E),await u.sender.setParameters(T)}}}catch{_.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,i,n){const r=Qt.exports.parse(e);return i.forEach((o,s)=>{const a=n[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Zr(c,o),sg(c,o,this.store.codec))}),Qt.exports.print(r)}mungReceiveAnswerSDP(e,i,n){const r=Qt.exports.parse(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===i);return o&&n===Z.AUDIO&&o.media.mediaType==="audio"&&Fn(o),Qt.exports.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let a=0;a<e.length;a++){var n,r,o,s;const c=e[a],d=i[a];if(d instanceof zt&&!d._hints.includes(re.LOW_STREAM)&&(n=d._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=d._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=d._scalabiltyMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=d._scalabiltyMode)===null||s===void 0?void 0:s.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},l={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:l.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:l.high}];const E=c.sender.getParameters();await c.sender.setParameters(Object.assign(E,u))}}}async applySimulcastEncodings(e,i){if(!Bt()&&e.length===i.length)for(let n=0;n<e.length;n++){const r=i[n];if(r instanceof zt&&this.isVP8Simulcast(r)){const o=e[n],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var i,n,r,o;return!!(e instanceof zt&&C("SIMULCAST")&&this.store.codec==="vp8"&&!e._hints.includes(re.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((n=e._encoderConfig)===null||n===void 0?void 0:n.bitrateMax)>200&&(r=e._scalabiltyMode)!==null&&r!==void 0&&r.numSpatialLayers&&((o=e._scalabiltyMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,r){if(C("SDP_LOGGING"))return _.upload("exchanging ".concat(n," ").concat(i," SDP during P2PConnection.").concat(r,`
`),e),i==="offer"?o=>{this.logSDPExchange(o,"answer",n==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(e);return i==null?void 0:i[0].ssrcId}setConfiguration(e){if(le().supportPCSetConfiguration){const i=Ko.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"connect"),vt.prototype),w(vt.prototype,"receive",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"receive"),vt.prototype),w(vt.prototype,"batchReceive",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"batchReceive"),vt.prototype),w(vt.prototype,"stopReceiving",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"stopReceiving"),vt.prototype),w(vt.prototype,"muteRemote",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"muteRemote"),vt.prototype),w(vt.prototype,"unmuteRemote",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"unmuteRemote"),vt.prototype),w(vt.prototype,"muteLocal",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"muteLocal"),vt.prototype),w(vt.prototype,"unmuteLocal",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"unmuteLocal"),vt.prototype),w(vt.prototype,"close",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"close"),vt.prototype),w(vt.prototype,"updateEncoderConfig",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"updateEncoderConfig"),vt.prototype),w(vt.prototype,"updateSendParameters",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"updateSendParameters"),vt.prototype),w(vt.prototype,"replaceTrack",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"replaceTrack"),vt.prototype),w(vt.prototype,"getRemoteSSRC",[Ai],Object.getOwnPropertyDescriptor(vt.prototype,"getRemoteSSRC"),vt.prototype),vt);function Ai(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{o()}},i}function Ig(t,e){let i=document.createElement("video"),n=document.createElement("canvas");i.setAttribute("style","display:none"),n.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),n.width=Sn(e.width),n.height=Sn(e.height);const r=Sn(e.framerate||15);document.body.append(i),document.body.append(n);let o=t._mediaStreamTrack;i.srcObject=new MediaStream([o]),i.play();const s=n.getContext("2d");if(!s)throw new I(f.UNEXPECTED_ERROR,"can not get canvas context");const a=le(),c=n.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0],d=X_(()=>(()=>{if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){const l=i.videoWidth,E=i.videoHeight/l,m=n.width*E;Math.abs(m-n.height)>=2&&(_.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(m)),n.height=m)}s.drawImage(i,0,0,n.width,n.height),c.requestFrame&&c.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,i.srcObject=new MediaStream([o]))})(),r),u=c.stop;return c.stop=()=>{u.call(c),d(),i&&(i.remove(),i=null),n&&(n.width=0,n.remove(),n=null),_.debug("clean low stream renderer")},c}var vg,Cg,yg,Ag,Oi,Og,bg,wg,Ng,Dg,Pg,Ne;function Lg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ga(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Lg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Lg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class kg extends K_{getUserId(){return this._userId}constructor(e,i,n,r){super(e,"track-".concat(e.kind,"-").concat(i,"-").concat(r.clientId,"_").concat(Lt(5,""))),h(this,"_userId",void 0),h(this,"_uintId",void 0),h(this,"_isDestroyed",!1),h(this,"store",void 0),h(this,"processor",void 0),h(this,"processorContext",void 0),this._userId=i,this._uintId=n,this.store=r}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,_.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Ta=(vg=Y({argsMap:(t,e,i)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),Cg=Y({argsMap:t=>[t.getTrackId()]}),yg=Y({argsMap:(t,e)=>[t.getTrackId(),e.name]}),Ag=Y({argsMap:t=>[t.getTrackId()]}),w((Oi=class extends kg{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==ge.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,i,n){super(t,e,i,n),h(this,"_videoVisibleTimer",null),h(this,"_previousVideoVisibleStatus",void 0),h(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),h(this,"trackMediaType","video"),h(this,"_videoWidth",void 0),h(this,"_videoHeight",void 0),h(this,"_player",void 0),h(this,"processorDestination",void 0),h(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new sm(this.getTrackId(),"remote"),this.processorDestination=new om(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return yo(()=>{_.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),on(this,J.GET_STATS)||ga({},C_)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const n=document.getElementById(t);n?t=n:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const i=ga(ga({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new Ru(i):this._player=new jf(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.emit(jr.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const n=this.getVideoElementVisibleStatus();this.emit(jr.VIDEO_ELEMENT_VISIBLE_STATUS,n)}catch{}},C("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){ef(this._originMediaStreamTrack).then(t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e}).catch(oa)}_updatePlayerSource(){_.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const i=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),n={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:r,slot:o}=n;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const s=TS.checkOneElementVisible(r),a=Object.assign({},s);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;const c=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(i){throw new I(f.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new I(f.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Ie.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Ie.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}).prototype,"play",[vg],Object.getOwnPropertyDescriptor(Oi.prototype,"play"),Oi.prototype),w(Oi.prototype,"stop",[Cg],Object.getOwnPropertyDescriptor(Oi.prototype,"stop"),Oi.prototype),w(Oi.prototype,"pipe",[yg],Object.getOwnPropertyDescriptor(Oi.prototype,"pipe"),Oi.prototype),w(Oi.prototype,"unpipe",[Ag],Object.getOwnPropertyDescriptor(Oi.prototype,"unpipe"),Oi.prototype),Oi),Ra=(Og=Y({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),bg=Y({argsMap:(t,e)=>[t.getTrackId(),e]}),wg=Y({argsMap:t=>[t.getTrackId()]}),Ng=Y({argsMap:t=>[t.getTrackId()]}),Dg=Y({argsMap:(t,e)=>[t.getTrackId(),e.name]}),Pg=Y({argsMap:t=>[t.getTrackId()]}),w((Ne=class extends kg{get isPlaying(){return this._useAudioElement?ii.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,i,n){super(t,e,i,n),h(this,"trackMediaType","audio"),h(this,"_source",void 0),h(this,"_useAudioElement",!0),h(this,"_volume",100),h(this,"processorContext",void 0),h(this,"processorDestination",void 0),h(this,"_played",!1),h(this,"_bypassWebAudio",!1),C("DISABLE_WEBAUDIO")?(this._source=new su,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new nu(t,!0),C("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Xe.RECEIVE_TRACK_BUFFER,()=>{this.emit(jr.FIRST_FRAME_DECODED)}),this.processorContext=new cm(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new am(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Xe.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Xe.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Xe.ON_AUDIO_BUFFER),this._source.on(Xe.ON_AUDIO_BUFFER,i=>t(i))}setVolume(t){this._volume=t,this._useAudioElement?ii.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement)throw new I(f.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ii.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return yo(()=>{_.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),on(this,J.GET_STATS)||ga({},v_)}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] use audio element to play")),ii.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?ii.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ii.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new I(f.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new I(f.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new I(f.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Ie.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(Ie.ON_NODE,t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Ie.ON_TRACK),this.processorDestination.removeAllListeners(Ie.ON_NODE)}}).prototype,"setVolume",[Og],Object.getOwnPropertyDescriptor(Ne.prototype,"setVolume"),Ne.prototype),w(Ne.prototype,"setPlaybackDevice",[bg],Object.getOwnPropertyDescriptor(Ne.prototype,"setPlaybackDevice"),Ne.prototype),w(Ne.prototype,"play",[wg],Object.getOwnPropertyDescriptor(Ne.prototype,"play"),Ne.prototype),w(Ne.prototype,"stop",[Ng],Object.getOwnPropertyDescriptor(Ne.prototype,"stop"),Ne.prototype),w(Ne.prototype,"pipe",[Dg],Object.getOwnPropertyDescriptor(Ne.prototype,"pipe"),Ne.prototype),w(Ne.prototype,"unpipe",[Pg],Object.getOwnPropertyDescriptor(Ne.prototype,"unpipe"),Ne.prototype),Ne);function Mg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Ug(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Mg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Mg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class Z0 extends Gt{constructor(){super(),h(this,"uplinkStatsUploadInterval",void 0),h(this,"uplinkStatsUploadSlowInterval",void 0),h(this,"uplinkRelatedStatsUploadInterval",void 0),h(this,"uplinkDenoiserStatsUploadInterval",void 0),h(this,"transportStatsUploadInterval",void 0),h(this,"uplinkExtensionStatsUploadInterval",void 0),h(this,"downlinkExtensionStatsUploadInterval",void 0),h(this,"extensionUsageStatsUploadInterval",void 0),h(this,"downlinkStatsUploadInterval",void 0),h(this,"downlinkStatsUploadSlowInterval",void 0),h(this,"downlinkRelatedStatsUploadInterval",void 0),h(this,"lastStats",void 0),h(this,"uploadUnplinkStarted",!1),h(this,"uploadDownlinkStarted",!1),h(this,"uploadTransportStarted",!1),h(this,"uploadExtensionUsageStarted",!1),h(this,"requestStats",void 0),h(this,"requestLocalMedia",void 0),h(this,"requestRemoteMedia",void 0),h(this,"requestAllTracks",void 0),h(this,"requestVideoIsReady",void 0),h(this,"requestUpload",void 0)}startUploadTransportStats(){this.uploadTransportStarted||(this.uploadTransportStarted=!0,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=window.setInterval(()=>{var e;const i=(e=this.requestStats)===null||e===void 0?void 0:e.call(this);i&&this.uploadTransportStats(i)},1e3))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval);const e=new Map;this.extensionUsageStatsUploadInterval=window.setInterval(async()=>{var i,n,r;const o=Date.now(),s={connectionInterval:C("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:o};let a=[];const c=((i=this.requestAllTracks)===null||i===void 0?void 0:i.call(this))||[];for(const E of c)!E.muted&&E.enabled&&(a=a.concat(await E.getProcessorUsage()));const d=((n=this.requestRemoteMedia)===null||n===void 0?void 0:n.call(this))||[];for(const[E,m]of d)m.has(Z.VIDEO)&&E.videoTrack&&(a=a.concat(await E.videoTrack.getProcessorUsage())),m.has(Z.AUDIO)&&E.audioTrack&&(a=a.concat(await E.audioTrack.getProcessorUsage()));if(a.length===0)return;s.details=function(E,m){const T={};for(const{id:A,value:P,level:H,direction:k}of E){var g;const M=(g=m.get(A))!==null&&g!==void 0?g:0,D=P===2?M+C("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:M;var R,y;m.set(A,D),T[A]?(P===2&&(T[A].value=P),H>T[A].level&&(T[A].level=H),k==="remote"&&(T[A].remoteUidCount+=1),T[A].totalTs=(R=m.get(A))!==null&&R!==void 0?R:0):T[A]={value:P,level:H,remoteUidCount:k==="local"?0:1,totalTs:(y=m.get(A))!==null&&y!==void 0?y:0}}return Object.keys(T).map(A=>{const{level:P,value:H,totalTs:k}=T[A];return{id:A,level:P,value:H,totalTs:k}})}(a,e);const u=Date.now(),l=u>o?u:o+1;(r=this.requestUpload)===null||r===void 0||r.call(this,Je.EXTENSION_USAGE_STATS,{usageStats:s,sendTs:l})},C("EXTENSION_USAGE_UPLOAD_INTERVAL"))}startUploadUplinkStats(){this.uploadUnplinkStarted||(this.uploadUnplinkStarted=!0,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkStatsUploadInterval=window.setInterval(()=>{var e;const i=(e=this.requestStats)===null||e===void 0?void 0:e.call(this);i&&(this.uploadUplinkStats(i),this.lastStats=i)},3e3),this.uplinkStatsUploadSlowInterval&&window.clearInterval(this.uplinkStatsUploadSlowInterval),this.uplinkStatsUploadSlowInterval=window.setInterval(()=>{var e;const i=(e=this.requestStats)===null||e===void 0?void 0:e.call(this);i&&this.uploadSlowUplinkStats(i)},6e4),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkRelatedStatsUploadInterval=window.setInterval(()=>{var e;const i=(e=this.requestStats)===null||e===void 0?void 0:e.call(this);i&&this.uploadRelatedUplinkStats(i,this.lastStats),this.lastStats=i},1e3),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval=window.setInterval(()=>{var e;const i=(e=this.requestAllTracks)===null||e===void 0?void 0:e.call(this);i&&this.uploadDenoiserStats(i)},2e3),this.uplinkExtensionStatsUploadInterval&&window.clearInterval(this.uplinkExtensionStatsUploadInterval),this.uplinkExtensionStatsUploadInterval=window.setInterval(()=>{var e;const i=(e=this.requestAllTracks)===null||e===void 0?void 0:e.call(this);i&&this.uploadExtensionStats(i)},2e3))}uploadTransportStats(e){Ui(()=>{var i;(i=this.requestUpload)===null||i===void 0||i.call(this,Je.TRANSPORT_STATS,function(n){const r={connectionType:100,googRtt:n.rtt};if(n.selectedCandidatePair.localCandidate.candidateType==="relay"){const o=n.selectedCandidatePair.localCandidate.relayProtocol;o==="udp"&&(r.connectionType=101),o==="tcp"&&(r.connectionType=103),o==="tls"&&(r.connectionType=104)}return r}(e))})}uploadUplinkStats(e){var i;(((i=this.requestLocalMedia)===null||i===void 0?void 0:i.call(this))||[]).forEach(n=>{let[r,{track:o,ssrcs:s}]=n;switch(r){case F.LocalVideoLowTrack:case F.LocalVideoTrack:{const a=function(u,l,E){var m;const T=l.videoSend.find(R=>R.ssrc===u);if(!T)return null;const g={id:Lt(10,""),timestamp:new Date(l.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:T.ssrc.toString()};switch(g.A_vstd=E._originMediaStreamTrack&&!E._originMediaStreamTrack.enabled||E._mediaStreamTrack&&!E._mediaStreamTrack.enabled?"1":"0",T.sentFrame&&(g.A_fhs=T.sentFrame.height.toString(),g.A_frs=T.sentFrame.frameRate.toString(),g.A_fws=T.sentFrame.width.toString()),T.adaptionChangeReason){case"none":g.A_ac="0";break;case"cpu":g.A_ac="1";break;case"bandwidth":g.A_ac="2";break;case"other":g.A_ac="3"}return g.A_lvps=Vd[E._player?E._player.videoElementStatus:"uninit"].toString(),g.A_nr=(m=T.nacksCount)===null||m===void 0?void 0:m.toString(),T.avgEncodeMs&&(g.A_aem=T.avgEncodeMs.toFixed(0).toString()),g}(s[0].ssrcId,e,o),c=r===F.LocalVideoTrack?Zm(s[0].ssrcId,e,o):null;a&&Ui(()=>{var u;return(u=this.requestUpload)===null||u===void 0?void 0:u.call(this,Je.PUBLISH_STATS,{stream_type:r===F.LocalVideoLowTrack?"low":"high",stats:Ug(Ug({},a),c)})});const d=function(u){const l={id:"bweforvideo",timestamp:new Date(u.timestamp).toISOString(),type:"VideoBwe"};return u.bitrate.retransmit&&(l.A_rb=u.bitrate.retransmit.toString()),u.bitrate.targetEncoded&&(l.A_teb=u.bitrate.targetEncoded.toString()),l.A_aeb=u.bitrate.actualEncoded.toString(),l.A_tb=u.bitrate.transmit.toString(),u.sendBandwidth!==void 0&&(l.A_asb=u.sendBandwidth.toString()),l}(e);d&&setTimeout(()=>{var u;return(u=this.requestUpload)===null||u===void 0?void 0:u.call(this,Je.PUBLISH_STATS,{stream_type:r===F.LocalVideoLowTrack?"low":"high",stats:d})},1e3);break}case F.LocalAudioTrack:{const a=function(c,d,u){const l=d.audioSend.find(m=>m.ssrc===c);if(!l)return null;const E={id:Lt(10,""),timestamp:new Date(d.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:l.ssrc.toString()};return E.A_astd=u._originMediaStreamTrack.enabled&&u._mediaStreamTrack.enabled?"0":"1",l.inputLevel?E.A_ail=Math.round(100*l.inputLevel).toString():E.A_ail=Math.round(100*u._source.getAccurateVolumeLevel()).toString(),E.A_apil=Math.round(100*u._source.getAccurateVolumeLevel()).toString(),l.aecReturnLoss&&(E.A_ecrl=Math.round(l.aecReturnLoss).toString()),l.aecReturnLossEnhancement&&(E.A_ecrle=Math.round(l.aecReturnLossEnhancement).toString()),E}(s[0].ssrcId,e,o);a&&Ui(()=>{var c;return(c=this.requestUpload)===null||c===void 0?void 0:c.call(this,Je.PUBLISH_STATS,{stream_type:"high",stats:a})});break}}})}uploadSlowUplinkStats(e){var i;(((i=this.requestLocalMedia)===null||i===void 0?void 0:i.call(this))||[]).filter(n=>{let[r]=n;return r===F.LocalVideoLowTrack||r===F.LocalVideoTrack}).forEach(n=>{let[r,{ssrcs:o}]=n;const s=Zm(o[0].ssrcId,e);s&&Ui(()=>{var a;return(a=this.requestUpload)===null||a===void 0?void 0:a.call(this,Je.PUBLISH_STATS,{stream_type:r===F.LocalVideoLowTrack?"low":"high",stats:s})})})}uploadRelatedUplinkStats(e,i){var n;(((n=this.requestLocalMedia)===null||n===void 0?void 0:n.call(this))||[]).filter(r=>{let[o]=r;return o===F.LocalVideoLowTrack||o===F.LocalVideoTrack}).forEach(r=>{let[o,{ssrcs:s}]=r;const a=function(c,d){const u=d.videoSend.find(l=>l.ssrc===c);return u?{mediaType:"video",isVideoMute:!1,frameRateInput:u.inputFrame&&u.inputFrame.frameRate.toString(),frameRateSent:u.sentFrame&&u.sentFrame.frameRate.toString(),googRtt:u.rttMs.toString(),qpSumPerFrame:Math.floor(u.qpSumPerFrame).toString()}:null}(s[0].ssrcId,e);a&&Ui(()=>{var c;(c=this.requestUpload)===null||c===void 0||c.call(this,Je.PUBLISH_RELATED_STATS,{stream_type:o===F.LocalVideoLowTrack?"low":"high",stats:a})})})}uploadDenoiserStats(e){for(let o=0;o<e.length;o++){const s=e[o];if(s instanceof ea){var i,n,r;const a=(i=(n=s._external).getDenoiserStats)===null||i===void 0?void 0:i.call(n);return void(a&&((r=this.requestUpload)===null||r===void 0||r.call(this,Je.DENOISER_STATS,a)))}}}uploadExtensionStats(e){for(let i=0;i<e.length;i++)e[i].getProcessorStats().forEach(n=>{var r;(r=this.requestUpload)===null||r===void 0||r.call(this,n.type,n.stats)})}stopUploadUplinkStats(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0)}startUploadDownlinkStats(){if(this.uploadDownlinkStarted)return;let e;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let i=!1;this.downlinkStatsUploadInterval=window.setInterval(()=>{var n;const r=(n=this.requestStats)===null||n===void 0?void 0:n.call(this);r&&(this.uploadDownlinkStats(r,i,e),e=r),i=!i},3e3),this.downlinkStatsUploadSlowInterval&&window.clearInterval(this.downlinkStatsUploadSlowInterval),this.downlinkStatsUploadSlowInterval=window.setInterval(()=>{var n;const r=(n=this.requestStats)===null||n===void 0?void 0:n.call(this);r&&this.uploadSlowDownlinkStats(r)},6e4),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkRelatedStatsUploadInterval=window.setInterval(()=>{var n;const r=(n=this.requestStats)===null||n===void 0?void 0:n.call(this);r&&(this.uploadRelatedDownlinkStats(r,this.lastStats),this.lastStats=r)},1e3),this.downlinkExtensionStatsUploadInterval&&window.clearInterval(this.downlinkExtensionStatsUploadInterval),this.downlinkExtensionStatsUploadInterval=window.setInterval(()=>{var n;const r=(n=this.requestRemoteMedia)===null||n===void 0?void 0:n.call(this);r&&this.uploadDownlinkExtensionStats(r)},2e3)}uploadDownlinkStats(e,i,n){var r;(((r=this.requestRemoteMedia)===null||r===void 0?void 0:r.call(this))||[]).forEach(o=>{let[s,a]=o;if(a.has(Z.VIDEO)&&s.videoTrack){const c=s.videoTrack?function(d,u,l,E,m){const T=u.videoRecv.find(A=>A.ssrc===d);if(!T)return null;const g={id:Lt(10,""),timestamp:new Date(u.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:T.ssrc.toString()};var R,y;if(g.bytesReceived=T.bytes.toString(),g.packetsLost=T.packetsLost.toString(),g.packetsReceived=T.packets.toString(),T.framesRateFirefox&&(g.A_frr=T.framesRateFirefox.toString()),T.receivedFrame?(g.A_frr=T.receivedFrame.frameRate.toString(),g.A_fhr=T.receivedFrame.height.toString(),g.A_fwr=T.receivedFrame.width.toString()):(g.A_fhr=(R=E._videoHeight)===null||R===void 0?void 0:R.toString(),g.A_fwr=(y=E._videoWidth)===null||y===void 0?void 0:y.toString()),g.A_frd=T.decodeFrameRate.toString(),T.outputFrame&&(g.A_fro=T.outputFrame.frameRate.toString()),T.jitterBufferMs!==void 0&&(g.A_jbm=Math.floor(T.jitterBufferMs).toString()),T.currentDelayMs!==void 0&&(g.A_cdm=Math.floor(T.currentDelayMs).toString()),g.A_fs=T.firsCount.toString(),g.A_ns=T.nacksCount.toString(),g.A_ps=T.plisCount.toString(),E&&(g.A_vrtd=E._originMediaStreamTrack.enabled&&E._mediaStreamTrack.enabled?"0":"1"),E._player&&E._player.freezeTimeCounterList.length>0&&(g.A_vrft=Math.round(E._player.freezeTimeCounterList.splice(0,1)[0]).toString()),m&&E._player&&fn.visibility==="visible"){const A=Math.min(6e3,E._player.renderFreezeAccTime);g.A_vrrft=Math.round(A).toString(),E._player.renderFreezeAccTime=Math.max(0,E._player.renderFreezeAccTime-A)}if(g.A_rvps=Vd[E._player?E._player.videoElementStatus:"uninit"].toString(),l){const A=l.videoRecv.find(P=>P.ssrc===d);if(A&&T.totalInterFrameDelay!==void 0&&T.totalSquaredInterFrameDelay!==void 0&&A.totalInterFrameDelay!==void 0&&A.totalSquaredInterFrameDelay!==void 0){const P=T.totalInterFrameDelay-A.totalInterFrameDelay,H=T.totalSquaredInterFrameDelay-A.totalSquaredInterFrameDelay,k=T.framesDecodeCount-A.framesDecodeCount,M=P/k*1e3,D=Math.round(1e3*Math.sqrt((H-Math.pow(P,2)/k)/k));!isNaN(D)&&M+D>Math.max(3*M,M+150)&&(g.A_ifdsd=D.toString())}}return g}(s._videoSSRC,e,n,s.videoTrack,i):void 0;c&&Ui(()=>{var d;return(d=this.requestUpload)===null||d===void 0?void 0:d.call(this,Je.SUBSCRIBE_STATS,{stream_id:s.uid,stats:c})})}if(a.has(Z.AUDIO)&&s.audioTrack){const c=s.audioTrack?function(d,u,l,E){const m=u.audioRecv.find(g=>g.ssrc===d);if(!m)return null;const T={id:Lt(10,""),timestamp:new Date(u.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:m.ssrc.toString()};if(T.bytesReceived=m.bytes.toString(),T.packetsLost=m.packetsLost.toString(),T.packetsReceived=m.packets.toString(),m.outputLevel?T.A_aol=Math.round(100*m.outputLevel).toString():T.A_aol=Math.round(100*E._source.getAccurateVolumeLevel()).toString(),T.A_apol=Math.round(100*E._source.getAccurateVolumeLevel()).toString(),E&&(T.A_artd=E._originMediaStreamTrack.enabled&&E._mediaStreamTrack.enabled?"0":"1"),T.A_jr=m.jitterMs.toString(),T.A_jbm=Math.floor(m.jitterBufferMs).toString(),T.A_cdm=Math.floor(m.jitterBufferMs).toString(),T.A_raps=Vd[ii.getPlayerState(E.getTrackId())].toString(),l){const g=l.audioRecv.find(R=>R.ssrc===d);if(g){const R=m.concealedSamples-g.concealedSamples;R>0&&(T.A_cs=Math.round(R).toString())}}return T}(s._audioSSRC,e,n,s.audioTrack):void 0;c&&Ui(()=>{var d;return(d=this.requestUpload)===null||d===void 0?void 0:d.call(this,Je.SUBSCRIBE_STATS,{stream_id:s.uid,stats:c})})}})}uploadSlowDownlinkStats(e){}uploadRelatedDownlinkStats(e,i){var n;(((n=this.requestRemoteMedia)===null||n===void 0?void 0:n.call(this))||[]).forEach(r=>{let[o,s]=r;if(s.has(Z.VIDEO)&&o.videoTrack){var a;const c=(o._videoSSRC&&((a=this.requestVideoIsReady)===null||a===void 0?void 0:a.call(this,o._videoSSRC))||!1)===!0,d=function(u,l,E,m,T,g){const R=E.videoRecv.find(H=>H.ssrc===u),y=T?T.videoRecv.find(H=>H.ssrc===u):void 0;if(!R)return null;const A=Kr.isRemoteVideoFreeze(g,R,y)&&l,P={mediaType:"video",isVideoMute:!1,peerId:m,frameRateReceived:R.receivedFrame&&R.receivedFrame.frameRate.toString(),frameRateDecoded:R.decodedFrame&&R.decodedFrame.frameRate.toString(),isFreeze:A,bytesReceived:R.bytes.toString(),packetsReceived:R.packets.toString(),packetsLost:R.packetsLost.toString(),qpSumPerFrame:Math.floor(R.qpSumPerFrame).toString()};return R.framesRateFirefox&&(P.frameRateDecoded=R.framesRateFirefox.toString(),P.frameRateReceived=R.framesRateFirefox.toString()),P}(o._videoSSRC,c,e,o.uid,i,o.videoTrack);d&&Ui(()=>{var u;(u=this.requestUpload)===null||u===void 0||u.call(this,Je.SUBSCRIBE_RELATED_STATS,{stream_id:o.uid,stats:d})})}if(s.has(Z.AUDIO)&&o.audioTrack){const c=function(d,u,l,E){const m=u.audioRecv.find(g=>g.ssrc===d);if(!m)return null;const T=Kr.isRemoteAudioFreeze(E);return{mediaType:"audio",isAudioMute:!1,peerId:l,googJitterReceived:m.jitterMs.toString(),isFreeze:T,bytesReceived:m.bytes.toString(),packetsReceived:m.packets.toString(),packetsLost:m.packetsLost.toString(),frameReceived:m.receivedFrames.toString(),frameDropped:m.droppedFrames.toString()}}(o._audioSSRC,e,o.uid,o.audioTrack);c&&Ui(()=>{var d;(d=this.requestUpload)===null||d===void 0||d.call(this,Je.SUBSCRIBE_RELATED_STATS,{stream_id:o.uid,stats:c})})}})}stopUploadDownlinkStats(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0)}stopUploadTransportStats(){this.uploadTransportStarted&&(this.uploadTransportStarted=!1,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=void 0)}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval),this.extensionUsageStatsUploadInterval=void 0)}uploadDownlinkExtensionStats(e){e.forEach(i=>{let[n,r]=i;r.has(Z.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(o=>{var s;(s=this.requestUpload)===null||s===void 0||s.call(this,o.type,o.stats)}),r.has(Z.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(o=>{var s;(s=this.requestUpload)===null||s===void 0||s.call(this,o.type,o.stats)})})}}const xg=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,Ia="9",qu=2e4,Ju=4e4;class $0{get localCapabilities(){return Xt(this._localCapabilities)}get rtpCapabilities(){return Xt(this._rtpCapabilities)}get candidates(){return Xt(this._candidates)}get iceParameters(){return Xt(this._iceParameters)}get dtlsParameters(){return Xt(this._dtlsParameters)}constructor(e){h(this,"sessionDesc",void 0),h(this,"_localCapabilities",void 0),h(this,"_rtpCapabilities",void 0),h(this,"_candidates",void 0),h(this,"_iceParameters",void 0),h(this,"_dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),h(this,"firefoxSsrcMidMap",new Map),e=Xt(e);const{remoteIceParameters:i,remoteDtlsParameters:n,candidates:r,remoteRTPCapabilities:o,remoteSetup:s,localCapabilities:a,cname:c}=e,d=Qt.exports.parse(xg);this._rtpCapabilities=o,this._candidates=r,this._iceParameters=i,this._dtlsParameters=n,this._localCapabilities=a,this.setup=s,this.cname=c;const u=this.rtpCapabilities.send;for(const l of d.mediaDescriptions){if(l.attributes.iceUfrag=i.iceUfrag,l.attributes.icePwd=i.icePwd,l.attributes.fingerprints=n.fingerprints,l.attributes.candidates=r,l.attributes.setup=s,l.media.mediaType==="application"&&(l.attributes.sctpPort="5000"),l.media.mediaType==="video"&&(l.media.fmts=u.videoCodecs.map(E=>E.payloadType.toString(10)),l.attributes.payloads=u.videoCodecs,l.attributes.extmaps=u.videoExtensions,C("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:E,ssrcGroups:m}=Ci([{ssrcId:Ju,rtx:C("USE_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=E,l.attributes.ssrcGroups=m}if(l.media.mediaType==="audio"&&(l.media.fmts=u.audioCodecs.map(E=>E.payloadType.toString(10)),l.attributes.payloads=u.audioCodecs,l.attributes.extmaps=u.audioExtensions,Fn(l),C("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:E,ssrcGroups:m}=Ci([{ssrcId:qu}],this.cname);l.attributes.ssrcs=E,l.attributes.ssrcGroups=m}}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const i=Qt.exports.parse(xg);this._rtpCapabilities=e;const n=this.rtpCapabilities.send;for(const r of i.mediaDescriptions){if(r.attributes.iceUfrag=this._iceParameters.iceUfrag,r.attributes.icePwd=this._iceParameters.icePwd,r.attributes.fingerprints=this._dtlsParameters.fingerprints,r.attributes.candidates=this._candidates,r.attributes.setup=this.setup,r.media.mediaType==="application"&&(r.attributes.sctpPort="5000"),r.media.mediaType==="video"&&(r.media.fmts=n.videoCodecs.map(o=>o.payloadType.toString(10)),r.attributes.payloads=n.videoCodecs,r.attributes.extmaps=n.videoExtensions,C("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:o,ssrcGroups:s}=Ci([{ssrcId:Ju,rtx:C("USE_RTX")?40001:void 0}],this.cname);r.attributes.ssrcs=o,r.attributes.ssrcGroups=s}if(r.media.mediaType==="audio"&&(r.media.fmts=n.audioCodecs.map(o=>o.payloadType.toString(10)),r.attributes.payloads=n.audioCodecs,r.attributes.extmaps=n.audioExtensions,C("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:o,ssrcGroups:s}=Ci([{ssrcId:qu}],this.cname);r.attributes.ssrcs=o,r.attributes.ssrcGroups=s}}this.sessionDesc=i,this.currentMidIndex=i.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const i=this.candidates,n=this.dtlsParameters,r=this.iceParameters,o=this.rtpCapabilities.send;for(let s=1;s<e;s++){const a=2*s+qu,c=2*s+Ju,{ssrcs:d,ssrcGroups:u}=Ci([{ssrcId:a}],this.cname),{ssrcs:l,ssrcGroups:E}=Ci([{ssrcId:c,rtx:C("USE_RTX")?c+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Ia,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.videoCodecs.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:i,extmaps:o.videoExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:E,rtcpFeedbackWildcards:[],payloads:o.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Ia,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.audioCodecs.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:i,extmaps:o.audioExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:u,rtcpFeedbackWildcards:[],payloads:o.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Qt.exports.print(this.sessionDesc)}send(e,i,n,r){const{ssrcs:o,ssrcGroups:s}=Ci(i,this.cname,C("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(Bt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,o);let d;return c===-1||Le()||ke()||SE()?(d=this.createOrRecycleSendMedia(e,o,s,"sendonly",r),this.updateBundleMids()):(d=Xt(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Bt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const i=e.map(o=>{let{kind:s,ssrcMsg:a,mslabel:c}=o;return this.send(s,a,c)}),n=[];let r=!1;return i.forEach(o=>{let{mid:s,needExchangeSDP:a}=o;a&&(r=!0),n.push(s)}),{mids:n,needExchangeSDP:r}}stopSending(e){const i=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1);if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");i.forEach(n=>{n.attributes.mid==="0"||Bt()||Le()||ke()?n.attributes.ssrcs=[]:(n.attributes.ssrcs=[],n.attributes.direction="inactive",n.media.port="0")}),this.updateBundleMids()}mute(e){const i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(e){const i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}muteRemote(e){const i=this.sessionDesc.mediaDescriptions.filter(n=>e.includes(n.attributes.mid||""));if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(e){const i=this.sessionDesc.mediaDescriptions.filter(n=>e.includes(n.attributes.mid||""));if(i.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(n=>{n.attributes.direction="recvonly"})}receive(e,i,n,r){e.forEach((o,s)=>{this.createOrRecycleRecvMedia(o,[],"recvonly",i,n,r[s])}),this.updateBundleMids()}stopReceiving(e){const i=this.sessionDesc.mediaDescriptions.filter(n=>e.indexOf(n.attributes.mid)!==-1);if(i.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");i.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}restartICE(e){e=Xt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=e.iceUfrag,i.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const i=[];for(let n=0;n<e;n++)i.push((this.currentMidIndex+n+1).toString(10));return i}findAvailableMediaIndex(e,i){return this.sessionDesc.mediaDescriptions.findIndex(n=>{const r=n.media.mediaType===e&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(Bt()){if(r){const o=this.firefoxSsrcMidMap.get(i[0].ssrcId);return!(o||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!o||o!==n.attributes.mid)}return!1}return r})}createOrRecycleRecvMedia(e,i,n,r,o,s){const a=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=this.localCapabilities.send;let u=[];if(a===Z.VIDEO){var l,E;if(C("H264_PROFILE_LEVEL_ID")&&r==="h264"&&(u=c.videoCodecs.filter(y=>{var A,P;return(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"").includes(r)&&(y==null||(P=y.fmtp)===null||P===void 0?void 0:P.parameters["profile-level-id"])===C("H264_PROFILE_LEVEL_ID")})),!u||((l=u)===null||l===void 0?void 0:l.length)===0){const y=d.videoCodecs.filter(A=>{var P;return(((P=A.rtpMap)===null||P===void 0?void 0:P.encodingName.toLowerCase())||"").includes(r)});y.length!==0&&(u=c.videoCodecs.filter(A=>y.some(P=>P.payloadType===A.payloadType)))}if(C("USE_RTX")){const y=u.map(P=>P.payloadType.toString()),A=c.videoCodecs.filter(P=>{var H,k;return((H=P.rtpMap)===null||H===void 0?void 0:H.encodingName)==="rtx"&&y.includes(((k=P.fmtp)===null||k===void 0?void 0:k.parameters.apt)||"")});u=[...u,...A]}u.length===0&&(_.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat((E=c.videoCodecs[0].rtpMap)===null||E===void 0?void 0:E.encodingName)),u=c.videoCodecs)}else u=c.audioCodecs.filter(y=>{var A;return(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"").includes(o)}),u.length===0&&(_.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),u=c.audioCodecs.filter(y=>{var A;return(((A=y.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"").includes("opus")}));const m=a===Z.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const T="".concat(this.currentMidIndex);let g={media:{mediaType:a,port:Ia,protos:["UDP","TLS","RTP","SAVPF"],fmts:u.map(y=>y.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:m,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:u,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(T)}};g=this.mungRecvMediaDsec(g,e,s);const R=this.findFirstClosedMedia(a);if(R){const y=this.sessionDesc.mediaDescriptions.indexOf(R);this.sessionDesc.mediaDescriptions[y]=g}else this.sessionDesc.mediaDescriptions.push(g);return g}createOrRecycleSendMedia(e,i,n,r,o){const s=this.rtpCapabilities.send,a=e===Z.VIDEO?s.videoCodecs:s.audioCodecs,c=e===Z.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let u={media:{mediaType:e,port:Ia,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(E=>E.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungSendMediaDesc(u,o);const l=this.findFirstClosedMedia(e);if(l){const E=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[E]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,i,n){const r=Xt(e);return Bu(r),Zr(r,i),Gu(r,i),og(r),ma(r,n,this.localCapabilities.send),r}mungSendMediaDesc(e,i){const n=Xt(e);return ma(n,i,this.localCapabilities.recv),Fn(n),n}updateRecvMedia(e,i){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(n!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],i);this.sessionDesc.mediaDescriptions[n]=r}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(i=>Bt()?i.media.port==="0"&&i.media.mediaType===e:i.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(i=>{var n,r;return((n=i.attributes)===null||n===void 0||(r=n.ssrcs[0])===null||r===void 0?void 0:r.ssrcId)===e[0].ssrcId})}getSSRC(e){var i;return(i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e))===null||i===void 0?void 0:i.attributes.ssrcs}}var ft;function Vg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function va(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Vg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Vg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let tD=(w((ft=class ba extends Xs{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,i,n){super(e,i),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"transportEventReceiver",void 0),h(this,"statsFilter",void 0),h(this,"useRTX",C("USE_RTX")),h(this,"localCapabilities",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"establishPromise",void 0),h(this,"mutex",new Ve("NVExtentionsConnection-mutex")),h(this,"rtcMedia",void 0),this.store=i,this.peerConnection=n,this.statsFilter=Yu(this.peerConnection,void 0,void 0,Bt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=_r(i.sdp),r=await ag(!this.useRTX,C("FILTER_VIDEO_FEC"),C("FILTER_AUDIO_FEC"));return this.localCapabilities=r,this.initialOffer=i,va(va({},n),{},{rtpCapabilities:r,offerSDP:i.sdp})}catch(i){throw new I(f.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(e,i,n,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new $0({remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:Wu(this.localCapabilities),cname:s});const a=this.remoteSDP.toString(),c=Qt.exports.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(E=>E.media.mediaType==="audio");d&&Fn(d);const u=Qt.exports.print(c),l=this.logSDPExchange(u||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:u}),l==null||l(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new I(f.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(a.toString()))}}async updateRemoteConnect(e){var i,n,r;(i=this.remoteSDP)===null||i===void 0||i.updateRemoteRTPCapabilities(e),(n=this.remoteSDP)===null||n===void 0||n.preloadRemoteMedia(2);const o=(r=this.remoteSDP)===null||r===void 0?void 0:r.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),_.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,i,n){var r=this;return xi(function*(){const o=yield rt(r.mutex.lock("From NVExtentionsConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const s=[];e.forEach(g=>{const R=r.peerConnection.addTransceiver(g._mediaStreamTrack,{direction:"sendonly"});s.push(R)}),Bt()&&C("SIMULCAST")===!0&&(yield rt(r.applySimulcastForFirefox(s,e)));const a=yield rt(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(e.length),d=r.mungSendOfferSDP(a.sdp,e,c),u=Qt.exports.parse(d),l=c.map(g=>{const R=u.mediaDescriptions.find(y=>y.attributes.mid===g);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return ng(R,r.useRTX)});let E;try{E=yield l}catch(g){E=[],r.remoteSDP.receive(e,i,n,E);const R=r.remoteSDP.toString();throw yield rt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield rt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield rt(r.stopSending(c,!0)),g}r.remoteSDP.receive(e,i,n,E);const m=r.remoteSDP.toString(),T=r.logSDPExchange(d,"offer","local","send");return yield rt(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield rt(r.applySimulcastEncodings(s,e)),yield rt(r.applySendEncodings(s,e)),T==null||T(m),yield rt(r.peerConnection.setRemoteDescription({type:"answer",sdp:m})),s.map((g,R)=>{const y=c[R];return{localSSRC:l[R],id:y,transceiver:g}})}catch(s){throw s instanceof I?s:new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(e,i){const n=i?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();s==null||s(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(r.toString()))}finally{n&&n()}}async receive(e,i,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,i,n,r);if(s){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(u.sdp,o,e);d==null||d(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),_.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else _.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o}}catch(o){throw new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const r=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const s=await this.peerConnection.createAnswer();o==null||o(s.sdp||""),await this.peerConnection.setLocalDescription(s),_.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else _.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return i.map(r=>{const o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r}})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(s=>{s.direction="inactive"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(s,a)=>{s.direction="sendonly"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new I(f.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(){var e=this;return xi(function*(){const i=yield rt(e.mutex.lock("From NVExtentionsConnection.restartICE"));try{const n=yield rt(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const r=_r(n.sdp),{remoteIceParameters:o}=yield r.iceParameters;if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");e.remoteSDP.restartICE(o);const s=e.remoteSDP.toString(),a=e.logSDPExchange(n.sdp||"","offer","local","restartICE");yield rt(e.peerConnection.setLocalDescription(n)),a==null||a(s),yield rt(e.peerConnection.setRemoteDescription({type:"answer",sdp:s}))}catch(n){_.warning("restart ICE failed, abort operation",n)}finally{i()}})()}close(){var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);const o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new I(f.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(e,i){const n=this.peerConnection.getTransceivers().filter(r=>r.mid===e);n.length===1&&(this.isVP8Simulcast(i)?Bt()||await this.applySimulcastEncodings(n,[i]):await this.applySendEncodings(n,[i]))}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const n=this.peerConnection.getTransceivers().find(r=>r.mid===i);n&&await n.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if((e=this.peerConnection.currentLocalDescription)===null||e===void 0||!e.sdp||!this.localCapabilities)throw new Error;return va(va({},_r(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},C("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Io(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...ba.turnServerConfigToIceServers(e.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...ba.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),C("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(n=>{n.security?n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(na(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!C("FORCE_TURN_TCP")&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),i}async applySendEncodings(e,i){try{if(!le().supportSetRtpSenderParameters||e.length!==i.length)return;for(let d=0;d<e.length;d++){const u=e[d],l=i[d];if(l&&l instanceof zt){var n,r;if(this.isVP8Simulcast(l))continue;const E={},m={};switch(l._optimizationMode){case"motion":E.degradationPreference="maintain-framerate";break;case"detail":E.degradationPreference="maintain-resolution";break;default:E.degradationPreference="balanced"}var o,s,a,c;if((n=l._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&(m.maxBitrate=1e3*((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)),l._hints.includes(re.LOW_STREAM)&&((s=l._encoderConfig)!==null&&s!==void 0&&s.frameRate&&(m.maxFramerate=Sn(l._encoderConfig.frameRate)),(a=l._encoderConfig)!==null&&a!==void 0&&a.scaleResolutionDownBy&&((c=l._encoderConfig)===null||c===void 0?void 0:c.scaleResolutionDownBy)>1&&(m.scaleResolutionDownBy=l._encoderConfig.scaleResolutionDownBy)),C("DSCP_TYPE")&&er()){const R=C("DSCP_TYPE");["very-low","low","medium","high"].includes(R)&&(m.networkPriority=R)}const T=u.sender.getParameters(),g=(r=T.encodings)===null||r===void 0?void 0:r[0];Bt()&&!g&&(E.encodings=[m]),g&&Object.assign(g,m),Object.assign(T,E),await u.sender.setParameters(T)}}}catch{_.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,i,n){const r=Qt.exports.parse(e);return i.forEach((o,s)=>{const a=n[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Zr(c,o),sg(c,o,this.store.codec))}),Qt.exports.print(r)}mungReceiveAnswerSDP(e,i,n){const r=Qt.exports.parse(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===i);return o&&n===Z.AUDIO&&o.media.mediaType==="audio"&&Fn(o),Qt.exports.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let a=0;a<e.length;a++){var n,r,o,s;const c=e[a],d=i[a];if(d instanceof zt&&!d._hints.includes(re.LOW_STREAM)&&(n=d._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=d._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=d._scalabiltyMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=d._scalabiltyMode)===null||s===void 0?void 0:s.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},l={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:l.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:l.high}];const E=c.sender.getParameters();await c.sender.setParameters(Object.assign(E,u))}}}async applySimulcastEncodings(e,i){if(!Bt()&&e.length===i.length)for(let n=0;n<e.length;n++){const r=i[n];if(r instanceof zt&&this.isVP8Simulcast(r)){const o=e[n],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var i,n,r,o;return!!(e instanceof zt&&C("SIMULCAST")&&this.store.codec==="vp8"&&!e._hints.includes(re.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((n=e._encoderConfig)===null||n===void 0?void 0:n.bitrateMax)>200&&(r=e._scalabiltyMode)!==null&&r!==void 0&&r.numSpatialLayers&&((o=e._scalabiltyMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,r){if(C("SDP_LOGGING"))return _.upload("exchanging ".concat(n," ").concat(i," SDP during NVExtentionsConnection.").concat(r,`
`),e),i==="offer"?o=>{this.logSDPExchange(o,"answer",n==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(e);return i==null?void 0:i[0].ssrcId}setConfiguration(e){if(le().supportPCSetConfiguration){const i=ba.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"connect"),ft.prototype),w(ft.prototype,"updateRemoteConnect",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"updateRemoteConnect"),ft.prototype),w(ft.prototype,"receive",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"receive"),ft.prototype),w(ft.prototype,"batchReceive",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"batchReceive"),ft.prototype),w(ft.prototype,"stopReceiving",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"stopReceiving"),ft.prototype),w(ft.prototype,"muteRemote",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"muteRemote"),ft.prototype),w(ft.prototype,"unmuteRemote",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"unmuteRemote"),ft.prototype),w(ft.prototype,"muteLocal",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"muteLocal"),ft.prototype),w(ft.prototype,"unmuteLocal",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"unmuteLocal"),ft.prototype),w(ft.prototype,"close",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"close"),ft.prototype),w(ft.prototype,"updateEncoderConfig",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"updateEncoderConfig"),ft.prototype),w(ft.prototype,"updateSendParameters",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"updateSendParameters"),ft.prototype),w(ft.prototype,"replaceTrack",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"replaceTrack"),ft.prototype),w(ft.prototype,"getRemoteSSRC",[Ei],Object.getOwnPropertyDescriptor(ft.prototype,"getRemoteSSRC"),ft.prototype),ft);function Ei(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,o=await r.lock("From NVExtentionsConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{o()}},i}var bt;function Fg(t){var e,i,n,r=2;for(typeof Symbol<"u"&&(i=tg,n=Symbol.iterator);r--;){if(i&&(e=t[i])!=null)return e.call(t);if(n&&(e=t[n])!=null)return new Xu(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Xu(t){function e(i){if(Object(i)!==i)return V.reject(new TypeError(i+" is not an object."));var n=i.done;return V.resolve(i.value).then(function(r){return{value:r,done:n}})}return(Xu=function(i){this.s=i,this.n=i.next}).prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(i){var n=this.s.return;return n===void 0?V.resolve({value:i,done:!0}):e(n.apply(this.s,arguments))},throw:function(i){var n=this.s.return;return n===void 0?V.reject(i):e(n.apply(this.s,arguments))}},new Xu(t)}let jn=(w((bt=class wa extends Xs{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,i){super(e,i),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"cname",void 0),h(this,"mutex",new Ve("DataChannelConnection-mutex")),h(this,"dataChannel",void 0),h(this,"_p2pConnection",void 0),h(this,"establishPromise",void 0),h(this,"_nvMedia",void 0),this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(wa.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new tD(e,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const i=(e=this._nvMedia)===null||e===void 0?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(i)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,i,n,r,o,s){return this.cname=s,await this._p2pConnection.connect(e,i,n,r,o,s),await new V((a,c)=>{const d=setTimeout(()=>{this.closeSignal(),c(new I(f.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(n))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(d),void a()},this.dataChannel.onerror=u=>{this.closeSignal(),c(u)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}send(e,i,n){var r=this;return xi(function*(){const o=yield rt(r.mutex.lock("From DataChannelConnection.send"));try{return yield*xo(Fg(r._p2pConnection.send(e,i,n)),rt)}finally{o()}})()}async stopSending(e,i){return this._p2pConnection.stopSending(e,i)}async receive(e,i,n,r){return this._nvMedia?(_.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,i,this.cname)):(_.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,i,n,r))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(){var e=this;return xi(function*(){return yield*xo(Fg(e._p2pConnection.restartICE()),rt)})()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var i;(i=this._nvMedia)===null||i===void 0||i.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,i){return await this._p2pConnection.updateEncoderConfig(e,i)}async updateSendParameters(e,i){return await this._p2pConnection.updateSendParameters(e,i)}setStatsRemoteVideoIsReady(e,i){this._p2pConnection.setStatsRemoteVideoIsReady(e,i)}async replaceTrack(e,i){return await this._p2pConnection.replaceTrack(e,i)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,i,n,r){if(C("SDP_LOGGING"))return _.upload("exchanging ".concat(n," ").concat(i," SDP during DataChannelConnection.").concat(r,`
`),e),i==="offer"?o=>{this.logSDPExchange(o,"answer",n==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Io(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...wa.turnServerConfigToIceServers(e.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...wa.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),C("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(n=>{n.security?n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(na(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!C("FORCE_TURN_TCP")&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),i}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var i;return(i=this.onICEConnectionStateChange)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var i;return(i=this.onConnectionStateChange)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var i;return(i=this.onDTLSTransportStateChange)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var i;return(i=this.onDTLSTransportError)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var i;return(i=this.onICETransportStateChange)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var i;return(i=this.onFirstAudioReceived)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var i;return(i=this.onFirstVideoReceived)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var i;return(i=this.onFirstAudioDecoded)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,i,n)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,e,i,n)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var i;return(i=this.onFirstVideoDecodedTimeout)===null||i===void 0?void 0:i.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,i)=>{var n;return(n=this.onSelectedLocalCandidateChanged)===null||n===void 0?void 0:n.call(this,e,i)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,i)=>{var n;return(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0?void 0:n.call(this,e,i)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}).prototype,"connect",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"connect"),bt.prototype),w(bt.prototype,"receive",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"receive"),bt.prototype),w(bt.prototype,"stopReceiving",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"stopReceiving"),bt.prototype),w(bt.prototype,"muteRemote",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"muteRemote"),bt.prototype),w(bt.prototype,"unmuteRemote",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"unmuteRemote"),bt.prototype),w(bt.prototype,"muteLocal",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"muteLocal"),bt.prototype),w(bt.prototype,"unmuteLocal",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"unmuteLocal"),bt.prototype),w(bt.prototype,"close",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"close"),bt.prototype),w(bt.prototype,"updateEncoderConfig",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"updateEncoderConfig"),bt.prototype),w(bt.prototype,"updateSendParameters",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"updateSendParameters"),bt.prototype),w(bt.prototype,"replaceTrack",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"replaceTrack"),bt.prototype),w(bt.prototype,"getRemoteSSRC",[Fi],Object.getOwnPropertyDescriptor(bt.prototype,"getRemoteSSRC"),bt.prototype),bt);function Fi(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,o=await r.lock("From DataChannelConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{o()}},i}var ht;function jg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Bn(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?jg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):jg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function zu(t){var e,i,n,r=2;for(typeof Symbol<"u"&&(i=tg,n=Symbol.iterator);r--;){if(i&&(e=t[i])!=null)return e.call(t);if(n&&(e=t[n])!=null)return new Qu(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Qu(t){function e(i){if(Object(i)!==i)return V.reject(new TypeError(i+" is not an object."));var n=i.done;return V.resolve(i.value).then(function(r){return{value:r,done:n}})}return(Qu=function(i){this.s=i,this.n=i.next}).prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(i){var n=this.s.return;return n===void 0?V.resolve({value:i,done:!0}):e(n.apply(this.s,arguments))},throw:function(i){var n=this.s.return;return n===void 0?V.reject(i):e(n.apply(this.s,arguments))}},new Qu(t)}let eD=(w((ht=class extends Gt{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(lt.StateChange,e,this._state)}constructor(t,e){super(),h(this,"store",void 0),h(this,"statsUploader",void 0),h(this,"connection",void 0),h(this,"localTrackMap",new Map),h(this,"remoteUserMap",new Map),h(this,"pendingLocalTracks",[]),h(this,"pendingRemoteTracks",[]),h(this,"statsCollector",void 0),h(this,"isPlanB",!1),h(this,"shouldForwardP2PCreation",void 0),h(this,"iceFailedCount",0),h(this,"dtlsFailedCount",0),h(this,"mutex",new Ve("P2PChannel-mutex")),h(this,"_state",oe.Disconnected),h(this,"handleMuteLocalTrack",async(i,n,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==oe.Connected)return void r(new I(f.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(i);if(s.length===0)return void n();const a=s.find(d=>d[0]==="videoLowTrack");a&&a[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(s.map(d=>{let[,{id:u}]=d;return u}));const c=this.createMuteMessage(s);await Vt(this,lt.RequestMuteLocal,c),n()}catch(s){r(s)}finally{o()}}),h(this,"handleUnmuteLocalTrack",async(i,n,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==oe.Connected)return void r(new I(f.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(i);if(s.length===0)return void n();const a=s.find(d=>d[0]==="videoLowTrack");if(a){const d=a[1];if(d.track._originMediaStreamTrack.stop(),le().supportDualStreamEncoding){const u=i._mediaStreamTrack.clone();d.track._mediaStreamTrack=u,d.track._originMediaStreamTrack=u}else{const u=Ig(i,hr(this,lt.RequestLowStreamParameter));d.track._mediaStreamTrack=u,d.track._originMediaStreamTrack=u}await new V((u,l)=>{this.handleReplaceTrack(d.track,u,l,!0)})}await this.connection.unmuteLocal(s.map(d=>{let[,{id:u}]=d;return u}));const c=this.createUnmuteMessage(s);await Vt(this,lt.RequestUnmuteLocal,c),n()}catch(s){r(s)}finally{o()}}),h(this,"handleUpdateVideoEncoder",async(i,n,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const s=this.localTrackMap.get(F.LocalVideoTrack);if(!this.connection||!s||s.track!==i||this.state!==oe.Connected)return void n();const{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),await this.connection.updateEncoderConfig(a,c),this.emit(lt.UpdateVideoEncoder,c),n()}catch(s){r(s)}finally{o()}}),h(this,"handleSetOptimizationMode",async(i,n,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const s=this.localTrackMap.get(F.LocalVideoTrack);if(!this.connection||!s||s.track!==i||this.state!==oe.Connected)return;const{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),n()}catch(s){r(s)}finally{o()}}),h(this,"handleReplaceTrack",async(i,n,r,o)=>{let s;_.debug("P2PChannel handleReplaceTrack for [track-id-".concat(i.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:l}]=u;return i===l});if(!this.connection||!d||this.state!==oe.Connected)return void n();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(i,d[1].id)),this.isPlanB){const u=d[1];u.id=i._mediaStreamTrack.id,this.localTrackMap.set(d[0],u)}if(d[0]===F.LocalVideoTrack&&le().supportDualStreamEncoding){const u=this.localTrackMap.get(F.LocalVideoLowTrack);if(u){const l=i._mediaStreamTrack.clone();u.track._originMediaStreamTrack.stop(),u.track._mediaStreamTrack=l,u.track._originMediaStreamTrack=l,await new V((E,m)=>{this.handleReplaceTrack(u.track,E,m,!0)})}}n()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}}),h(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),h(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),h(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),h(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new Z0,this.bindStatsUploaderEvents(),this.isPlanB=!le().supportUnifiedPlan||C("CHROME_FORCE_PLAN_B")&&er(),this.shouldForwardP2PCreation=C("FORWARD_P2P_CREATION")&&le().supportPCSetConfiguration,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new jn({},this.store):this.isPlanB?new jo({},this.store):new Bo({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,e){if(this.state=oe.New,this.shouldForwardP2PCreation||(this.connection=this.store.useDataChannel?new jn(t,this.store):this.isPlanB?new jo(t,this.store):new Bo(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new I(f.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t,e,i,n,r,o){if(!this.connection)throw new I(f.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof jn?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(t,e,i,n,r,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=oe.Connected)}async preConnect(t,e,i,n,r,o){if(!this.connection)throw new I(f.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const s=await this.connection.connect(t,e,i,n,r,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=oe.Connected,s}getEstablishParams(){if(this.connection instanceof jn)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}publish(t,e,i){var n=this;return xi(function*(){const r=yield rt(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==oe.Connected){if(n.state===oe.Disconnected)throw new I(f.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(t);const s=t.filter(a=>n.pendingLocalTracks.indexOf(a)===-1);return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(s))}n.store.pubId=n.store.pubId+1,Ri.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(t,e,i);if(o.length===0)return void(yield rt(n.tryToUnmuteAudio(t)));yield*xo(zu(n.doPublish(n.connection,o)),rt)}finally{r()}})()}doPublish(t,e){var i=this;return xi(function*(){e.forEach(d=>{let{track:u,type:l}=d;const E=Date.now();i.store.publish(u.getTrackId(),l===F.LocalAudioTrack?"audio":"video",E)}),i.bindLocalTrackEvents(e);const n=yield rt(t.send(e.map(d=>{let{track:u}=d;return u}),i.store.codec,i.store.audioCodec)),r=(yield rt(n.next())).value,o=i.createGatewayPublishMessage(e,r);let s;try{s=yield o}catch(d){throw n.throw(d),(d==null?void 0:d.code)===f.WS_ABORT&&e.forEach(u=>{let{track:l}=u;i.pendingLocalTracks.indexOf(l)===-1&&i.pendingLocalTracks.push(l)}),i.unbindLocalTrackEvents(e),d}const a=i.mapPubResToRemoteConfig(o,s),c=(yield rt(n.next(a))).value;e.forEach(d=>{let{type:u}=d;i.statsCollector.addLocalStats(u)}),i.assignLocalTracks(e,c),i.statsUploader.startUploadUplinkStats(),e.forEach(d=>{let{track:u,type:l}=d;const E=Date.now();i.store.publish(u.getTrackId(),l===F.LocalAudioTrack?"audio":"video",void 0,E)})})()}publishLowStream(t){var e=this;return xi(function*(){if(!e.connection||e.state!==oe.Connected)return;const i=yield rt(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=e.localTrackMap.get(F.LocalVideoTrack);if(!r)throw new I(f.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(F.LocalVideoLowTrack))throw new I(f.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:e.getLowVideoTrack(r.track,t),type:F.LocalVideoLowTrack}];if(yield*xo(zu(e.doPublish(e.connection,o)),rt),r.track.muted||!r.track.enabled){var n;const s=(n=e.localTrackMap.get(F.LocalVideoLowTrack))===null||n===void 0?void 0:n.id;s!==void 0&&(yield rt(e.connection.muteLocal([s])))}}finally{i()}})()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("Emit P2PChannelEvents.RequestRePublish to republish tracks."),await ye(this,lt.RequestRePublish,this.pendingLocalTracks),this.emit(lt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:i,kind:n}=this.pendingRemoteTracks[e];(n!==Z.AUDIO||i._audio_added_&&i._audioSSRC)&&(n!==Z.VIDEO||i._video_added_&&i._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)await ye(this,lt.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:i}of this.pendingRemoteTracks)await this.subscribe(e,i,i===Z.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:i}=e;this.emit(lt.MediaReconnectEnd,i.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==oe.Connected)return void t.forEach(n=>{const r=this.pendingLocalTracks.indexOf(n);r!==-1&&this.pendingLocalTracks.splice(r,1)});const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const i=e.find(n=>n[0]==="videoLowTrack");return i&&i[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishLowStream(){if(!this.connection||this.state!==oe.Connected)return;const t=this.localTrackMap.get(F.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[F.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const i=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map(n=>{let[,{id:r}]=n;return r})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(n=>{let[r,{track:o}]=n;return{type:r,track:o}})),e.forEach(n=>{let[r]=n;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadUplinkStats(),i}async subscribe(t,e,i,n,r){var o;if(!this.connection||this.state!==oe.Connected)throw new I(f.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(t))!==null&&o!==void 0&&o.has(e))return;let s,a;if(r){const u=r.find(E=>{let{stream_type:m}=E;return m===e});if(!u)throw new I(f.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const l=await this.connection.receive(e,u.ssrcs,String(t._uintid),u.attributes);s=l.track,a=l.id}else{const u=await this.connection.receive(e,[{ssrcId:i,rtx:n}],String(t._uintid),void 0);s=u.track,a=u.id}e===Z.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(s):(t._audioTrack=new Ra(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(s):(t._videoTrack=new Ta(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),this.bindRemoteTrackEvents(t,t._videoTrack));const c=this.remoteUserMap.get(t);c?c.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadDownlinkStats();const d=this.pendingRemoteTracks.findIndex(u=>{let{user:l,kind:E}=u;return l.uid===t.uid&&e===E});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(lt.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==oe.Connected)throw new I(f.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(i=>{var n;let{user:r,mediaType:o}=i;return!((n=this.remoteUserMap.get(r))!==null&&n!==void 0&&n.has(o))});const e=await this.connection.batchReceive(t.map(i=>{let{user:n,mediaType:r,ssrcId:o,rtxSsrcId:s}=i;return{kind:r,ssrcMsg:[{ssrcId:o,rtx:s}],mslabel:String(n._uintid)}}));t.forEach((i,n)=>{let{user:r,mediaType:o}=i;const{track:s,id:a}=e[n];o===Z.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(s):(r._audioTrack=new Ra(s,r.uid,r._uintid,this.store),_.info("[".concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(s):(r._videoTrack=new Ta(s,r.uid,r._uintid,this.store),_.info("[".concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),this.bindRemoteTrackEvents(r,r._videoTrack));const c=this.remoteUserMap.get(r);c?c.set(o,a):this.remoteUserMap.set(r,new Map([[o,a]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadDownlinkStats();const d=this.pendingRemoteTracks.findIndex(u=>{let{user:l,kind:E}=u;return l.uid===r.uid&&o===E});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(lt.MediaReconnectEnd,r.uid))})}async unsubscribe(t,e,i){const n=this.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid});if(n.forEach(s=>{const a=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(a,1)}),this.connection&&this.state===oe.Connected||i||n.forEach(s=>{let{kind:a}=s;var c;if(a===Z.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===Z.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==oe.Connected)return;const r=this.filterTobeUnSubscribedTracks(t,e);if(r.length===0)return;await this.connection.stopReceiving(r.map(s=>{let[,{id:a}]=s;return a}));const o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadDownlinkStats(),r.forEach(s=>{let[a,{kind:c}]=s;var d,u;if(c===Z.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===Z.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),i||((u=a._videoTrack)===null||u===void 0||u._destroy(),a._videoTrack=void 0);else if(c===Z.AUDIO){var l;this.unbindRemoteTrackEvents(a._audioTrack),!i&&((l=a._audioTrack)===null||l===void 0||l._destroy(),a._audioTrack=void 0)}}),o}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:r,mediaType:o}of t){const s=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return o!==void 0?c.uid===r.uid&&o===d:c.uid===r.uid});s.forEach(a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),e=e.concat(s)}if(!this.connection||this.state!==oe.Connected)return void e.forEach(r=>{let{user:o,kind:s}=r;var a;if(s===Z.AUDIO)(a=o._audioTrack)===null||a===void 0||a._destroy(),o._audioTrack=void 0;else if(s===Z.VIDEO){var c;(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0}});const i=On(t).call(t,(r,o)=>{let{user:s,mediaType:a}=o;const c=this.filterTobeUnSubscribedTracks(s,a);return r.concat(c)},[]);if(i.length===0)return;await this.connection.stopReceiving(i.map(r=>{let[,{id:o}]=r;return o}));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&this.statsUploader.stopUploadDownlinkStats(),i.forEach(r=>{let[o,{kind:s}]=r;var a,c;if(s===Z.VIDEO&&o._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),s===Z.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0;else if(s===Z.AUDIO){var d;this.unbindRemoteTrackEvents(o._audioTrack),(d=o._audioTrack)===null||d===void 0||d._destroy(),o._audioTrack=void 0}}),n}async muteRemote(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);if(!i)return void _.warning("P2PChannel.muteRemote has no remote user ".concat(t.uid,"."));if(!i.get(e))return void _.warning("P2PChannel.muteRemote has no remote user ".concat(t.uid," media type ").concat(e,"."));const n=e===Z.VIDEO?t._videoSSRC:t._audioSSRC;n!==void 0&&this.connection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);if(!i)return void _.warning("P2PChannel.unmuteRemote has no remote user ".concat(t.uid,"."));i.get(e)||_.warning("P2PChannel.unmuteRemote has no remote user ".concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(F.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Ti){const i=e.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return r!==F.LocalAudioTrack}).filter(n=>{let[r]=n;return!(t&&r===F.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[n]=i;return!(t&&n===F.LocalVideoLowTrack)}).map(i=>{let[,{track:n}]=i;return n})}reportPublishEvent(t,e,i,n,r){if(t){const s=this.localTrackMap.get(F.LocalAudioTrack),a=n?this.localTrackMap.get(F.LocalVideoLowTrack):this.localTrackMap.get(F.LocalVideoTrack);G.publish(this.store.sessionId,{eventElapse:Ri.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(re.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;i||(i=[]);const s=i.find(c=>c instanceof ve),a=n?(o=this.localTrackMap.get(F.LocalVideoTrack))===null||o===void 0?void 0:o.track:i.find(c=>c instanceof zt);G.publish(this.store.sessionId,{eventElapse:Ri.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s==null?void 0:s.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(re.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,i,n){const r=n===Z.VIDEO?i._videoSSRC:i._audioSSRC;r&&G.subscribe(this.store.sessionId,{succ:t,ec:e,video:n===Z.VIDEO,audio:n===Z.AUDIO,peerid:i.uid,subscribeRequestid:n===Z.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:Ri.measureFromSubscribeStart(this.store.clientId,r)})}reset(){_.debug("P2PChannel.reset"),this.mutex=new Ve("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new jn({},this.store):this.isPlanB?new jo({},this.store):new Bo({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.state=oe.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(F.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(F.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof zt||e&&e.track instanceof ve?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}getRemoteMedia(t){var e;const i=Array.from(cr(e=this.remoteUserMap).call(e)).find(n=>n.uid===t);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(i=>{let[n]=i;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(F.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=kd(t).call(t,(i,n)=>i.level-n.level),t}async disconnectForReconnect(){this.connection&&(_.debug("P2PChannel.disconnectForReconnect closing P2PConnection"),this.state=oe.Reconnecting,C("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{var e,i,n,r;let[o]=t;(e=o._videoTrack)===null||e===void 0||(i=e._player)===null||i===void 0||(n=i.getVideoElement())===null||n===void 0||n.pause(),(r=o._videoTrack)===null||r===void 0||r._originMediaStreamTrack.stop()}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new jn({},this.store):this.isPlanB?new jo({},this.store):new Bo({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:i}]=t;switch(e){case F.LocalVideoTrack:i._hints.includes(re.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case F.LocalAudioTrack:i instanceof Ti?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);break;case F.LocalVideoLowTrack:}}),this.emit(lt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;Array.from(cr(i).call(i)).forEach(n=>{this.setPendingRemoteMedia(e,n)}),this.emit(lt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),_.debug("P2PChannel disconnected, waiting to reconnect."))}hasPendingRemoteMedia(t,e){for(const i of this.pendingRemoteTracks){const{user:n,kind:r}=i;if((t instanceof Iu?t.uid:t)===n.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(){var t=this;return xi(function*(){if(!t.connection||t.state!==oe.Connected||t.connection instanceof jn)return;const e=yield rt(t.mutex.lock("From P2PChannel.restartICE"));try{yield*xo(zu(t.connection.restartICE()),rt)}finally{e()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(F.LocalVideoTrack),i=this.localTrackMap.get(F.LocalAudioTrack),n=t.videoSend.find(m=>m.ssrc===(e==null?void 0:e.ssrcs[0].ssrcId)),r=t.audioSend.find(m=>m.ssrc===(i==null?void 0:i.ssrcs[0].ssrcId));if(!n||!r)return 1;const o=on(this,lt.NeedSignalRTT),s=n?n.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,u=100*t.sendPacketLossRate*.7/50+.3*d/1500,l=u<.17?1:u<.36?2:u<.59?3:u<.1?4:5,E=e==null?void 0:e.track;if(E&&E._encoderConfig&&E._hints.indexOf(re.SCREEN_TRACK)===-1){const m=E._encoderConfig.bitrateMax,T=t.bitrate.actualEncoded;if(m&&T){const g=(1e3*m-T)/(1e3*m);return Db[g<.15?0:g<.3?1:g<.45?2:g<.6?3:4][l]}}return l}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[n]=i;const r=n._audioSSRC,o=n._videoSSRC,s=t.audioRecv.find(T=>T.ssrc===r),a=t.videoRecv.find(T=>T.ssrc===o);if(!s&&!a)return void(e+=1);const c=on(this,lt.NeedSignalRTT),d=t.rtt,u=(d&&c?(d+c)/2:d||c)||0,l=s?s.jitterMs:void 0,E=t.recvPacketLossRate;let m=.7*E*100/50+.3*u/1500;l&&(m=.6*E*100/50+.2*u/1500+.2*l/400),e+=m<.1?1:m<.17?2:m<.36?3:m<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new V((e,i)=>{this.handleMuteLocalTrack(t,e,i)})}filterTobePublishedTracks(t,e,i){const n=[],r=le(),o=this.getAllTracks();t=nf(t=t.filter(c=>o.indexOf(c)===-1));let s=!1,a=!1;for(const c of t){if(c instanceof zt&&(this.localTrackMap.has(F.LocalVideoTrack)||s?new I(f.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:c,type:F.LocalVideoTrack}),s=!0),e)){const d=this.getLowVideoTrack(c,i);n.push({track:d,type:F.LocalVideoLowTrack})}if(c instanceof ve){const d=this.localTrackMap.get(F.LocalAudioTrack);if(d){if(!(d.track instanceof Ti))throw new I(f.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new I(f.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const u=n.find(l=>{let{type:E}=l;return E===F.LocalAudioTrack});if(!(u.track instanceof Ti))throw new I(f.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new I(f.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof Ti||c._bypassWebAudio)n.push({track:c,type:F.LocalAudioTrack});else{const u=new Ti;u.addAudioTrack(c),n.push({track:u,type:F.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(t){const e=[],i=this.getAllTracks();t=nf(t=t.filter(n=>i.indexOf(n)!==-1));for(const n of t){if(n instanceof ve){const r=this.localTrackMap.get(F.LocalAudioTrack);if(!r)continue;r.track instanceof Ti?(r.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),r.track.trackList.length===0&&(e.push([F.LocalAudioTrack,r]),r.track.close())):e.push([F.LocalAudioTrack,r])}if(n instanceof zt){const r=this.localTrackMap.get(F.LocalVideoTrack);if(!r)continue;e.push([F.LocalVideoTrack,r]);const o=this.localTrackMap.get(F.LocalVideoLowTrack);o&&e.push([F.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:i,type:n}=e;switch(n){case F.LocalVideoTrack:i.addListener(J.GET_STATS,this.handleGetLocalVideoStats),i.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(J.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(J.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),i.addListener(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case F.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);break;case F.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof Ti?t.trackList.forEach(i=>{i.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(J.GET_STATS,this.handleGetLocalAudioStats),i.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(J.GET_STATS,this.handleGetLocalAudioStats),t.addListener(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(J.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[i,{track:n}]=e;return{track:n,type:i}})),t.forEach(e=>{let{track:i,type:n}=e;switch(n){case F.LocalVideoTrack:i.off(J.GET_STATS,this.handleGetLocalVideoStats),i.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(J.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(J.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),i.off(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case F.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);break;case F.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof Ti?t.trackList.forEach(e=>{e.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(J.GET_STATS,this.handleGetLocalAudioStats),e.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(J.GET_STATS,this.handleGetLocalAudioStats),t.off(J.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(J.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(J.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(J.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(J.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Ta&&e.addListener(J.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(t))}),e instanceof Ra&&e.addListener(J.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(J.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;i.has(Z.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has(Z.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((i,n)=>{let r,o,{track:s,type:a}=i;switch(a){case F.LocalAudioTrack:r=ee.Audio,o={dtx:s instanceof ea&&s._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case F.LocalVideoTrack:r=s._hints.includes(re.SCREEN_TRACK)?ee.Screen:ee.High,o=Bn(Bn({},Qm(s)),{},{codec:this.store.codec});break;case F.LocalVideoLowTrack:r=ee.Low,o=Bn(Bn({},Qm(s)),{},{codec:this.store.codec})}return{stream_type:r,attributes:o,ssrcs:e[n]}})}createGatewayUnpublishMessage(t){return t.map(e=>{let i,[n,{track:r,ssrcs:o,id:s}]=e;switch(n){case F.LocalVideoTrack:i=r._hints.includes(re.SCREEN_TRACK)?ee.Screen:ee.High;break;case F.LocalAudioTrack:i=ee.Audio;break;case F.LocalVideoLowTrack:i=ee.Low}return{stream_type:i,ssrcs:o,mid:s}})}assignLocalTracks(t,e){t.forEach((i,n)=>{let{track:r,type:o}=i;this.localTrackMap.set(o,{track:r,id:e[n].id,ssrcs:e[n].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[i]=e;this.localTrackMap.delete(i)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(_.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(lt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&C("ICE_RESTART")&&on(this,lt.QueryClientConnectionState)==="CONNECTED"&&this.emit(lt.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(_.debug("P2PConnection disconnected timeout 4000ms, force reconnect"),setTimeout(()=>this.emit(lt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(_.debug("P2PConnection state failed, force reconnect"),setTimeout(()=>this.emit(lt.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),G.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Mt.TRACER}).onSuccess(),this.emit(lt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{_.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{_.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{_.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var i;const n=Array.from(cr(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===e);var r;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(r=n.audioTrack)===null||r===void 0||r.emit(jr.FIRST_FRAME_DECODED),G.firstRemoteFrame(this.store.sessionId,Te.FIRST_AUDIO_DECODE,Ut.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:Ri.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var i;const n=Array.from(cr(i=this.remoteUserMap).call(i)).find(r=>r._audioSSRC===e);n&&G.firstRemoteFrame(this.store.sessionId,Te.FIRST_AUDIO_RECEIVED,Ut.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:Ri.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,i,n)=>{this.reportVideoFirstFrameDecoded(e,i,n)},t.onFirstVideoReceived=e=>{var i;const n=Array.from(cr(i=this.remoteUserMap).call(i)).find(r=>r._videoSSRC===e);n&&G.firstRemoteFrame(this.store.sessionId,Te.FIRST_VIDEO_RECEIVED,Ut.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:Ri.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,i)=>{const n=e.candidateType==="relay",r=i.candidateType==="relay";i.candidateType!=="unknown"&&n===r||this.emit(lt.ConnectionTypeChange,n),_.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ra(i))," -> ").concat(JSON.stringify(ra(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,i)=>{_.info("[p2pId: ".concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ra(i))," -> ").concat(JSON.stringify(ra(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const i=this.localTrackMap.get(F.LocalAudioTrack);if(t instanceof ve&&(i==null?void 0:i.track)instanceof Ti)return i.track.isActive||e.push([F.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(n&&(e.push(n),n[0]===F.LocalVideoTrack)){const r=this.localTrackMap.get(F.LocalVideoLowTrack);r&&e.push([F.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],i=this.localTrackMap.get(F.LocalAudioTrack);if(t instanceof ve&&(i==null?void 0:i.track)instanceof Ti)return i.track.isActive&&e.push([F.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(n)if(n[0]===F.LocalVideoTrack){e.push(n);const r=this.localTrackMap.get(F.LocalVideoLowTrack);r&&e.push([F.LocalVideoLowTrack,r])}else e.push(n);return e}createMuteMessage(t){return t.map(e=>{let i,[n,{track:r,ssrcs:o,id:s}]=e;switch(n){case F.LocalAudioTrack:i=ee.Audio;break;case F.LocalVideoTrack:i=r._hints.includes(re.SCREEN_TRACK)?ee.Screen:ee.High;break;case F.LocalVideoLowTrack:i=ee.Low}return{stream_type:i,ssrcs:o,mid:s}})}createUnmuteMessage(t){return t.map(e=>{let i,[n,{track:r,ssrcs:o,id:s}]=e;switch(n){case F.LocalAudioTrack:i=ee.Audio;break;case F.LocalVideoTrack:i=r._hints.includes(re.SCREEN_TRACK)?ee.Screen:ee.High;break;case F.LocalVideoLowTrack:i=ee.Low}return{stream_type:i,ssrcs:o,mid:s}})}filterTobeUnSubscribedTracks(t,e){const i=[],n=this.remoteUserMap.get(t);if(!n)return i;if(e){const r=n.get(e);if(!r)return i;i.push([t,{kind:e,id:r}])}else Array.from(n.entries()).forEach(r=>{let[o,s]=r;i.push([t,{kind:o,id:s}])});return i}createUnsubscribeMessage(t){const e=[];return t.forEach(i=>{let[n,{kind:r,id:o}]=i;switch(r){case Z.VIDEO:return void(n._videoSSRC&&e.push({stream_type:Z.VIDEO,ssrcId:n._videoSSRC}));case Z.AUDIO:return void(n._audioSSRC&&e.push({stream_type:Z.AUDIO,ssrcId:n._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach(i=>{let[n,{kind:r}]=i;if(e.has(n)){let o=e.get(n);r===Z.VIDEO?o|=qt.Video:o|=qt.Audio,e.set(n,o)}else r===Z.VIDEO?e.set(n,qt.Video):e.set(n,qt.Audio)}),{users:Array.from(e.entries()).map(i=>{let[n,r]=i;return{stream_id:n.uid,stream_type:r}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[i,{kind:n}]=e;const r=this.remoteUserMap.get(i);r&&(r.delete(n),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(F.LocalVideoTrack),i=this.localTrackMap.get(F.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),i&&t.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,e){return t.map((i,n)=>{var r;let{stream_type:o}=i;return(r=e.find(s=>{let{stream_type:a}=s;return o===a}))===null||r===void 0?void 0:r.attributes})}async tryToUnmuteAudio(t){for(let i=0;i<t.length;i++)if(t[i]instanceof ve){var e;const n=this.filterTobeUnmutedTracks(t[i]);if(n.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(n.map(o=>{let[,{id:s}]=o;return s})));const r=this.createUnmuteMessage(n);return void await Vt(this,lt.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(lt.RequestUploadStats,t,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Ce(Cd(this.dtlsFailedCount,ne)),this.emit(lt.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await ye(this,lt.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(lt.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(F.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof zt)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof zt).length>1)throw new I(f.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof ve).length>1&&(t.some(e=>e instanceof ve&&e._bypassWebAudio)||!le().webAudioMediaStreamDest))throw new I(f.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof zt&&this.pendingLocalTracks.some(i=>i instanceof zt))throw new I(f.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ve&&this.pendingLocalTracks.some(i=>i instanceof ve)&&(!le().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof ve&&i._bypassWebAudio)))throw new I(f.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const i=le().supportDualStreamEncoding,n=Bn(Bn({},{width:160,height:120,framerate:15,bitrate:50}),e);let r;r=i?t._mediaStreamTrack.clone():Ig(t,n);const o=Lt(8,"track-low-"),s=new zt(r,Bn(Bn({},i&&{scaleResolutionDownBy:kN(n,t)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return s._hints.push(re.LOW_STREAM),t.addListener(J.NEED_CLOSE,()=>{s.close()}),s}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}reportVideoFirstFrameDecoded(t,e,i,n){var r;const o=Array.from(cr(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){n||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");G.firstRemoteVideoDecode(this.store.sessionId,Te.FIRST_VIDEO_DECODE,Ut.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:i,subscribeElapse:Ri.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(a==null?void 0:a.subscribeEnd)||0,subscriberStart:(a==null?void 0:a.subscribeStart)||0,videoAddNotify:(a==null?void 0:a.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(t,e,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(t);if(!n)return!1;const r=n.get(e);if(!r)return!1;const o=await this.connection.getRemoteSSRC(r);return o!==void 0&&o!==i}resetConnection(t){_.debug("[P2PChannel] reset connection to ".concat(t)),this.state===oe.Connected?(_.debug("[P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first"),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===qs.datachannel?new jn({},this.store):this.isPlanB?new jo({},this.store):new Bo({},this.store),this.bindConnectionEvents(this.connection)))}}).prototype,"startP2PConnection",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"startP2PConnection"),ht.prototype),w(ht.prototype,"connect",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"connect"),ht.prototype),w(ht.prototype,"preConnect",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"preConnect"),ht.prototype),w(ht.prototype,"unpublish",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"unpublish"),ht.prototype),w(ht.prototype,"unpublishLowStream",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"unpublishLowStream"),ht.prototype),w(ht.prototype,"subscribe",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"subscribe"),ht.prototype),w(ht.prototype,"massSubscribe",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"massSubscribe"),ht.prototype),w(ht.prototype,"unsubscribe",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"unsubscribe"),ht.prototype),w(ht.prototype,"massUnsubscribe",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"massUnsubscribe"),ht.prototype),w(ht.prototype,"muteRemote",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"muteRemote"),ht.prototype),w(ht.prototype,"unmuteRemote",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"unmuteRemote"),ht.prototype),w(ht.prototype,"hasRemoteMediaWithLock",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"hasRemoteMediaWithLock"),ht.prototype),w(ht.prototype,"disconnectForReconnect",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"disconnectForReconnect"),ht.prototype),w(ht.prototype,"updateBitrateLimit",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"updateBitrateLimit"),ht.prototype),w(ht.prototype,"remoteMediaSsrcChanged",[ni],Object.getOwnPropertyDescriptor(ht.prototype,"remoteMediaSsrcChanged"),ht.prototype),ht);function ni(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,o=await r.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{o()}},i}function Bg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function W(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Bg(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Bg(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}var ot;(function(t){t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL"})(ot||(ot={}));class iD{constructor(e,i,n,r){h(this,"state",void 0),this.state={codec:e,audioCodec:i,mode:n,clientId:r,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1}}dispatch(e){this.state=function(i,n){switch(n.type){case ot.SET_SESSION_ID:return W(W({},i),{},{sessionId:n.sessionId});case ot.SET_P2P_ID:return W(W({},i),{},{p2pId:n.p2pId});case ot.SET_UID:return W(W({},i),{},{uid:n.uid});case ot.SET_PUB_ID:return W(W({},i),{},{pubId:n.pubId});case ot.KEY_METRIC_CLIENT_CREATED:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{clientCreated:n.metric})});case ot.KEY_METRIC_JOIN_START:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{joinStart:n.metric})});case ot.AVOID_JOIN_START:return W(W({},i),{},{avoidJoinStart:n.avoidJoinStart});case ot.KEY_METRIC_JOIN_END:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{joinEnd:n.metric})});case ot.KEY_METRIC_REQUEST_AP_START:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{requestAPStart:n.metric})});case ot.KEY_METRIC_REQUEST_AP_END:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{requestAPEnd:n.metric})});case ot.KEY_METRIC_JOIN_GATEWAY_START:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{joinGatewayStart:n.metric})});case ot.KEY_METRIC_JOIN_GATEWAY_END:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{joinGatewayEnd:n.metric})});case ot.KEY_METRIC_PEER_CONNECTION_START:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{peerConnectionStart:n.metric})});case ot.KEY_METRIC_PEER_CONNECTION_END:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{peerConnectionEnd:n.metric})});case ot.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{signalChannelOpen:n.metric})});case ot.KEY_METRIC_ICE_CONNECTION_END:return W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{iceConnectionEnd:n.metric})});case ot.KEY_METRIC_PUBLISH:{const r=i.keyMetrics.publish,o=r.findIndex(s=>s.trackId===n.metric.trackId);return o!==-1?(r[o]=W(W({},r[o]),n.metric),W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{publish:[...r]})})):W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{publish:[...i.keyMetrics.publish,n.metric]})})}case ot.KEY_METRIC_SUBSCRIBE:{const r=i.keyMetrics.subscribe,o=r.findIndex(s=>s.userId===n.metric.userId&&s.type===n.metric.type);return o!==-1?(r[o]=W(W({},r[o]),n.metric),W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{subscribe:[...r]})})):W(W({},i),{},{keyMetrics:W(W({},i.keyMetrics),{},{subscribe:[...i.keyMetrics.subscribe,n.metric]})})}case ot.SET_CLOUD_PROXY_SERVER_MODE:return i.cloudProxyServerMode=n.mode,i;case ot.RECORD_JOIN_CHANNEL_SERVICE:return typeof n.index!="number"?i.joinChannelServiceRecords=[...i.joinChannelServiceRecords,n.record]:(i.joinChannelServiceRecords[n.index]=W(W({},i.joinChannelServiceRecords[n.index]),n.record),i.joinChannelServiceRecords=[...i.joinChannelServiceRecords]),i;case ot.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return i.joinChannelServiceRecords=[],i;case ot.RESET_KEY_METRICS:return i.keyMetrics={publish:[],subscribe:[]},i;case ot.SET_USE_DATACHANNEL:return W(W({},i),{},{useDataChannel:n.val});default:return i}}(this.state,e)}set sessionId(e){this.dispatch({type:ot.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}get codec(){return this.state.codec}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:ot.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:ot.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:ot.SET_UID,uid:e})}get uid(){return this.state.uid}set pubId(e){this.dispatch({type:ot.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:ot.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:ot.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}clientCreated(){this.dispatch({type:ot.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:ot.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:ot.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:ot.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:ot.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:ot.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:ot.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:ot.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:ot.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:ot.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:ot.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,i,n,r){this.dispatch({type:ot.KEY_METRIC_PUBLISH,metric:W(W({trackId:e,type:i},n&&{publishStart:n}),r&&{publishEnd:r})})}subscribe(e,i,n,r,o,s,a){this.dispatch({type:ot.KEY_METRIC_SUBSCRIBE,metric:W(W(W(W(W({userId:e,type:i},n&&{subscribeStart:n}),r&&{subscribeEnd:r}),o&&{firstFrame:o}),s&&{streamAdded:s}),a&&{firstDecoded:a})})}massSubscribe(e,i,n,r){e.forEach(o=>{this.dispatch({type:ot.KEY_METRIC_SUBSCRIBE,metric:W(W(W({userId:o.userId,type:o.type},i&&{subscribeStart:i}),n&&{subscribeEnd:n}),r&&{firstFrame:r})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,i){e.service==="gateway"&&Array.isArray(e.urls)&&(e.urls=e.urls.map(n=>n.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof i!="number"?(this.dispatch({type:ot.RECORD_JOIN_CHANNEL_SERVICE,record:W(W({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(i<0||i>=this.state.joinChannelServiceRecords.length||this.dispatch({type:ot.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:i}),i)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:ot.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:ot.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:ot.AVOID_JOIN_START,avoidJoinStart:e})}}let Ca;const nD=()=>(Ca||Ca||(Ca=(window.location.protocol.split(":")[0]||"").toUpperCase(),Ca))==="HTTPS",Gg=()=>window.isSecureContext!==void 0;function rD(t){let e=Kg();return function(i,n){let r=i.appId;r!==void 0&&(pt(n,10),an(n,r));let o=i.cid;o!==void 0&&(pt(n,16),pt(n,o));let s=i.cname;s!==void 0&&(pt(n,26),an(n,s));let a=i.deviceId;a!==void 0&&(pt(n,34),an(n,a));let c=i.elapse;c!==void 0&&(pt(n,40),Gn(n,c));let d=i.fileSize;d!==void 0&&(pt(n,48),Gn(n,$r(d)));let u=i.height;u!==void 0&&(pt(n,56),Gn(n,$r(u)));let l=i.jpg;l!==void 0&&(pt(n,66),pt(n,l.length),function($e,O){let N=to($e,O.length);$e.bytes.set(O,N)}(n,l));let E=i.networkType;E!==void 0&&(pt(n,72),Gn(n,$r(E)));let m=i.osType;m!==void 0&&(pt(n,80),Gn(n,$r(m)));let T=i.requestId;T!==void 0&&(pt(n,90),an(n,T));let g=i.sdkVersion;g!==void 0&&(pt(n,98),an(n,g));let R=i.sequence;R!==void 0&&(pt(n,104),Gn(n,$r(R)));let y=i.sid;y!==void 0&&(pt(n,114),an(n,y));let A=i.timestamp;A!==void 0&&(pt(n,120),Gn(n,A));let P=i.uid;P!==void 0&&(pt(n,128),pt(n,P));let H=i.vid;H!==void 0&&(pt(n,136),pt(n,H));let k=i.width;k!==void 0&&(pt(n,144),Gn(n,$r(k)));let M=i.service;M!==void 0&&(pt(n,152),pt(n,M));let D=i.callbackData;D!==void 0&&(pt(n,162),an(n,D));let j=i.jpgEncryption;j!==void 0&&(pt(n,168),pt(n,j));let yt=i.requestType;yt!==void 0&&(pt(n,176),pt(n,yt));let Q=i.scorePorn;Q!==void 0&&(pt(n,185),il(n,Q));let Dt=i.scoreSexy;Dt!==void 0&&(pt(n,193),il(n,Dt));let At=i.scoreNeutral;At!==void 0&&(pt(n,201),il(n,At));let Yt=i.scene;Yt!==void 0&&(pt(n,208),pt(n,Yt));let _e=i.ossFilePrefix;_e!==void 0&&(pt(n,218),an(n,_e));let Kt=i.serviceVendor;if(Kt!==void 0)for(let $e of Kt){pt(n,226);let O=Kg();aD($e,O),pt(n,O.limit),lD(n,O),uD(O)}}(t,e),function(i){let n=i.bytes,r=i.limit;return n.length===r?n:n.subarray(0,r)}(e)}function oD(t){return function(i){let n={};t:for(;!Yg(i);){let r=cn(i);switch(r>>>3){case 0:break t;case 1:n.code=cn(i);break;case 2:n.msg=qg(i,cn(i));break;case 3:{let o=cD(i);n.data=sD(i),i.limit=o;break}default:Wg(i,7&r)}}return n}({bytes:e=t,offset:0,limit:e.length});var e}function sD(t){let e={};t:for(;!Yg(t);){let i=cn(t);switch(i>>>3){case 0:break t;case 1:e.requestId=qg(t,cn(t));break;case 2:e.requestType=cn(t)>>>0;break;case 3:e.scorePorn=el(t);break;case 4:e.scoreSexy=el(t);break;case 5:e.scoreNeutral=el(t);break;case 6:e.requestScene=cn(t)>>>0;break;case 7:e.scene=cn(t)>>>0;break;default:Wg(t,7&i)}}return e}function aD(t,e){let i=t.service;i!==void 0&&(pt(e,8),pt(e,i));let n=t.vendor;n!==void 0&&(pt(e,16),pt(e,n));let r=t.token;r!==void 0&&(pt(e,26),an(e,r));let o=t.callbackUrl;o!==void 0&&(pt(e,34),an(e,o))}function cD(t){let e=cn(t),i=t.limit;return t.limit=t.offset+e,i}function Wg(t,e){switch(e){case 0:for(;128&Jg(t););break;case 2:$u(t,cn(t));break;case 5:$u(t,4);break;case 1:$u(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let dD=new Float32Array(1);new Uint8Array(dD.buffer);let Zu=new Float64Array(1),Ze=new Uint8Array(Zu.buffer);function $r(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let Hg=[];function Kg(){const t=Hg.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function uD(t){Hg.push(t)}function $u(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function Yg(t){return t.offset>=t.limit}function to(t,e){let i=t.bytes,n=t.offset,r=t.limit,o=n+e;if(o>i.length){let s=new Uint8Array(2*o);s.set(i),t.bytes=s}return t.offset=o,o>r&&(t.limit=o),n}function tl(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function qg(t,e){let i=tl(t,e),n=String.fromCharCode,r=t.bytes,o="ï¿½",s="";for(let a=0;a<e;a++){let c,d,u,l,E=r[a+i];128&E?(224&E)==192?a+1>=e?s+=o:(c=r[a+i+1],(192&c)!=128?s+=o:(l=(31&E)<<6|63&c,l<128?s+=o:(s+=n(l),a++))):(240&E)==224?a+2>=e?s+=o:(c=r[a+i+1],d=r[a+i+2],(49344&(c|d<<8))!=32896?s+=o:(l=(15&E)<<12|(63&c)<<6|63&d,l<2048||l>=55296&&l<=57343?s+=o:(s+=n(l),a+=2))):(248&E)==240?a+3>=e?s+=o:(c=r[a+i+1],d=r[a+i+2],u=r[a+i+3],(12632256&(c|d<<8|u<<16))!=8421504?s+=o:(l=(7&E)<<18|(63&c)<<12|(63&d)<<6|63&u,l<65536||l>1114111?s+=o:(l-=65536,s+=n(55296+(l>>10),56320+(1023&l)),a+=3))):s+=o:s+=n(E)}return s}function an(t,e){let i=e.length,n=0;for(let s=0;s<i;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<i&&(a=(a<<10)+e.charCodeAt(++s)-56613888),n+=a<128?1:a<2048?2:a<65536?3:4}pt(t,n);let r=to(t,n),o=t.bytes;for(let s=0;s<i;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<i&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function lD(t,e){let i=to(t,e.limit),n=t.bytes,r=e.bytes;for(let o=0,s=e.limit;o<s;o++)n[o+i]=r[o]}function Jg(t){return t.bytes[tl(t,1)]}function Xg(t,e){let i=to(t,1);t.bytes[i]=e}function el(t){let e=tl(t,8),i=t.bytes;return Ze[0]=i[e++],Ze[1]=i[e++],Ze[2]=i[e++],Ze[3]=i[e++],Ze[4]=i[e++],Ze[5]=i[e++],Ze[6]=i[e++],Ze[7]=i[e++],Zu[0]}function il(t,e){let i=to(t,8),n=t.bytes;Zu[0]=e,n[i++]=Ze[0],n[i++]=Ze[1],n[i++]=Ze[2],n[i++]=Ze[3],n[i++]=Ze[4],n[i++]=Ze[5],n[i++]=Ze[6],n[i++]=Ze[7]}function cn(t){let e,i=0,n=0;do e=Jg(t),i<32&&(n|=(127&e)<<i),i+=7;while(128&e);return n}function pt(t,e){for(e>>>=0;e>=128;)Xg(t,127&e|128),e>>>=7;Xg(t,e)}function Gn(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?n===0?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:r<128?9:10,s=to(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?n>>>21|128:n>>>21&127;case 7:a[s+6]=o!==7?n>>>14|128:n>>>14&127;case 6:a[s+5]=o!==6?n>>>7|128:n>>>7&127;case 5:a[s+4]=o!==5?128|n:127&n;case 4:a[s+3]=o!==4?i>>>21|128:i>>>21&127;case 3:a[s+2]=o!==3?i>>>14|128:i>>>14&127;case 2:a[s+1]=o!==2?i>>>7|128:i>>>7&127;case 1:a[s]=o!==1?128|i:127&i}}const hD=async(t,e,i)=>{const n=function(s){const a=[];for(let c=0;c<s.length;c+=2)a.push(parseInt(s.slice(c,c+2),16));return Uint8Array.from(a)}(function(s){const a="0123456789abcdef";function c(yt){let Q,Dt="";for(Q=0;Q<=3;Q++)Dt+=a.charAt(yt>>8*Q+4&15)+a.charAt(yt>>8*Q&15);return Dt}function d(yt,Q){const Dt=(65535&yt)+(65535&Q);return(yt>>16)+(Q>>16)+(Dt>>16)<<16|65535&Dt}function u(yt,Q,Dt,At,Yt,_e){return d(function(Kt,$e){return Kt<<$e|Kt>>>32-$e}(d(d(Q,yt),d(At,_e)),Yt),Dt)}function l(yt,Q,Dt,At,Yt,_e,Kt){return u(Q&Dt|~Q&At,yt,Q,Yt,_e,Kt)}function E(yt,Q,Dt,At,Yt,_e,Kt){return u(Q&At|Dt&~At,yt,Q,Yt,_e,Kt)}function m(yt,Q,Dt,At,Yt,_e,Kt){return u(Q^Dt^At,yt,Q,Yt,_e,Kt)}function T(yt,Q,Dt,At,Yt,_e,Kt){return u(Dt^(Q|~At),yt,Q,Yt,_e,Kt)}const g=function(yt){let Q;const Dt=1+(yt.length+8>>6),At=new Array(16*Dt);for(Q=0;Q<16*Dt;Q++)At[Q]=0;for(Q=0;Q<yt.length;Q++)At[Q>>2]|=yt.charCodeAt(Q)<<Q%4*8;return At[Q>>2]|=128<<Q%4*8,At[16*Dt-2]=8*yt.length,At}(s);let R,y,A,P,H,k=1732584193,M=-271733879,D=-1732584194,j=271733878;for(R=0;R<g.length;R+=16)y=k,A=M,P=D,H=j,k=l(k,M,D,j,g[R+0],7,-680876936),j=l(j,k,M,D,g[R+1],12,-389564586),D=l(D,j,k,M,g[R+2],17,606105819),M=l(M,D,j,k,g[R+3],22,-1044525330),k=l(k,M,D,j,g[R+4],7,-176418897),j=l(j,k,M,D,g[R+5],12,1200080426),D=l(D,j,k,M,g[R+6],17,-1473231341),M=l(M,D,j,k,g[R+7],22,-45705983),k=l(k,M,D,j,g[R+8],7,1770035416),j=l(j,k,M,D,g[R+9],12,-1958414417),D=l(D,j,k,M,g[R+10],17,-42063),M=l(M,D,j,k,g[R+11],22,-1990404162),k=l(k,M,D,j,g[R+12],7,1804603682),j=l(j,k,M,D,g[R+13],12,-40341101),D=l(D,j,k,M,g[R+14],17,-1502002290),M=l(M,D,j,k,g[R+15],22,1236535329),k=E(k,M,D,j,g[R+1],5,-165796510),j=E(j,k,M,D,g[R+6],9,-1069501632),D=E(D,j,k,M,g[R+11],14,643717713),M=E(M,D,j,k,g[R+0],20,-373897302),k=E(k,M,D,j,g[R+5],5,-701558691),j=E(j,k,M,D,g[R+10],9,38016083),D=E(D,j,k,M,g[R+15],14,-660478335),M=E(M,D,j,k,g[R+4],20,-405537848),k=E(k,M,D,j,g[R+9],5,568446438),j=E(j,k,M,D,g[R+14],9,-1019803690),D=E(D,j,k,M,g[R+3],14,-187363961),M=E(M,D,j,k,g[R+8],20,1163531501),k=E(k,M,D,j,g[R+13],5,-1444681467),j=E(j,k,M,D,g[R+2],9,-51403784),D=E(D,j,k,M,g[R+7],14,1735328473),M=E(M,D,j,k,g[R+12],20,-1926607734),k=m(k,M,D,j,g[R+5],4,-378558),j=m(j,k,M,D,g[R+8],11,-2022574463),D=m(D,j,k,M,g[R+11],16,1839030562),M=m(M,D,j,k,g[R+14],23,-35309556),k=m(k,M,D,j,g[R+1],4,-1530992060),j=m(j,k,M,D,g[R+4],11,1272893353),D=m(D,j,k,M,g[R+7],16,-155497632),M=m(M,D,j,k,g[R+10],23,-1094730640),k=m(k,M,D,j,g[R+13],4,681279174),j=m(j,k,M,D,g[R+0],11,-358537222),D=m(D,j,k,M,g[R+3],16,-722521979),M=m(M,D,j,k,g[R+6],23,76029189),k=m(k,M,D,j,g[R+9],4,-640364487),j=m(j,k,M,D,g[R+12],11,-421815835),D=m(D,j,k,M,g[R+15],16,530742520),M=m(M,D,j,k,g[R+2],23,-995338651),k=T(k,M,D,j,g[R+0],6,-198630844),j=T(j,k,M,D,g[R+7],10,1126891415),D=T(D,j,k,M,g[R+14],15,-1416354905),M=T(M,D,j,k,g[R+5],21,-57434055),k=T(k,M,D,j,g[R+12],6,1700485571),j=T(j,k,M,D,g[R+3],10,-1894986606),D=T(D,j,k,M,g[R+10],15,-1051523),M=T(M,D,j,k,g[R+1],21,-2054922799),k=T(k,M,D,j,g[R+8],6,1873313359),j=T(j,k,M,D,g[R+15],10,-30611744),D=T(D,j,k,M,g[R+6],15,-1560198380),M=T(M,D,j,k,g[R+13],21,1309151649),k=T(k,M,D,j,g[R+4],6,-145523070),j=T(j,k,M,D,g[R+11],10,-1120210379),D=T(D,j,k,M,g[R+2],15,718787259),M=T(M,D,j,k,g[R+9],21,-343485551),k=d(k,y),M=d(M,A),D=d(D,P),j=d(j,H);return c(k)+c(M)+c(D)+c(j)}(""+e+i)).slice(0,16),r=n.slice(0,12),o=await window.crypto.subtle.importKey("raw",n,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},o,t))};function zg(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}const pD=new Map([["moderation",1],["supervise",2]]);class ya extends Gt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const i=this._connectionState;this._connectionState=e,this.emit(ie.CONNECTION_STATE_CHANGE,i,e)}get inspectType(){return this._inspectType}set inspectType(e){var i;this._inspectMode=On(i=e.map(n=>pD.get(n)||0)).call(i,(n,r)=>n+r),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),h(this,"name","AgoraRTCVideoContentInspect"),h(this,"_connectionState",ci.CONNECTING),h(this,"_innerConnectionState",void 0),h(this,"sequence",0),h(this,"inspectStartTime",void 0),h(this,"workerManagerConnection",void 0),h(this,"workerConnection",void 0),h(this,"workerMessageLengthLimit",void 0),h(this,"inspectIntervalMinimum",void 0),h(this,"qualityRatio",void 0),h(this,"_connectInfo",void 0),h(this,"_cancelTokenSource",Pi.CancelToken.source()),h(this,"_retryConfig",void 0),h(this,"wmSequence",0),h(this,"inspectInterval",void 0),h(this,"inspectTimer",null),h(this,"ossFilePrefix",void 0),h(this,"extraInfo",void 0),h(this,"_inspectType",void 0),h(this,"_inspectMode",void 0),h(this,"_quality",1),h(this,"qualityTimer",null),h(this,"_inspectId",void 0),h(this,"_needWorkUrlOnly",!1),h(this,"inspectImage",()=>{if(this.connectionState!==ci.CONNECTED)throw new I(f.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===ci.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=Lt(5,"inspect-"),this.workerMessageLengthLimit=C("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=C("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=C("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Jr("worker-manager-"+this._inspectId,ne),this.on(ie.STATE_CHANGE,(i,n)=>{this._innerConnectionState=i,_.debug("[".concat(this._inspectId,"] Inspect operation :").concat(di[i]," ").concat(n||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Jr("worker-"+this._inspectId,ne),this.handleWorkerEvents()}async init(e,i){this.emit(ie.STATE_CHANGE,di.CONNECT_AP),this._connectInfo=e;const n=this._cancelTokenSource.token;return this._retryConfig=i,new V((r,o)=>{this.on(ie.CONNECTION_STATE_CHANGE,(s,a)=>{a===ci.CONNECTED&&r()}),this.requestAP(e,n,i).then(s=>{this.connectWorkerManager(s)}).catch(s=>{o(s)})})}async requestAP(e,i,n){const r=C("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),o=await function(a,c,d,u){let{appId:l,areaCode:E,cname:m,sid:T,token:g,uid:R}=c;Su++;const y="image_moderation_api",A={service_name:y,json_body:JSON.stringify({appId:l,areaCode:E,cname:m,command:"allocateEdge",requestId:Su,seq:Su,sid:T,token:g,ts:Date.now(),uid:R+""})};let P,H,k=a[0];return tn(async()=>{P=Date.now();const M=await Yi(k,{data:A,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(H=Date.now()-P,M.code!==0){const Q=new I(f.UNEXPECTED_RESPONSE,"image inspect ap error, code"+M.code,{retry:!0,responseTime:H});throw _.error(Q.toString()),Q}const D=JSON.parse(M.json_body);if(D.code!==200){const Q=new I(f.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(D.code,", reason: ").concat(D.reason),{code:D.code,responseTime:H});throw _.error(Q.toString()),Q}if(!D.servers||!Array.isArray(D.servers)||D.servers.length===0){const Q=new I(f.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:D.code,responseTime:H});throw _.error(Q.toString()),Q}const j=C("VIDEO_INSPECT_WORKER_MANAGER_HOST"),yt=C("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:D.servers.map(Q=>{let{address:Dt,wss:At}=Q;if(Dt&&At)return"wss://".concat(Dt.replace(/\./g,"-"),".").concat(j,":").concat(yt||At)}).filter(Q=>!!Q),workerToken:D.workerToken,vid:D.vid,responseTime:H}},(M,D)=>(G.apworkerEvent(T,{success:!0,sc:200,serviceName:y,responseDetail:JSON.stringify(M.addressList),firstSuccess:D===0,responseTime:H,serverIp:a[D%a.length]}),!1),(M,D)=>(G.apworkerEvent(T,{success:!1,sc:M.data&&M.data.code||200,serviceName:y,responseTime:H,serverIp:a[D%a.length]}),!!(M.code!==f.OPERATION_ABORTED&&M.code!==f.UNEXPECTED_RESPONSE||M.data&&M.data.retry)&&(k=a[(D+1)%a.length],!0)),u)}(r,e,i,n);this.emit(ie.STATE_CHANGE,di.AP_CONNECTED);const{addressList:s}=o;return this.wmSequence++,s}async connectWorkerManager(e){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=i,this.emit(ie.STATE_CHANGE,di.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on($.CONNECTED,async()=>{this.emit(ie.STATE_CHANGE,di.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.17.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on($.CLOSED,()=>{this._innerConnectionState<di.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on($.FAILED,()=>{this._innerConnectionState<di.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on($.RECONNECTING,()=>{this._innerConnectionState<di.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on($.ON_MESSAGE,async e=>{this.emit(ie.STATE_CHANGE,di.GET_WORKER_MANAGER_RESPONSE);const i=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(e.data);if(n.code!==200)throw _.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new I(f.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&i))throw _.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new I(f.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const r=C("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,o=i.replace(/:\d+\/?$/,":".concat(r));this.emit(ie.STATE_CHANGE,di.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(ie.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o)}}),this.workerManagerConnection.on($.WILL_RECONNECT,(e,i)=>{i(e)}),this.workerManagerConnection.on($.REQUEST_NEW_URLS,(e,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(i)})}handleWorkerEvents(){this.workerConnection.on($.CONNECTED,async()=>{this.emit(ie.STATE_CHANGE,di.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=ci.CONNECTED}),this.workerConnection.on($.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const n=oD(new Uint8Array(e.data));if(C("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&_.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),n.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(ie.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var i;const r={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},o=On(i=Object.keys(r)).call(i,(a,c)=>r[a]>r[c]?a:c,"porn"),s=Object.keys(r).find(a=>a===o);this.emit(ie.INSPECT_RESULT,s)}else this.emit(ie.INSPECT_RESULT,void 0,new I(f.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(ie.INSPECT_RESULT,void 0,new I(f.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else _.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(ie.INSPECT_RESULT,void 0,new I(f.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on($.CLOSED,()=>{this.connectionState=ci.CLOSED}),this.workerConnection.on($.FAILED,()=>{this.connectionState=ci.CLOSED}),this.workerConnection.on($.RECONNECTING,()=>{this.connectionState=this.connectionState===ci.CONNECTED?ci.RECONNECTING:ci.CONNECTING}),this.workerConnection.on($.WILL_RECONNECT,(e,i)=>{e==="recover"&&i(e),i("tryNext")}),this.workerConnection.on($.REQUEST_NEW_URLS,(e,i)=>{this.workerManagerConnection.close(),this.once(ie.REQUEST_NEW_WORKER_URL,n=>{e([n])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n=>{this.connectWorkerManager(n,!0)}).catch(n=>{i(n)})})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=on(this,ie.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(ie.INSPECT_RESULT,void 0,new I(f.INVALID_OPERATION,"Only the track being played can be inspected"));const n=await this.generateRequestData(e,i);this.workerConnection.sendMessage(n,!0,!0)}else this.emit(ie.INSPECT_RESULT,void 0,new I(f.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,i){let{appId:n,cname:r,cid:o,vid:s,sid:a,uid:c}=i;const d=Date.now(),u=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await(async(g,R,y)=>await hD(g.buffer,R,y))(u,n,r),E=this.sequence+"-"+o+"-"+c+"-"+d+"-"+Lt(12,""),m={appId:n,cid:o,cname:r,deviceId:"",elapse:ya.intToLong(Number(d-this.inspectStartTime)),fileSize:l.byteLength,jpgEncryption:2,height:u.height,width:u.width,jpg:l,networkType:6,osType:7,requestId:E,sdkVersion:"4.17.2",sequence:this.sequence,sid:a,timestamp:ya.intToLong(d),uid:c,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete m.callbackData,this.ossFilePrefix===void 0&&delete m.ossFilePrefix;const T=rD(m);if(T.byteLength<this.workerMessageLengthLimit){if(C("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const g=function(R){for(var y=1;y<arguments.length;y++){var A=arguments[y]!=null?arguments[y]:{};y%2?zg(Object(A),!0).forEach(function(P){h(R,P,A[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(R,Object.getOwnPropertyDescriptors(A)):zg(Object(A)).forEach(function(P){Object.defineProperty(R,P,Object.getOwnPropertyDescriptor(A,P))})}return R}({},m);delete g.jpg,_.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(g))}return T}{const g=this.quality*this.qualityRatio;return this.quality=g,await this.generateRequestData(e,{appId:n,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Pi.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=ci.CLOSED,this.emit(ie.STATE_CHANGE,di.CLOSED)}}var Qg,Zg,$g,tT,eT,iT,nT,rT,oT,sT,aT,cT,dT,uT,lT,hT,pT,ET,_T,mT,fT,ST,gT,TT,RT,IT,vT,CT,yT,AT,OT,bT,wT,NT,DT,PT,LT,kT,U;function MT(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Go(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?MT(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):MT(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let ED=(Qg=Y(),Zg=Y({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),e.map(i=>i?Object(i).toString():"null"))}),$g=Y({argsMap:(t,e)=>(e||(e=[]),Array.isArray(e)||(e=[e]),e.map(i=>i.getTrackId()))}),tT=Y({argsMap:(t,e,i)=>[e.uid,i]}),eT=Y({argsMap:(t,e)=>e.map(i=>{let{user:n,mediaType:r}=i;return[n==null?void 0:n.uid,r]})}),iT=Y({argsMap:(t,e,i)=>[e.uid,i]}),nT=Y({argsMap:(t,e)=>e.map(i=>{let{user:n,mediaType:r}=i;return{uid:n==null?void 0:n.uid,mediaType:r}})}),rT=Y(),oT=Y(),sT=Y(),aT=Y(),cT=Y(),dT=Y(),uT=Y(),lT=Y(),hT=Y(),pT=Y(),ET=Y(),_T=Y(),mT=Y(),fT=Y(),ST=Y({argsMap:(t,e)=>[e]}),gT=Y(),TT=Y(),RT=Y(),IT=Y(),vT=Y(),CT=Y(),yT=Y(),AT=Y(),OT=Y(),bT=Y(),wT=Y({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),NT=Y(),DT=Y(),PT=Y(),LT=Y({reportResult:!0}),kT=Y(),w((U=class extends Gt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t){let e;if(super(),h(this,"store",void 0),h(this,"_uid",void 0),h(this,"_channelName",void 0),h(this,"_uintUid",void 0),h(this,"_users",[]),h(this,"_codec",void 0),h(this,"_mode",void 0),h(this,"_config",void 0),h(this,"_clientId",void 0),h(this,"_appId",void 0),h(this,"_sessionId",null),h(this,"_key",void 0),h(this,"_joinInfo",void 0),h(this,"_gateway",void 0),h(this,"_statsCollector",void 0),h(this,"_configDistribute",void 0),h(this,"_leaveMutex",new Ve("client-leave")),h(this,"_publishMutex",new Ve("client-publish")),h(this,"_renewTokenMutex",new Ve("client-renewtoken")),h(this,"_subscribeMutex",new Ve("client-subscribe")),h(this,"_encryptionMode","none"),h(this,"_encryptionSecret",null),h(this,"_encryptionSalt",null),h(this,"_proxyServer",void 0),h(this,"_turnServer",{servers:[],mode:"auto"}),h(this,"_cloudProxyServerMode","disabled"),h(this,"_isDualStreamEnabled",!1),h(this,"_defaultStreamFallbackType",void 0),h(this,"_lowStreamParameter",void 0),h(this,"_streamFallbackTypeCacheMap",new Map),h(this,"_remoteStreamTypeCacheMap",new Map),h(this,"_axiosCancelSource",Pi.CancelToken.source()),h(this,"_audioVolumeIndicationInterval",void 0),h(this,"_networkQualityInterval",void 0),h(this,"_userOfflineTimeout",void 0),h(this,"_streamRemovedTimeout",void 0),h(this,"_injectStreamingClient",void 0),h(this,"_liveTranscodeStreamingClient",void 0),h(this,"_liveRawStreamingClient",void 0),h(this,"_channelMediaRelayClient",void 0),h(this,"_networkQualitySensitivity","normal"),h(this,"_p2pChannel",void 0),h(this,"_useLocalAccessPoint",!1),h(this,"_setLocalAPVersion",void 0),h(this,"_joinAndNotLeaveYet",!1),h(this,"_numberOfJoinCount",0),h(this,"_remoteDefaultVideoStreamType",void 0),h(this,"_inspect",void 0),h(this,"_license",void 0),h(this,"_handleLocalTrackEnable",(i,n,r)=>{this.publish(i,!1).then(n).catch(r)}),h(this,"_handleLocalTrackDisable",(i,n,r)=>{this.unpublish(i).then(n).catch(r)}),h(this,"_handleUserOnline",i=>{if(C("BLOCK_LOCAL_CLIENT")&&sr(i.uid,this.channelName))return void _.debug("[".concat(i.uid,"] will be ignored in local"));this.isStringUID&&typeof i.uid!="string"&&_.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const n=this._users.find(r=>r.uid===i.uid);if(n)n._trust_in_room_=!0;else{const r=new Iu(i.uid,i.uint_id||i.uid);this._users.push(r),_.debug("[".concat(this._clientId,"] user online"),i.uid),this.emit(nt.USER_JOINED,r)}}),h(this,"_handleUserOffline",i=>{if(C("BLOCK_LOCAL_CLIENT")&&sr(i.uid,this.channelName))return;const n=this._users.find(r=>r.uid===i.uid);n&&(this._handleRemoveStream(i),lu(this._users,n),this._remoteStreamTypeCacheMap.delete(n.uid),this._streamFallbackTypeCacheMap.delete(n.uid),_.debug("[".concat(this._clientId,"] user offline"),i.uid,"reason:",i.reason),this.emit(nt.USER_LEAVED,n,i.reason))}),h(this,"_handleAddAudioOrVideoStream",(i,n,r,o,s,a,c)=>{if(C("BLOCK_LOCAL_CLIENT")&&sr(n,this.channelName))return;const d=this._users.find(l=>l.uid===n);if(!d)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(n,", type ").concat(i)),this.store.subscribe(d.uid,i,void 0,void 0,void 0,Date.now());const u=i==="audio"?d.hasAudio:d.hasVideo;d._uintid||(d._uintid=s||n),i==="audio"?d._trust_audio_stream_added_state_=!0:d._trust_video_stream_added_state_=!0,i==="audio"?(d._audio_added_=!0,r!==void 0&&(d._audioSSRC=r),o!==void 0&&(d._cname=o),a&&(d._audioOrtc=a)):(d._video_added_=!0,r!==void 0&&(d._videoSSRC=r),o!==void 0&&(d._cname=o),c!==void 0&&(d._rtxSsrcId=c),a&&(d._videoOrtc=a)),(i==="audio"?d.hasAudio:d.hasVideo)&&!u&&(_.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published ").concat(i)),this.emit(nt.USER_PUBLISHED,d,i)),i==="video"?G.onGatewayStream(this._sessionId,Te.ON_ADD_VIDEO_STREAM,Ut.ON_ADD_VIDEO_STREAM,{peer:s||n}):G.onGatewayStream(this._sessionId,Te.ON_ADD_AUDIO_STREAM,Ut.ON_ADD_AUDIO_STREAM,{peer:s||n}),this._p2pChannel.remoteMediaSsrcChanged(d,i,r).then(l=>{if(l)return _.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(d.uid," after rejoin because SSRC id changed.")),this._p2pChannel.unsubscribe(d,i,!0).then(()=>this._subscribe(d,i,!0).catch(E=>{_.error("[".concat(this._clientId,"] resubscribe error"),E.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(d,i)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(d.uid," after reconnect.")),this._subscribe(d,i,!0).catch(l=>{_.error("[".concat(this._clientId,"] resubscribe error"),l.toString())}))}),h(this,"_handleRemoveStream",i=>{if(C("BLOCK_LOCAL_CLIENT")&&sr(i.uid,this.channelName))return;const n=this._users.find(o=>o.uid===i.uid);if(!n)return void _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));_.debug("[".concat(this._clientId,"] stream removed with uid ").concat(i.uid));let r=()=>{};n.hasAudio&&n.hasVideo?r=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished audio track")),this.emit(nt.USER_UNPUBLISHED,n,"audio"),_.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished video track")),this.emit(nt.USER_UNPUBLISHED,n,"video")}:n.hasVideo?r=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished video track")),this.emit(nt.USER_UNPUBLISHED,n,"video")}:n.hasAudio&&(r=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished audio track")),this.emit(nt.USER_UNPUBLISHED,n,"audio")}),n._trust_audio_stream_added_state_=!0,n._trust_video_stream_added_state_=!0,n._audio_added_=!1,n._video_added_=!1,this._p2pChannel.unsubscribe(n).then(o=>{if(o)return this._gateway.unsubscribe(o,n.uid)}),n._audioSSRC=void 0,n._videoSSRC=void 0,n._audioOrtc=void 0,n._videoOrtc=void 0,n._rtxSsrcId=void 0,G.onGatewayStream(this._sessionId,Te.ON_REMOVE_STREAM,Ut.ON_REMOVE_STREAM,{peer:i.uint_id||i.uid}),r()}),h(this,"_handleSetStreamLocalEnable",(i,n,r)=>{if(C("BLOCK_LOCAL_CLIENT")&&sr(n,this.channelName))return;const o=this._users.find(c=>c.uid===n);if(!o)return void _.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));_.debug("[".concat(this._clientId,"] local ").concat(i," ").concat(r?"enabled":"disabled"," with uid ").concat(n));const s=i==="audio"?o.hasAudio:o.hasVideo;if(i==="audio"){o._trust_audio_enabled_state_=!0;const c=o._audio_enabled_;if(o._audio_enabled_=r,o._audio_enabled_===c)return;{const d=o._audio_enabled_?"enable-local-audio":"disable-local-audio";_.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(n,", msg: ").concat(d)),this.emit(nt.USER_INFO_UPDATED,n,d)}}else{o._trust_video_enabled_state_=!0;const c=o._video_enabled_;if(o._video_enabled_=r,o._video_enabled_===c)return;{const d=o._video_enabled_?"enable-local-video":"disable-local-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(d)),this.emit(nt.USER_INFO_UPDATED,n,d)}}const a=i==="audio"?o.hasAudio:o.hasVideo;return s!==a?!s&&a?(_.info("[".concat(this._clientId,"] remote user ").concat(n," published ").concat(i)),void this.emit(nt.USER_PUBLISHED,o,i)):(i==="video"&&o._videoTrack&&o._videoTrack._destroy(),i==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,i),_.info("[".concat(this._clientId,"] remote user ").concat(n," unpublished ").concat(i)),void this.emit(nt.USER_UNPUBLISHED,o,i)):void 0}),h(this,"_handleMuteStream",(i,n,r)=>{if(C("BLOCK_LOCAL_CLIENT")&&sr(i,this.channelName))return;_.debug("[".concat(this._clientId,"] receive mute message"),i,n,r);const o=this._users.find(c=>c.uid===i);if(!o)return void _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(i));const s=n==="audio"?o.hasAudio:o.hasVideo;if(n==="audio"){o._trust_audio_mute_state_=!0;const c=o._audio_muted_;if(o._audio_muted_=r,o._audio_muted_===c)return;{const d=o._audio_muted_?"mute-audio":"unmute-audio";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(d)),this.emit(nt.USER_INFO_UPDATED,i,d)}}else{o._trust_video_mute_state_=!0;const c=o._video_muted_;if(o._video_muted_=r,o._video_muted_===c)return;{const d=o._video_muted_?"mute-video":"unmute-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(d)),this.emit(nt.USER_INFO_UPDATED,i,d)}}const a=n==="audio"?o.hasAudio:o.hasVideo;if(s!==a){if(!s&&a)return(n==="audio"?o._audioSSRC:o._videoSSRC)?(_.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(n)),void this.emit(nt.USER_PUBLISHED,o,n)):void _.warning("[".concat(this._clientId,"] remote user ").concat(i," receive ").concat(n," unmute message  before add stream message, ").concat(n," SSRC doesn't exist yet."));n==="video"&&o._videoTrack&&o._videoTrack._destroy(),n==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,n),_.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(n)),this.emit(nt.USER_UNPUBLISHED,o,n)}}),h(this,"_handleP2PLost",async i=>{_.debug("[".concat(this._clientId,"] receive p2p lost"),i),parseInt(i.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():_.warning("P2PLost stream not found",i)}),h(this,"_handleTokenWillExpire",()=>{_.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.emit(nt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),h(this,"_handleBeforeUnload",i=>{i.type==="beforeunload"&&i.returnValue!==void 0&&i.returnValue!==""||(this.leave(),_.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),h(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.emit(nt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const i={downlinkNetworkQuality:0,uplinkNetworkQuality:0};i.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),i.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.emit(nt.NETWORK_QUALITY,i)}),this._codec=t.codec,this._mode=t.mode,this._clientId=Lt(5,"client-"),this.store=new iD(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),_.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(gi," build: ").concat(Ad,", mode: ").concat(this._mode,", codec: ").concat(this._codec)),t.clientRoleOptions)try{I_(t.clientRoleOptions),e=Object.assign({},t.clientRoleOptions)}catch(i){_.warning("[".concat(this._clientId,"] ").concat(i.toString()))}this._statsCollector=new Kr(this.store),this._statsCollector.onStatsException=(i,n,r)=>{_.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(i,", msg: ").concat(n,", uid: ").concat(r)),this.emit(nt.EXCEPTION,{code:i,msg:n,uid:r})},this._statsCollector.onUploadPublishDuration=(i,n,r,o)=>{const s=this._users.find(a=>a.uid===i);s&&G.peerPublishStatus(this._sessionId,{subscribeElapse:o,audioPublishDuration:n,videoPublishDuration:r,peer:s._uintid})},this.store.useDataChannel=le().supportDataChannel&&C("SIGNAL_CHANNEL"),this._gateway=new jN(this.store,{clientId:this._clientId,mode:this._mode,codec:this._codec,websocketRetryConfig:t.websocketRetryConfig||ne,httpRetryConfig:t.httpRetryConfig||ne,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:e}),this._config=t,this._configDistribute=new XN,this._p2pChannel=new eD(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async join(t,e,i,n,r){const o=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);const s=nD(),a=Gg()?window.isSecureContext:"Browser Not Support";if(!Gg()&&!s||!window.isSecureContext){const m="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";_.warning(m)}const c=uu();this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),_.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const d=G.reportApiInvoke(c,{name:$t.JOIN,options:[t,e,i,n],states:{isHttps:s,isSecureContext:a},tag:Mt.TRACER});G.setAppId(t);try{if(!i&&i!==null)throw new I(f.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Se(i,"token",1,2047),Se(t,"appid",1,2047),Ud(e),n&&xd(n),r&&Se(r,"optionalInfo",1,2047)}catch(m){throw d.onError(m),m}if(_.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._leaveMutex.isLocked&&(_.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),_.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const m=new I(f.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw d.onError(m),m}this._sessionId||(this._sessionId=c,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const u=Go({clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof n!="string"?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(u.setLocalAPVersion=this._setLocalAPVersion),typeof n=="string"&&(u.stringUid=n,this._uintUid?(u.uid=this._uintUid,this._uintUid=void 0):u.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(u.aesmode=this._encryptionMode,u.aespassword=await(async m=>{const T=hu(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),g=await window.crypto.subtle.importKey("spki",T,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),R=tu(m),y=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},g,R);return sa(new Uint8Array(y))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new I(f.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(u.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:e,appId:t});const l=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&l===this._sessionId&&G.joinChannelTimeout(this._sessionId,5)},5e3);try{let m;const T=u.cloudProxyServer;if(["proxy3","proxy4","proxy5"].includes(T)){const A=C("PROXY_SERVER_TYPE3");Array.isArray(A)?u.proxyServer=A[0]:u.proxyServer=A}if(G.setProxyServer(u.proxyServer),_.setProxyServer(u.proxyServer),this.store.requestAPStart(),u.stringUid&&!u.uid){const A=await Of(u.stringUid,u,this._axiosCancelSource.token,this._config.httpRetryConfig||ne,this.store);_.debug("getUserAccount Success ".concat(u.stringUid," => ").concat(A)),u.uid=A,m=await Af(u,this._axiosCancelSource.token,this._config.httpRetryConfig||ne,!0,this.store)}else m=await Af(u,this._axiosCancelSource.token,this._config.httpRetryConfig||ne,!0,this.store);if(!this._joinAndNotLeaveYet)throw new I(f.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(u,this._axiosCancelSource.token),this._configDistribute.on(vo.UPDATE_BITRATE_LIMIT,A=>{this._p2pChannel.updateBitrateLimit(A)})},0),this._key=i||t;const g=m.gatewayInfo;this._joinInfo=Go(Go({},u),{},{cid:g.cid,uid:u.uid?u.uid:g.uid,vid:g.vid,apResponse:g.res,uni_lbs_ip:g.uni_lbs_ip,gatewayAddrs:g.gatewayAddrs});const R=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new I(f.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));d.onSuccess(R),this._appId=t,this._channelName=u.cname,this._uid=R,this.store.uid=R,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Le()?"beforeunload":"pagehide",this._handleBeforeUnload)},0);const y=u.stringUid?"string uid: ".concat(u.stringUid,",uid: ").concat(u.uid):"uid: ".concat(this._uid);return _.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(y)),setTimeout(()=>{_.startUpload()},5e3),this.store.joinEnd(),E=this,or.includes(E)||or.push(E),R}catch(m){const T=Array.isArray(m)?m[0]:m;throw _.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),T),T.code!==f.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),d.onError(T),T}var E}_joinGateway(){if(!this._joinInfo||!this._key)throw new I(f.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!C("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(t=>t).catch(t=>{if(t.code===f.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,_t.FALLBACK),t;if(t.code===f.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,_t.FALLBACK),t;throw t}).then(t=>{if(t instanceof I){if(t.code===f.INIT_WEBSOCKET_TIMEOUT){if(_.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new I(f.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=C("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const n=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),r=n.slice(n.length-2).join(".");e.forEach(o=>{this._joinInfo&&o.includes(r)&&(this._joinInfo.proxyServer=o)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const i=C("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return i&&i[1]&&i[1]!=="443"&&_.setProxyServer(this._joinInfo.proxyServer),C("STATS_COLLECTOR_PORT").toString()!=="443"&&G.setProxyServer(this._joinInfo.proxyServer),G.reportApiInvoke(this._sessionId,{name:$t.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:Mt.TRACER}).onSuccess(),this.emit(nt.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),C("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(n=>{"forceturn"in n&&(n.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(_.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new I(f.INVALID_OPERATION);return G.reportApiInvoke(this._sessionId,{name:$t.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:Mt.TRACER}).onSuccess(),this._joinGateway()}return t}).then(t=>t)}async leave(){_.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Le()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const i=or.indexOf(e);i!==-1&&or.splice(i,1)}(this);const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return _.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED"),_.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(Array.isArray(t)||(t=[t]),t.length===0)throw new I(f.INVALID_PARAMS,"track list is empty");if(this._gateway.role==="audience")throw new I(f.INVALID_OPERATION,"audience can not publish stream");for(const n of t){if(!(n instanceof eu))throw new I(f.INVALID_PARAMS,"parameter is not local track");if(!n._enabled&&e)throw new I(f.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(n.getTrackId()))}_.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(t.map(n=>"".concat(n.getTrackId()," ")))),await this._configDistribute.awaitConfigDistributeComplete(),e&&t.forEach(n=>{const r=this._configDistribute.getBitrateLimit();n instanceof zt&&r&&n.setBitrateLimit(r.uplink)});const i=await this._publishMutex.lock();try{await this._publishHighStream(t),_.info("[".concat(this._clientId,"] Publish success, id ").concat(t.map(n=>"".concat(n.getTrackId()," "))))}catch(n){throw _.error("[".concat(this._clientId,"] publish error"),n.toString()),n}finally{i()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new I(f.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");t?Array.isArray(t)||(t=[t]):t=this._p2pChannel.getAllTracks(!0),_.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map(i=>"".concat(i.getTrackId()," "))," "));const e=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublish(t);i&&await this._gateway.unpublish(i,this._uid),_.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map(n=>"".concat(n.getTrackId()))))}catch(i){throw _.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{e&&e()}}async subscribe(t,e){return this._subscribe(t,e)}async _subscribe(t,e,i){if(ce(e,"mediaType",["audio","video"]),!this._joinInfo)throw new I(f.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new I(f.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(c=>c===t)){const c=new I(f.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),c}if(!t.hasAudio&&!t.hasVideo){const c=new I(f.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),c}if(!(i||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){const c=new I(f.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),c}const n=e==="audio"?t._audioSSRC:t._videoSSRC,r=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,s={stream_type:e==="audio"?Z.AUDIO:Z.VIDEO,ssrcId:n},a=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{Ri.markSubscribeStart(this.store.clientId,n),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,n,o,r);try{await this._gateway.subscribe(t.uid,s,!0)}catch(d){if((d==null?void 0:d.code)!==f.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),d;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(d){throw this._p2pChannel.reportSubscribeEvent(!1,d==null?void 0:d.code,t,e),d}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(d=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),d)});const c=e==="audio"?t._audioTrack:t._videoTrack;if(!c)throw new I(f.UNEXPECTED_ERROR,"can not find remote track in user object");return c}catch(c){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),c),c}finally{a()}}async massSubscribe(t){if(_n(t,"subscribeList"),!this._joinInfo)throw new I(f.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new I(f.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),i=new Map,n=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(a=>{let{user:c,mediaType:d}=a;return"user: ".concat(c==null?void 0:c.uid,", mediaType: ").concat(d)}).join("; ")));const r=(t=[...t]).map(a=>{let{user:c,mediaType:d}=a;return{user:c,mediaType:d}}),o=await this._p2pChannel.globalLock();try{var s;for(let c=t.length-1;c>=0;c--){const d=t[c],{user:u,mediaType:l}=d;if(ce(l,"mediaType",["audio","video"]),!u){const T=new I(f.INVALID_PARAMS,"user property does not exist in subscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),T}if(!this._users.find(T=>T===u)){const T=new I(f.INVALID_REMOTE_USER,"user is not in the channel");_.error("[".concat(this._clientId,"] can not massSubscribe ").concat(u.uid,", this user is not in the channel")),r[c].error=T,t.splice(c,1);continue}if(l==="audio"&&(!u.hasAudio||u._audioSSRC===void 0)||l==="video"&&(!u.hasVideo||u._videoSSRC===void 0)){const T=new I(f.REMOTE_USER_IS_NOT_PUBLISHED);_.error("[".concat(this._clientId,"] can not subscribe ").concat(u.uid," with mediaType ").concat(l,", remote user is not published")),r[c].error=T,t.splice(c,1);continue}const E=qt.Video|qt.LwoVideo,m=i.get(u);if(m){if(l==="video"?m&E:m&qt.Audio){t.splice(c,1),_.warning("repeat massSubscribe user:".concat(u.uid,", mediaType:").concat(l," twice"));continue}i.set(u,m|(l==="video"?E:qt.Audio))}else i.set(u,l==="video"?E:qt.Audio)}for(let c=t.length-1;c>=0;c--){const d=t[c],{user:u,mediaType:l}=d,E=qt.Video|qt.LwoVideo;if(this._p2pChannel.hasRemoteMedia(u,l)){await this._p2pChannel.unmuteRemoteNoLock(u,l);const m=i.get(u);i.set(u,l==="video"?m^E:m^qt.Audio),t.splice(c,1)}}this.store.massSubscribe(t.map(c=>({userId:c.user.uid,type:c.mediaType})),e);const a=On(s=Array.from(i.entries())).call(s,(c,d)=>{let[u,l]=d;if(l===0)return c;const E={stream_id:u.uid,stream_type:l};return l&qt.Audio&&(E.audio_ssrc=u._audioSSRC),l&qt.Video&&(E.video_ssrc=u._videoSSRC),c.push(E),c},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(d=>{let{user:u,mediaType:l}=d;return{user:u,mediaType:l,ssrcId:l===Z.VIDEO?u._videoSSRC:u._audioSSRC,rtxSsrcId:u._rtxSsrcId}}));const c=new Map;if(a.length>0){const d=await this._gateway.subscribeAll(a,!0);((d==null?void 0:d.users)||[]).forEach(u=>{let{stream_id:l,video_error_code:E,audio_error_code:m,error_code:T}=u;(E||m||T)&&c.set(l,{video_error_code:E,audio_error_code:m,error_code:T})})}if(Array.from(c.entries()).length>0){const d=Array.from(c.entries()).map(u=>{let l,[E,m]=u;return m.error_code||m.video_error_code&&m.audio_error_code?l=void 0:m.video_error_code?l=Z.VIDEO:m.audio_error_code&&(l=Z.AUDIO),{user:this.remoteUsers.find(T=>T.uid===E),mediaType:l}});await this._p2pChannel.massUnsubscribeNoLock(d)}for(const d of r){const u=c.get(d.user.uid);if(u){const l=u.error_code||d.mediaType==="audio"&&u.audio_error_code||d.mediaType==="video"&&u.video_error_code;if(l){const E=Oo(l);_.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(E.desc)),d.error=new I(f.SUBSCRIBE_FAILED,"code ".concat(l,": ").concat(E.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter(d=>!d.error).map(d=>({userId:d.user.uid,type:d.mediaType})),void 0,Date.now()),r.forEach(d=>{var u;G.subscribe(this.store.sessionId,{succ:!!d.error,ec:((u=d.error)===null||u===void 0?void 0:u.code)||null,video:d.mediaType===Z.VIDEO,audio:d.mediaType===Z.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===Z.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e)},!0)}),_.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(d=>{let{user:u,mediaType:l}=d;return"user: ".concat(u==null?void 0:u.uid,", mediaType: ").concat(l)}).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(t),c}}finally{o(),n()}}async unsubscribe(t,e){if(e&&ce(e,"mediaType",["audio","video"]),!this._joinInfo)throw new I(f.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(i=>i===t)){const i=new I(f.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),i}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));try{const i=await this._p2pChannel.unsubscribe(t,e);i&&await this._gateway.unsubscribe(i,t.uid),_.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}catch(i){if(i.code===f.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),i.toString()),i}}async massUnsubscribe(t){if(_n(t,"unsubscribeList"),!this._joinInfo)throw new I(f.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");_.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(i=>{let{user:n,mediaType:r}=i;return"user: ".concat(n==null?void 0:n.uid,", mediaType: ").concat(r,";")}).join())),t=[...t];const e=new Map;for(let i=t.length-1;i>=0;i--){const{user:n,mediaType:r}=t[i];if(!n){const s=new I(f.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),s}if(ce(r,"mediaType",["video","audio",void 0]),!this._users.find(s=>s===n)){_.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),t.splice(i,1);continue}const o=qt.Video|qt.LwoVideo;if(e.has(n)){const s=e.get(n);let a;switch(r){case"video":a=s&o;break;case"audio":a=s&qt.Audio;break;default:a=s&(qt.Audio|o)}if(a){_.warning("repeat massUnsubscribe user:".concat(n.uid,",mediaType:").concat(r," twice.")),t.splice(i,1);continue}r?r==="audio"?e.set(n,s|qt.Audio):r==="video"&&e.set(n,s|o):e.set(n,s|qt.Audio|o)}else r?r==="audio"?e.set(n,qt.Audio):r==="video"&&e.set(n,o):e.set(n,qt.Audio|o)}try{const i=await this._p2pChannel.massUnsubscribe(t);i&&await this._gateway.massUnsubscribe(i),_.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(n=>{let{user:r,mediaType:o}=n;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(o,";")}).join()))}catch(i){if(i.code===f.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] massUnsubscribe error"),i.toString()),i}}setLowStreamParameter(t){(function(i){if(!i)throw new I(f.INVALID_PARAMS);Pt(i.width)||Md(i.width,"streamParameter.width"),Pt(i.height)||Md(i.height,"streamParameter.height"),Pt(i.framerate)||Md(i.framerate,"streamParameter.framerate"),Pt(i.bitrate)||Nt(i.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&_.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),_.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t}async enableDualStream(){if(!le().supportDualStream)throw G.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new I(f.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new I(f.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw G.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,G.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),_.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new I(f.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(F.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw G.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,G.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),_.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(i){ce(i,"role",["audience","host"])}(t),e&&I_(e),this._mode==="rtc")throw _.warning("[".concat(this._clientId,"]rtc mode can not use setClientRole")),new I(f.INVALID_OPERATION,"rtc mode can not use setClientRole");if(e&&e.level&&t==="host")throw new I(f.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new I(f.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,e),_.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))}setProxyServer(t,e){if(Se(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new I(f.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new I(f.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,G.setProxyServer(this._proxyServer),_.setProxyServer(this._proxyServer),_.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new I(f.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new I(f.INVALID_OPERATION,"You have already set the proxy")}if(Io(t))return this._turnServer={servers:t,mode:"original-manual"},void _.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(i=>i.urls).join(","),"."));t.forEach(i=>R_(i)),this._turnServer={servers:t,mode:"manual"},_.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new I(f.INVALID_OPERATION,"you should set license before join channel");if(Se(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new I(f.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,_.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new I(f.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new I(f.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let i;switch(t===void 0&&(t=3),t){case 1:case 2:throw new I(f.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new I(f.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new I(f.INVALID_OPERATION,"Stop proxy server after leave channel");G.setProxyServer(),_.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new I(f.INVALID_PARAMS,"accessPoints is required.");_n(t.accessPoints.serverList,"accessPoints.serverList"),Se(t.accessPoints.domain,"accessPoints.domain");const e=(E,m)=>{Nt(E,m,0,65535,!0)};let i=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),i=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new I(f.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");C("CLOSE_AFB_FOR_LOCAL_AP")&&(Ct("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Ct("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=t.accessPoints.domain,o=t.accessPoints.serverList.map(E=>n.test(E)?"".concat(E.replace(/\./g,"-"),".").concat(r):E),s=o.map(E=>"".concat(E,":").concat(i));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Ct("WEBCS_DOMAIN",s),Ct("WEBCS_DOMAIN_BACKUP_LIST",s),Ct("GATEWAY_DOMAINS",[r]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(_n(t.report.hostname,"report.hostname"),Ct("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Ct("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Ct("EVENT_REPORT_DOMAIN",o[0]),Ct("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),Ct("STATS_COLLECTOR_PORT",a),t.report?Ct("ENABLE_EVENT_REPORT",!0):Ct("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(_n(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=o[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),Ct("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let u=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(_n(t.cds.hostname,"cds.hostname"),u=t.cds.hostname):u=o;let l=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),l=t.cds.port),Ct("CDS_AP",u.map(E=>"".concat(E,":").concat(l))),t.cds?Ct("ENABLE_CONFIG_DISTRIBUTE",!0):Ct("ENABLE_CONFIG_DISTRIBUTE",!1),_.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(_n(t,"serverList"),Se(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new I(f.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(n=>i.test(n)?"".concat(n.replace(/\./g,"-"),".").concat(e):n),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Ct("WEBCS_DOMAIN",t),Ct("WEBCS_DOMAIN_BACKUP_LIST",t),Ct("GATEWAY_DOMAINS",[e]),Ct("EVENT_REPORT_DOMAIN",t[0]),Ct("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Ct("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),_.info("set local access point success")}async setRemoteDefaultVideoStreamType(t){if(ce(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw _.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else _.debug("haven't joined yet, cache remoteDefaultVideoStreamType ".concat(t))}async setRemoteVideoStreamType(t,e){ce(e,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{const i=this._users.find(n=>n.uid===t);i&&i.videoTrack&&i.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(i){throw _.error("[".concat(this._clientId,"] set remote video stream type error"),i.toString()),i}_.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){ce(e,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(i){throw _.error("[".concat(this._clientId,"] set stream fallback option"),i.toString()),i}_.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,i){if(function(n){ce(n,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])}(t),Se(e,"secret"),["aes-128-gcm2","aes-256-gcm2"].includes(t)){if(!i||!(i instanceof Uint8Array&&i.length===32))throw new I(f.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new I(f.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||_.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,i&&(this._encryptionSalt=sa(i))}async renewToken(t){if(Se(t,"token",1,2047),!this._key||!this._joinInfo)throw new I(f.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const i=await this._renewTokenMutex.lock();try{if(C("USE_NEW_TOKEN")){_.debug("start renew token with ticket from unilbs");const n=await JN(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||ne);_.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:n})}else _.debug("start renew token without ticket"),await this._gateway.renewToken({token:t});_.debug("[".concat(this._clientId,"] renewToken success"))}catch(n){throw this._key=e,this._joinInfo.token=e,_.error("[".concat(this._clientId,"] renewToken failed"),n.toString()),n}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?_.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const t=this._p2pChannel.getAudioLevels();this.emit(nt.VOLUME_INDICATOR,t)},C("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this._codec!=="h264")throw new I(f.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new I(f.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new I(f.LIVE_STREAMING_TASK_CONFLICT);const i=e?te.TRANSCODE:te.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(t,i)}setLiveTranscoding(t){return this._createLiveStreamingClient(te.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(i=>i&&i.hasUrl(t));if(!e.length)throw new I(f.INVALID_PARAMS,"can not find live streaming url to stop");await V.all(e.map(i=>i&&i.stopLiveStreamingTask(t)))}async addInjectStreamUrl(t,e){if(!this._joinInfo)throw new I(f.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(te.INJECT);i.setInjectStreamConfig(e,0),await i.startLiveStreamingTask(t,te.INJECT)}async removeInjectStreamUrl(){var t;const e=this._createLiveStreamingClient(te.INJECT),i=Array.from(nn(t=e.streamingTasks).call(t)).find(n=>n.mode===te.INJECT);if(!this._joinInfo||!i)throw new I(f.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(t){Mf(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){Mf(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay()}sendStreamMessage(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new I(f.INVALID_OPERATION,"can not send data stream, not joined");if(typeof t=="string"&&(t=new TextEncoder().encode(t)),new Blob([t]).size>1024)throw new I(f.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(q.DATA_STREAM,{payload:sa(t)},!e)}sendMetadata(t){if(!this._joinInfo)throw new I(f.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new I(f.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(q.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:sa(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(cw),!this._joinInfo)throw new I(f.INVALID_OPERATION,"can not send custom report, not joined");await G.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){ce(e.spatialLayer,"spatialLayer",[0,1,2,3]),ce(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(i){throw _.error("[".concat(this._clientId,"] pick SVC layer failed"),i.toString()),i}}_reset(){if(_.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=Pi.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy()}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Ve("client-publish"),this._subscribeMutex=new Ve("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}}_startSession(t,e){const i=t||uu();t?_.debug("[".concat(this._clientId,"] new Session ").concat(i)):_.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i)),this._sessionId=i,this.store.sessionId=i,e?G.sessionInit(this._sessionId,{lts:new Date().getTime(),cname:e.channel,appid:e.appId,mode:this._mode}):this._joinInfo?G.sessionInit(this._sessionId,{lts:new Date().getTime(),cname:this._joinInfo.cname,appid:this._joinInfo.appId,mode:this._mode}):this._gateway.joinInfo&&G.sessionInit(this._sessionId,{lts:new Date().getTime(),cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId,mode:this._mode}),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new I(f.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new I(f.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&C("FORCE_TURN")&&!C("TURN_ENABLE_TCP")&&!C("TURN_ENABLE_UDP"))throw new I(f.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");_.debug("[".concat(this._clientId,"] publish high stream"));try{const i=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter),n=(await i.next()).value;if(n){var e;let r;try{r=await this._gateway.publish(this._uid,n,!0)}catch(o){if(o.code!==f.DISCONNECT_P2P)throw i.throw(o),o}await i.next(((e=r)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of t)r instanceof zt&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,t),(i==null?void 0:i.code)===f.WS_ABORT)return;throw i}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new I(f.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new I(f.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));_.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const i=await this._p2pChannel.publishLowStream(this._lowStreamParameter),n=(await i.next()).value;if(n){var e;let r;try{r=await this._gateway.publish(this._uid,n,!0)}catch(o){if(o.code!==f.DISCONNECT_P2P)throw i.throw(o),o}i.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,void 0,!0),(i==null?void 0:i.code)===f.WS_ABORT)return;throw i}}_createLiveStreamingClient(t){if(!this._joinInfo||!this._appId)return new I(f.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const e=()=>new QN(this._joinInfo,this._config.websocketRetryConfig||ne,this._config.httpRetryConfig||ne),i=n=>{n.onLiveStreamError=(r,o)=>{G.reportApiInvoke(this._sessionId,{name:$t.ON_LIVE_STREAM_ERROR,options:[r,o],tag:Mt.TRACER}).onSuccess(),this.emit(nt.LIVE_STREAMING_ERROR,r,o)},n.onLiveStreamWarning=(r,o)=>{G.reportApiInvoke(this._sessionId,{name:$t.ON_LIVE_STREAM_WARNING,options:[r,o],tag:Mt.TRACER}).onSuccess(),this.emit(nt.LIVE_STREAMING_WARNING,r,o)},n.on(Fr.REQUEST_WORKER_MANAGER_LIST,(r,o,s)=>{if(!this._joinInfo)return s(new I(f.INVALID_OPERATION,"can not find join info to get worker manager"));wf(r,this._joinInfo,this._axiosCancelSource.token,ne).then(o).catch(s)})};switch(t){case te.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=e(),i(this._liveRawStreamingClient)),this._liveRawStreamingClient;case te.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=e(),i(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case te.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=e(),this._injectStreamingClient.on(Fr.REQUEST_WORKER_MANAGER_LIST,(n,r,o)=>{if(!this._joinInfo)return o(new I(f.INVALID_OPERATION,"can not find join info to get worker manager"));wf(n,this._joinInfo,this._axiosCancelSource.token,ne).then(r).catch(o)}),this._injectStreamingClient.onInjectStatusChange=(n,r,o)=>{this.emit(nt.INJECT_STREAM_STATUS,n,r,o)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){return this._joinInfo?(this._channelMediaRelayClient||(this._channelMediaRelayClient=new $N(this._joinInfo,this._clientId,this._config.websocketRetryConfig||ne,this._config.httpRetryConfig||ne),this._channelMediaRelayClient.on("state",t=>{t===Ge.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.emit(nt.CHANNEL_MEDIA_RELAY_STATE,t)}),this._channelMediaRelayClient.on("event",t=>{this.emit(nt.CHANNEL_MEDIA_RELAY_EVENT,t)})),this._channelMediaRelayClient):new I(f.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw()}_handleGatewayEvents(){this._gateway.on(kt.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(kt.CONNECTION_STATE_CHANGE,(t,e,i)=>{var n;if(i===_t.FALLBACK)return;const r=()=>{this.emit(nt.CONNECTION_STATE_CHANGE,t,e,i)};if(G.reportApiInvoke(this._sessionId||((n=this._gateway.joinInfo)===null||n===void 0?void 0:n.sid)||null,{name:$t.CONNECTION_STATE_CHANGE,options:[t,e,i],tag:Mt.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:i})),_.info("[".concat(this._clientId,"] connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void r();if(t==="RECONNECTING")this._users.forEach(s=>{s._trust_in_room_=!1,s._trust_audio_enabled_state_=!1,s._trust_video_enabled_state_=!1,s._trust_audio_mute_state_=!1,s._trust_video_mute_state_=!1,s._trust_audio_stream_added_state_=!1,s._trust_video_stream_added_state_=!1,s._audioSSRC=void 0,s._videoSSRC=void 0,s._videoOrtc=void 0,s._audioOrtc=void 0,s._cname=void 0,s._rtxSsrcId=void 0}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((s,a)=>{this._gateway.setStreamFallbackOption(a,s).catch(c=>{_.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)})}),this._remoteStreamTypeCacheMap.forEach((s,a)=>{this._gateway.setRemoteVideoStreamType(a,s).catch(c=>{_.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)})}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{_.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(s=>{_.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(s))}),this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(s=>!s._trust_in_room_).forEach(s=>{_.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(s.uid)),this._handleUserOffline({uid:s.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(s=>{s._trust_audio_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,"audio",!1)),s._trust_video_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,"video",!1)),s._trust_audio_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(s.uid)),this._handleSetStreamLocalEnable("audio",s.uid,!0)),s._trust_video_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(s.uid)),this._handleSetStreamLocalEnable("video",s.uid,!0)),s._trust_video_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(s.uid)),this._handleResetAddStream(s,"video")),s._trust_audio_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(s.uid)),this._handleResetAddStream(s,"audio")),s._video_added_||s._audio_added_||(_.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(s.uid)),this._handleRemoveStream({uid:s.uid,uint_id:s._uintid}))}))},1e3)}r()}),this._gateway.on(kt.REQUEST_NEW_GATEWAY_LIST,(t,e)=>{if(!this._joinInfo)return e(new I(f.UNEXPECTED_ERROR,"can not recover, no join info"));gu(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||ne,this.store).then(i=>{this._joinInfo&&(this._joinInfo.apResponse=i.gatewayInfo.res,this._joinInfo.gatewayAddrs=i.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=i.gatewayInfo.uni_lbs_ip),t(i.gatewayInfo.gatewayAddrs.map(n=>{if(this._joinInfo&&this._joinInfo.proxyServer){const r=n.address.split(":");return"wss://".concat(this._joinInfo.proxyServer,"/ws/?h=").concat(r[0],"&p=").concat(r[1])}return"wss://".concat(n.address)}))}).catch(e)}),this._gateway.on(kt.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.emit(nt.NETWORK_QUALITY,t)}),this._gateway.on(kt.STREAM_TYPE_CHANGE,(t,e)=>{this.emit(nt.STREAM_TYPE_CHANGED,t,e),G.reportApiInvoke(this._sessionId,{name:$t.STREAM_TYPE_CHANGE,options:[t,e],tag:Mt.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))}),this._gateway.on(kt.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(kt.NEED_RENEW_SESSION,()=>{this._startSession()}),this._gateway.on(kt.REQUEST_P2P_CONNECTION_PARAMS,async(t,e,i)=>{try{e(await this._p2pChannel.startP2PConnection(t))}catch(n){i(n)}}),this._gateway.on(kt.JOIN_RESPONSE,(t,e)=>{const{dtlsParameters:i,iceParameters:n,candidates:r,rtpCapabilities:o,setup:s,cname:a}=rg(t.ortc,e);this._p2pChannel.connect(n,i,r,o,s,a)}),this._gateway.on(kt.REQUEST_DC_CONNECTION_PARAMS,t=>{t(this._p2pChannel.getEstablishParams())}),this._gateway.on(kt.RESET_SIGNAL,t=>{this._p2pChannel.resetConnection(t),this._handleGatewaySignalEvents()}),this._gateway.on(kt.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(kt.DATACHANNEL_PRECONNECT,async(t,e,i,n)=>{var r,o,s,a,c,d;await this._p2pChannel.startP2PConnection({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},!0);const u=function(l,E){let m;return E&&E.ip&&typeof E.port=="number"?(m=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:E.ip,port:E.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(E.ip,":").concat(E.port)),E.ip6&&(m.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:E.ip6,port:E.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(E.ip6,":").concat(E.port)))):m=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:l.ip,port:l.port.toString(),type:"host",extension:{}}],m}(t,e);return this._p2pChannel.preConnect({iceUfrag:"".concat((o=this._joinInfo)===null||o===void 0?void 0:o.apResponse.cid,"_").concat((s=this._joinInfo)===null||s===void 0?void 0:s.apResponse.cert),icePwd:"".concat((a=this._joinInfo)===null||a===void 0?void 0:a.apResponse.cid,"_").concat((c=this._joinInfo)===null||c===void 0?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(d=C("FINGERPRINT"))!==null&&d!==void 0?d:t.fingerprint}]},u,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(i).catch(n)})}_handleGatewaySignalEvents(){this._gateway.signal.on(et.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(et.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(et.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(et.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(et.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(et.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(et.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,"audio",!0)),this._gateway.signal.on(et.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,"audio",!1)),this._gateway.signal.on(et.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,"video",!0)),this._gateway.signal.on(et.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,"video",!1)),this._gateway.signal.on(et.RECEIVE_METADATA,t=>{const e=hu(t.metadata);this.emit(nt.RECEIVE_METADATA,t.uid,e)}),this._gateway.signal.on(et.ON_DATA_STREAM,t=>{t.seq&&delete t.seq,t.payload=hu(t.payload),this.emit(nt.STREAM_MESSAGE,t.uid,t.payload),this.onStreamMessage&&this.onStreamMessage(t)}),this._gateway.signal.on(et.ON_CRYPT_ERROR,()=>{yo(()=>{_.warning("[".concat(this._clientId,"] on crypt error")),this.emit(nt.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(et.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(et.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{_.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0),this.emit(nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(et.ON_STREAM_FALLBACK_UPDATE,t=>{_.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.emit(nt.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(et.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),_.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(et.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(et.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(B.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case q.PUBLISH:{if(!e)return;const s=(e=e).ortc;if(s){var i,n,r,o;const a=s.some(u=>{let{stream_type:l}=u;return l===ee.Audio}),c=s.some(u=>{let{stream_type:l}=u;return l!==ee.Audio}),d=s.some(u=>{let{stream_type:l}=u;return l===ee.Screen||l===ee.ScreenLow});e.state==="offer"&&G.publish(this._joinInfo.sid,{eventElapse:Ri.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:f.TIMEOUT,audio:a,video:c,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:d,audioName:a?(i=s.find(u=>{let{stream_type:l}=u;return l===ee.Audio}))===null||i===void 0||(n=i.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:c?(r=s.find(u=>{let{stream_type:l}=u;return l!==ee.Audio}))===null||r===void 0||(o=r.ssrcs[0])===null||o===void 0?void 0:o.ssrcId.toString():void 0})}break}case q.SUBSCRIBE:(e=e)&&G.subscribe(this._joinInfo.sid,{succ:!1,ec:f.TIMEOUT,audio:e.stream_type===Z.AUDIO,video:e.stream_type===Z.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:Ri.measureFromSubscribeStart(this.store.clientId,e.ssrcId)})}}),this._gateway.signal.on(et.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(et.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;C("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(n=>!sr(n.audio_ssrc,this.channelName)));const e=[],i=[];for(const n of t.users){let r=this._users.find(d=>d.uid===n.stream_id);r?r._trust_in_room_=!0:(r=new Iu(n.stream_id,n.stream_id),this._users.push(r),this.getListeners(nt.PUBLISHED_USER_LIST).length===0&&(_.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.emit(nt.USER_JOINED,r)));const o=qt.Audio&n.stream_type,s=(qt.Video|qt.LwoVideo)&n.stream_type,a=o&&r.hasAudio,c=s&&r.hasVideo;s&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=n.video_ssrc),o&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=n.audio_ssrc),o&&!a&&this.getListeners(nt.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.emit(nt.USER_PUBLISHED,r,"audio")),s&&!c&&this.getListeners(nt.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.emit(nt.USER_PUBLISHED,r,"video")),(o&&!a||s&&!c)&&e.push(r),s&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&i.push({user:r,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&i.push({user:r,mediaType:"audio"})}i.length>0&&(_.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map(n=>"user: ".concat(n.user.uid,", mediaType: ").concat(n.mediaType)).join("; ")," ")),this.massSubscribe(i).catch(n=>{_.error("[".concat(this._clientId,"] mass resubscribe error"),n.toString())})),this.getListeners(nt.PUBLISHED_USER_LIST).length>0?(_.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(n=>n.uid).join(", "))),this.emit(nt.PUBLISHED_USER_LIST,e)):_.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(n=>n.uid).join(", ")))})}_handleP2PChannelEvents(){this._p2pChannel.on(lt.RequestMuteLocal,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===f.DISCONNECT_P2P?e():i(n)}else e()}),this._p2pChannel.on(lt.RequestUnmuteLocal,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===f.DISCONNECT_P2P?e():i(n)}else e()}),this._p2pChannel.on(lt.RequestRePublish,(t,e,i)=>{this.publish(t,!1).then(e).catch(i)}),this._p2pChannel.on(lt.RequestReSubscribe,async(t,e,i)=>{try{for(const{user:n,kind:r}of t)r===Z.VIDEO?await this.subscribe(n,"video"):await this.subscribe(n,"audio");e()}catch(n){i(n)}}),this._p2pChannel.on(lt.RequestUploadStats,(t,e)=>{this._gateway.uploadStats(t,e)}),this._p2pChannel.on(lt.MediaReconnectStart,t=>{this.emit(nt.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(lt.MediaReconnectEnd,t=>{this.emit(nt.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(lt.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(lt.RequestRestartICE,async()=>{const t=await this._p2pChannel.restartICE(),e=await t.next();if(e.done)return;const i=e.value;let n;try{n=await this._gateway.restartICE({iceParameters:i})}catch(o){return void t.throw(o)}const{iceParameters:r}=function(o){const s=o.iceParameters;return{iceParameters:{iceUfrag:s.iceUfrag,icePwd:s.icePwd}}}(n);await t.next({remoteIceParameters:r})}),this._p2pChannel.on(lt.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(lt.RequestReconnectPC,async()=>{var t;const{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:s,iceParameters:a,candidates:c,rtpCapabilities:d,setup:u,cname:l}=rg(r,o);await this._p2pChannel.connect(a,s,c,d,u,l),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(lt.RequestUnpublishForReconnectPC,async(t,e,i)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):i()}),this._p2pChannel.on(lt.P2PLost,()=>{this.emit(nt.P2P_LOST,this.store.uid)}),this._p2pChannel.on(lt.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(lt.ConnectionTypeChange,t=>{this.emit(nt.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(lt.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(lt.QueryClientConnectionState,t=>{t(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new I(f.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new I(f.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!t)throw new I(f.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!t.inspectType||!Array.isArray(t.inspectType))throw new I(f.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const e=[...new Set(t.inspectType)];e.forEach(i=>{if(!["supervise","moderation"].includes(i))throw new I(f.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(i," is not a valid inspect type."))}),t.inspectType=e}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new I(f.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const e=new ya(t);this._inspect=e,this.handleVideoInspectEvents(this._inspect),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},ne)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new I(f.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}handleVideoInspectEvents(t){t.on(ie.CONNECTION_STATE_CHANGE,(e,i)=>{switch(this.emit(nt.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,i),i){case ci.CONNECTED:if(this.connectionState!=="CONNECTED")return void this.emit(nt.CONTENT_INSPECT_ERROR,new I(f.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(ie.INSPECT_RESULT,(e,i)=>{var n;if((i==null?void 0:i.code)===f.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return _.debug("Stop inspect content because that has left channel"),this==null||(n=this._inspect)===null||n===void 0||n.close(),void(this._inspect=void 0);this.emit(nt.CONTENT_INSPECT_RESULT,e,i)}),t.on(ie.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return _.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){To(t,"enabled"),Ct("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}}).prototype,"leave",[Qg],Object.getOwnPropertyDescriptor(U.prototype,"leave"),U.prototype),w(U.prototype,"publish",[Zg],Object.getOwnPropertyDescriptor(U.prototype,"publish"),U.prototype),w(U.prototype,"unpublish",[$g],Object.getOwnPropertyDescriptor(U.prototype,"unpublish"),U.prototype),w(U.prototype,"subscribe",[tT],Object.getOwnPropertyDescriptor(U.prototype,"subscribe"),U.prototype),w(U.prototype,"massSubscribe",[eT],Object.getOwnPropertyDescriptor(U.prototype,"massSubscribe"),U.prototype),w(U.prototype,"unsubscribe",[iT],Object.getOwnPropertyDescriptor(U.prototype,"unsubscribe"),U.prototype),w(U.prototype,"massUnsubscribe",[nT],Object.getOwnPropertyDescriptor(U.prototype,"massUnsubscribe"),U.prototype),w(U.prototype,"setLowStreamParameter",[rT],Object.getOwnPropertyDescriptor(U.prototype,"setLowStreamParameter"),U.prototype),w(U.prototype,"enableDualStream",[oT],Object.getOwnPropertyDescriptor(U.prototype,"enableDualStream"),U.prototype),w(U.prototype,"disableDualStream",[sT],Object.getOwnPropertyDescriptor(U.prototype,"disableDualStream"),U.prototype),w(U.prototype,"setClientRole",[aT],Object.getOwnPropertyDescriptor(U.prototype,"setClientRole"),U.prototype),w(U.prototype,"setProxyServer",[cT],Object.getOwnPropertyDescriptor(U.prototype,"setProxyServer"),U.prototype),w(U.prototype,"setTurnServer",[dT],Object.getOwnPropertyDescriptor(U.prototype,"setTurnServer"),U.prototype),w(U.prototype,"setLicense",[uT],Object.getOwnPropertyDescriptor(U.prototype,"setLicense"),U.prototype),w(U.prototype,"startProxyServer",[lT],Object.getOwnPropertyDescriptor(U.prototype,"startProxyServer"),U.prototype),w(U.prototype,"stopProxyServer",[hT],Object.getOwnPropertyDescriptor(U.prototype,"stopProxyServer"),U.prototype),w(U.prototype,"setLocalAccessPointsV2",[pT],Object.getOwnPropertyDescriptor(U.prototype,"setLocalAccessPointsV2"),U.prototype),w(U.prototype,"setLocalAccessPoints",[ET],Object.getOwnPropertyDescriptor(U.prototype,"setLocalAccessPoints"),U.prototype),w(U.prototype,"setRemoteDefaultVideoStreamType",[_T],Object.getOwnPropertyDescriptor(U.prototype,"setRemoteDefaultVideoStreamType"),U.prototype),w(U.prototype,"setRemoteVideoStreamType",[mT],Object.getOwnPropertyDescriptor(U.prototype,"setRemoteVideoStreamType"),U.prototype),w(U.prototype,"setStreamFallbackOption",[fT],Object.getOwnPropertyDescriptor(U.prototype,"setStreamFallbackOption"),U.prototype),w(U.prototype,"setEncryptionConfig",[ST],Object.getOwnPropertyDescriptor(U.prototype,"setEncryptionConfig"),U.prototype),w(U.prototype,"renewToken",[gT],Object.getOwnPropertyDescriptor(U.prototype,"renewToken"),U.prototype),w(U.prototype,"enableAudioVolumeIndicator",[TT],Object.getOwnPropertyDescriptor(U.prototype,"enableAudioVolumeIndicator"),U.prototype),w(U.prototype,"startLiveStreaming",[RT],Object.getOwnPropertyDescriptor(U.prototype,"startLiveStreaming"),U.prototype),w(U.prototype,"setLiveTranscoding",[IT],Object.getOwnPropertyDescriptor(U.prototype,"setLiveTranscoding"),U.prototype),w(U.prototype,"stopLiveStreaming",[vT],Object.getOwnPropertyDescriptor(U.prototype,"stopLiveStreaming"),U.prototype),w(U.prototype,"addInjectStreamUrl",[CT],Object.getOwnPropertyDescriptor(U.prototype,"addInjectStreamUrl"),U.prototype),w(U.prototype,"removeInjectStreamUrl",[yT],Object.getOwnPropertyDescriptor(U.prototype,"removeInjectStreamUrl"),U.prototype),w(U.prototype,"startChannelMediaRelay",[AT],Object.getOwnPropertyDescriptor(U.prototype,"startChannelMediaRelay"),U.prototype),w(U.prototype,"updateChannelMediaRelay",[OT],Object.getOwnPropertyDescriptor(U.prototype,"updateChannelMediaRelay"),U.prototype),w(U.prototype,"stopChannelMediaRelay",[bT],Object.getOwnPropertyDescriptor(U.prototype,"stopChannelMediaRelay"),U.prototype),w(U.prototype,"sendCustomReportMessage",[wT],Object.getOwnPropertyDescriptor(U.prototype,"sendCustomReportMessage"),U.prototype),w(U.prototype,"pickSVCLayer",[NT],Object.getOwnPropertyDescriptor(U.prototype,"pickSVCLayer"),U.prototype),w(U.prototype,"enableContentInspect",[DT],Object.getOwnPropertyDescriptor(U.prototype,"enableContentInspect"),U.prototype),w(U.prototype,"disableContentInspect",[PT],Object.getOwnPropertyDescriptor(U.prototype,"disableContentInspect"),U.prototype),w(U.prototype,"getJoinChannelServiceRecords",[LT],Object.getOwnPropertyDescriptor(U.prototype,"getJoinChannelServiceRecords"),U.prototype),w(U.prototype,"setPublishAudioFilterEnabled",[kT],Object.getOwnPropertyDescriptor(U.prototype,"setPublishAudioFilterEnabled"),U.prototype),U);class _D extends Q_{set currentState(e){e!==this._currentState&&(this._currentState=e,this.emit(Xe.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),h(this,"audioBuffer",void 0),h(this,"sourceNode",void 0),h(this,"startPlayTime",0),h(this,"startPlayOffset",0),h(this,"pausePlayTime",0),h(this,"options",void 0),h(this,"currentLoopCount",0),h(this,"_currentState","stopped"),this.audioBuffer=e,this.options=i,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer.duration}get currentTime(){return this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:(this.context.currentTime-this.startPlayTime+this.startPlayOffset)%this.audioBuffer.duration}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):_.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const UT=new Map;async function mD(t,e){let i=null;if(typeof t=="string"){const r=UT.get(t);if(r)return _.debug("use cached audio resource: ",t),r;try{i=(await tn(()=>Pi.get(t,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(o){throw new I(f.FETCH_AUDIO_FILE_FAILED,o.toString())}}else i=await new V((o,s)=>{const a=new FileReader;a.onload=c=>{c.target?o(c.target.result):s(new I(f.READ_LOCAL_AUDIO_FILE_ERROR))},a.onerror=()=>{s(new I(f.READ_LOCAL_AUDIO_FILE_ERROR))},a.readAsArrayBuffer(t)});const n=await function(r){const o=Gr();return new V((s,a)=>{o.decodeAudioData(r,c=>{s(c)},c=>{a(new I(f.DECODE_AUDIO_FILE_FAILED,c.toString()))})})}(i);return typeof t=="string"&&e&&UT.set(t,n),n}function xT(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Aa(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?xT(Object(i),!0).forEach(function(n){h(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):xT(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function nl(t,e,i,n){i.optimizationMode&&(n&&n.width&&n.height?(i.encoderConfig=Aa(Aa({},n),{},{bitrateMin:n.bitrateMin,bitrateMax:n.bitrateMax}),i.optimizationMode!=="motion"&&i.optimizationMode!=="detail"||(e.contentHint=i.optimizationMode,e.contentHint===i.optimizationMode?_.debug("[".concat(t,"] set content hint to"),i.optimizationMode):_.debug("[".concat(t,"] set content hint failed")))):_.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}const fD=Rt().name;function SD(t,e,i,n){let r,o=0,s=null;return new V((a,c)=>{setTimeout(()=>{r&&(r(),a(o))},e),r=X_(()=>{(function(){o>n&&r&&(r(),a(o));const d=i.getContext("2d");if(!d){const E=new I(f.UNEXPECTED_ERROR,"can not get canvas 2d context.");return _.error(E.toString()),void c(E)}d.drawImage(t,0,0,160,120);const u=d.getImageData(0,0,i.width,i.height),l=Math.floor(u.data.length/3);if(s){for(let E=0;E<l;E+=3)if(u.data[E]!==s[E])return o+=1,void(s=u.data);s=u.data}else s=u.data})()},30)})}class Wo{constructor(e,i){h(this,"id",0),h(this,"element",void 0),h(this,"peerPair",void 0),h(this,"context",void 0),h(this,"audioPlayerElement",void 0),h(this,"audioTrack",void 0),Wo.count+=1,this.id=Wo.count,this.element=e,this.context=i}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const i=document.createElement("audio");i.srcObject=new MediaStream([e.track]),i.play(),this.audioPlayerElement=i}}async switchSdp(){if(!this.peerPair)return;const e=async(n,r)=>{const o=r==="offer"?await n.createOffer():await n.createAnswer();return await n.setLocalDescription(o),n.iceGatheringState==="complete"?n.localDescription:new V(s=>{n.onicegatheringstatechange=()=>{n.iceGatheringState==="complete"&&s(n.localDescription)}})},i=async(n,r)=>await n.setRemoteDescription(r);try{const n=await e(this.peerPair[0],"offer");await i(this.peerPair[1],n);const r=await e(this.peerPair[1],"answer");await i(this.peerPair[0],r)}catch(n){throw new I(f.LOCAL_AEC_ERROR,n.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let i;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),i=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(i)}catch(r){throw new I(f.LOCAL_AEC_ERROR,r.toString()).print()}if(!i)throw new I(f.LOCAL_AEC_ERROR,"no dest node when local aec").print();const n=i.stream.getAudioTracks()[0];return this.audioTrack=n,n}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,i=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(i),await this.switchSdp()}close(){_.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var VT,Oa;h(Wo,"count",0);const gD=window.AudioContext||window.webkitAudioContext,TD=new(VT=Y({report:G}),w((Oa=class{constructor(){h(this,"units",[]),h(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return _.debug("the system does not need to process local aec"),-1;this.context||(this.context=new gD);let e=this.units.find(i=>i&&i.getElement()===t);return e||(e=new Wo(t,this.context),this.units.push(e)),e.startEchoCancellation(),_.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Rt().name!==St.SAFARI}}).prototype,"processExternalMediaAEC",[VT],Object.getOwnPropertyDescriptor(Oa.prototype,"processExternalMediaAEC"),Oa.prototype),Oa);Ct("PROCESS_ID","process-".concat(Lt(8,""),"-").concat(Lt(4,""),"-").concat(Lt(4,""),"-").concat(Lt(4,""),"-").concat(Lt(12,""))),function(){const t=Rt();xe.getDisplayMedia=function(e){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)}(),xe.getStreamFromExtension=t.name===St.CHROME&&Number(t.version)>34,xe.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let i=!1;try{e.addTransceiver("audio"),i=!0}catch{}return e.close(),i}(),xe.supportMinBitrate=t.name===St.CHROME||t.name===St.EDGE,xe.supportSetRtpSenderParameters=function(){const e=Rt();return!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters||!window.RTCRtpSender.prototype.getParameters?!1:!!er()||!(!Le()&&!ks())||e.name===St.FIREFOX&&Number(e.version)>=64}(),t.name===St.SAFARI&&(Number(t.version)>=14?xe.supportDualStream=!0:xe.supportDualStream=!1),xe.webAudioMediaStreamDest=function(){const e=Rt();return!(e.name===St.SAFARI&&Number(e.version)<12)}(),xe.supportReplaceTrack=function(){return window.RTCRtpSender?typeof RTCRtpSender.prototype.replaceTrack=="function":!1}(),xe.supportWebGL=typeof WebGLRenderingContext<"u",xe.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,er()||(xe.webAudioWithAEC=!0),xe.supportShareAudio=function(){const e=Rt();return(e.os===be.WIN_10||e.os===be.WIN_81||e.os===be.WIN_7||e.os===be.LINUX||e.os===be.MAC_OS)&&e.name===St.CHROME&&Number(e.version)>=74}(),xe.supportDualStreamEncoding=function(){const e=Rt();return C("DISABLE_WEBAUDIO")?!0:e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&C("CHROME_DUAL_STREAM_USE_ENCODING"))}(),xe.supportDataChannel=function(){return!!(sd(76)||function(e){const i=Rt();return!(i.name!==St.FIREFOX||!i.osVersion)&&Number(i.version)>=e}(68)||function(e){const i=Rt();return!(i.name!==St.SAFARI||!i.osVersion)&&Number(i.version)>=e}(14))}(),xe.supportPCSetConfiguration=!Bt()&&!!RTCPeerConnection.prototype.setConfiguration,_.info("browser compatibility",JSON.stringify(xe),JSON.stringify(t))}(),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),i=Date.now();_.debug("Loading global parameters from cache",e),Object.keys(e).forEach(n=>{if(Object.prototype.hasOwnProperty.call(qe,n)){const{value:r,expires:o}=e[n];if(o&&o<=i)return;rr[n]=r,qe[n]=r}})}catch(e){_.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray(rr.AREAS)&&rr.AREAS.length>0&&_u(rr.AREAS,!0);const He={__CLIENT_LIST__:or,__TRACK_LIST__:go,VERSION:gi,BUILD:Ad,setParameter:(t,e,i)=>{_.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),Ct(t,e,i)},getParameter:C,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection;e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});const i=(await e.createOffer()).sdp;if(!i)return t;e.close(),e=null,t=function(n){const r={video:[],audio:[]};return n.match(/ VP8/i)&&r.video.push("VP8"),n.match(/ VP9/i)&&r.video.push("VP9"),n.match(/ AV1/i)&&r.video.push("AV1"),n.match(/ H264/i)&&r.video.push("H264"),n.match(/ opus/i)&&r.audio.push("OPUS"),n.match(/ PCMU/i)&&r.audio.push("PCMU"),n.match(/ PCMA/i)&&r.audio.push("PCMA"),n.match(/ G722/i)&&r.audio.push("G722"),r}(i)}catch(e){throw new I(f.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return t},checkSystemRequirements:function(){const t=G.reportApiInvoke(null,{name:$t.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Mt.TRACER});let e=!1;try{const o=window.RTCPeerConnection,s=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,a=window.WebSocket;e=!!(o&&s&&a)}catch(o){return _.error("check system requirement failed: ",o),!1}let i=!1;const n=Rt();n.name===St.CHROME&&Number(n.version)>=58&&(!MO()||kO())&&(i=!0),n.name===St.FIREFOX&&Number(n.version)>=56&&(i=!0),n.name===St.OPERA&&Number(n.version)>=45&&(i=!0),n.name===St.SAFARI&&Number(n.version)>=11&&(i=!0),(IE()||Rt().name===St.QQ)&&(i=!0),_.debug("checkSystemRequirements, api:",e,"browser",i);const r=e&&i;return t.onSuccess(r),r},getDevices:function(t){return hi.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return hi.getRecordingDevices(t)},getCameras:function(t){return hi.getCamerasDevices(t)},getElectronScreenSources:$_,getPlaybackDevices:function(t){return hi.getSpeakers(t)},createClient:function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const e=G.reportApiInvoke(null,{name:$t.CREATE_CLIENT,options:[t],tag:Mt.TRACER});try{uw(t)}catch(i){throw e.onError(i),i}return t.audioCodec===void 0&&(t.audioCodec="opus"),e.onSuccess(),new ED(Go(Go({forceWaitGatewayResponse:!0},t),{},{role:t.mode==="rtc"?"host":t.role}))},createCameraVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CREATE_CAM_VIDEO_TRACK,options:[Aa({},t)]}),i=ua(t),n=Lt(8,"track-cam-");let r=null;_.info("start create camera video track with config",JSON.stringify(t),"trackId",n);try{r=(await Mi({video:i},n)).getVideoTracks()[0]||null}catch(s){throw e.onError(s),s}if(!r){const s=new I(f.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(s),s.throw()}t.optimizationMode&&nl(n,r,t,nr(t.encoderConfig));const o=new IS(r,t,i,t.scalabiltyMode?Ks(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n);return e.onSuccess(o.getTrackId()),_.info("create camera video success, trackId:",n),o},createCustomVideoTrack:function(t){const e=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),i=new zt(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Ks(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,Lt(8,"track-cus-"),[re.CUSTOM_TRACK]);return e.onSuccess(i.getTrackId()),_.info("create custom video track success with config",t,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const i=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CREATE_SCREEN_VIDEO_TRACK,options:[Aa({},t),e]});t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";const n=t0(t),r=Lt(8,"track-scr-v-");let o=null,s=null;const a=le();if(!a.supportShareAudio&&e==="enable"){const u=new I(f.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(u),u.throw()}_.info("start create screen video track with config",t,"withAudio",e,"trackId",r);try{const u=await Mi({screen:n,screenAudio:e==="auto"?a.supportShareAudio:e==="enable"},r);o=u.getVideoTracks()[0]||null,s=u.getAudioTracks()[0]||null}catch(u){throw i.onError(u),u}if(!o){const u=new I(f.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(u),u.throw()}if(!s&&e==="enable"){o&&o.stop();const u=new I(f.SHARE_AUDIO_NOT_ALLOWED);return i.onError(u),u.throw()}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(nl(r,o,t,t.encoderConfig&&bd(t.encoderConfig)),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));const c=new zt(o,t.encoderConfig?bd(t.encoderConfig):{},t.scalabiltyMode?Ks(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,r,[re.SCREEN_TRACK]);if(!s)return i.onSuccess(c.getTrackId()),_.info("create screen video track success","video:",c.getTrackId()),c;const d=new ve(s,void 0,Lt(8,"track-scr-a-"),!1,!0);return i.onSuccess([c.getTrackId(),d.getTrackId()]),_.info("create screen video track success","video:",c.getTrackId(),"audio:",d.getTrackId()),[c,d]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CREATE_MIC_AND_CAM_TRACKS,options:[t,e]}),n=ua(e),r=Bf(t),o=Lt(8,"track-mic-"),s=Lt(8,"track-cam-");let a=null,c=null;_.info("start create camera video track(".concat(s,") and microphone audio track(").concat(o,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{const l=await Mi({audio:r,video:n},"".concat(o,"-").concat(s));a=l.getAudioTracks()[0],c=l.getVideoTracks()[0]}catch(l){throw i.onError(l),l}if(!a||!c){const l=new I(f.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(l),l.throw()}e.optimizationMode&&nl(s,c,e,nr(e.encoderConfig));const d=new ea(a,t,r,o),u=new IS(c,e,n,e.scalabiltyMode?Ks(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,s);return i.onSuccess([d.getTrackId(),u.getTrackId()]),_.info("create camera video track(".concat(s,") and microphone audio track(").concat(o,") success")),[d,u]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CREATE_MIC_AUDIO_TRACK,options:[t]}),i=Bf(t),n=Lt(8,"track-mic-");let r=null;_.info("start create microphone audio track with config",JSON.stringify(t),"trackId",n);try{r=(await Mi({audio:i},n)).getAudioTracks()[0]||null}catch(s){throw e.onError(s),s}if(!r){const s=new I(f.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(s),s.throw()}const o=new ea(r,t,i,n);return e.onSuccess(o.getTrackId()),_.info("create microphone audio track success, trackId:",n),o},createCustomAudioTrack:function(t){const e=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),i=new ve(t.mediaStreamTrack,t.encoderConfig?Ys(t.encoderConfig):{},Lt(8,"track-cus-"),!1,!0);return _.info("create custom audio track success with config",t,"trackId",i.getTrackId()),e.onSuccess(i.getTrackId()),i},createBufferSourceAudioTrack:async function(t){const e=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CREATE_BUFFER_AUDIO_TRACK,options:[t]});if(C("DISABLE_WEBAUDIO"))throw new I(f.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const i=Lt(8,"track-buf-");_.info("start create buffer source audio track with config",JSON.stringify(t),"trackId",i);const n=t.source;if(!(t.source instanceof AudioBuffer))try{t.source=await mD(t.source,t.cacheOnlineFile)}catch(s){return e.onError(s),s.throw()}const r=new _D(t.source),o=new DN(n,r,t.encoderConfig?Ys(t.encoderConfig):{},i);return _.info("create buffer source audio track success, trackId:",i),e.onSuccess(o.getTrackId()),o},setAppType:function(t){if(_.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw _.debug("Invalid appType"),new I(f.INVALID_PARAMS,"invalid app type",t);Ct("APP_TYPE",Math.floor(t))},setLogLevel:function(t){_.setLogLevel(t)},enableLogUpload:function(){C("USE_NEW_LOG")?Ct("UPLOAD_LOG",!0):_.enableLogUpload()},disableLogUpload:function(){C("USE_NEW_LOG")?Ct("UPLOAD_LOG",!1):_.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new kf},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof ve||t instanceof Ra)){const c=new I(f.INVALID_TRACK,"the parameter is not a audio track");return i.onError(c),c.throw()}e&&e<1e3&&(e=1e3);const n=t instanceof ve?t.getTrackLabel():"remote_track",r=t.getVolumeLevel();let o=r,s=r;const a=Date.now();return new V(c=>{const d=setInterval(()=>{const u=t.getVolumeLevel();o=u>o?u:o,s=u<s?u:s;const l=o-s>1e-4,E=Date.now()-a;if(l||E>e){clearInterval(d);const m=l,T={duration:E,deviceLabel:n,maxVolumeLevel:o,result:m};_.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(T))),i.onSuccess(T),c(m)}},200)})},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=G.reportApiInvoke(null,{tag:Mt.TRACER,name:$t.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof zt||t instanceof Ta)){const E=new I(f.INVALID_TRACK,"the parameter is not a video track");return i.onError(E),E.throw()}const n=4;e&&e<1e3&&(e=1e3);const r=t instanceof zt?t.getTrackLabel():"remote_track",o=t.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(Le()||ks())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([o]),s.play();const a=document.createElement("canvas");a.width=160,a.height=120;let c=0,d=0;try{const E=Date.now();c=await SD(s,e,a,n),d=Date.now()-E}catch(E){throw i.onError(E),E}fD===St.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;const u=c>n,l={duration:d,changedPicNum:c,deviceLabel:r,result:u};return _.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),i.onSuccess(l),u},setArea:_u,audioElementPlayCenter:ii,processExternalMediaAEC:function(t){TD.processExternalMediaAEC(t)},registerExtensions:function(t){t.forEach(e=>{const i=e;i.__registered__=!0,i.logger.hookLog=_.extLog,i.reporter.hookApiInvoke=G.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach(n=>{i.parameters[n]=C(n)})})},ChannelMediaRelayError:Ln,ChannelMediaRelayEvent:Ki,ChannelMediaRelayState:Ge,RemoteStreamFallbackType:Yd,RemoteStreamType:Kd,ConnectionDisconnectedReason:_t,AudienceLatencyLevelType:jd,AREAS:at},rl=window||document;return Object.defineProperties(He,{onAudioAutoplayFailed:{get:()=>ui.onAudioAutoplayFailed,set:t=>{ui.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>ui.onAutoplayFailed,set:t=>{ui.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>He._onSecurityPolicyViolation,set(t){if(He._onSecurityPolicyViolation=t,!rl)return;const e=n=>{if(!(n&&n.blockedURI&&He.onSecurityPolicyViolation))return;const r=n.blockedURI;C("CSP_DETECTED_HOSTNAME_LIST").some(o=>r.includes(o))&&He.onSecurityPolicyViolation&&typeof He.onSecurityPolicyViolation=="function"&&He.onSecurityPolicyViolation(n)},i=He._cspEventHandlerPointer;i&&rl.removeEventListener("securitypolicyviolation",i),t&&typeof t=="function"&&rl.addEventListener("securitypolicyviolation",e),He._cspEventHandlerPointer=e}}}),hi.on(mn.CAMERA_DEVICE_CHANGED,t=>{_.info("camera device changed",JSON.stringify(t)),He.onCameraChanged&&He.onCameraChanged(t)}),hi.on(mn.RECORDING_DEVICE_CHANGED,t=>{_.info("microphone device changed",JSON.stringify(t)),He.onMicrophoneChanged&&He.onMicrophoneChanged(t)}),hi.on(mn.PLAYOUT_DEVICE_CHANGED,t=>{_.debug("playout device changed",JSON.stringify(t)),He.onPlaybackDeviceChanged&&He.onPlaybackDeviceChanged(t)}),ii.onAutoplayFailed=()=>{_.info("detect audio element autoplay failed"),ui.onAudioAutoplayFailed&&ui.onAudioAutoplayFailed()},ct.on("autoplay-failed",()=>{_.info("detect webaudio autoplay failed"),ui.onAudioAutoplayFailed&&ui.onAudioAutoplayFailed()}),window&&(window.__ARTC__=He),He})})(BT);var ID=BT.exports;const sl=RD(ID);let wi={appId:"526b5d98970e4093b953bd95e54a737a",channel:"nishant",token:"007eJxTYPh61DD66IRPrDftsrnyV/YY1KZ0vH7Kt58pb0WhX4wg6ysFBlMjsyTTFEsLS3ODVBMDS+MkS1PjpBRL01RTk0RzY/PE072NKQ2BjAwqnkYsjAwQCOKzM+RlFmck5pUwMAAAdIIfNg==",uid:0,role:""},he={localAudioTrack:null,localVideoTrack:null,remoteAudioTrack:null,remoteVideoTrack:null,remoteUid:null};async function vD(){const pe=sl.createClient({mode:"live",codec:"vp8"}),Ye=document.createElement("div"),ri=document.createElement("div");ri.id=wi.uid,ri.textContent="Local user "+wi.uid,ri.style.width="640px",ri.style.height="480px",ri.style.padding="15px 5px 5px 5px",Ye.style.width="640px",Ye.style.height="480px",Ye.style.padding="15px 5px 5px 5px",pe.on("user-published",async(Oe,Tt)=>{await pe.subscribe(Oe,Tt),console.log("subscribe success"),Tt=="video"&&(he.remoteVideoTrack=Oe.videoTrack,he.remoteAudioTrack=Oe.audioTrack,he.remoteUid=Oe.uid.toString(),Ye.id=Oe.uid.toString(),he.remoteUid=Oe.uid.toString(),Ye.textContent="Remote user "+Oe.uid.toString(),document.body.append(Ye),wi.role!="host"&&he.remoteVideoTrack.play(Ye)),Tt=="audio"&&(he.remoteAudioTrack=Oe.audioTrack,he.remoteAudioTrack.play()),pe.on("user-unpublished",De=>{console.log(De.uid+"has left the channel")})}),window.onload=function(){document.getElementById("join").onclick=async function(){if(wi.role==""){window.alert("Select a user role first!");return}await pe.join(wi.appId,wi.channel,wi.token,wi.uid),he.localAudioTrack=await sl.createMicrophoneAudioTrack(),he.localVideoTrack=await sl.createCameraVideoTrack(),document.body.append(ri),wi.role=="host"&&(await pe.publish([he.localAudioTrack,he.localVideoTrack]),he.localVideoTrack.play(ri),console.log("publish success!"))},document.getElementById("leave").onclick=async function(){he.localAudioTrack.close(),he.localVideoTrack.close(),jT(Ye.id),jT(ri.id),await pe.leave(),console.log("You left the channel"),window.location.reload()},document.getElementById("host").onclick=async function(){document.getElementById("host").checked&&(wi.role="host",await pe.setClientRole(wi.role),he.localVideoTrack!=null&&(await pe.publish([he.localAudioTrack,he.localVideoTrack]),he.remoteVideoTrack.stop(),he.localVideoTrack.play(ri)))},document.getElementById("Audience").onclick=async function(){document.getElementById("Audience").checked&&(wi.role="audience",he.localAudioTrack!=null&&he.localVideoTrack!=null&&he.remoteVideoTrack!=null&&await channelParamaters.localVideoTrack.replaceTrack(channelParamaters.remoteVideoTrack,!0),await pe.setClientRole(wi.role))}}}vD();function jT(pe){console.log("Removing "+pe+"Div");let Ye=document.getElementById(pe);Ye&&Ye.remove()}
